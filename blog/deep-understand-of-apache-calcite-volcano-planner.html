<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.30.1" theme-name="Stellar" theme-version="1.30.1"><meta name="generator" content="Hexo 7.3.0"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin><link rel="preconnect" href="https://googleads.g.doubleclick.net" crossorigin><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="theme-color" content="#f9fafb"><title>æ·±å…¥ç†è§£ Apache Calcite ValcanoPlanner ä¼˜åŒ–å™¨ - ç«¯å°å¼ºçš„åšå®¢</title><meta name="description" content="æ³¨æ„ï¼šæœ¬æ–‡åŸºäº Calcite 1.35.0 ç‰ˆæœ¬æºç è¿›è¡Œå­¦ä¹ ç ”ç©¶ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šå­˜åœ¨å®ç°é€»è¾‘å·®å¼‚ï¼Œå¯¹æºç æ„Ÿå…´è¶£çš„è¯»è€…è¯·æ³¨æ„ç‰ˆæœ¬é€‰æ‹©ã€‚   å‰è¨€ åœ¨ä¸Šä¸€ç¯‡æ·±å…¥ç†è§£ Apache Calcite HepPlanner ä¼˜åŒ–å™¨ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†æŸ¥è¯¢ä¼˜åŒ–å™¨çš„åŸºæœ¬æ¦‚å¿µå’Œç”¨é€”ï¼Œå¹¶ç»“åˆ Calcite HepPlanner æ·±å…¥åˆ†æäº†å¯å‘å¼ä¼˜åŒ–å™¨çš„å®ç°åŸç†ã€‚å¯å‘å¼ä¼˜åŒ–å™¨ä½¿ç”¨ç›¸å¯¹ç®€å•ï¼Œå®ƒç›´æ¥å¯¹é€»è¾‘æ‰§è¡Œè®¡åˆ’è¿›è¡Œ"><meta property="og:type" content="article"><meta property="og:title" content="æ·±å…¥ç†è§£ Apache Calcite ValcanoPlanner ä¼˜åŒ–å™¨"><meta property="og:url" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner.html"><meta property="og:site_name" content="ç«¯å°å¼ºçš„åšå®¢"><meta property="og:description" content="æ³¨æ„ï¼šæœ¬æ–‡åŸºäº Calcite 1.35.0 ç‰ˆæœ¬æºç è¿›è¡Œå­¦ä¹ ç ”ç©¶ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šå­˜åœ¨å®ç°é€»è¾‘å·®å¼‚ï¼Œå¯¹æºç æ„Ÿå…´è¶£çš„è¯»è€…è¯·æ³¨æ„ç‰ˆæœ¬é€‰æ‹©ã€‚   å‰è¨€ åœ¨ä¸Šä¸€ç¯‡æ·±å…¥ç†è§£ Apache Calcite HepPlanner ä¼˜åŒ–å™¨ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†æŸ¥è¯¢ä¼˜åŒ–å™¨çš„åŸºæœ¬æ¦‚å¿µå’Œç”¨é€”ï¼Œå¹¶ç»“åˆ Calcite HepPlanner æ·±å…¥åˆ†æäº†å¯å‘å¼ä¼˜åŒ–å™¨çš„å®ç°åŸç†ã€‚å¯å‘å¼ä¼˜åŒ–å™¨ä½¿ç”¨ç›¸å¯¹ç®€å•ï¼Œå®ƒç›´æ¥å¯¹é€»è¾‘æ‰§è¡Œè®¡åˆ’è¿›è¡Œ"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1701996404.png"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1701996456.png"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1701996507.png"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1702118316.png"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1702769869.png"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1703207948.png"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1703208192.png"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1703298241.png"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1703810657.png"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1703636903.png"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1703810113.jpg"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1703897196.png"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1704158875.png"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1704245597.png"><meta property="og:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/202309210909027-20240207092016569.png"><meta property="og:image" content="https://strongduanmu.com/assets/wechat/gongzhonghao.png"><meta property="article:published_time" content="2023-12-06T00:17:59.000Z"><meta property="article:modified_time" content="2023-12-06T00:17:59.000Z"><meta property="article:author" content="ç«¯å°å¼º"><meta property="article:tag" content="Calcite"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner/1701996404.png"><meta name="twitter:creator" content="@strongduanmu"><meta name="keywords" content="Calcite"><link rel="alternate" href="/atom.xml" title="ç«¯å°å¼ºçš„åšå®¢" type="application/atom+xml"><link rel="stylesheet" href="/css/main.css?v=1.30.1"><link rel="shortcut icon" href="/assets/placeholder/favicon.ico"><meta name="baidu-site-verification" content="codeva-sIRwgTpHve"><link rel="apple-touch-icon" sizes="180x180" href="/assets/placeholder/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/placeholder/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/placeholder/favicon-16x16.png"><link rel="manifest" href="/assets/placeholder/site.webmanifest"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/lxgwwenkaimono-bold.css" media="print" onload='this.media="all"'><noscript><link rel="stylesheet" href="/css/lxgwwenkaimono-bold.css"></noscript><link rel="stylesheet" href="/css/lxgwwenkaiscreen.css" media="print" onload='this.media="all"'><noscript><link rel="stylesheet" href="/css/lxgwwenkaiscreen.css"></noscript><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="preconnect" href="https://pagead2.googlesyndication.com"><link rel="dns-prefetch" href="https://pagead2.googlesyndication.com"><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9880881761323734" crossorigin="anonymous"></script><script src="/js/plugins/article-bottom-ad.js"></script><script src="/js/plugins/sticky-adsense.js"></script><script src="/js/plugins/adblock-detector.js"></script><style>.widget-wrapper.adsense{background:0 0!important}.widget-wrapper.adsense .widget-body{padding:0!important;background:0 0!important}.widget-wrapper.adsense .widget-body p{margin:0!important}.widget-wrapper.adsense ins.adsbygoogle{display:block;border-radius:12px;overflow:hidden}.article-bottom-ad{margin:2rem 0;padding:1rem;text-align:center}.article-bottom-ad .ad-container{max-width:100%;margin:0 auto}.article-bottom-ad ins.adsbygoogle{display:block;background:0 0}</style></head><body><div class="l_body content tech" id="start" layout="post"><aside class="l_left"><div class="leftbar-container"><header class="header"><div class="logo-wrap"><a class="avatar" href="/more/"><div class="bg" style="opacity:0;background-image:url(/assets/placeholder/rainbow64@3x.webp)"></div><img no-lazy class="avatar" src="/assets/placeholder/avatar.png" onerror="javascript:this.classList.add('error');this.src='/assets/placeholder/image.svg';"></a><a class="title" href="/"><div class="main" ff="title">ç«¯å°å¼ºçš„åšå®¢</div><div class="sub normal cap">ä¸ç§¯è·¬æ­¥ï¼Œæ— ä»¥è‡³åƒé‡Œ ğŸ¤”</div><div class="sub hover cap" style="opacity:0">ä¸ç§¯å°æµï¼Œæ— ä»¥æˆæ±Ÿæµ· ğŸ˜ƒ</div></a></div></header><div class="nav-area"><div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="ç«™å†…æœç´¢"></form><div id="search-result"></div><div class="search-no-result">æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼</div></div><nav class="menu dis-select"><a class="nav-item active" title="åšå®¢" href="/"><span>åšå®¢</span></a><a class="nav-item" title="æ–‡æ¡£" href="/wiki/"><span>æ–‡æ¡£</span></a><a class="nav-item" title="ä¾¿ç¬º" href="/notes/"><span>ä¾¿ç¬º</span></a><a class="nav-item" title="æ›´å¤š" href="/more/"><span>æ›´å¤š</span></a></nav></div><div class="widgets"><widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">æœ¬æ–‡ç›®å½•</span><a class="cap-action" onclick="sidebar.toggleTOC()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#volcanocascades-%E4%BC%98%E5%8C%96%E5%99%A8"><span class="toc-text">Volcano&#x2F;Cascades ä¼˜åŒ–å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#volcano-%E4%BC%98%E5%8C%96%E5%99%A8%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-text">Volcano ä¼˜åŒ–å™¨ç”Ÿæˆå™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cascades-%E4%BC%98%E5%8C%96%E5%99%A8"><span class="toc-text">Cascades ä¼˜åŒ–å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#memo-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">Memo æ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rule-%E7%9A%84%E6%94%B9%E8%BF%9B"><span class="toc-text">Rule çš„æ”¹è¿›</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pattern-%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99"><span class="toc-text">Pattern åŒ¹é…è§„åˆ™</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#searching-algorithm"><span class="toc-text">Searching Algorithm</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#volcanoplanner-%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D"><span class="toc-text">VolcanoPlanner åŸºç¡€ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">æ ¸å¿ƒæ¦‚å¿µ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#relnode"><span class="toc-text">RelNode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#relset"><span class="toc-text">RelSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#relsubset"><span class="toc-text">RelSubset</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-text">å¤„ç†æµç¨‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#volcanoplanner-%E6%BA%90%E7%A0%81%E6%8E%A2%E7%A7%98"><span class="toc-text">VolcanoPlanner æºç æ¢ç§˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#volcanoplanner-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">VolcanoPlanner åˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setroot-%E6%B5%81%E7%A8%8B"><span class="toc-text">setRoot æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%BD%AE-setroot"><span class="toc-text">ç¬¬ä¸€è½® setRoot</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#onregister"><span class="toc-text">onRegister</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#addreltoset"><span class="toc-text">addRelToSet</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#firerules"><span class="toc-text">fireRules</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%BD%AE-setroot"><span class="toc-text">ç¬¬äºŒè½® setRoot</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#changetraits"><span class="toc-text">changeTraits</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#registersubset"><span class="toc-text">registerSubset</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ensurerootconverters"><span class="toc-text">ensureRootConverters</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#findbestexp-%E6%B5%81%E7%A8%8B"><span class="toc-text">findBestExp æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#drive"><span class="toc-text">drive</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#buildcheapestplan"><span class="toc-text">buildCheapestPlan</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="toc-text">æ•´ä½“æµç¨‹æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-text">ç»“è¯­</span></a></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>å›åˆ°é¡¶éƒ¨</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>å‚ä¸è®¨è®º</span></a></div></widget><widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">ä¸“æ ï¼šCalcite</span></div><div class="widget-body"><a class="item" href="/blog/speed-up-by-100x-shardingsphere-sql-federation-in-predicate-deep-optimization-practice.html"><span class="title">ç™¾å€æé€Ÿï¼ShardingSphere è”é‚¦æŸ¥è¯¢æ‰¹é‡ IN æŸ¥è¯¢æ·±åº¦ä¼˜åŒ–</span></a><a class="item" href="/blog/analyze-wrong-result-for-shardingsphere-sql-federation-grouping-function.html"><span class="title">ShardingSphere è”é‚¦æŸ¥è¯¢ GROUPING èšåˆç»“æœé—®é¢˜åˆ†æ</span></a><a class="item" href="/blog/apache-calcite-catalog-type-system-implementation.html"><span class="title">Apache Calcite Catalog æ‹¾é—ä¹‹ç±»å‹ç³»ç»Ÿå®ç°</span></a><a class="item" href="/blog/using-calcite-as-an-example-to-explore-the-common-implementation-of-join-operators.html"><span class="title">ä»¥ Calcite ä¸ºä¾‹æ¢ç©¶ Join ç®—å­çš„å¸¸ç”¨å®ç°</span></a><a class="item" href="/blog/explore-the-practice-of-apache-calcite-in-mycat2.html"><span class="title">Apache Calcite åœ¨ MyCat2 ä¸­çš„å®è·µæ¢ç©¶</span></a><a class="item" href="/blog/calcite-udf-in-action-shardingsphere-sql-federation-adapte-to-mysql-bit-count.html"><span class="title">Calcite UDF å®æˆ˜ä¹‹ ShardingSphere è”é‚¦æŸ¥è¯¢é€‚é… MySQL BIT_COUNT</span></a><a class="item" href="/blog/apache-calcite-catalog-udf-function-implementation-and-extension.html"><span class="title">Apache Calcite Catalog æ‹¾é—ä¹‹ UDF å‡½æ•°å®ç°å’Œæ‰©å±•</span></a><a class="item" href="/blog/in-depth-exploration-of-implementation-principle-of-apache-calcite-sql-validator.html"><span class="title">æ·±åº¦æ¢ç©¶ Apache Calcite SQL æ ¡éªŒå™¨å®ç°åŸç†</span></a><a class="item" href="/blog/cornerstone-of-cbo-optimization-apache-calcite-statistics-and-cost-model.html"><span class="title">CBO ä¼˜åŒ–çš„åŸºçŸ³â€”â€”Apache Calcite ç»Ÿè®¡ä¿¡æ¯å’Œä»£ä»·æ¨¡å‹è¯¦è§£</span></a><a class="item active" href="/blog/deep-understand-of-apache-calcite-volcano-planner.html"><span class="title">æ·±å…¥ç†è§£ Apache Calcite ValcanoPlanner ä¼˜åŒ–å™¨</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a><a class="item" href="/blog/deep-understand-of-apache-calcite-hep-planner.html"><span class="title">æ·±å…¥ç†è§£ Apache Calcite HepPlanner ä¼˜åŒ–å™¨</span></a><a class="item" href="/blog/explore-apache-calcite-system-catalog-implementation.html"><span class="title">Apache Calcite System Catalog å®ç°æ¢ç©¶</span></a><a class="item" href="/blog/implementation-principle-of-apache-calcite-sql-parser.html"><span class="title">Apache Calcite SQL Parser åŸç†å‰–æ</span></a><a class="item" href="/blog/apache-calcite-quick-start-guide.html"><span class="title">Apache Calcite å¿«é€Ÿå…¥é—¨æŒ‡å—</span></a><a class="item" href="/blog/apache-calcite-learning-materials.html"><span class="title">Apache Calcite å­¦ä¹ èµ„æ–™æ•´ç†</span></a></div></widget></div><footer class="footer dis-select"><div class="social-wrap"><a class="social" href="mailto:duanzhengqiang@apache.org" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/email.svg"></a><a class="social" href="https://github.com/strongduanmu" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/github.svg"></a><a class="social" href="/sitemap.xml" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/sitemap.svg"></a><a class="social" href="/atom.xml" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/rss.svg"></a></div></footer></div></aside><div class="l_main" id="main"><div class="article banner top"><img class="bg lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/banner/banner_7.jpg"><div class="content"><div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">ä¸»é¡µ</a> <span class="sep"></span><a class="cap breadcrumb" id="menu" href="/topic">ä¸“æ </a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/blog/speed-up-by-100x-shardingsphere-sql-federation-in-predicate-deep-optimization-practice.html">Calcite</a></div><div class="flex-row" id="post-meta"><span class="text created">å‘å¸ƒäºï¼š<time datetime="2023-12-06T00:17:59.000Z">2023-12-06</time></span><span class="sep updated"></span><span class="text updated">æ›´æ–°äºï¼š<time datetime="2023-12-06T00:17:59.000Z">2023-12-06</time></span></div></div></div><div class="bottom only-title"><div class="text-area"><h1 class="text title"><span>æ·±å…¥ç†è§£ Apache Calcite ValcanoPlanner ä¼˜åŒ–å™¨</span></h1></div></div></div></div><article class="md-text content"><blockquote><p>æ³¨æ„ï¼šæœ¬æ–‡åŸºäº <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/tree/75750b78b5ac692caa654f506fc1515d4d3991d6">Calcite 1.35.0</a> ç‰ˆæœ¬æºç è¿›è¡Œå­¦ä¹ ç ”ç©¶ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šå­˜åœ¨å®ç°é€»è¾‘å·®å¼‚ï¼Œå¯¹æºç æ„Ÿå…´è¶£çš„è¯»è€…<strong>è¯·æ³¨æ„ç‰ˆæœ¬é€‰æ‹©</strong>ã€‚</p></blockquote><h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2><p>åœ¨ä¸Šä¸€ç¯‡<a href="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-hep-planner.html">æ·±å…¥ç†è§£ Apache Calcite HepPlanner ä¼˜åŒ–å™¨</a>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†æŸ¥è¯¢ä¼˜åŒ–å™¨çš„åŸºæœ¬æ¦‚å¿µå’Œç”¨é€”ï¼Œå¹¶ç»“åˆ Calcite <code>HepPlanner</code> æ·±å…¥åˆ†æäº†<code>å¯å‘å¼ä¼˜åŒ–å™¨</code>çš„å®ç°åŸç†ã€‚å¯å‘å¼ä¼˜åŒ–å™¨ä½¿ç”¨ç›¸å¯¹ç®€å•ï¼Œå®ƒç›´æ¥å¯¹é€»è¾‘æ‰§è¡Œè®¡åˆ’è¿›è¡Œç­‰ä»·å˜æ¢ä»è€Œå®ç° SQL ä¼˜åŒ–ï¼Œå¸¸è§çš„å¯å‘å¼ä¼˜åŒ–åŒ…å«äº†ï¼š<code>åˆ—è£å‰ª</code>ã€<code>è°“è¯ä¸‹æ¨</code>ç­‰ã€‚å¯å‘å¼ä¼˜åŒ–å™¨å®ç°ç®€å•ï¼Œè‡ªç„¶ä¹Ÿå­˜åœ¨ä¸€äº›ç¼ºé™·ï¼Œä¾‹å¦‚ï¼šå®ƒå¯¹æ‰§è¡Œçš„é¡ºåºæœ‰è¦æ±‚ï¼Œä¸åŒçš„æ‰§è¡Œé¡ºåºå¯èƒ½ä¼šå¯¼è‡´ä¼˜åŒ–è§„åˆ™çš„å¤±æ•ˆï¼Œä½¿å¾—ä¼˜åŒ–è¾¾ä¸åˆ°é¢„æœŸçš„æ•ˆæœã€‚</p><p>æ­£æ˜¯ç”±äºå¯å‘å¼ä¼˜åŒ–å™¨å­˜åœ¨è¿™äº›é—®é¢˜ï¼Œä½¿å¾—å®ƒæ— æ³•é€‚åº”æ‰€æœ‰çš„ SQL åœºæ™¯ï¼Œå› æ­¤å½“å‰ä¸»æµçš„æ•°æ®åº“ç³»ç»Ÿæ›´å¤šæ˜¯ä½¿ç”¨<code>åŸºäºä»£ä»·çš„ä¼˜åŒ–å™¨</code>ï¼Œæˆ–è€…å°†ä¸¤è€…ç»“åˆä½¿ç”¨ã€‚åŸºäºä»£ä»·çš„ä¼˜åŒ–å™¨èƒ½å¤Ÿä¸ºå¤šä¸ªç­‰ä»·çš„æ‰§è¡Œè®¡åˆ’ç”Ÿæˆä»£ä»· <code>Cost</code> ä¿¡æ¯ï¼Œç„¶åé€‰æ‹©ä»£ä»·æœ€å°çš„é€‰é¡¹ä½œä¸ºæœ€ç»ˆçš„æ‰§è¡Œè®¡åˆ’ï¼Œä»è€Œè¾¾åˆ°æå‡ SQL æ‰§è¡Œæ•ˆç‡çš„ç›®çš„ã€‚</p><p>æœ¬æ–‡å°†é‡ç‚¹ä¸ºå¤§å®¶ä»‹ç» Calcite ä¸­åŸºäºä»£ä»·çš„ä¼˜åŒ–å™¨ <code>VolcanoPlanner</code>ï¼Œé¦–å…ˆæˆ‘ä»¬ä¼šäº†è§£ VolcanoPlanner èƒŒåçš„ç†è®ºåŸºç¡€â€”â€”<code>Volcano/Cascades Optimizer</code>ï¼Œç„¶åä¼šä»‹ç» VolcanoPlanner çš„æ ¸å¿ƒæ¦‚å¿µä»¥åŠæ‰§è¡Œæµç¨‹ï¼Œæœ€åå†æ·±å…¥æ¢ç©¶ Calcite VolcanoPlanner çš„æºç ç»†èŠ‚ï¼Œç»“åˆä¸€äº›å®é™…çš„ SQL ä¼˜åŒ–æ¡ˆä¾‹ï¼ŒæœŸæœ›èƒ½å¤Ÿè®©å¤§å®¶å½»åº•ææ‡‚ VolcanoPlanner ä¼˜åŒ–å™¨ã€‚</p><h2 id="volcanocascades-ä¼˜åŒ–å™¨"><a class="markdownIt-Anchor" href="#volcanocascades-ä¼˜åŒ–å™¨"></a> Volcano/Cascades ä¼˜åŒ–å™¨</h2><p>Calcite VolcanoPlanner ä¼˜åŒ–å™¨æ˜¯åŸºäº <code>Goetz Graefe</code> çš„ä¸¤ç¯‡ç»å…¸ä¼˜åŒ–å™¨è®ºæ–‡ <a target="_blank" rel="noopener" href="https://15721.courses.cs.cmu.edu/spring2019/papers/22-optimizer1/graefe-icde1993.pdf">The Volcano Optimizer Generator: Extensibility and Efficient Search</a> å’Œ <a target="_blank" rel="noopener" href="https://15721.courses.cs.cmu.edu/spring2018/papers/15-optimizer1/graefe-ieee1995.pdf">The Cascades Framework for Query Optimization</a> å®ç°çš„ï¼Œå› æ­¤åœ¨æ¢ç©¶ VolcanoPlanner ä¼˜åŒ–å™¨å®ç°ç»†èŠ‚ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸‹è¿™ä¸¤ç¯‡è®ºæ–‡çš„æ ¸å¿ƒæ€æƒ³ï¼Œæ–¹ä¾¿åç»­çš„å­¦ä¹ å’Œç†è§£ã€‚</p><h3 id="volcano-ä¼˜åŒ–å™¨ç”Ÿæˆå™¨"><a class="markdownIt-Anchor" href="#volcano-ä¼˜åŒ–å™¨ç”Ÿæˆå™¨"></a> Volcano ä¼˜åŒ–å™¨ç”Ÿæˆå™¨</h3><p><code>Volcano Optimizer Generator</code> çš„å®šä½æ˜¯ä¸€ä¸ªä¼˜åŒ–å™¨çš„<code>ç”Ÿæˆå™¨</code>ï¼Œå…¶æ ¸å¿ƒè´¡çŒ®æ˜¯æä¾›äº†ä¸€ä¸ªæœç´¢å¼•æ“ã€‚è®ºæ–‡ä¸­æå‡ºäº†æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å™¨çš„åŸºæœ¬æ¡†æ¶ï¼Œæ•°æ®åº“å®ç°è€…åªéœ€è¦ä¸ºè‡ªå·±çš„ <code>Data Model</code> å®ç°ç›¸åº”çš„æ¥å£ï¼Œä¾¿å¯ä»¥å®ç°ä¸€ä¸ªæŸ¥è¯¢ä¼˜åŒ–å™¨ã€‚æœ¬æ–‡æš‚æ—¶å¿½ç•¥<code>ç”Ÿæˆå™¨</code>ç›¸å…³çš„æ¦‚å¿µï¼Œåªä»‹ç»è®ºæ–‡åœ¨<code>ä¼˜åŒ–å™¨</code>æ–¹é¢æå‡ºçš„ä¸€äº›æ€è·¯ï¼š</p><ul><li><p>Volcano Optimizer ä½¿ç”¨ä¸¤é˜¶æ®µä¼˜åŒ–çš„æ–¹å¼ï¼Œå®ƒä½¿ç”¨ <code>Logical Algebra</code> æ¥è¡¨ç¤ºå„ç§å…³ç³»ä»£æ•°ç®—å­ï¼Œè€Œä½¿ç”¨ <code>Physical Algebra</code> æ¥è¡¨ç¤ºå„ç§å…³ç³»ä»£æ•°ç®—å­çš„å®ç°ç®—æ³•ã€‚Logical Algebra ä¹‹é—´ä½¿ç”¨ <code>Transformation</code> æ¥å®Œæˆå˜æ¢ï¼Œè€Œ Logical Algebra åˆ° Physical Algebra ä¹‹é—´çš„è½¬æ¢åˆ™åŸºäºä»£ä»·ï¼ˆ<code>Cost-Based</code>ï¼‰è¿›è¡Œé€‰æ‹©ï¼›</p></li><li><p>Volcano Optimizer ä¸­çš„å˜åŒ–éƒ½ä½¿ç”¨ <code>Rule</code> æ¥æè¿°ã€‚ä¾‹å¦‚ Logical Algebra ä¹‹é—´çš„å˜åŒ–ä½¿ç”¨ <code>Transformation Rule</code>ï¼Œè€Œ Logical Algebra åˆ° Physical Algebra ä¹‹é—´çš„è½¬æ¢ä½¿ç”¨ <code>Implementation Rule</code>ï¼›</p></li><li><p>Volcano Optimizer ä¸­å„ä¸ªç®—å­ã€è¡¨è¾¾å¼çš„ç»“æœä½¿ç”¨ <code>Property</code> æ¥è¡¨ç¤ºã€‚<code>Logical Propery</code> å¯ä»¥ä» Logical Algebra ä¸­æå–ï¼Œä¸»è¦åŒ…æ‹¬ç®—å­çš„ Schemaã€ç»Ÿè®¡ä¿¡æ¯ç­‰ã€‚<code>Physical Property</code> å¯ä»¥ä» Physical Algebra ä¸­æå–ï¼Œè¡¨ç¤ºç®—å­æ‰€äº§ç”Ÿçš„æ•°æ®å…·æœ‰çš„ç‰©ç†å±æ€§ï¼Œæ¯”å¦‚æŒ‰ç…§æŸä¸ª Key æ’åºã€æŒ‰ç…§æŸä¸ª Key åˆ†å¸ƒåœ¨é›†ç¾¤ä¸­ç­‰ï¼›</p></li><li><p>Volcano Optimizer çš„æœç´¢é‡‡ç”¨<code>è‡ªé¡¶å‘ä¸‹çš„åŠ¨æ€è§„åˆ’ç®—æ³•</code>ï¼ˆè®°å¿†åŒ–æœç´¢ï¼‰ã€‚</p></li></ul><h3 id="cascades-ä¼˜åŒ–å™¨"><a class="markdownIt-Anchor" href="#cascades-ä¼˜åŒ–å™¨"></a> Cascades ä¼˜åŒ–å™¨</h3><p><code>Cascades Optimizer</code> æ˜¯å¯¹ <code>Volcano Optimizer</code> çš„è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ŒCascades Optimizer æå‡ºäº† <code>Memo</code>ã€<code>Rule</code>ã€<code>Pattern</code> å’Œ <code>Search Algorithm</code> ç­‰åŸºæœ¬æ¦‚å¿µï¼Œä¸‹é¢æˆ‘ä»¬å°†å›´ç»•è¿™äº›æ¦‚å¿µä¸€ä¸€è¿›è¡Œä»‹ç»ã€‚</p><h4 id="memo-æ•°æ®ç»“æ„"><a class="markdownIt-Anchor" href="#memo-æ•°æ®ç»“æ„"></a> Memo æ•°æ®ç»“æ„</h4><p>Cascades Optimizer åœ¨æœç´¢çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒçš„æœç´¢ç©ºé—´æ˜¯ä¸€ä¸ªå…³ç³»ä»£æ•°ç®—å­æ ‘æ‰€ç»„æˆçš„æ£®æ—ï¼Œè€Œä¿å­˜è¿™ä¸ªæ£®æ—çš„æ•°æ®ç»“æ„å°±æ˜¯ <code>Memo</code>ã€‚Memo åŒ…å«äº†ä¸¤ä¸ªæœ€åŸºæœ¬çš„æ¦‚å¿µï¼š<code>Expression Group</code>ï¼ˆä¸‹æ–‡ç®€ç§° <code>Group</code>ï¼‰ å’Œ <code>Group Expression</code>ï¼ˆå¯¹åº”å…³ç³»ä»£æ•°ç®—å­ï¼‰ã€‚æ¯ä¸ª Group ä¸­ä¿å­˜çš„æ˜¯é€»è¾‘ç­‰ä»·çš„ Group Expressionï¼Œè€Œ Group Expression çš„å­èŠ‚ç‚¹æ˜¯ç”± Group ç»„æˆã€‚ä¸‹å›¾æ˜¯ç”±äº”ä¸ª Group ç»„æˆçš„ Memoï¼š</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1701996404.png" title="Memo ç»„æˆç»“æ„"><p>é€šè¿‡ä¸Šé¢çš„ Memo ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥æå–å‡ºä»¥ä¸‹ä¸¤æ£µç­‰ä»·çš„ç®—å­æ ‘ï¼Œä½¿ç”¨ Memo ç»“æ„å­˜å‚¨ä¸‹é¢ä¸¤æ£µæ ‘ï¼Œå¯ä»¥é¿å…å­˜å‚¨å†—ä½™çš„ç®—å­ï¼ˆå¦‚ <code>Scan A</code> ä»¥åŠ <code>Scan B</code>ï¼‰ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1701996456.png" title="ç­‰ä»·ç®—å­æ ‘"><h4 id="rule-çš„æ”¹è¿›"><a class="markdownIt-Anchor" href="#rule-çš„æ”¹è¿›"></a> Rule çš„æ”¹è¿›</h4><p>åœ¨ Volcano Optimizer ä¸­ï¼ŒRule è¢«åˆ†ä¸ºäº† <code>Transformation Rule</code> å’Œ <code>Implementation Rule</code> ä¸¤ç§ã€‚å…¶ä¸­ Transformation Rule ç”¨æ¥åœ¨ Memo ä¸­æ·»åŠ ç­‰ä»·çš„å…³ç³»ä»£æ•°ç®—å­ã€‚Transformation Rule å…·æœ‰åŸå­æ€§ï¼Œåªä½œç”¨äºç®—å­æ ‘çš„ä¸€ä¸ªå±€éƒ¨å°ç‰‡æ®µï¼Œæ¯ä¸ª Transformation Rule éƒ½æœ‰è‡ªå·±çš„åŒ¹é…æ¡ä»¶ï¼Œé€šè¿‡ä¸åœçš„åº”ç”¨åŒ¹é…ä¸Šçš„ Transformation Rule æ¥æ‰©å±•æœç´¢ç©ºé—´ï¼Œå¯»æ‰¾å¯èƒ½çš„æœ€ä¼˜è§£ã€‚Implementation Rule åˆ™æ˜¯ä¸º Group Expression é€‰æ‹©ç‰©ç†ç®—å­ã€‚åœ¨ Cascades Optimizer ä¸­ï¼Œä¸å†åŒºåˆ†è¿™ä¸¤ç±» Ruleã€‚</p><h4 id="pattern-åŒ¹é…è§„åˆ™"><a class="markdownIt-Anchor" href="#pattern-åŒ¹é…è§„åˆ™"></a> Pattern åŒ¹é…è§„åˆ™</h4><p><code>Pattern</code> ç”¨äºæè¿° Group Expression çš„å±€éƒ¨ç‰¹å¾ã€‚æ¯ä¸ª Rule éƒ½æœ‰è‡ªå·±çš„ Patternï¼Œåªæœ‰æ»¡è¶³äº†ç›¸åº” Pattern çš„ Group Expression æ‰èƒ½å¤Ÿåº”ç”¨è¯¥ Ruleã€‚ä¸‹å›¾ä¸­å·¦ä¾§å®šä¹‰äº†ä¸€ä¸ª <code>Selection -&gt; Projection</code> çš„ Patternï¼Œå¹¶åœ¨å³ä¾§ Memo ä¸­çº¢è‰²è™šçº¿å†…åŒ¹é…ä¸Šäº† Group Expressionã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1701996507.png" title="Pattern åŒ¹é…å…³ç³»ä»£æ•°ç®—å­"><h4 id="searching-algorithm"><a class="markdownIt-Anchor" href="#searching-algorithm"></a> Searching Algorithm</h4><p>Cascades Optimizer ä¸º Rule çš„åº”ç”¨é¡ºåºåšäº†ç»†è‡´çš„è®¾è®¡ï¼Œä¾‹å¦‚æ¯ä¸ª Rule éƒ½æœ‰ <code>promise</code> å’Œ <code>condition</code> ä¸¤ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­ <code>promise</code> ç”¨æ¥è¡¨ç¤º Rule åœ¨å½“å‰æœç´¢è¿‡ç¨‹ä¸­çš„é‡è¦æ€§ï¼Œ<code>promise</code> å€¼è¶Šé«˜ï¼Œåˆ™è¯¥è§„åˆ™è¶Šå¯èƒ½æœ‰ç”¨ï¼Œå½“ <code>promise</code> å€¼å°äºç­‰äº 0 æ—¶ï¼Œè¿™ä¸ª Rule å°±ä¸ä¼šè¢«æ‰§è¡Œã€‚è€Œ <code>condition</code> ç›´æ¥é€šè¿‡è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼å†³å®šä¸€ä¸ª Rule æ˜¯å¦å¯ä»¥åœ¨å½“å‰è¿‡ç¨‹ä¸­è¢«åº”ç”¨ã€‚å½“ä¸€ä¸ª Rule è¢«æˆåŠŸåº”ç”¨ä¹‹åï¼Œä¼šè®¡ç®—ä¸‹ä¸€æ­¥æœ‰å¯èƒ½ä¼šè¢«åº”ç”¨çš„ Rule çš„é›†åˆã€‚</p><p>Cascades Optimizer çš„æœç´¢ç®—æ³•ä¸ Volcano Optimizer æœ‰æ‰€ä¸åŒï¼ŒVolcano Optimizer å°†æœç´¢åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µæšä¸¾æ‰€æœ‰é€»è¾‘ç­‰ä»·çš„ Logical Algebraï¼Œè€Œåœ¨ç¬¬äºŒé˜¶æ®µè¿ç”¨åŠ¨æ€è§„åˆ’çš„æ–¹æ³•è‡ªé¡¶å‘ä¸‹åœ°æœç´¢ä»£ä»·æœ€å°çš„ Physical Algebraã€‚Cascades Optimizer åˆ™å°†è¿™ä¸¤ä¸ªé˜¶æ®µèåˆåœ¨ä¸€èµ·ï¼Œé€šè¿‡æä¾›ä¸€ä¸ª <code>Guidance</code> æ¥æŒ‡å¯¼ Rule çš„æ‰§è¡Œé¡ºåºï¼Œ<strong>åœ¨æšä¸¾é€»è¾‘ç­‰ä»·ç®—å­çš„åŒæ—¶ä¹Ÿè¿›è¡Œç‰©ç†ç®—å­çš„ç”Ÿæˆ</strong>ï¼Œè¿™æ ·åšå¯ä»¥é¿å…æšä¸¾æ‰€æœ‰çš„é€»è¾‘æ‰§è¡Œè®¡åˆ’ï¼Œä½†æ˜¯<strong>å…¶å¼Šç«¯å°±æ˜¯é”™è¯¯çš„ Guidance ä¼šå¯¼è‡´æœç´¢åœ¨å±€éƒ¨æ”¶æ•›ï¼Œå› è€Œæœç´¢ä¸åˆ°æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’</strong>ã€‚</p><p>Volcano/Cascades Optimzier éƒ½ä½¿ç”¨äº† <code>Branch-And-Bound</code> æ–¹æ³•å¯¹æœç´¢ç©ºé—´è¿›è¡Œå‰ªæã€‚ç”±äºä¸¤è€…éƒ½é‡‡ç”¨äº†è‡ªé¡¶å‘ä¸‹çš„æœç´¢ï¼Œåœ¨æœç´¢çš„è¿‡ç¨‹ä¸­å¯ä»¥ä¸ºç®—å­è®¾ç½®å…¶ <code>Cost Upper Bound</code>ï¼Œå¦‚æœåœ¨å‘ä¸‹æœç´¢çš„è¿‡ç¨‹ä¸­è¿˜æ²¡æœ‰æœç´¢åˆ°å¶å­èŠ‚ç‚¹å°±è¶…è¿‡äº†é¢„è®¾çš„ Cost Upper Boundï¼Œå°±å¯ä»¥å¯¹è¿™ä¸ªæœç´¢åˆ†æ”¯é¢„å…ˆè¿›è¡Œå‰ªæã€‚</p><div class="article-inline-ad-wrapper"><div class="article-inline-ad-container"><ins class="adsbygoogle" style="display:block;text-align:center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9880881761323734" data-ad-slot="7617691942"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="article-inline-ad-label">èµåŠ©å•†</div></div><h2 id="volcanoplanner-åŸºç¡€ä»‹ç»"><a class="markdownIt-Anchor" href="#volcanoplanner-åŸºç¡€ä»‹ç»"></a> VolcanoPlanner åŸºç¡€ä»‹ç»</h2><p>å‰é¢éƒ¨åˆ†æˆ‘ä»¬ä»‹ç»äº† Volcano/Cascades ä¼˜åŒ–å™¨çš„ç†è®ºåŸºç¡€ï¼Œæƒ³å¿…å¤§å®¶å·²ç»å¯¹ä¼˜åŒ–å™¨çš„åŸç†æœ‰äº†ä¸€äº›åŸºç¡€çš„è®¤è¯†ã€‚ä¸ºäº†é¿å…é™·å…¥ä»£ç ç»†èŠ‚ï¼Œæˆ‘ä»¬å­¦ä¹  VolcanoPlanner ä¹‹å‰ï¼Œå…ˆæ¥äº†è§£ä¸‹ VolcanoPlanner ä¸­æ¶‰åŠåˆ°çš„æ ¸å¿ƒæ¦‚å¿µï¼Œç†è§£è¿™äº›æ¦‚å¿µä¼šè®©æˆ‘ä»¬é˜…è¯»æºç æ›´åŠ è½»æ¾ã€‚ç„¶åæˆ‘ä»¬ä¼šä»æ•´ä½“è§’åº¦ï¼Œå†æ¥å­¦ä¹ ä¸‹ VolcanoPlanner çš„å¤„ç†æµç¨‹ï¼Œçœ‹çœ‹ Calcite é€»è¾‘è®¡åˆ’æ˜¯å¦‚ä½•ä¼˜åŒ–å¹¶è½¬æ¢ä¸ºç‰©ç†æ‰§è¡Œè®¡åˆ’çš„ã€‚</p><h3 id="æ ¸å¿ƒæ¦‚å¿µ"><a class="markdownIt-Anchor" href="#æ ¸å¿ƒæ¦‚å¿µ"></a> æ ¸å¿ƒæ¦‚å¿µ</h3><h4 id="relnode"><a class="markdownIt-Anchor" href="#relnode"></a> RelNode</h4><p>Caclite æºç ä¸­å¯¹ RelNode çš„å®šä¹‰ä¸º <code>A RelNode is a relational expression</code>ï¼Œå³å…³ç³»ä»£æ•°è¡¨è¾¾å¼ï¼ŒRelNode ç»§æ‰¿ RelOptNode æ¥å£ï¼Œè¡¨ç¤ºå¯ä»¥è¢«ä¼˜åŒ–å™¨ä¼˜åŒ–ã€‚å…³ç³»ä»£æ•°è¡¨è¾¾å¼ç”¨äºå¤„ç†æ•°æ®ï¼Œæ‰€ä»¥ä»–ä»¬é€šå¸¸ä½¿ç”¨åŠ¨è¯å‘½åï¼Œä¾‹å¦‚ï¼š<code>Sort</code>ã€<code>Join</code>ã€<code>Project</code>ã€<code>Filter</code>ã€<code>Scan</code> ç­‰ã€‚åœ¨ Caclite ä¸­ï¼Œä¸å»ºè®®ç›´æ¥å®ç° RelNode æ¥å£ï¼Œè€Œæ˜¯æ¨èç»§æ‰¿ <code>AbstractRelNode</code> æŠ½è±¡ç±»ã€‚</p><p>AbstractRelNode æŠ½è±¡ç±»çš„æ ¸å¿ƒå±æ€§å’Œæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractRelNode</span> <span class="keyword">implements</span> <span class="title class_">RelNode</span> &#123;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RelTraitSet that describes the traits of this RelNode.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> RelTraitSet traitSet;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pure</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="meta">@Nullable</span> Convention <span class="title function_">getConvention</span><span class="params">(<span class="meta">@UnknownInitialization</span> AbstractRelNode <span class="built_in">this</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> traitSet == <span class="literal">null</span> ? <span class="literal">null</span> : traitSet.getTrait(ConventionTraitDef.INSTANCE);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> RelDataType <span class="title function_">getRowType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (rowType == <span class="literal">null</span>) &#123;</span><br><span class="line">            rowType = deriveRowType();</span><br><span class="line">            <span class="keyword">assert</span> rowType != <span class="literal">null</span> : <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rowType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(RelOptPlanner planner)</span> &#123;</span><br><span class="line">        Util.discard(planner);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;RelNode&gt; <span class="title function_">getInputs</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">estimateRowCount</span><span class="params">(RelMetadataQuery mq)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@Nullable</span> RelOptCost <span class="title function_">computeSelfCost</span><span class="params">(RelOptPlanner planner, RelMetadataQuery mq)</span> &#123;</span><br><span class="line">        <span class="comment">// by default, assume cost is proportional to number of rows</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">rowCount</span> <span class="operator">=</span> mq.getRowCount(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span> planner.getCostFactory().makeCost(rowCount, rowCount, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>traitSet</code> ç”¨äºè®°å½•å½“å‰ RelNode çš„ç‰©ç†ç‰¹å¾ <code>RelTrait</code>ï¼ŒCalcite ä¸­æä¾›äº† <code>Convention</code> ã€<code>RelCollation</code> å’Œ <code>RelDistribution</code> 3 ç§ç‰©ç†ç‰¹å¾ï¼Œåˆ†åˆ«è¡¨ç¤ºè°ƒç”¨çº¦å®šï¼ˆä»£è¡¨æŸä¸€ç§æ•°æ®æºï¼Œä¸åŒæ•°æ®æºä¸Šçš„ç®—å­éœ€è¦ä½¿ç”¨ Converter è¿›è¡Œè½¬æ¢ï¼‰ã€æ’åºå’Œåˆ†å¸ƒç‰¹å¾ï¼›</li><li><code>getConvention</code> æ–¹æ³•æ˜¯ç”¨äºè·å–å½“å‰ RelNode ä¸­è®°å½•çš„ Convention ç‰¹å¾ï¼›</li><li><code>getRowType</code> ç”¨äºè·å–å½“å‰æ•°æ®è¡Œçš„ç±»å‹ä¿¡æ¯ï¼ŒRelNode æ ¹èŠ‚ç‚¹çš„ RelDataType å¯ä»¥ä»£è¡¨æœ€ç»ˆæŸ¥è¯¢ç»“æœçš„è¡Œè®°å½•ç±»å‹ä¿¡æ¯ï¼›</li><li><code>getInputs</code> ç”¨äºè·å–å½“å‰ RelNode çš„å­èŠ‚ç‚¹ï¼ŒRelNode é€šè¿‡ inputs ç»„ç»‡æˆä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼›</li><li><code>estimateRowCount</code> æ–¹æ³•ç”¨äºä¼°è®¡å½“å‰ RelNode è¿”å›çš„è¡Œæ•°ï¼Œè¡Œæ•°ä¿¡æ¯å¯ä»¥ç”¨æ¥è®¡ç®— RelNode çš„ä»£ä»· Costï¼›</li><li><code>computeSelfCost</code> æ–¹æ³•ç”¨äºè®¡ç®—å½“å‰ RelNode çš„ä»£ä»· Costï¼›</li><li><code>register</code> æ–¹æ³•ç”¨äºæ³¨å†Œå½“å‰ RelNode ç‰¹æœ‰çš„ä¼˜åŒ–è§„åˆ™ï¼Œä¾‹å¦‚ï¼š<code>InnodbTableScan</code> å®ç°äº† register æ–¹æ³•ï¼Œæ³¨å†Œäº†å’Œ <code>InnodbTableScan</code> è¿™ç±» RelNode ç›¸å…³çš„ä¼˜åŒ–è§„åˆ™ã€‚</li></ul><h4 id="relset"><a class="markdownIt-Anchor" href="#relset"></a> RelSet</h4><p>Calcite å¯¹ <code>RelSet</code> çš„å®šä¹‰ä¸º <code>A RelSet is an equivalence-set of expressions</code>ï¼Œå³ä¸€ç»„ç­‰ä»·çš„å…³ç³»ä»£æ•°é›†åˆï¼ŒåŒä¸€ä¸ª RelSet ä¸­çš„å…³ç³»ä»£æ•°å…·æœ‰ç›¸åŒçš„è°ƒç”¨è§„çº¦ï¼ˆCalling Conventionï¼‰ã€‚RelSet ç±»ä¸­çš„æ ¸å¿ƒå±æ€§å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RelSet</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ç­‰ä»·çš„å…³ç³»ä»£æ•°é›†åˆ</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;RelNode&gt; rels = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// ç‰©ç†å±æ€§ç›¸åŒçš„ç­‰ä»·å…³ç³»ä»£æ•°é›†åˆ</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;RelSubset&gt; subsets = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">  	<span class="comment">// ç­‰ä»·çš„ RelSet</span></span><br><span class="line">    <span class="meta">@MonotonicNonNull</span> RelSet equivalentSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>RelSet ç±»æ˜¯ç­‰ä»·å…³ç³»ä»£æ•°çš„é›†åˆç±»ï¼Œä¸æ˜¯ RelNodeï¼›</li><li>ç­‰ä»·çš„å…³ç³»ä»£æ•°é›†åˆå­˜å‚¨åœ¨ <code>rels</code> ä¸­ï¼Œä»–ä»¬å…·æœ‰ç›¸åŒçš„è°ƒç”¨è§„çº¦ï¼Œä½†æ˜¯å…¶ä»–ç‰©ç†å±æ€§å¯èƒ½ä¸ç›¸åŒï¼Œä¾‹å¦‚ï¼šRelCollation å’Œ RelDistributionï¼›</li><li>ç‰©ç†å±æ€§ç›¸åŒçš„ç­‰ä»·å…³ç³»ä»£æ•°é›†åˆä¼šå­˜å‚¨åœ¨ <code>subsets</code> ä¸­ï¼Œ<code>RelSubset</code> å¯¹è±¡ä¼šæ ¹æ®ç‰©ç†å±æ€§å¯¹å…³ç³»ä»£æ•°è¿›è¡Œå½’ç±»ï¼Œç›¸åŒç‰©ç†å±æ€§çš„å…³ç³»ä»£æ•°ä¼šå­˜å‚¨åœ¨åŒä¸€ä¸ª RelSubset ä¸­ã€‚</li></ul><h4 id="relsubset"><a class="markdownIt-Anchor" href="#relsubset"></a> RelSubset</h4><p>Caclite å¯¹ <code>RelSubset</code> çš„å®šä¹‰ä¸º <code>Subset of an equivalence class where all relational expressions have the same physical properties.</code>ï¼Œå³ RelSet ç­‰ä»·ç±»çš„å­é›†ï¼Œå®ƒä¼šæŒ‰ç…§ç‰©ç†å±æ€§å°†å…³ç³»ä»£æ•° RelNode è¿›è¡Œåˆ†ç±»ï¼Œç‰©ç†å±æ€§ç›¸åŒçš„ RelNode ä¼šåœ¨åŒä¸€ä¸ª RelSubSet ä¸­ã€‚RelSubset ç±»ä¸­çš„æ ¸å¿ƒå±æ€§å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RelSubset</span> <span class="keyword">extends</span> <span class="title class_">AbstractRelNode</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cost of best known plan (it may have improved since).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RelOptCost bestCost;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The set this subset belongs to.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> RelSet set;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Best known plan.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span> RelNode best;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the rel nodes in this rel subset.  All rels must have the same</span></span><br><span class="line"><span class="comment">     * traits and are logically equivalent.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> all the rels in the subset</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Iterable&lt;RelNode&gt; <span class="title function_">getRels</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> () -&gt; Linq4j.asEnumerable(set.rels).where(v1 -&gt; v1.getTraitSet().satisfies(traitSet)).iterator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>RelSubset å®ç°äº† <code>AbstractRelNode</code>ï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å…³ç³»ä»£æ•° RelNodeï¼›</li><li>RelSubSet ä¸­è®°å½•äº†<strong>ç‰©ç†å±æ€§ç›¸åŒçš„å…³ç³»ä»£æ•° RelNode</strong>ï¼Œå¹¶ä¸”è¿™äº›å…³ç³»ä»£æ•°ä¸æ˜¯ç›´æ¥å­˜å‚¨åœ¨ RelSubSet ä¸­ï¼Œè€Œæ˜¯é€šè¿‡å¼•ç”¨ RelSet å¯¹è±¡å¹¶é€šè¿‡ traitSet è¿‡æ»¤å¾—åˆ°ï¼›</li><li>RelSubSet ä¼šè®¡ç®—å†…éƒ¨å…³ç³»ä»£æ•°çš„<strong>æœ€ä¼˜ä»£ä»· bestCost</strong>ï¼Œå¹¶è®°å½•å½“å‰<strong>æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ best</strong>ï¼ŒbestCost å’Œ best ä¼šéšç€ä¼˜åŒ–çš„æ‰§è¡Œè€Œä¸æ–­æ›´æ–°ã€‚</li></ul><h3 id="å¤„ç†æµç¨‹"><a class="markdownIt-Anchor" href="#å¤„ç†æµç¨‹"></a> å¤„ç†æµç¨‹</h3><p>ä»‹ç»å®Œ VolcanoPlanner ä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼Œè®©æˆ‘ä»¬å†æ¥äº†è§£ä¸‹ Calcite ä¼˜åŒ–å™¨çš„å¤„ç†æµç¨‹ï¼ŒJulain åœ¨ 2016 å¹´ä¸¾åŠçš„ Hadoop Summit å¤§ä¼šä¸Šåˆ†äº«äº† <a target="_blank" rel="noopener" href="https://calcite.apache.org/community/#cost-based-query-optimization-in-apache-phoenix-using-apache-calcite">Cost-based Query Optimization in Apache Phoenix using Apache Calcite</a>ï¼Œå…¶ä¸­ä»‹ç»äº† Caclite ä¼˜åŒ–å™¨çš„å¤„ç†æµç¨‹ï¼Œè™½ç„¶å·²ç»è¿‡å»äº†å¾ˆä¹…ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä½œä¸º VolcanoPlanner çš„å‚è€ƒèµ„æ–™ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1702118316.png" title="Calcite Volcano Planner å¤„ç†æµç¨‹"><p>ä¸Šå›¾å±•ç¤ºäº† VolcanoPlanner çš„å¤„ç†æµç¨‹ï¼Œå¯ä»¥çœ‹åˆ° SQL è¯­å¥è¢«è§£æä¸º AST åï¼Œé€šè¿‡ SqlToRelConverter å°† AST è½¬æ¢ä¸º RelNode å’Œ RexNodeã€‚RelNode Tree å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„é€»è¾‘æ‰§è¡Œè®¡åˆ’ã€‚æ–¹æ¡†å†…æ˜¯ VolcanoPlanner çš„æ ¸å¿ƒæµç¨‹ï¼Œä¸»è¦åŒ…å«äº†å¦‚ä¸‹å‡ ä¸ªå…³é”®æ­¥éª¤ï¼š</p><ul><li><p>å°†åŒ¹é…çš„è§„åˆ™ Rule æ·»åŠ åˆ° <code>RuleQueue</code> ä¸­ï¼ŒCalcite æä¾›äº† <code>IterativeRuleQueue</code> å’Œ <code>TopDownRuleQueue</code>ï¼›</p></li><li><p>åº”ç”¨åŒ¹é…çš„è§„åˆ™ Ruleï¼Œå¯¹ RelNode Tree è¿›è¡Œè½¬æ¢ï¼›</p></li><li><p>è¿›è¡Œç›¸åº”çš„è¿­ä»£ï¼Œç›´åˆ° RuleQueue ä¸­çš„ Rule å…¨éƒ¨è¿­ä»£å®Œæˆæˆ–è€…ä»£ä»· Cost ä¸å†å˜åŒ–ï¼›</p></li><li><p>åŸºäº RelNode çš„ä»£ä»·å’Œæ·±åº¦åŒ¹é… <code>Importance</code>ï¼ŒImportance æè¿°äº† RuleMatch çš„é‡è¦ç¨‹åº¦ï¼ŒImportance å¤§çš„ä¼˜å…ˆå¤„ç†ï¼Œæ¯ä¸€è½®è¿­ä»£éƒ½ä¼šå®æ—¶è°ƒæ•´ã€‚</p></li></ul><p>é™¤äº†ä»¥ä¸Šçš„å‡ ä¸ªå…³é”®æ­¥éª¤å¤–ï¼Œå›¾ä¸­è¿˜æè¿°äº† VolcanoPlanner ä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼š<code>è®¡åˆ’æ ‘ï¼ˆPlan Treeï¼‰</code>ã€<code>ä¼˜åŒ–è§„åˆ™ï¼ˆRulesï¼‰</code>ã€<code>ä»£ä»·æ¨¡å‹ï¼ˆCost Modelï¼‰</code> å’Œ <code>å…ƒæ•°æ®æä¾›å™¨ï¼ˆMetadata Providersï¼‰</code>ã€‚è®¡åˆ’æ ‘é€šè¿‡å‰æ–‡ä»‹ç»çš„ RelSet å’Œ RelSubset ç»´æŠ¤äº†ä¼˜åŒ–è¿‡ç¨‹ä¸­æ‰€éœ€çš„æ•°æ®ç»“æ„ï¼Œä¼˜åŒ–è§„åˆ™ç”¨äºå¯¹ RelNode è¿›è¡Œä¼˜åŒ–ï¼Œä»¥ç”Ÿæˆç­‰ä»·ä¸”æ›´ä¼˜çš„å…³ç³»ä»£æ•°ï¼Œä»£ä»·æ¨¡å‹ç”¨äºè®¡ç®— RelNode çš„ä»£ä»·å’Œç´¯ç§¯ä»£ä»·ï¼Œå…ƒæ•°æ®æä¾›å™¨åˆ™æä¾›äº†ä»£ä»·è®¡ç®—æ‰€éœ€çš„ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šFilter é€‰æ‹©æ€§ã€Join é€‰æ‹©æ€§ç­‰ã€‚è¿™äº›ç»„æˆéƒ¨åˆ†åœ¨ VolcanoPlanner ä¸­ç›¸äº’é…åˆï¼Œå…±åŒå®Œæˆäº†ä¼˜åŒ–è¿‡ç¨‹ï¼Œåœ¨ä¸‹é¢çš„æºç æ¢ç§˜éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†ä¸€ä¸€è¿›è¡Œç ”ç©¶å­¦ä¹ ã€‚</p><h2 id="volcanoplanner-æºç æ¢ç§˜"><a class="markdownIt-Anchor" href="#volcanoplanner-æºç æ¢ç§˜"></a> VolcanoPlanner æºç æ¢ç§˜</h2><p>ä»‹ç»å®Œ VolcanoPlanner ä¸­çš„æ ¸å¿ƒæ¦‚å¿µå’ŒåŸºç¡€æµç¨‹ï¼Œæƒ³å¿…å¤§å®¶å¯¹ VolcanoPlanner å·²ç»æœ‰äº†åˆæ­¥åœ°è®¤è¯†ï¼Œä½†æ˜¯æƒ³è¦å½»åº•ç†è§£ VolcanoPlannerï¼Œè¿˜éœ€è¦ç»“åˆä¸€äº›æ¡ˆä¾‹ï¼Œå¯¹æºç è¿›è¡Œæ·±å…¥å­¦ä¹ ç†è§£ï¼Œæ‰èƒ½çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚æœ¬å°èŠ‚å°†ä»¥ <code>CsvTest#testSelectSingleProjectGz</code> æµ‹è¯• Case ä¸ºä¾‹ï¼Œå’Œå¤§å®¶ä¸€èµ·æ¢ç§˜ VolcanoPlanner æºç ã€‚å¦‚ä¸‹å±•ç¤ºäº†æµ‹è¯• Caseï¼Œä½¿ç”¨äº† <code>smart</code> æ¨¡å‹ï¼Œè¡¨ç¤ºä½¿ç”¨ <code>TranslatableTable</code> è¿›è¡Œä¼˜åŒ–å¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSelectSingleProjectGz</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    sql(<span class="string">&quot;smart&quot;</span>, <span class="string">&quot;select * from EMPS where name = &#x27;Alice&#x27;&quot;</span>).ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="volcanoplanner-åˆå§‹åŒ–"><a class="markdownIt-Anchor" href="#volcanoplanner-åˆå§‹åŒ–"></a> VolcanoPlanner åˆå§‹åŒ–</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥è·Ÿè¸ªä¸‹ VolcanoPlanner åˆå§‹åŒ–æµç¨‹ï¼Œçœ‹ä¸‹åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œä¼˜åŒ–å™¨éƒ½åšäº†å“ªäº›å‡†å¤‡å·¥ä½œã€‚æ‰§è¡Œç¤ºä¾‹ç¨‹åºï¼Œåœ¨ <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/967bb5acc5448bc8d6ee9b9f5fa3c5f0d71405c2/core/src/main/java/org/apache/calcite/prepare/CalcitePrepareImpl.java#L438">CalcitePrepareImpl#createPlanner</a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹åˆå§‹åŒ–é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a query planner and initializes it with a default set of rules.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> RelOptPlanner <span class="title function_">createPlanner</span><span class="params">(<span class="keyword">final</span> CalcitePrepare.Context prepareContext, <span class="meta">@Nullable</span> Context externalContext, <span class="meta">@Nullable</span> RelOptCostFactory costFactory)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (externalContext == <span class="literal">null</span>) &#123;</span><br><span class="line">        externalContext = Contexts.of(prepareContext.config());</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// åˆå§‹åŒ– VolcanoPlannerï¼Œå…è®¸ç”¨æˆ·ä¼ å…¥ä»£ä»·å·¥å‚ costFactoryï¼Œé»˜è®¤ä½¿ç”¨ VolcanoCost.FACTORY</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">VolcanoPlanner</span> <span class="variable">planner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VolcanoPlanner</span>(costFactory, externalContext);</span><br><span class="line">  	<span class="comment">// è®¾ç½®æ ‡é‡è¡¨è¾¾å¼ scalar expressions çš„æ‰§è¡Œå™¨</span></span><br><span class="line">    planner.setExecutor(<span class="keyword">new</span> <span class="title class_">RexExecutorImpl</span>(DataContexts.EMPTY));</span><br><span class="line">    planner.addRelTraitDef(ConventionTraitDef.INSTANCE);</span><br><span class="line">    <span class="keyword">if</span> (CalciteSystemProperty.ENABLE_COLLATION_TRAIT.value()) &#123;</span><br><span class="line">        planner.addRelTraitDef(RelCollationTraitDef.INSTANCE);</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// æ˜¯å¦å¼€å¯è‡ªé¡¶å‘ä¸‹ä¼˜åŒ–ï¼Œä¼šæ ¹æ®è¯¥å‚æ•°æ˜¯å¦å¼€å¯ï¼Œåˆå§‹åŒ–ä¸åŒç±»å‹çš„ RuleDriver å’Œ RuleQueue</span></span><br><span class="line">    planner.setTopDownOpt(prepareContext.config().topDownOpt());</span><br><span class="line">  	<span class="comment">// æ³¨å†Œé»˜è®¤ä¼˜åŒ–è§„åˆ™</span></span><br><span class="line">    RelOptUtil.registerDefaultRules(planner, prepareContext.config().materializationsEnabled(), enableBindable);</span><br><span class="line">    <span class="keyword">return</span> planner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»º VolcanoPlanner å¯¹è±¡æ—¶ï¼Œå…è®¸ç”¨æˆ·ä¼ å…¥ <code>costFactory</code> ä»£ä»·å·¥å‚ï¼Œé»˜è®¤ä¼šä½¿ç”¨ <code>VolcanoCost.FACTORY</code> å·¥å‚ç±»ã€‚åˆå§‹åŒ–ä¼˜åŒ–å™¨æ—¶ï¼ŒåŒæ—¶ä¼šè®¾ç½®æ ‡é‡è¡¨è¾¾å¼ï¼ˆ<code>scalar expressions</code>ï¼‰æ‰§è¡Œå™¨ï¼Œè´Ÿè´£è®¡ç®—è¡¨è¾¾å¼çš„ç»“æœã€‚<code>setTopDownOpt</code> æ–¹æ³•ä¼šæ ¹æ®é…ç½®åˆ¤æ–­æ˜¯å¦å¼€å¯è‡ªé¡¶å‘ä¸‹ä¼˜åŒ–ï¼Œè¯¥é…ç½®é»˜è®¤ä¸º falseï¼ŒåŒæ—¶ä¼šæ ¹æ®è¯¥å‚æ•°åˆå§‹åŒ– <code>RuleDriver</code> å’Œ <code>RuleQueue</code>ï¼Œæœ¬æ–‡å…ˆå…³æ³¨ Calcite é»˜è®¤çš„ <code>IterativeRuleDriver</code> å’Œ <code>IterativeRuleQueue</code>ï¼Œåç»­æ–‡ç« ä¼šå†æ¢è®¨ <code>Volcano &amp; Cascades</code> è®ºæ–‡ä¸­æå‡ºçš„ <code>TopDownRuleDriver</code> å’Œ <code>TopDownRuleQueue</code>ã€‚</p><p><code>RelOptUtil.registerDefaultRules</code> æ–¹æ³•ä¼šæ³¨å†Œé»˜è®¤çš„ä¼˜åŒ–è§„åˆ™ï¼Œå†…éƒ¨è°ƒç”¨ <code>planner.addRule</code> æ–¹æ³•ï¼Œå°†è§„åˆ™è®°å½•åœ¨ä¼˜åŒ–å™¨çˆ¶ç±» <code>AbstractRelOptPlanner</code> çš„ <code>mapDescToRule</code> å±æ€§ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Experimental</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerDefaultRules</span><span class="params">(RelOptPlanner planner, <span class="type">boolean</span> enableMaterializations, <span class="type">boolean</span> enableBindable)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (CalciteSystemProperty.ENABLE_COLLATION_TRAIT.value()) &#123;</span><br><span class="line">        registerAbstractRelationalRules(planner);</span><br><span class="line">    &#125;</span><br><span class="line">    registerAbstractRules(planner);</span><br><span class="line">    registerBaseRules(planner);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (enableMaterializations) &#123;</span><br><span class="line">        registerMaterializationRules(planner);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (enableBindable) &#123;</span><br><span class="line">        <span class="keyword">for</span> (RelOptRule rule : Bindables.RULES) &#123;</span><br><span class="line">            planner.addRule(rule);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    planner.addRule(Bindables.BINDABLE_TABLE_SCAN_RULE);</span><br><span class="line">    planner.addRule(CoreRules.PROJECT_TABLE_SCAN);</span><br><span class="line">    planner.addRule(CoreRules.PROJECT_INTERPRETER_TABLE_SCAN);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (CalciteSystemProperty.ENABLE_ENUMERABLE.value()) &#123;</span><br><span class="line">        registerEnumerableRules(planner);</span><br><span class="line">        planner.addRule(EnumerableRules.TO_INTERPRETER);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (enableBindable &amp;&amp; CalciteSystemProperty.ENABLE_ENUMERABLE.value()) &#123;</span><br><span class="line">        planner.addRule(EnumerableRules.TO_BINDABLE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (CalciteSystemProperty.ENABLE_STREAM.value()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (RelOptRule rule : StreamRules.RULES) &#123;</span><br><span class="line">            planner.addRule(rule);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    planner.addRule(CoreRules.FILTER_REDUCE_EXPRESSIONS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Calcite JDBC é»˜è®¤æ³¨å†Œäº† 101 ä¸ªä¼˜åŒ–è§„åˆ™ï¼Œè¿™äº›ä¼˜åŒ–è§„åˆ™çš„ä½œç”¨ï¼Œæˆ‘ä»¬åç»­æ–‡ç« ä¼šè¿›è¡Œåˆ†ç±»å­¦ä¹ ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­å¯ä»¥é€‰æ‹©è‡ªå·±éœ€è¦çš„ä¼˜åŒ–è§„åˆ™å»ä½¿ç”¨ã€‚åˆ°è¿™é‡Œï¼ŒCalicte å°±å®Œæˆäº† VolcanoPlanner çš„ä¼˜åŒ–ï¼Œå¹¶é»˜è®¤æ³¨å†Œäº† 101 ä¸ªä¼˜åŒ–è§„åˆ™ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1702769869.png" title="Calcite JDBC é»˜è®¤æ³¨å†Œçš„è§„åˆ™"><h3 id="setroot-æµç¨‹"><a class="markdownIt-Anchor" href="#setroot-æµç¨‹"></a> setRoot æµç¨‹</h3><p>VolcanoPlanner åˆå§‹åŒ–å®Œæˆåï¼Œåˆä¼šè°ƒç”¨ SqlParser è¿›è¡Œ SQL è§£æï¼Œå¹¶ä½¿ç”¨ SqlToRelConverter å°† AST è½¬æ¢ä¸º RelNode é€»è¾‘æ‰§è¡Œè®¡åˆ’ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„ Logical Planï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LogicalProject(EMPNO=[$0], NAME=[$1], DEPTNO=[$2], GENDER=[$3], CITY=[$4], EMPID=[$5], AGE=[$6], SLACKER=[$7], MANAGER=[$8], JOINEDAT=[$9])</span><br><span class="line">  LogicalFilter(condition=[=($1, &#x27;Alice&#x27;)])</span><br><span class="line">    CsvTableScan(table=[[SALES, EMPS]], fields=[[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]])</span><br></pre></td></tr></table></figure><p>Calcite JDBC æµç¨‹ä¸­å°†ä¼˜åŒ–å™¨çš„è°ƒç”¨å°è£…åœ¨äº† <code>Program</code> ä¸­ï¼Œå¦‚ä¸‹ç¤ºä¾‹å±•ç¤ºäº†è°ƒç”¨é€»è¾‘ï¼Œæœ€æ ¸å¿ƒçš„æ–¹å¼æ˜¯ <code>setRoot</code> å’Œ <code>findBestExp</code>ï¼Œæœ¬å°èŠ‚å…ˆå…³æ³¨ <code>setRoot</code> æ–¹æ³•çš„å®ç°é€»è¾‘ï¼Œçœ‹çœ‹ç¤ºä¾‹ä¸­çš„ä¸¤æ¬¡ setRoot éƒ½è¿›è¡Œäº†å“ªäº›å¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the standard program with user metadata provider.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Program <span class="title function_">standard</span><span class="params">(RelMetadataProvider metadataProvider)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Program</span> <span class="variable">program1</span> <span class="operator">=</span> (planner, rel, requiredOutputTraits, materializations, lattices) -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (RelOptMaterialization materialization : materializations) &#123;</span><br><span class="line">            planner.addMaterialization(materialization);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (RelOptLattice lattice : lattices) &#123;</span><br><span class="line">            planner.addLattice(lattice);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// setRoot è®¾ç½® RelSubset æ ¹èŠ‚ç‚¹        </span></span><br><span class="line">        planner.setRoot(rel);</span><br><span class="line">        <span class="comment">// å˜æ¢ trait å±æ€§ï¼Œå°† Convention NONE å˜æ¢ä¸º ENUMERABLE</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">RelNode</span> <span class="variable">rootRel2</span> <span class="operator">=</span> rel.getTraitSet().equals(requiredOutputTraits)</span><br><span class="line">                ? rel : planner.changeTraits(rel, requiredOutputTraits);</span><br><span class="line">        <span class="keyword">assert</span> rootRel2 != <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// setRoot è®¾ç½® RelSubset æ ¹èŠ‚ç‚¹</span></span><br><span class="line">        planner.setRoot(rootRel2);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">RelOptPlanner</span> <span class="variable">planner2</span> <span class="operator">=</span> planner.chooseDelegate();</span><br><span class="line">        <span class="comment">// æŸ¥æ‰¾æœ€ä½³æ‰§è¡Œè®¡åˆ’</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">RelNode</span> <span class="variable">rootRel3</span> <span class="operator">=</span> planner2.findBestExp();</span><br><span class="line">        <span class="keyword">assert</span> rootRel3 != <span class="literal">null</span> : <span class="string">&quot;could not implement exp&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> rootRel3;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> sequence(subQuery(metadataProvider), <span class="keyword">new</span> <span class="title class_">Programs</span>.DecorrelateProgram(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Programs</span>.TrimFieldsProgram(), program1, calc(metadataProvider));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç¬¬ä¸€è½®-setroot"><a class="markdownIt-Anchor" href="#ç¬¬ä¸€è½®-setroot"></a> ç¬¬ä¸€è½® setRoot</h4><p>ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>setRoot</code> æ–¹æ³•ï¼Œç›´æ¥ä¼ é€’äº†åŸå§‹çš„ RelNodeï¼Œæœªè¿›è¡Œ Trait å˜æ¢ï¼Œ<code>setRoot</code> æ–¹æ³•è´Ÿè´£å°† RelNode Tree è½¬æ¢ä¸º RelSubset Treeï¼Œå¹¶è®¾ç½®åˆ° VolcanoPlanner ä¸­çš„ <code>root</code> å±æ€§ä¸­ã€‚å¦‚ä¸‹æ˜¯ <code>setRoot</code> çš„ä»£ç å®ç°ï¼Œ<code>registerImpl</code> æ˜¯å…¶æ ¸å¿ƒé€»è¾‘ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RelSubset æ ¹èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">protected</span> <span class="meta">@MonotonicNonNull</span> RelSubset root;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRoot</span><span class="params">(RelNode rel)</span> &#123;</span><br><span class="line">  	<span class="comment">// æ ¸å¿ƒé€»è¾‘</span></span><br><span class="line">    <span class="built_in">this</span>.root = registerImpl(rel, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.originalRoot == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.originalRoot = rel;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    rootConvention = <span class="built_in">this</span>.root.getConvention();</span><br><span class="line">    ensureRootConverters();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>registerImpl</code> æ–¹æ³•ç”¨äºæ³¨å†Œæ–°çš„å…³ç³»ä»£æ•°è¡¨è¾¾å¼ï¼Œå¹¶å°†åŒ¹é…çš„è§„åˆ™åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚å¦‚æœ <code>set</code>ï¼ˆç­‰ä»·é›†åˆï¼‰ å‚æ•°ä¸ä¸º nullï¼Œåˆ™å°†å½“å‰è¡¨è¾¾å¼åŠ å…¥åˆ°ç­‰ä»·é›†åˆä¸­ï¼Œå¦‚æœå·²ç»æ³¨å†Œäº†ç›¸åŒçš„è¡¨è¾¾å¼ï¼Œåˆ™æ— éœ€å°†å…¶åŠ å…¥åˆ°ç­‰ä»·é›†åˆä»¥åŠé˜Ÿåˆ—ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RelSubset <span class="title function_">registerImpl</span><span class="params">(RelNode rel, <span class="meta">@Nullable</span> RelSet set)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ rel å·²ç»æ˜¯ RelSubsetï¼Œåˆ™ç›´æ¥è°ƒç”¨ registerSubset æ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">if</span> (rel <span class="keyword">instanceof</span> RelSubset) &#123;</span><br><span class="line">        <span class="keyword">return</span> registerSubset(set, (RelSubset) rel);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Ensure that its sub-expressions are registered.</span></span><br><span class="line">    <span class="comment">// ç›‘å¬è¯¥è¡¨è¾¾å¼å°†è¦æ³¨å†Œçš„é€šçŸ¥</span></span><br><span class="line">    rel = rel.onRegister(<span class="built_in">this</span>);</span><br><span class="line">  	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="onregister"><a class="markdownIt-Anchor" href="#onregister"></a> onRegister</h5><p>ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>setRoot</code> æ–¹æ³•æ—¶ï¼Œ<code>rel</code> å‚æ•°ä¸º <code>LogicalProject</code>ï¼Œå› æ­¤ä¼šè°ƒç”¨åç»­é€»è¾‘è¿›è¡Œå¤„ç†ï¼Œ<code>onRegister</code> æ–¹æ³•ä¼šç¡®ä¿ RelNode çš„å­èŠ‚ç‚¹ä¹Ÿæ³¨å†Œç”Ÿæˆ RelSubsetã€‚<code>AbstractRelNode#onRegister</code> æ–¹æ³•å®ç°é€»è¾‘å¦‚ä¸‹ï¼Œ<code>getInputs</code> æ–¹æ³•ä¼šè·å–å½“å‰ RelNode çš„å­èŠ‚ç‚¹ï¼ˆè¿”å› LogicalFilter å­èŠ‚ç‚¹ï¼‰ï¼Œå¹¶è°ƒç”¨ <code>VolcanoPlanner#ensureRegistered</code> æ–¹æ³•ï¼Œç¡®ä¿æ‰€æœ‰çš„å­èŠ‚ç‚¹éƒ½ä¼šè¿›è¡Œæ³¨å†Œï¼Œç„¶åé‡æ–° copy ç”Ÿæˆæ–°çš„ RelNodeã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RelNode <span class="title function_">onRegister</span><span class="params">(RelOptPlanner planner)</span> &#123;</span><br><span class="line">  	<span class="comment">// è·å–å­èŠ‚ç‚¹</span></span><br><span class="line">    List&lt;RelNode&gt; oldInputs = getInputs();</span><br><span class="line">    List&lt;RelNode&gt; inputs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(oldInputs.size());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> RelNode input : oldInputs) &#123;</span><br><span class="line">      	<span class="comment">// è°ƒç”¨ VolcanoPlanner#ensureRegistered æ³¨å†Œå­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">RelNode</span> <span class="variable">e</span> <span class="operator">=</span> planner.ensureRegistered(input, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">assert</span> e == input || RelOptUtil.equal(<span class="string">&quot;rowtype of rel before registration&quot;</span>, input.getRowType(), <span class="string">&quot;rowtype of rel after registration&quot;</span>, e.getRowType(), Litmus.THROW);</span><br><span class="line">        inputs.add(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">RelNode</span> <span class="variable">r</span> <span class="operator">=</span> <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (!Util.equalShallow(oldInputs, inputs)) &#123;</span><br><span class="line">      	<span class="comment">// å¤åˆ¶ç”Ÿæˆæ–°çš„ RelNode</span></span><br><span class="line">        r = copy(getTraitSet(), inputs);</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// é‡æ–°è®¡ç®— Digest æ‘˜è¦ä¿¡æ¯ï¼Œæ˜¯ RelNode çš„å”¯ä¸€æ ‡è¯†</span></span><br><span class="line">    r.recomputeDigest();</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>VolcanoPlanner#ensureRegistered</code> æ–¹æ³•ä¼šå¯¹å½“å‰å­èŠ‚ç‚¹ LogicalFilter è¿›è¡Œæ³¨å†Œï¼Œå…ˆè°ƒç”¨ getSubset ä» <code>mapRel2Subset</code> è·å–å½“å‰ RelNode å¯¹åº”çš„ RelSubsetï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è°ƒç”¨ <code>VolcanoPlanner#register</code> æ–¹æ³•è¿›è¡Œæ³¨å†Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»´æŠ¤å·²æ³¨å†Œçš„ RelNode å’Œ RelSubset æ˜ å°„å…³ç³»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> IdentityHashMap&lt;RelNode, RelSubset&gt; mapRel2Subset = <span class="keyword">new</span> <span class="title class_">IdentityHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RelSubset <span class="title function_">ensureRegistered</span><span class="params">(RelNode rel, <span class="meta">@Nullable</span> RelNode equivRel)</span> &#123;</span><br><span class="line">    RelSubset result;</span><br><span class="line">    <span class="comment">// ä» mapRel2Subset ä¸­è·å– RelSubset</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">RelSubset</span> <span class="variable">subset</span> <span class="operator">=</span> getSubset(rel);</span><br><span class="line">    <span class="keyword">if</span> (subset != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (equivRel != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">RelSubset</span> <span class="variable">equivSubset</span> <span class="operator">=</span> getSubsetNonNull(equivRel);</span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰èŠ‚ç‚¹çš„ç­‰ä»·é›†åˆå’Œå·²çŸ¥çš„ç­‰ä»·é›†åˆä¸åŒï¼Œåˆ™è¿›è¡Œåˆå¹¶</span></span><br><span class="line">            <span class="keyword">if</span> (subset.set != equivSubset.set) &#123;</span><br><span class="line">                merge(equivSubset.set, subset.set);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        result = canonize(subset);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ RelSubset ä¸ºç©ºåˆ™è¿›è¡Œæ³¨å†Œ</span></span><br><span class="line">        result = register(rel, equivRel);</span><br><span class="line">    &#125;</span><br><span class="line">		...</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>VolcanoPlanner#register</code> æ–¹æ³•ä¼šè°ƒç”¨ <code>VolcanoPlanner#registerImpl</code> å¯¹ LogicalFilter èŠ‚ç‚¹è¿›è¡Œæ³¨å†Œï¼Œç„¶åé€»è¾‘åˆé‡æ–°å›åˆ°äº† <code>VolcanoPlanner#registerImpl</code> æ–¹æ³•ã€‚<code>onRegister</code> æ–¹æ³•ä¼šå¯¹ LogicalFilter èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ <code>CsvTableScan</code> è¿›è¡Œæ³¨å†Œï¼Œç”±äº CsvTableScan èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œå› æ­¤åœ¨ onRegister æ–¹æ³•å¤„ç†æ—¶ä¼šä¸­æ–­é€’å½’ï¼Œæ­¤å¤–ï¼Œç”±äºæ²¡æœ‰å­èŠ‚ç‚¹ï¼ŒCsvTableScan ä¼šè¿”å›å½“å‰ RelNodeã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RelNode <span class="title function_">onRegister</span><span class="params">(RelOptPlanner planner)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å­èŠ‚ç‚¹</span></span><br><span class="line">    List&lt;RelNode&gt; oldInputs = getInputs();</span><br><span class="line">    List&lt;RelNode&gt; inputs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(oldInputs.size());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> RelNode input : oldInputs) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">RelNode</span> <span class="variable">r</span> <span class="operator">=</span> <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (!Util.equalShallow(oldInputs, inputs)) &#123;</span><br><span class="line">        <span class="comment">// å¤åˆ¶ç”Ÿæˆæ–°çš„ RelNode</span></span><br><span class="line">        r = copy(getTraitSet(), inputs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é‡æ–°è®¡ç®— Digest æ‘˜è¦ä¿¡æ¯ï¼Œæ˜¯ RelNode çš„å”¯ä¸€æ ‡è¯†</span></span><br><span class="line">    r.recomputeDigest();</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åä¼˜åŒ–å™¨ä¼šä»åŒç«¯é˜Ÿåˆ— ruleCallStack ä¸­è·å–é¦–ä¸ªå…ƒç´ ï¼Œå¹¶è®°å½•åˆ° <code>provenanceMap</code> ä¸­ï¼ŒprovenanceMap ç”¨äºè®°å½• RelNode çš„æ¥æºï¼ŒåŒ…æ‹¬ <code>UnknownProvenance</code>ã€<code>DirectProvenance</code> å’Œ <code>RuleProvenance</code>ã€‚å¦‚æœå½“å‰å‚æ•°çš„ RelSet ä¸º nullï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ª RelSet å¹¶æ·»åŠ åˆ° <code>allSets</code> ä¸­ã€‚<code>registerClass</code> æ–¹æ³•å…è®¸ RelNode æ³¨å†Œè‡ªå·±ç‰¹æœ‰çš„ä¼˜åŒ–è§„åˆ™ï¼Œæœ¬æ¡ˆä¾‹ä¸­ <code>CsvTableScan</code> æ³¨å†Œäº† <code>CsvRules.PROJECT_SCAN</code> è§„åˆ™ã€‚å®Œæˆè§„åˆ™æ³¨å†Œåï¼Œä¼˜åŒ–å™¨ä¼šè°ƒç”¨ addRelToSet å’Œ fireRules æ–¹æ³•ï¼Œè¿™éƒ¨åˆ†æ˜¯ VolcanoPlanner çš„æ ¸å¿ƒé€»è¾‘ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä¸€èµ·æ·±å…¥åˆ†æä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RelSubset <span class="title function_">registerImpl</span><span class="params">(RelNode rel, <span class="meta">@Nullable</span> RelSet set)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (rel <span class="keyword">instanceof</span> RelSubset) &#123;</span><br><span class="line">        <span class="keyword">return</span> registerSubset(set, (RelSubset) rel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Ensure that its sub-expressions are registered.</span></span><br><span class="line">    rel = rel.onRegister(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// Record its provenance. (Rule call may be null.)</span></span><br><span class="line">    <span class="comment">// ä»åŒç«¯é˜Ÿåˆ—ä¸­è·å– VolcanoRuleCallï¼Œå¹¶è®°å½•åˆ° provenanceMap ä¸­</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">VolcanoRuleCall</span> <span class="variable">ruleCall</span> <span class="operator">=</span> ruleCallStack.peek();</span><br><span class="line">    <span class="keyword">if</span> (ruleCall == <span class="literal">null</span>) &#123;</span><br><span class="line">        provenanceMap.put(rel, Provenance.EMPTY);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        provenanceMap.put(rel, <span class="keyword">new</span> <span class="title class_">RuleProvenance</span>(ruleCall.rule, ImmutableList.copyOf(ruleCall.rels), ruleCall.id));</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Place the expression in the appropriate equivalence set.</span></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰ RelSet ä¸ºç©ºï¼Œåˆ™åˆ›å»ºä¸€ä¸ª RelSet å¹¶æ·»åŠ åˆ° allSets ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (set == <span class="literal">null</span>) &#123;</span><br><span class="line">        set = <span class="keyword">new</span> <span class="title class_">RelSet</span>(nextSetId++, Util.minus(RelOptUtil.getVariablesSet(rel), rel.getVariablesSet()), RelOptUtil.getVariablesUsed(rel));</span><br><span class="line">        <span class="built_in">this</span>.allSets.add(set);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Allow each rel to register its own rules.</span></span><br><span class="line">    <span class="comment">// è§¦å‘å½“å‰ RelNode#register æ–¹æ³•ï¼Œå…è®¸æ³¨å†Œè‡ªå·±çš„ä¼˜åŒ–è§„åˆ™</span></span><br><span class="line">    <span class="comment">// CsvTableScan#register æ–¹æ³•æ³¨å†Œäº† CsvRules.PROJECT_SCAN è§„åˆ™</span></span><br><span class="line">    registerClass(rel);</span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹æ³¨å†Œå®Œæˆåï¼Œè°ƒç”¨ addRelToSet æ·»åŠ åˆ°ç­‰ä»·é›†åˆä¸­</span></span><br><span class="line">    <span class="type">RelSubset</span> <span class="variable">subset</span> <span class="operator">=</span> addRelToSet(rel, set);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Queue up all rules triggered by this relexp&#x27;s creation.</span></span><br><span class="line">    <span class="comment">// å¯¹æ³¨å†Œçš„è§„åˆ™è¿›è¡ŒåŒ¹é…ç­›é€‰</span></span><br><span class="line">    fireRules(rel);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> subset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="addreltoset"><a class="markdownIt-Anchor" href="#addreltoset"></a> addRelToSet</h5><p>æ¯ä¸ª RelNode æ³¨å†Œå®Œæˆåä¼šè°ƒç”¨ <code>addRelToSet</code> æ·»åŠ åˆ°ç­‰ä»·é›† RelSet ä¸­ï¼Œ<code>set.add(rel)</code> å†…éƒ¨ä¼šè°ƒç”¨ <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/c4042a34ef054b89cec1c47fefcbc8689bad55be/core/src/main/java/org/apache/calcite/plan/volcano/RelSet.java#L261">RelSet#getOrCreateSubset</a> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ ¹æ®ç‰¹å¾ Trait åˆ¤æ–­ RelSubset æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º RelSubset å®ä¾‹ï¼Œæ­¤æ—¶ bestCost ä¸º VolcanoCost.INFINITYã€‚ç„¶åä¼šå°†è¿”å›çš„ RelSubset ç»´æŠ¤åˆ° <code>mapRel2Subset</code> ä¸­ï¼Œæ–¹ä¾¿åç»­å¤ç”¨ã€‚<code>propagateCostImprovements</code> ä¼šé‡æ–°è®¡ç®—èŠ‚ç‚¹çš„ä»£ä»·ï¼Œå¦‚æœå®ƒçš„ä»£ä»·å°äº RelSubset çš„ä»£ä»·ï¼Œåˆ™æ›´æ–° RelSubset ä¸­çš„ <code>bestCost</code> å’Œ <code>best</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RelSubset <span class="title function_">addRelToSet</span><span class="params">(RelNode rel, RelSet set)</span> &#123;</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°ç­‰ä»·é›†åˆä¸­ RelSet å’Œ RelSubset ä¸­ï¼Œå¹¶è¿”å› RelSubset</span></span><br><span class="line">    <span class="type">RelSubset</span> <span class="variable">subset</span> <span class="operator">=</span> set.add(rel);</span><br><span class="line">    <span class="comment">// ç»´æŠ¤ Rel å’Œ Subset æ˜ å°„å…³ç³»</span></span><br><span class="line">    mapRel2Subset.put(rel, subset);</span><br><span class="line">    <span class="comment">// While a tree of RelNodes is being registered, sometimes nodes&#x27; costs</span></span><br><span class="line">    <span class="comment">// improve and the subset doesn&#x27;t hear about it. You can end up with</span></span><br><span class="line">    <span class="comment">// a subset with a single rel of cost 99 which thinks its best cost is</span></span><br><span class="line">    <span class="comment">// 100. We think this happens because the back-links to parents are</span></span><br><span class="line">    <span class="comment">// not established. So, give the subset another chance to figure out</span></span><br><span class="line">    <span class="comment">// its cost.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// é‡æ–°è®¡ç®—æ˜¯å¦å­˜åœ¨æ›´å°çš„ costï¼Œå­˜åœ¨åˆ™æ›´æ–° RelSubset ä¸­çš„ bestCost å’Œ best</span></span><br><span class="line">        propagateCostImprovements(rel);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CyclicMetadataException e) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ruleDriver != <span class="literal">null</span>) &#123;</span><br><span class="line">        ruleDriver.onProduce(rel, subset);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> subset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>propagateCostImprovements</code> æ–¹æ³•çš„å®ç°é€»è¾‘å¦‚ä¸‹ï¼Œæ–¹æ³•å†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¼šæ ¹æ® RelNode çš„ä»£ä»· RelOptCost è¿›è¡Œæ’åºï¼Œä»è€Œæ–¹ä¾¿è·å–æœ€å°ä»£ä»·çš„ RelNodeã€‚ç„¶åä»é˜Ÿåˆ—ä¸­å¼¹å‡º RelNodeï¼Œå¹¶éå† RelNode å¯¹åº” RelSet ä¸­çš„ RelSubsetï¼Œåˆ¤æ–­å½“å‰è®¡ç®—çš„ä»£ä»·æ˜¯å¦å°äºå·²çŸ¥çš„æœ€å°ä»£ä»·ï¼Œå¦‚æœä»£ä»·æ›´å°åˆ™æ›´æ–°æœ€å°ä»£ä»· bestCost å’Œæœ€ä¼˜è®¡åˆ’ bestã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">propagateCostImprovements</span><span class="params">(RelNode rel)</span> &#123;</span><br><span class="line">    <span class="type">RelMetadataQuery</span> <span class="variable">mq</span> <span class="operator">=</span> rel.getCluster().getMetadataQuery();</span><br><span class="line">    <span class="comment">// RelNode å’Œ RelOptCost æ˜ å°„ï¼Œæ–¹ä¾¿åç»­è·å– RelOptCost</span></span><br><span class="line">    Map&lt;RelNode, RelOptCost&gt; propagateRels = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ŒæŒ‰ç…§ RelOptCost æ’åº</span></span><br><span class="line">    PriorityQueue&lt;RelNode&gt; propagateHeap = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;((o1, o2) -&gt; &#123;...&#125;);</span><br><span class="line">    <span class="comment">// è·å– RelNode å¯¹åº”çš„ä»£ä»·</span></span><br><span class="line">    propagateRels.put(rel, getCostOrInfinite(rel, mq));</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    propagateHeap.offer(rel);</span><br><span class="line">    RelNode relNode;</span><br><span class="line">    <span class="comment">// ä»é˜Ÿåˆ—ä¸­å¼¹å‡º RelNode</span></span><br><span class="line">    <span class="keyword">while</span> ((relNode = propagateHeap.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">RelOptCost</span> <span class="variable">cost</span> <span class="operator">=</span> requireNonNull(propagateRels.get(relNode), <span class="string">&quot;propagateRels.get(relNode)&quot;</span>);</span><br><span class="line">        <span class="comment">// éå†å½“å‰ RelNode å¯¹åº” RelSet ä¸­çš„ RelSubset é›†åˆï¼ˆTrait ä¸åŒå­˜å‚¨åœ¨ä¸åŒ RelSubset ä¸­ï¼‰</span></span><br><span class="line">        <span class="keyword">for</span> (RelSubset subset : getSubsetNonNull(relNode).set.subsets) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­ Trait æ˜¯å¦ç›¸åŒ</span></span><br><span class="line">            <span class="keyword">if</span> (!relNode.getTraitSet().satisfies(subset.getTraitSet())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­ä»£ä»·æ˜¯å¦å°äºå·²çŸ¥æœ€å°ä»£ä»·</span></span><br><span class="line">            <span class="keyword">if</span> (!cost.isLt(subset.bestCost)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Update subset best cost when we find a cheaper rel or the current</span></span><br><span class="line">            <span class="comment">// best&#x27;s cost is changed</span></span><br><span class="line">            subset.timestamp++;</span><br><span class="line">            LOGGER.trace(<span class="string">&quot;Subset cost changed: subset [&#123;&#125;] cost was &#123;&#125; now &#123;&#125;&quot;</span>,</span><br><span class="line">                    subset, subset.bestCost, cost);</span><br><span class="line">            <span class="comment">// æ›´æ–°æœ€å°ä»£ä»·å’Œæœ€ä¼˜è®¡åˆ’</span></span><br><span class="line">            subset.bestCost = cost;</span><br><span class="line">            subset.best = relNode;</span><br><span class="line">            <span class="comment">// since best was changed, cached metadata for this subset should be removed</span></span><br><span class="line">            mq.clearCache(subset);</span><br><span class="line">            <span class="comment">// éå† RelSubset çš„çˆ¶èŠ‚ç‚¹ï¼ˆCsvTableScan å¯¹åº” RelSet çš„çˆ¶èŠ‚ç‚¹ä¸ºç©ºï¼‰</span></span><br><span class="line">            <span class="keyword">for</span> (RelNode parent : subset.getParents()) &#123;</span><br><span class="line">                mq.clearCache(parent);</span><br><span class="line">                <span class="comment">// è®¡ç®—çˆ¶èŠ‚ç‚¹ä»£ä»·</span></span><br><span class="line">                <span class="type">RelOptCost</span> <span class="variable">newCost</span> <span class="operator">=</span> getCostOrInfinite(parent, mq);</span><br><span class="line">                <span class="type">RelOptCost</span> <span class="variable">existingCost</span> <span class="operator">=</span> propagateRels.get(parent);</span><br><span class="line">                <span class="keyword">if</span> (existingCost == <span class="literal">null</span> || newCost.isLt(existingCost)) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœçˆ¶èŠ‚ç‚¹ä»£ä»·æ›´å°ï¼Œåˆ™åŠ å…¥ propagateHeap é‡æ–°è®¡ç®—</span></span><br><span class="line">                    propagateRels.put(parent, newCost);</span><br><span class="line">                    <span class="keyword">if</span> (existingCost != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// Cost reduced, force the heap to adjust its ordering</span></span><br><span class="line">                        propagateHeap.remove(parent);</span><br><span class="line">                    &#125;</span><br><span class="line">                    propagateHeap.offer(parent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¡ç®— RelNode ä»£ä»·æ˜¯é€šè¿‡ <code>VolcanoPlanner#getCostOrInfinite</code> æ–¹æ³•ï¼Œå¦‚æœ getCost è¿”å›çš„ä»£ä»·ä¸º nullï¼Œåˆ™ä¼šè¿”å›æ— ç©·å¤§ä»£ä»· infCostã€‚getCost æ–¹æ³•ä¼šå…ˆåˆ¤æ–­å½“å‰ RelNode æ˜¯å¦å·²ç»æ˜¯ RelSubsetï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å› bestCostã€‚ç„¶åæ ¹æ® <code>noneConventionHasInfiniteCost</code> æ ‡è®°ä»¥åŠå½“å‰ RelNode çš„ Trait åˆ¤æ–­æ˜¯å¦é’ˆå¯¹ None Convention ç›´æ¥è¿”å›æ— ç©·å¤§ä»£ä»·ï¼ŒnoneConventionHasInfiniteCost å‚æ•°å¯ä»¥é€šè¿‡ <code>VolcanoPlanner#setNoneConventionHasInfiniteCost</code> æ–¹æ³•è®¾ç½®ã€‚å½“å‰èŠ‚ç‚¹çš„ä»£ä»·è®¡ç®—æ˜¯è°ƒç”¨ <code>RelMetadataQuery#getNonCumulativeCost</code> æ–¹æ³•è·å–ï¼Œç„¶åè·å–å­èŠ‚ç‚¹çš„ä»£ä»·è¿›è¡Œç´¯åŠ ï¼Œå³ <code>RelNode æ€»ä»£ä»· = RelNode è‡ªèº«ä»£ä»· + æ‰€æœ‰å­èŠ‚ç‚¹ä»£ä»·</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RelOptCost <span class="title function_">getCostOrInfinite</span><span class="params">(RelNode rel, RelMetadataQuery mq)</span> &#123;</span><br><span class="line">    <span class="type">RelOptCost</span> <span class="variable">cost</span> <span class="operator">=</span> getCost(rel, mq);</span><br><span class="line">    <span class="keyword">return</span> cost == <span class="literal">null</span> ? infCost : cost;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> RelOptCost <span class="title function_">getCost</span><span class="params">(RelNode rel, RelMetadataQuery mq)</span> &#123;</span><br><span class="line">  	<span class="comment">// å¦‚æœå·²ç»æ˜¯ RelSubsetï¼Œç›´æ¥è¿”å› bestCost</span></span><br><span class="line">    <span class="keyword">if</span> (rel <span class="keyword">instanceof</span> RelSubset) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((RelSubset) rel).bestCost;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// æ ¹æ® noneConventionHasInfiniteCost æ ‡è®°ä»¥åŠå½“å‰ RelNode çš„ Trait åˆ¤æ–­æ˜¯å¦é’ˆå¯¹ None Convention ç›´æ¥è¿”å›æ— ç©·å¤§ä»£ä»·</span></span><br><span class="line">  	<span class="comment">// noneConventionHasInfiniteCost å‚æ•°å¯ä»¥é€šè¿‡ VolcanoPlanner#setNoneConventionHasInfiniteCost è®¾ç½®</span></span><br><span class="line">    <span class="keyword">if</span> (noneConventionHasInfiniteCost</span><br><span class="line">            &amp;&amp; rel.getTraitSet().getTrait(ConventionTraitDef.INSTANCE) == Convention.NONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> costFactory.makeInfiniteCost();</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// è·å–å½“å‰ RelNode çš„ä»£ä»·</span></span><br><span class="line">    <span class="type">RelOptCost</span> <span class="variable">cost</span> <span class="operator">=</span> mq.getNonCumulativeCost(rel);</span><br><span class="line">    <span class="keyword">if</span> (cost == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// åˆ¤æ–­ä»£ä»·æ˜¯å¦ä¸ºæ­£æ•°ä»£ä»·ï¼Œä¸æ»¡è¶³åˆ™è¿”å›æœ€å°ä»£ä»·</span></span><br><span class="line">    <span class="keyword">if</span> (!zeroCost.isLt(cost)) &#123;</span><br><span class="line">        <span class="comment">// cost must be positive, so nudge it</span></span><br><span class="line">        cost = costFactory.makeTinyCost();</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// è·å–å­èŠ‚ç‚¹çš„ä»£ä»·è¿›è¡Œç´¯åŠ ï¼Œå³ RelNode æ€»ä»£ä»· = RelNode è‡ªèº«ä»£ä»· + æ‰€æœ‰å­èŠ‚ç‚¹ä»£ä»·</span></span><br><span class="line">    <span class="keyword">for</span> (RelNode input : rel.getInputs()) &#123;</span><br><span class="line">        <span class="type">RelOptCost</span> <span class="variable">inputCost</span> <span class="operator">=</span> getCost(input, mq);</span><br><span class="line">        <span class="keyword">if</span> (inputCost == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cost = cost.plus(inputCost);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cost;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RelMetadataQuery#getNonCumulativeCost</code> æ–¹æ³•å¦‚ä¸‹ï¼ŒCalcite ä¼šé€šè¿‡ Janino åŠ¨æ€ç”Ÿæˆ nonCumulativeCostHandler å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ <code>RelMdPercentageOriginalRows#getNonCumulativeCost</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨ RelNode#computeSelfCost æ–¹æ³•ï¼Œæ­¤å¤„ä¸º CsvTableScan å®ç°çš„æ–¹æ³•ã€‚CsvTableScan ä¼šè°ƒç”¨çˆ¶ç±» TableScan ä¸­çš„æ–¹æ³•ï¼Œæ­¤æ—¶ä¼šè·å–ç»Ÿè®¡ä¿¡æ¯ä¸­è·å–è¡Œæ•°ä¿¡æ¯ rowCountï¼Œç„¶åä½¿ç”¨ä¼˜åŒ–å™¨ä¸­çš„ CostFactory è®¡ç®—ä»£ä»·ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RelMetadataQuery#getNonCumulativeCost æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> RelOptCost <span class="title function_">getNonCumulativeCost</span><span class="params">(RelNode rel)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> nonCumulativeCostHandler.getNonCumulativeCost(rel, <span class="built_in">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MetadataHandlerProvider.NoHandler e) &#123;</span><br><span class="line">            nonCumulativeCostHandler = revise(BuiltInMetadata.NonCumulativeCost.Handler.class);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RelMdPercentageOriginalRows#getNonCumulativeCost æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> RelOptCost <span class="title function_">getNonCumulativeCost</span><span class="params">(RelNode rel, RelMetadataQuery mq)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> rel.computeSelfCost(rel.getCluster().getPlanner(), mq);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CsvTableScan#computeSelfCost æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> RelOptCost <span class="title function_">computeSelfCost</span><span class="params">(RelOptPlanner planner, RelMetadataQuery mq)</span> &#123;</span><br><span class="line">    <span class="comment">// Multiply the cost by a factor that makes a scan more attractive if it</span></span><br><span class="line">    <span class="comment">// has significantly fewer fields than the original scan.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The &quot;+ 2D&quot; on top and bottom keeps the function fairly smooth.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// For example, if table has 3 fields, project has 1 field,</span></span><br><span class="line">    <span class="comment">// then factor = (1 + 2) / (3 + 2) = 0.6</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.computeSelfCost(planner, mq).multiplyBy(((<span class="type">double</span>) fields.length + <span class="number">2D</span>) / ((<span class="type">double</span>) table.getRowType().getFieldCount() + <span class="number">2D</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TableScan#computeSelfCost æ–¹æ³•</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> RelOptCost <span class="title function_">computeSelfCost</span><span class="params">(RelOptPlanner planner, RelMetadataQuery mq)</span> &#123;</span><br><span class="line">    <span class="type">double</span> <span class="variable">dRows</span> <span class="operator">=</span> table.getRowCount();</span><br><span class="line">    <span class="type">double</span> <span class="variable">dCpu</span> <span class="operator">=</span> dRows + <span class="number">1</span>; <span class="comment">// ensure non-zero cost</span></span><br><span class="line">    <span class="type">double</span> <span class="variable">dIo</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> planner.getCostFactory().makeCost(dRows, dCpu, dIo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RelOptTableImpl#getRowCount æ–¹æ³•</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getRowCount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (rowCount != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> rowCount;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (table != <span class="literal">null</span>) &#123;</span><br><span class="line">      	<span class="comment">// CSV ç¤ºä¾‹ä¸­æœªæ³¨å†Œç»Ÿè®¡ä¿¡æ¯ï¼Œé»˜è®¤ä¸º Statistics.UNKNOWNï¼ŒrowCount ä¸º null</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Double</span> <span class="variable">rowCount</span> <span class="operator">=</span> table.getStatistic().getRowCount();</span><br><span class="line">        <span class="keyword">if</span> (rowCount != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> rowCount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// é»˜è®¤è¿”å› 100d</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">100d</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè¿”å›çš„ CsvTableScan VolcanoCost å¯¹è±¡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè®°å½•äº† <code>cpu</code>ã€<code>io</code> å’Œ <code>rowCount</code> ä¿¡æ¯ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1703207948.png" title="CsvTableScan VolcanoCost å¯¹è±¡"><p><code>propagateCostImprovements</code> æ–¹æ³•ä¼šæŒ‰ç…§å‰æ–‡æ‰€è¿°ï¼Œå°† RelSubset ä¸­çš„ä»£ä»·å’Œæ–°è®¡ç®—çš„ä»£ä»·è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå‘ç°æ›´å°ä»£ä»·ï¼Œåˆ™ä¼šæ›´æ–° bestCost å’Œ best å±æ€§ï¼ŒRelSubset æ›´æ–°åçš„å¯¹è±¡å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1703208192.png" title="æ›´æ–°ä»£ä»·åçš„ RelSubset"><h5 id="firerules"><a class="markdownIt-Anchor" href="#firerules"></a> fireRules</h5><p>ç”Ÿæˆå®Œ RelSubset å¹¶è®¡ç®— RelNode çš„ä»£ä»·åï¼ŒVolcanoPlanner ä¼šè°ƒç”¨ <code>fireRules</code> æ–¹æ³•ï¼Œå¯¹é˜Ÿåˆ—ä¸­çš„è§„åˆ™è¿›è¡ŒåŒ¹é…ç­›é€‰ï¼ŒfireRules å®ç°é€»è¾‘å¦‚ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Fires all rules matched by a relational expression.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rel Relational expression which has just been created (or maybe</span></span><br><span class="line"><span class="comment"> *            from the queue)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">fireRules</span><span class="params">(RelNode rel)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (RelOptRuleOperand operand : classOperands.get(rel.getClass())) &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­å½“å‰ Rel æ˜¯å¦åŒ¹é…è§„åˆ™</span></span><br><span class="line">        <span class="keyword">if</span> (operand.matches(rel)) &#123;</span><br><span class="line">            <span class="keyword">final</span> VolcanoRuleCall ruleCall;</span><br><span class="line">            ruleCall = <span class="keyword">new</span> <span class="title class_">DeferringRuleCall</span>(<span class="built_in">this</span>, operand);</span><br><span class="line">            ruleCall.match(rel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>classOperands</code> ä¸­è®°å½•äº† RelNode å’Œ RelOptRuleOperand çš„å¯¹åº”å…³ç³»ï¼ŒRelOptRuleOperand ç”¨äºåˆ¤æ–­ RelOptRule æ˜¯å¦å¯ä»¥ç”¨äºæŸä¸ªå…³ç³»ä»£æ•°ã€‚ä¸‹å›¾å±•ç¤ºäº† CsvTableScan å¯¹åº”çš„ RelOptRuleOperand é›†åˆï¼Œè¿™äº› RelOptRuleOperand éƒ½æ˜¯å’Œ TableScan ç›¸å…³çš„è§„åˆ™ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1703298241.png" title="classOperands å­˜å‚¨çš„ä¼˜åŒ–è§„åˆ™"><p>å¯¹äºæ¯ä¸€ä¸ª RelOptRuleOperandï¼Œéƒ½ä¼šè°ƒç”¨å…¶ <code>matches</code> æ–¹æ³•ï¼Œæ–¹æ³•å†…ä¼šåˆ¤æ–­ RelNode æ˜¯å¦æ˜¯ RelOptRuleOperand ä¸­è®°å½•çš„ clazz å®ä¾‹ï¼Œä»¥åŠ RelNode æ˜¯å¦åŒ…å«å®šä¹‰çš„ trait ç‰¹å¾ï¼Œæœ€åä¼šä½¿ç”¨ predicate æ–¹æ³•å¯¹ RelNode è¿›è¡ŒåŒ¹é…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(RelNode rel)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!clazz.isInstance(rel)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((trait != <span class="literal">null</span>) &amp;&amp; !rel.getTraitSet().contains(trait)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> predicate.test(rel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½å¥‡çš„è¯»è€…å¯èƒ½ä¼šé—®ï¼ŒRelOptRuleOperand è®°å½•çš„è¿™äº›ä¿¡æ¯æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–çš„ï¼Ÿä»¥ CsvProjectTableScanRule ä¸ºä¾‹ï¼Œåœ¨è¯¥ä¼˜åŒ–è§„åˆ™åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ <code>super(config)</code> æ–¹æ³•ï¼Œä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/bebe473fab2e242736614659ed6e5d04eeeb8bf5/core/src/main/java/org/apache/calcite/plan/RelRule.java#L123">OperandBuilderImpl.operand(config.operandSupplier())</a> åˆå§‹åŒ– RelOptRuleOperand ç±»ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªè¡Œæ¢ç©¶ä¸‹ã€‚</p><p>RelOptRuleOperand åŒ¹é…æˆåŠŸåï¼Œä¼šåˆ›å»ºä¸€ä¸ª <code>DeferringRuleCall</code>ï¼Œè¯¥ç±»è¡¨ç¤ºå¯¹ Rule çš„è°ƒç”¨ï¼Œå¹¶ä¸”å¯ä»¥å»¶è¿Ÿæ‰§è¡Œã€‚ç„¶åè°ƒç”¨ <code>DeferringRuleCall#match</code> æ–¹æ³•åº”ç”¨å½“å‰åŒ¹é…çš„è§„åˆ™ï¼Œmatch æ–¹æ³•ä¼šè°ƒç”¨ <code>VolcanoRuleCall#matchRecurse</code> æ–¹æ³•ï¼Œå¦‚æœè§„åˆ™åŒ¹é…åˆ™ä¼šè°ƒç”¨ onMatch æ–¹æ³•ã€‚<code>DeferringRuleCall#onMatch</code> æ–¹æ³•ä¼šåŒ¹é…è§„åˆ™ä»¥åŠ RelNode å°è£…æˆ VolcanoRuleMatchï¼Œç„¶åæ·»åŠ åˆ° RuleQueue ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VolcanoRuleCall#matchRecurse æ–¹æ³•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">matchRecurse</span><span class="params">(<span class="type">int</span> solve)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;RelOptRuleOperand&gt; operands = getRule().operands;</span><br><span class="line">		<span class="comment">// å½“æ±‚è§£é¡ºåºå‚æ•°ç­‰äºæ“ä½œæ•°æ—¶ï¼Œåˆ¤æ–­å½“å‰ Rule æ˜¯å¦</span></span><br><span class="line">    <span class="keyword">if</span> (solve == operands.size()) &#123;</span><br><span class="line">        <span class="comment">// We have matched all operands. Now ask the rule whether it</span></span><br><span class="line">        <span class="comment">// matches; this gives the rule chance to apply side-conditions.</span></span><br><span class="line">        <span class="comment">// If the side-conditions are satisfied, we have a match.</span></span><br><span class="line">        <span class="keyword">if</span> (getRule().matches(<span class="built_in">this</span>)) &#123;</span><br><span class="line">            onMatch();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DeferringRuleCall#onMatch æ–¹æ³•</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Rather than invoking the rule (as the base method does), creates a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> VolcanoRuleMatch&#125; which can be invoked later.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMatch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">VolcanoRuleMatch</span> <span class="variable">match</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VolcanoRuleMatch</span>(volcanoPlanner, getOperand0(), rels, nodeInputs);</span><br><span class="line">    volcanoPlanner.ruleDriver.getRuleQueue().addMatch(match);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒsetRoot å°±å®Œæˆäº†å¯¹ CsvTableScan èŠ‚ç‚¹çš„å¤„ç†ï¼Œä¸º CsvTableScan ç”Ÿæˆäº† RelSet å’Œ RelSubsetï¼Œå¹¶ç­›é€‰äº† CsvTableScan åŒ¹é…çš„è§„åˆ™ã€‚CsvTableScan å¯¹åº”çš„ RelSubset ä¼šä»¥ inputs çš„å½¢å¼è¿”å›ï¼Œæä¾›ç»™ LogicalFilter ä½œä¸ºå­èŠ‚ç‚¹ï¼ŒLogicalFilter ä»ç„¶ä¼šæŒ‰ç…§å‰æ–‡ä»‹ç»çš„ <code>onRegister</code> -&gt; <code>addRelToSet</code> -&gt; <code>fireRules</code> çš„æµç¨‹è¿›è¡Œå¤„ç†ï¼Œå¹¶åŒæ ·è¿”å› RelSubset ä½œä¸º LogicalProject çš„å­èŠ‚ç‚¹ã€‚LogicalFilter å’Œ LogicalProject ç”±äº Convention ä¸º Noneï¼Œå› æ­¤è®¡ç®—ä»£ä»·æ—¶ï¼Œä»–ä»¬çš„ä»£ä»·ä¸ºæ­£æ— ç©·ï¼Œæ‰§è¡Œå®Œç¬¬ä¸€è½® setRoot æ–¹æ³•ï¼Œæœ€ç»ˆä¼šå¾—åˆ°å¦‚ä¸‹çš„ RelSubset æ ‘ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LogicalProject(subset=[rel#14:RelSubset#2.NONE.[]], EMPNO=[$0], NAME=[$1], DEPTNO=[$2], GENDER=[$3], CITY=[$4], EMPID=[$5], AGE=[$6], SLACKER=[$7], MANAGER=[$8], JOINEDAT=[$9])</span><br><span class="line">  LogicalFilter(subset=[rel#12:RelSubset#1.NONE.[]], condition=[=($1, &#x27;Alice&#x27;)])</span><br><span class="line">    CsvTableScan(subset=[rel#10:RelSubset#0.ENUMERABLE.[]], table=[[SALES, EMPS]], fields=[[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]])</span><br></pre></td></tr></table></figure><p>RelSubset æ ‘æ˜¯é€šè¿‡æˆå‘˜å˜é‡ <code>final RelSet set</code> å˜é‡å®ç°ï¼ŒRelSet ä¸­ç»´æŠ¤äº†å½“å‰ RelNodeï¼Œé€šè¿‡ RelNode çš„ input ç»´æŠ¤äº† RelSubset å­èŠ‚ç‚¹ï¼Œä»¥æ­¤ç±»æ¨ï¼Œå½¢æˆäº†ä¸€é¢— RelSubset æ ‘ï¼Œæ•´ä½“ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1703810657.png" title="RelSubset æ ‘ç»“æ„"><h4 id="ç¬¬äºŒè½®-setroot"><a class="markdownIt-Anchor" href="#ç¬¬äºŒè½®-setroot"></a> ç¬¬äºŒè½® setRoot</h4><p>åœ¨è°ƒç”¨ç¬¬äºŒè½® setRoot å‰ï¼Œä¼šä¼˜å…ˆåˆ¤æ–­å½“å‰ RelNode çš„ Trait æ˜¯å¦å’Œç›®æ ‡ Trait ç›¸åŒï¼Œä¸ç›¸åŒåˆ™è°ƒç”¨ä¼˜åŒ–å™¨çš„ <code>changeTraits</code> æ–¹æ³•å˜æ¢ç‰¹å¾ã€‚ç”±äº RelNode ä¸­çš„ Convention Trait æ˜¯ NONEï¼Œç›®æ ‡ Convention Trait æ˜¯ ENUMERABLEï¼Œå› æ­¤ä¼šå…ˆè°ƒç”¨ changeTraits æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">RelNode</span> <span class="variable">rootRel2</span> <span class="operator">=</span> rel.getTraitSet().equals(requiredOutputTraits) ? rel : planner.changeTraits(rel, requiredOutputTraits);</span><br></pre></td></tr></table></figure><h5 id="changetraits"><a class="markdownIt-Anchor" href="#changetraits"></a> changeTraits</h5><p>changeTraits å®ç°é€»è¾‘å¦‚ä¸‹ï¼Œä¼šä¼ å…¥ RelNode å’ŒæœŸæœ›çš„ RelTraitSetï¼Œç„¶åå…ˆè°ƒç”¨ ensureRegistered ç¡®ä¿æ‰€æœ‰çš„ RelNode éƒ½æ³¨å†Œæˆ RelSubsetï¼Œç„¶åè°ƒç”¨ <code>getOrCreateSubset</code> æ–¹æ³•ç”Ÿæˆ RelTraitSet å¯¹åº”çš„ RelSubsetã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RelNode <span class="title function_">changeTraits</span><span class="params">(<span class="keyword">final</span> RelNode rel, RelTraitSet toTraits)</span> &#123;</span><br><span class="line">    <span class="type">RelSubset</span> <span class="variable">rel2</span> <span class="operator">=</span> ensureRegistered(rel, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (rel2.getTraitSet().equals(toTraits)) &#123;</span><br><span class="line">        <span class="keyword">return</span> rel2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rel2.set.getOrCreateSubset(rel.getCluster(), toTraits, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œæ ¹èŠ‚ç‚¹ RelSubSet çš„ Convention å·²ç»å˜æ¢ä¸º ENUMERABLEï¼Œå­èŠ‚ç‚¹ RelSubSet çš„ Convention ä»ç„¶æ˜¯ NONEï¼Œåç»­éœ€è¦å…³æ³¨å­èŠ‚ç‚¹ Convention çš„å˜æ¢æ—¶æœºã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1703636903.png" title="æ ¹èŠ‚ç‚¹ RelSubSet Convention"><h5 id="registersubset"><a class="markdownIt-Anchor" href="#registersubset"></a> registerSubset</h5><p>ç”±äºç»è¿‡äº†ç¬¬ä¸€è½® setRoot ä»¥åŠ changeTraits å¤„ç†ï¼Œ<code>rootRel2</code> å˜æˆäº†ä¸€é¢— RelSubset æ ‘ï¼Œåœ¨ç¬¬äºŒè½® setRoot è°ƒç”¨ registerImpl æ—¶ï¼Œç”±äº RelNode å·²ç»æ˜¯ RelSubsetï¼Œå› æ­¤ä¼šè°ƒç”¨ registerSubset æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VolcanoPlanner#registerImpl æ–¹æ³•</span></span><br><span class="line"><span class="keyword">private</span> RelSubset <span class="title function_">registerImpl</span><span class="params">(RelNode rel, <span class="meta">@Nullable</span> RelSet set)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (rel <span class="keyword">instanceof</span> RelSubset) &#123;</span><br><span class="line">        <span class="keyword">return</span> registerSubset(set, (RelSubset) rel);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>registerSubset æ–¹æ³•å®ç°é€»è¾‘å¦‚ä¸‹ï¼Œé¦–å…ˆä¼šå°è¯•å¯¹ RelSet è¿›è¡Œåˆå¹¶ï¼Œç”±äºå½“å‰æ¡ˆä¾‹ä¸­ <code>RelSet set</code> ä¸º nullï¼Œæœªè¦†ç›– merge é€»è¾‘ï¼Œåç»­æˆ‘ä»¬ä¼šæ¢ç´¢å…¶ä»–å¤æ‚æ¡ˆä¾‹çš„ RelSet åˆå¹¶æ“ä½œã€‚<code>canonize</code> æ–¹æ³•ç”¨äºå¤„ç†å½“å‰ RelSubset å­˜åœ¨å¤šä¸ªç­‰ä»·çš„ RelSubset æ—¶ï¼Œè·å–åŸå§‹çš„ RelSubSetã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RelSubset <span class="title function_">registerSubset</span><span class="params">(<span class="meta">@Nullable</span> RelSet set, RelSubset subset)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((set != subset.set) &amp;&amp; (set != <span class="literal">null</span>) &amp;&amp; (set.equivalentSet == <span class="literal">null</span>)) &#123;</span><br><span class="line">        LOGGER.trace(<span class="string">&quot;Register #&#123;&#125; &#123;&#125;, and merge sets&quot;</span>, subset.getId(), subset);</span><br><span class="line">        merge(set, subset.set);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> canonize(subset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * If a subset has one or more equivalent subsets (owing to a set having</span></span><br><span class="line"><span class="comment"> * merged with another), returns the subset which is the leader of the</span></span><br><span class="line"><span class="comment"> * equivalence class.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> subset Subset</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Leader of subset&#x27;s equivalence class</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> RelSubset <span class="title function_">canonize</span><span class="params">(<span class="keyword">final</span> RelSubset subset)</span> &#123;</span><br><span class="line">    <span class="type">RelSet</span> <span class="variable">set</span> <span class="operator">=</span> subset.set;</span><br><span class="line">    <span class="keyword">if</span> (set.equivalentSet == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> subset;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¾ªç¯è·å–åŸå§‹çš„ RelSetï¼Œç„¶ååˆ›å»ºå¯¹åº” Trait çš„ RelSubset</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        set = set.equivalentSet;</span><br><span class="line">    &#125; <span class="keyword">while</span> (set.equivalentSet != <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">return</span> set.getOrCreateSubset(subset.getCluster(), subset.getTraitSet(), subset.isRequired());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ensurerootconverters"><a class="markdownIt-Anchor" href="#ensurerootconverters"></a> ensureRootConverters</h5><p>æœ€åä¼šæ‰§è¡Œ <code>ensureRootConverters</code> æ–¹æ³•ï¼Œç¡®ä¿æ ¹èŠ‚ç‚¹çš„ç­‰ä»·é›†åˆéƒ½åŒ…å«äº† <code>AbstractConverter</code>ï¼Œä»¥ä¾¿äºå‘ç°ä»£ä»·æ›´å°çš„å®ç°æ—¶ï¼Œèƒ½å¤Ÿå°† RelSubset è½¬æ¢ä¸ºæ ¹èŠ‚ç‚¹ã€‚ensureRootConverters æ–¹æ³•å®ç°é€»è¾‘å¦‚ä¸‹ï¼Œå¦‚æœæ ¹èŠ‚ç‚¹ä¸­è®°å½•çš„ç­‰ä»·å…³ç³»ä»£æ•° RelNode å·²ç»æ˜¯ AbstractConverterï¼Œåˆ™ç›´æ¥æ·»åŠ åˆ° subsets é›†åˆä¸­ã€‚ç„¶ååˆ¤æ–­æ ¹èŠ‚ç‚¹çš„æ‰€æœ‰ RelSubsetï¼Œå¦‚æœå‘ç° <code>root trait</code> å’Œ <code>subset trait</code> ä¸åŒæ—¶ï¼Œå°†ä¼šæ³¨å†Œä¸€ä¸ª AbstractConverterï¼ˆAbstractConverter æ˜¯ä¸€ä¸ª RelNodeï¼Œç”¨äºå°†ä¸€ä¸ªå…³ç³»ä»£æ•°è½¬æ¢ä¸ºæŒ‡å®š Convention çš„å…³ç³»ä»£æ•°ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Ensures that the subset that is the root relational expression contains</span></span><br><span class="line"><span class="comment"> * converters to all other subsets in its equivalence set.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Thus the planner tries to find cheap implementations of those other</span></span><br><span class="line"><span class="comment"> * subsets, which can then be converted to the root. This is the only place</span></span><br><span class="line"><span class="comment"> * in the plan where explicit converters are required; elsewhere, a consumer</span></span><br><span class="line"><span class="comment"> * will be asking for the result in a particular convention, but the root has</span></span><br><span class="line"><span class="comment"> * no consumers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">ensureRootConverters</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Set&lt;RelSubset&gt; subsets = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (RelNode rel : root.getRels()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rel <span class="keyword">instanceof</span> AbstractConverter) &#123;</span><br><span class="line">            subsets.add((RelSubset) ((AbstractConverter) rel).getInput());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (RelSubset subset : root.set.subsets) &#123;</span><br><span class="line">        <span class="keyword">final</span> ImmutableList&lt;RelTrait&gt; difference = root.getTraitSet().difference(subset.getTraitSet());</span><br><span class="line">      	<span class="comment">// å½“ root trait å’Œ subset trait ä¸åŒæ—¶ï¼Œæ³¨å†Œä¸€ä¸ª AbstractConverterï¼ˆAbstractConverter æ˜¯ä¸€ä¸ª RelNodeï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (difference.size() == <span class="number">1</span> &amp;&amp; subsets.add(subset)) &#123;</span><br><span class="line">            register(<span class="keyword">new</span> <span class="title class_">AbstractConverter</span>(subset.getCluster(), subset, difference.get(<span class="number">0</span>).getTraitDef(), root.getTraitSet()), root);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨ register æ–¹æ³•ï¼Œåˆ†åˆ«å°† AbstractConverter å’Œ root èŠ‚ç‚¹ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œç„¶åè°ƒç”¨ ensureRegistered æ–¹æ³•å°† RelNode æ³¨å†Œä¸º RelSubsetï¼Œæ­¤å¤„ root èŠ‚ç‚¹å·²ç»ä¸º RelSubsetï¼Œæ‰€ä»¥ä¼šç›´æ¥è¿”å›ï¼Œå¹¶è·å–åˆ° RelSubset å¯¹åº”çš„ RelSetã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RelSubset <span class="title function_">register</span><span class="params">(RelNode rel, <span class="meta">@Nullable</span> RelNode equivRel)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> RelSet set;</span><br><span class="line">    <span class="keyword">if</span> (equivRel == <span class="literal">null</span>) &#123;</span><br><span class="line">        set = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        equivRel = ensureRegistered(equivRel, <span class="literal">null</span>);</span><br><span class="line">        set = getSet(equivRel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> registerImpl(rel, set);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åé€»è¾‘ä¼šå†æ¬¡è°ƒç”¨åˆ° registerImpl æ–¹æ³•ï¼Œå½“å‘ç°å½“å‰èŠ‚ç‚¹æ˜¯ Converter æ—¶ï¼Œä¼šå°è¯•å°† Converter merge åˆ° Converter å­èŠ‚ç‚¹çš„ RelSet ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RelSubset <span class="title function_">registerImpl</span><span class="params">(RelNode rel, <span class="meta">@Nullable</span> RelSet set)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Converters are in the same set as their children.</span></span><br><span class="line">    <span class="keyword">if</span> (rel <span class="keyword">instanceof</span> Converter) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">RelNode</span> <span class="variable">input</span> <span class="operator">=</span> ((Converter) rel).getInput();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">RelSet</span> <span class="variable">childSet</span> <span class="operator">=</span> castNonNull(getSet(input));</span><br><span class="line">      	<span class="comment">// </span></span><br><span class="line">        <span class="keyword">if</span> ((set != <span class="literal">null</span>) &amp;&amp; (set != childSet) &amp;&amp; (set.equivalentSet == <span class="literal">null</span>)) &#123;</span><br><span class="line">            merge(set, childSet);</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            set = childSet;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒè½® setRoot ç»“æŸåï¼ŒRelSubset çš„æ ‘å½¢ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ ¹èŠ‚ç‚¹çš„ Convention å˜æˆäº† ENUMERABLEï¼Œæ ¹èŠ‚ç‚¹ RelSet ä¸­è®°å½•çš„ rels å¢åŠ äº† AbstractConverterï¼Œsubsets å¢åŠ äº† Convention ä¸º ENUMERABLE çš„ RelSubsetï¼Œå…¶ä»–å­èŠ‚ç‚¹çš„ä¿¡æ¯å’Œç¬¬ä¸€è½® setRoot ä¸€è‡´ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1703810113.jpg" title="ç¬¬äºŒè½® setRoot RelSubset æ ‘å½¢ç»“æ„"><h3 id="findbestexp-æµç¨‹"><a class="markdownIt-Anchor" href="#findbestexp-æµç¨‹"></a> findBestExp æµç¨‹</h3><p>å®Œæˆäº† setRoot æµç¨‹åï¼Œæœ€åä¸€æ­¥å°±æ˜¯è°ƒç”¨ <code>findBestExp</code> æ–¹æ³•ï¼Œæ ¹æ® setRoot é˜¶æ®µç”Ÿæˆçš„ RelSubset æ ‘ä»¥åŠå…¶ä¸­è®°å½•çš„ä»£ä»·ä¿¡æ¯ï¼Œå¯»æ‰¾æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚ä¸‹é¢æ˜¯ findBestExp æ–¹æ³•çš„å®ç°ï¼Œæ ¸å¿ƒçš„å¤„ç†é€»è¾‘ä¸»è¦æ˜¯ <code>ruleDriver.drive()</code> å’Œ <code>buildCheapestPlan</code> æ–¹æ³•ï¼Œ<code>ruleDriver.drive()</code> è´Ÿè´£ä» ruleQueue ä¸­å–å‡ºåŒ¹é…çš„è§„åˆ™å¹¶è¿›è¡Œå…³ç³»ä»£æ•°å˜æ¢ï¼Œå¹¶å’Œä¹‹å‰çš„ä»£ä»·è¿›è¡Œæ¯”è¾ƒä»¥å¯»æ‰¾æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„æœ€å°ä»£ä»·å®ç°ã€‚<code>buildCheapestPlan</code> æ–¹æ³•åˆ™éå†æ•´ä¸ª RelSubset æ ‘ï¼Œå¯»æ‰¾å‡ºå…¨å±€æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finds the most efficient expression to implement the query given via</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.apache.calcite.plan.RelOptPlanner#setRoot(org.apache.calcite.rel.RelNode)&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the most efficient RelNode tree found for implementing the given</span></span><br><span class="line"><span class="comment"> * query</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RelNode <span class="title function_">findBestExp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">assert</span> root != <span class="literal">null</span> : <span class="string">&quot;root must not be null&quot;</span>;</span><br><span class="line">    <span class="comment">// ç¡®ä¿æ‰€æœ‰ç­‰ä»·é›†éƒ½åŒ…å« AbstractConverterï¼Œä»¥ä¾¿äºå‘ç°ä»£ä»·æ›´å°çš„å®ç°æ—¶ï¼Œèƒ½å¤Ÿå°† RelSubset è½¬æ¢ä¸ºæ ¹èŠ‚ç‚¹</span></span><br><span class="line">    ensureRootConverters();</span><br><span class="line">  	<span class="comment">// æ³¨å†Œç‰©åŒ–è§†å›¾ç›¸å…³çš„å…³ç³»ä»£æ•°ï¼Œæœ¬æ–‡æš‚æ—¶ä¸æ¶‰åŠï¼Œåç»­æ–‡ç« ä¼šå•ç‹¬è§£è¯»ç‰©åŒ–è§†å›¾å’Œ Lattice æ ¼</span></span><br><span class="line">    registerMaterializations();</span><br><span class="line">    <span class="comment">// å¯»æ‰¾æœ€ä¼˜ planï¼Œå³ cost æœ€å°çš„ planï¼Œå…ˆæ‰¾åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„æœ€ä¼˜ planï¼Œç„¶åæ„å»ºå…¨å±€æœ€ä¼˜ plan</span></span><br><span class="line">    <span class="comment">// ruleDriver åŒ…æ‹¬ IterativeRuleDriver å’Œ TopDownRuleDriver ä¸¤ç§ï¼Œæœ¬æ–‡æ¡ˆä¾‹ä½¿ç”¨çš„æ˜¯ IterativeRuleDriver</span></span><br><span class="line">    ruleDriver.drive();</span><br><span class="line">    <span class="comment">// æ„å»ºå…¨å±€æœ€ä¼˜ plan</span></span><br><span class="line">    <span class="type">RelNode</span> <span class="variable">cheapest</span> <span class="operator">=</span> root.buildCheapestPlan(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span> cheapest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="drive"><a class="markdownIt-Anchor" href="#drive"></a> drive</h4><p>æœ¬æ–‡æ¡ˆä¾‹ä¸­ <code>driver</code> çš„å®ç°ç±»ä¸º <code>IterativeRuleDriver</code>ï¼Œè¯¥æ–¹æ³•è´Ÿè´£åº”ç”¨è§„åˆ™ï¼ŒæŒ‰ç…§ä¼˜åŒ–è§„åˆ™å¯¹å…³ç³»ä»£æ•°è¿›è¡Œå˜æ¢ã€‚<code>IterativeRuleDriver#drive</code> æ–¹æ³•å®ç°é€»è¾‘å¦‚ä¸‹ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨äº†ä¸€ä¸ª <code>while(true)</code> æ­»å¾ªç¯ï¼Œä¼šä¸æ–­åœ°ä» <code>ruleQueue</code> ä¸­å¼¹å‡ºè§„åˆ™ï¼Œå¹¶è°ƒç”¨ <code>VolcanoRuleMatch#onMatch</code> æ–¹æ³•å¯¹å…³ç³»ä»£æ•°è¿›è¡Œå˜æ¢ã€‚å½“ ruleQueue ä¸­æ²¡æœ‰åŒ¹é…çš„è§„åˆ™ï¼Œæˆ–è€…ä¼˜åŒ–å™¨æŠ›å‡ºäº† <code>VolcanoTimeoutException</code> æ—¶ï¼Œæ­¤æ—¶ä¼šä¸­æ–­å¾ªç¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">drive</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// ä» ruleQueue ä¸­å¼¹å‡ºåŒ¹é…è§„åˆ™</span></span><br><span class="line">        <span class="type">VolcanoRuleMatch</span> <span class="variable">match</span> <span class="operator">=</span> ruleQueue.popMatch();</span><br><span class="line">        <span class="keyword">if</span> (match == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­è§„åˆ™æ˜¯å¦åŒ¹é…</span></span><br><span class="line">        <span class="keyword">assert</span> match.getRule().matches(match);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨ onMatch æ–¹æ³•å¯¹å…³ç³»ä»£æ•°è¿›è¡Œå˜æ¢</span></span><br><span class="line">            match.onMatch();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (VolcanoTimeoutException e) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">&quot;Volcano planning times out, cancels the subsequent optimization.&quot;</span>);</span><br><span class="line">            planner.canonize();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// The root may have been merged with another subset. Find the new root subset.</span></span><br><span class="line">        planner.canonize();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“å‰çš„æ¡ˆä¾‹ä¸­ï¼ŒpreQueue ä¸­è®°å½•äº† 2 ä¸ªéœ€è¦é¢„å…ˆå¤„ç†çš„åŒ¹é…è§„åˆ™ï¼š<code>ExpandConversionRule</code> å’Œ <code>ProjectRemoveRule</code>ï¼ŒruleQueue åŒ…å«äº† 4 ä¸ªåŒ¹é…è§„åˆ™ï¼Œåˆ†åˆ«æ˜¯ <code>EnumerableFilterRule</code>ã€<code>ProjectFilterTransposeRule</code>ã€<code>EnumerableProjectRule</code> å’Œ <code>ExpandConversionRule</code>ã€‚</p><p>ExpandConversionRule åˆ™ç”¨äºå°† AbstractConverter è½¬æ¢ä¸º converters é“¾ï¼Œconverters é“¾ä¼šå°†åŸå§‹çš„å…³ç³»ä»£æ•°è½¬æ¢åˆ°ç›®æ ‡ç‰¹å¾ã€‚ProjectRemoveRule è´Ÿè´£å°†ä»…è¿”å›å…¶è¾“å…¥çš„ Project èŠ‚ç‚¹è½¬æ¢ä¸ºå…¶å­èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼š<code>Project(ArrayReader(a), &#123;$input0&#125;) becomes ArrayReader(a)</code>ã€‚</p><p>EnumerableFilterRule å’Œ EnumerableProjectRule åœ¨ Calcite ä¸­å±äº <code>ConverterRule</code>ï¼Œè´Ÿè´£å°† LogicalFilterã€LogicalProject è½¬æ¢ä¸º EnumerableFilter å’Œ EnumerableProjectã€‚ProjectFilterTransposeRule ä¼šå°† Project å’Œ Filter è¿›è¡Œè½¬ç½®å˜æ¢ï¼Œå±äº <code>TransformationRule</code>ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1703897196.png" title="ruleQueue åŒ…å«çš„ VolcanoRuleMatch"><p>ä»é˜Ÿåˆ—ä¸­å¼¹å‡º <code>VolcanoRuleMatch</code> åä¼šè°ƒç”¨ <code>VolcanoRuleMatch#onMatch</code> æ–¹æ³•è¿›è¡Œå…³ç³»ä»£æ•°å˜æ¢ï¼Œæ–¹æ³•å®ç°é€»è¾‘å¦‚ä¸‹ã€‚VolcanoRuleMatch ç»§æ‰¿äº† <code>RelOptRuleCall</code>ï¼ŒRelOptRuleCall ä»£è¡¨äº†å¯¹ RelOptRule çš„è°ƒç”¨ï¼Œå¹¶ä¼ é€’äº†ä¸€ç»„å…³ç³»è¡¨è¾¾å¼ä½œä¸ºå‚æ•°ã€‚å¼€å§‹ onMatch å‰ï¼Œä¼šå°†å½“å‰çš„ VolcanoRuleCall æ·»åŠ åˆ° deque å¤´éƒ¨ï¼Œç„¶åè°ƒç”¨ä¸åŒ rule çš„ onMatch æ–¹æ³•ï¼Œå®Œæˆå finally ä»£ç å—ä¼šä» deque å¤´éƒ¨å¼¹å‡ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VolcanoRuleMatch ç»§æ‰¿äº† RelOptRuleCallï¼ŒRelOptRuleCall ä»£è¡¨äº†å¯¹ RelOptRule çš„è°ƒç”¨ï¼Œå¹¶ä¼ é€’äº†ä¸€ç»„å…³ç³»è¡¨è¾¾å¼ä½œä¸ºå‚æ•°</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMatch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// éå† VolcanoRuleMatch ä¸­è®°å½•çš„ rels</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; rels.length; i++) &#123;</span><br><span class="line">            <span class="type">RelNode</span> <span class="variable">rel</span> <span class="operator">=</span> rels[i];</span><br><span class="line">            <span class="comment">// è·å–å¯¹åº”çš„ RelSubset</span></span><br><span class="line">            <span class="type">RelSubset</span> <span class="variable">subset</span> <span class="operator">=</span> volcanoPlanner.getSubset(rel);</span><br><span class="line">            <span class="comment">// æ£€æŸ¥ subset ä¸èƒ½ä¸ºç©ºï¼Œå¹¶è¾“å‡º debug æ—¥å¿—</span></span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// å°†å½“å‰çš„ VolcanoRuleCall æ·»åŠ åˆ° deque å¤´éƒ¨ï¼Œpush å†…éƒ¨è°ƒç”¨ addFirst</span></span><br><span class="line">        volcanoPlanner.ruleCallStack.push(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨ VolcanoRuleCall ä¸­ç¼“å­˜çš„ rule#onMatch æ–¹æ³•</span></span><br><span class="line">            getRule().onMatch(<span class="built_in">this</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// ä» ruleCallStack ä¸­å¼¹å‡ºé¦–ä¸ªå¯¹è±¡ï¼Œè°ƒç”¨ deque removeFirst æ–¹æ³•</span></span><br><span class="line">            volcanoPlanner.ruleCallStack.pop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Error while applying rule &quot;</span> + getRule() + <span class="string">&quot;, args &quot;</span> + Arrays.toString(rels), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ <code>EnumerableFilterRule</code> ä¸ºä¾‹ï¼ŒonMatch æ–¹æ³•ä¼šå…ˆè°ƒç”¨ <code>convert</code> æ–¹æ³•ï¼Œå°† LogicalFilter è½¬æ¢ä¸º EnumerableFilterï¼Œç„¶åè°ƒç”¨ transformTo æ–¹æ³•å¯¹ RelNode æ ‘è¿›è¡Œå˜æ¢ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMatch</span><span class="params">(RelOptRuleCall call)</span> &#123;</span><br><span class="line">    <span class="type">RelNode</span> <span class="variable">rel</span> <span class="operator">=</span> call.rel(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (rel.getTraitSet().contains(inTrait)) &#123;</span><br><span class="line">        <span class="comment">// å°† LogicalFilter è½¬æ¢ä¸º EnumerableFilter</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">RelNode</span> <span class="variable">converted</span> <span class="operator">=</span> convert(rel);</span><br><span class="line">        <span class="keyword">if</span> (converted != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨ transformTo æ–¹æ³•å¯¹ RelNode æ ‘è¿›è¡Œå˜æ¢</span></span><br><span class="line">            call.transformTo(converted);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>VolcanoRuleCall#transformTo</code> å®ç°é€»è¾‘å¦‚ä¸‹ï¼Œç”±äº EnumerableFilter æ˜¯è½¬æ¢çš„èŠ‚ç‚¹ï¼Œä¼šè°ƒç”¨ ensureRegistered æ–¹æ³•å¯¹è¯¥èŠ‚ç‚¹è¿›è¡Œé‡æ–°æ³¨å†Œï¼Œæ­¤æ—¶ä¼šè®¡ç®— EnumerableFilter çš„ä»£ä»·ï¼Œå¹¶æ›´æ–° RelSubset ä¸­è®°å½•çš„æœ€å°ä»£ä»·ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transformTo</span><span class="params">(RelNode rel, Map&lt;RelNode, RelNode&gt; equiv, RelHintsPropagator handler)</span> &#123;</span><br><span class="line">    <span class="comment">// å¯¹ Hint è¿›è¡Œå¤„ç†ï¼Œå°†åŸå§‹ RelNode çš„ Hint å¤åˆ¶åˆ°æ–°çš„ RelNode ä¸­</span></span><br><span class="line">    rel = handler.propagate(rels[<span class="number">0</span>], rel);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Registering the root relational expression implicitly registers</span></span><br><span class="line">        <span class="comment">// its descendants. Register any explicit equivalences first, so we</span></span><br><span class="line">        <span class="comment">// don&#x27;t register twice and cause churn.</span></span><br><span class="line">        <span class="comment">// éå†ç­‰ä»·é›†ï¼Œå¹¶è¿›è¡Œæ³¨å†Œï¼Œæœ¬æ¡ˆä¾‹ä¸­ EnumerableFilter ç­‰ä»·é›†åˆä¸ºç©º</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;RelNode, RelNode&gt; entry : equiv.entrySet()) &#123;</span><br><span class="line">            volcanoPlanner.ensureRegistered(entry.getKey(), entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ³¨å†Œ EnumerableFilter å¹¶é‡æ–°è®¡ç®—æœ€å°ä»£ä»·</span></span><br><span class="line">        <span class="type">RelSubset</span> <span class="variable">subset</span> <span class="operator">=</span> volcanoPlanner.ensureRegistered(rel, rels[<span class="number">0</span>]);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Error occurred while applying rule &quot;</span> + getRule(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å˜æ¢å®Œæˆå RelSubset æ ‘æ›´æ–°äº† bestCostï¼Œå¹¶ä¸” rels ä¸­åŒæ—¶è®°å½•äº† LogicalFilter å’Œ EnumerableFilterã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1704158875.png" title="EnumerableFilterRule å˜æ¢åç»“æ„"><h4 id="buildcheapestplan"><a class="markdownIt-Anchor" href="#buildcheapestplan"></a> buildCheapestPlan</h4><p>å˜æ¢å®Œæˆåï¼Œä¼šè°ƒç”¨ <code>RelSubset#buildCheapestPlan</code> æ–¹æ³•æ„å»ºä»£ä»·æœ€å°çš„æ‰§è¡Œè®¡åˆ’ï¼ŒbuildCheapestPlan æ–¹æ³•å®ç°é€»è¾‘å¦‚ä¸‹ï¼Œé¦–å…ˆä¼šåˆå§‹åŒ– CheapestPlanReplacer ç±»ï¼Œå®ƒè´Ÿè´£éå† RelSubset æ ‘å¹¶å°†æ¯ä¸ªèŠ‚ç‚¹æ›¿æ¢ä¸ºä»£ä»·æœ€å°çš„ RelNodeï¼Œéå†å®Œæˆåè¿”å›å…¨å±€æœ€å°ä»£ä»·çš„æ‰§è¡Œè®¡åˆ’ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Recursively builds a tree consisting of the cheapest plan at each node.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">RelNode <span class="title function_">buildCheapestPlan</span><span class="params">(VolcanoPlanner planner)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ ‘éå†å™¨ï¼Œä¼šéå† RelSubset æ ‘å¹¶è¿›è¡ŒèŠ‚ç‚¹æ›¿æ¢</span></span><br><span class="line">    <span class="type">CheapestPlanReplacer</span> <span class="variable">replacer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CheapestPlanReplacer</span>(planner);</span><br><span class="line">    <span class="comment">// Replacer å†…éƒ¨ç»´æŠ¤äº† final Map&lt;Integer, RelNode&gt; visited = new HashMap&lt;&gt;(); è®°å½•å½“å‰èŠ‚ç‚¹æ˜¯å¦éå†è¿‡</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">RelNode</span> <span class="variable">cheapest</span> <span class="operator">=</span> replacer.visit(<span class="built_in">this</span>, -<span class="number">1</span>, <span class="literal">null</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> cheapest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CheapestPlanReplacer#visit</code> æ˜¯å¤„ç†çš„æ ¸å¿ƒé€»è¾‘ï¼Œå…¶å®ç°ç»†èŠ‚å¦‚ä¸‹ï¼Œé¦–å…ˆä¼šæ ¹æ® RelNode çš„ Id æ ‡è¯†ä» visited ä¸­è·å–æœ€ä¼˜èŠ‚ç‚¹ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹å·²ç»éå†è¿‡åˆ™ä¼šç›´æ¥è¿”å›ã€‚å¦‚æœ visited ä¸­æœªåŒ…å«ï¼Œåˆ™ä¼šåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦ä¸º RelSubsetï¼Œæ¡ˆä¾‹ä¸­çš„èŠ‚ç‚¹å·²ç»éƒ½å˜æ¢ä¸º RelSubsetï¼Œå› æ­¤è¿™ä¸€æ­¥ä¼šæ‰¾å‡º RelSubset ä¸­çš„æœ€å°ä»£ä»· cheapest è¿›è¡Œæ›¿æ¢ã€‚ç„¶åä¼šç»§ç»­éå†å­èŠ‚ç‚¹å¯»æ‰¾ cheapest è¿›è¡Œæ›¿æ¢ï¼Œæ›¿æ¢åçš„å­èŠ‚ç‚¹ä¼šå’ŒåŸå­èŠ‚ç‚¹è¿›è¡Œæ¯”å¯¹ï¼Œä¸åŒåˆ™ä¼šå°†æ–°çš„å­èŠ‚ç‚¹å¤åˆ¶åˆ°å½“å‰èŠ‚ç‚¹ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RelNode <span class="title function_">visit</span><span class="params">(RelNode p, <span class="type">int</span> ordinal, <span class="meta">@Nullable</span> RelNode parent)</span> &#123;</span><br><span class="line">    <span class="comment">// æ¯ä¸€ä¸ª RelNode éƒ½æœ‰ä¸ªå”¯ä¸€ Id</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">pId</span> <span class="operator">=</span> p.getId();</span><br><span class="line">    <span class="comment">// ä» visited ä¸­è·å–å½“å‰èŠ‚ç‚¹æ˜¯å¦å·²ç»éå†è¿‡ï¼Œå¦‚æœéå†è¿‡åˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="type">RelNode</span> <span class="variable">prevVisit</span> <span class="operator">=</span> visited.get(pId);</span><br><span class="line">    <span class="keyword">if</span> (prevVisit != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// return memoized result of previous visit if available</span></span><br><span class="line">        <span class="keyword">return</span> prevVisit;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰èŠ‚ç‚¹ä¸º RelSubsetï¼Œåˆ™è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (p <span class="keyword">instanceof</span> RelSubset) &#123;</span><br><span class="line">        <span class="type">RelSubset</span> <span class="variable">subset</span> <span class="operator">=</span> (RelSubset) p;</span><br><span class="line">        <span class="comment">// è·å– RelSubset ä¸­è®°å½•çš„æœ€ä¼˜ plan</span></span><br><span class="line">        <span class="type">RelNode</span> <span class="variable">cheapest</span> <span class="operator">=</span> subset.best;</span><br><span class="line">        <span class="keyword">if</span> (cheapest == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœè·å–ä¸åˆ°æœ€ä¼˜ planï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            ...</span><br><span class="line">            LOGGER.trace(<span class="string">&quot;Caught exception in class=&#123;&#125;, method=visit&quot;</span>, getClass().getName(), e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        p = cheapest;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ï¼Œè¿›è¡Œéå†å¤„ç†ï¼Œè·å–æœ€ä¼˜ plan</span></span><br><span class="line">    List&lt;RelNode&gt; oldInputs = p.getInputs();</span><br><span class="line">    List&lt;RelNode&gt; inputs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; oldInputs.size(); i++) &#123;</span><br><span class="line">        <span class="type">RelNode</span> <span class="variable">oldInput</span> <span class="operator">=</span> oldInputs.get(i);</span><br><span class="line">        <span class="comment">// éå†å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">RelNode</span> <span class="variable">input</span> <span class="operator">=</span> visit(oldInput, i, p);</span><br><span class="line">        inputs.add(input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ–°çš„å­èŠ‚ç‚¹å’Œè€çš„å­èŠ‚ç‚¹ä¸åŒï¼Œåˆ™å°†æ–°çš„å­èŠ‚ç‚¹å¤åˆ¶åˆ°å½“å‰èŠ‚ç‚¹ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (!inputs.equals(oldInputs)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">RelNode</span> <span class="variable">pOld</span> <span class="operator">=</span> p;</span><br><span class="line">        p = p.copy(p.getTraitSet(), inputs);</span><br><span class="line">        planner.provenanceMap.put(p, <span class="keyword">new</span> <span class="title class_">VolcanoPlanner</span>.DirectProvenance(pOld));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®°å½•åˆ° visited</span></span><br><span class="line">    visited.put(pId, p); <span class="comment">// memoize result for pId</span></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆï¼Œæˆ‘ä»¬å¾—åˆ°äº†å¦‚ä¸‹çš„æœ€ä¼˜æ‰§è¡Œè®¡åˆ’ï¼ŒCalcite æ‰§è¡Œå™¨ä¼šç”Ÿæˆæ‰§è¡Œä»£ç ï¼Œæ‰§è¡Œå¹¶è¿”å›æŸ¥è¯¢ç»“æœã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EnumerableFilter(condition=[=($1, &#x27;Alice&#x27;)])</span><br><span class="line">  CsvTableScan(table=[[SALES, EMPS]], fields=[[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]])</span><br></pre></td></tr></table></figure><h3 id="æ•´ä½“æµç¨‹æ€»ç»“"><a class="markdownIt-Anchor" href="#æ•´ä½“æµç¨‹æ€»ç»“"></a> æ•´ä½“æµç¨‹æ€»ç»“</h3><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/1704245597.png" title="VolcanoPlanner æ•´ä½“æµç¨‹"><p>å‰æ–‡æˆ‘ä»¬ä»¥ç®€å•çš„æŸ¥è¯¢è¯­å¥ä¸ºä¾‹ï¼Œä¸€èµ·æ¢ç©¶äº† VolcanoPlanner ä¼˜åŒ–å™¨å®ç°ç»†èŠ‚ï¼Œæƒ³å¿…å¤§å®¶é˜…è¯»å®Œä¸€å®šæœ‰æ‰€æ”¶è·ã€‚ä¸ºäº†åŠ æ·±å¤§å®¶å¯¹ä¼˜åŒ–å™¨çš„ç†è§£ï¼Œæœ€åæˆ‘ä»¬å†è¿›è¡Œä¸€äº›æ¢³ç†æ€»ç»“ï¼Œä¸Šå›¾å±•ç¤ºäº† VolcanoPlanner ä¼˜åŒ–å™¨çš„æ•´ä½“æµç¨‹ï¼Œæ€»ä½“ä¸Šå¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ol><li>ç¬¬ä¸€æ­¥ï¼šæ³¨å†Œä¼˜åŒ–å™¨è§„åˆ™ã€‚é€šè¿‡è°ƒç”¨ <code>addRule</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿå°†ä¼˜åŒ–å™¨è§„åˆ™æ³¨å†Œè¿›æ¥ï¼Œè¿™äº›è§„åˆ™ä¼šç»´æŠ¤åœ¨ VolcanoPlanner çš„ classOperands å¯¹è±¡ä¸­ï¼Œåç»­ç­›é€‰è§„åˆ™æ—¶ä¼šä»è¯¥å¯¹è±¡ä¸­è·å–è§„åˆ™ï¼›</li><li>ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ– <code>RelSubset</code>ã€‚è¿™æ­¥ä¼šéå†é€»è¾‘è®¡åˆ’æ ‘ï¼Œå°†æ¯ä¸ªèŠ‚ç‚¹æ³¨å†Œæˆä¸º RelSubset å¹¶ç»´æŠ¤èŠ‚ç‚¹çš„ä»£ä»·ä¿¡æ¯ï¼Œç„¶åå°†é€»è¾‘è®¡åˆ’æ ‘è½¬æ¢ä¸º RelSubset æ ‘ï¼ŒRelSubset å¯¹è±¡å…³è”äº†æ‰€å±çš„ <code>RelSet</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç»´æŠ¤äº†å½“å‰èŠ‚ç‚¹çš„ç­‰ä»·é›†åˆï¼ŒRelSubset ä¸­è®°å½•çš„æ˜¯å½“å‰å·²çŸ¥ä»£ä»·æœ€å°çš„å…³ç³»ä»£æ•°ã€‚<code>fireRules</code> æ–¹æ³•è´Ÿè´£ç­›é€‰è§„åˆ™ï¼Œä¼šå°†åŒ¹é…çš„è§„åˆ™æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼›</li><li>ç¬¬ä¸‰æ­¥ï¼šæŸ¥æ‰¾æœ€ä¼˜è®¡åˆ’ã€‚æ ¹æ®å‰æ–‡åˆå§‹åŒ–çš„ RelSubset æ ‘ä»¥åŠé˜Ÿåˆ—ä¸­è®°å½•çš„åŒ¹é…è§„åˆ™ï¼Œè¯¥æ­¥éª¤ä¼šè°ƒç”¨ <code>drive</code> æ–¹æ³•åº”ç”¨è§„åˆ™ï¼Œç„¶åé€šè¿‡ <code>onMatch</code> æ–¹æ³•å¯¹å…³ç³»ä»£æ•°è¿›è¡Œå˜æ¢ï¼Œå®Œæˆå˜æ¢åä¼šé‡æ–°è®¡ç®—ä»£ä»·ä¿¡æ¯ï¼Œå¹¶æ›´æ–° RelSubset å’Œ RelSet å¯¹è±¡ã€‚æœ€åä¼šè°ƒç”¨ buildCheapestPlan æ–¹æ³•ï¼Œä» RelSubset æ ‘ä¸­è·å–æ•´ä½“ä»£ä»·æœ€å°çš„æ‰§è¡Œè®¡åˆ’ã€‚</li></ol><h2 id="ç»“è¯­"><a class="markdownIt-Anchor" href="#ç»“è¯­"></a> ç»“è¯­</h2><p>æœ¬æ–‡é¦–å…ˆä»‹ç»äº† Volcano/Cascades ä¼˜åŒ–å™¨çš„ç†è®ºåŸºç¡€ï¼ŒVolcano ä¼˜åŒ–å™¨ç”Ÿæˆå™¨è®ºæ–‡ä¸­ä»‹ç»çš„ <code>Logical Algebra</code>ã€<code>Physical Algebra</code>ã€<code>Transformation Rule</code>ï¼Œä»¥åŠ Cascades ä¼˜åŒ–å™¨è®ºæ–‡ä¸­ä»‹ç»çš„ <code>Memo</code> æ•°æ®ç»“æ„ï¼Œ<code>Pattern</code> åŒ¹é…è§„åˆ™ç­‰æ¦‚å¿µåœ¨ Calcite VolcanoPlanner ä¸­éƒ½æœ‰ä½“ç°ï¼Œå¤§å®¶åœ¨é˜…è¯»ä»£ç æ—¶å¯ä»¥å‚è€ƒè®ºæ–‡ä¸­çš„æ¦‚å¿µè¿›è¡Œç†è§£ã€‚</p><p>ç„¶åä»‹ç»äº† VolcanoPlanner ä¸­çš„ä¸€äº›åŸºç¡€æ¦‚å¿µâ€”â€”RelNodeã€RelSet å’Œ RelSubsetï¼Œç†è§£äº†è¿™äº›æ¦‚å¿µå¯¹å­¦ä¹  VolcanoPlanner åŸç†éå¸¸æœ‰å¸®åŠ©ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å‚è€ƒäº† Julain åˆ†äº«çš„ <a target="_blank" rel="noopener" href="https://calcite.apache.org/community/#cost-based-query-optimization-in-apache-phoenix-using-apache-calcite">Cost-based Query Optimization in Apache Phoenix using Apache Calcite</a>ï¼Œæå‰äº†è§£äº† VolcanoPlanner çš„å¤„ç†æµç¨‹ï¼Œæ•´ä½“ä¸Šå¯¹ä¼˜åŒ–æµç¨‹æœ‰äº†ä¸€äº›äº†è§£ã€‚æœ€åï¼Œæœ¬æ–‡ç»“åˆä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹ï¼Œæ·±å…¥ Calcite æºç ç»†èŠ‚ï¼Œå¸¦é¢†å¤§å®¶ä¸€èµ·æ¢ç©¶äº†æ•´ä¸ªæµç¨‹ã€‚</p><p>é™äºæ–‡ç« çš„ç¯‡å¹…ä»¥åŠæ¡ˆä¾‹çš„é€‰æ‹©ï¼ŒVolcanoPlanner ä¼˜åŒ–å™¨çš„ä¸€äº›ç»†èŠ‚æœ¬æ–‡æ— æ³•å…¨é¢è¦†ç›–ï¼Œè¿˜è¯·å„ä½è¯»è€…å¤šå¤šåŒ…æ¶µã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°†å…³æ³¨ <strong>VolcanoPlanner ä¸­çš„ç»Ÿè®¡ä¿¡æ¯å’Œä»£ä»·æ¨¡å‹ï¼Œå¹¶ä¼šé€šè¿‡ä¸€ä¸ªå¤šè¡¨å…³è”æŸ¥è¯¢çš„æ¡ˆä¾‹ï¼Œä¸€èµ·æ¢ç©¶ä¸‹ VolcanoPlanner ä¼˜åŒ–å™¨æ˜¯å¦‚ä½•ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯å’Œä»£ä»·æ¨¡å‹è¿›è¡Œä»£ä»·è®¡ç®—ï¼Œåœ¨å¤šè¡¨å…³è”æŸ¥è¯¢ SQL ä¸­ï¼ŒVolcanoPlanner åˆä¼šä½¿ç”¨å“ªäº›ä¼˜åŒ–æ–¹å¼å¾—åˆ°æœ€ä¼˜æ‰§è¡Œè®¡åˆ’</strong>ã€‚æ¬¢è¿å¤§å®¶æŒç»­å…³æ³¨åç»­æ–‡ç« ï¼Œå¦‚æœæœ‰æ„Ÿå…´è¶£çš„é—®é¢˜ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶ç•™è¨€äº¤æµã€‚</p><div class="tag-plugin quot"><p class="content" type="text"><span class="empty"></span><span class="text">å†™åœ¨æœ€å</span><span class="empty"></span></p></div><p>ç¬”è€…å› ä¸ºå·¥ä½œåŸå› æ¥è§¦åˆ° Calciteï¼Œå‰æœŸå­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œæ·±æ„Ÿ Calcite å­¦ä¹ èµ„æ–™ä¹‹åŒ®ä¹ï¼Œå› æ­¤åˆ›å»ºäº† <a target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/group/51128414222814">Calcite ä»å…¥é—¨åˆ°ç²¾é€šçŸ¥è¯†æ˜Ÿçƒ</a>ï¼Œå¸Œæœ›èƒ½å¤Ÿå°†å­¦ä¹ è¿‡ç¨‹ä¸­çš„èµ„æ–™å’Œç»éªŒæ²‰æ·€ä¸‹æ¥ï¼Œä¸ºæ›´å¤šæƒ³è¦å­¦ä¹  Calcite çš„æœ‹å‹æä¾›ä¸€äº›å¸®åŠ©ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/deep-understand-of-apache-calcite-volcano-planner/202309210909027-20240207092016569.png" title="Calcite ä»å…¥é—¨åˆ°ç²¾é€š"><div class="tag-plugin quot"><p class="content" type="text"><span class="empty"></span><span class="text">æ¬¢è¿å…³æ³¨</span><span class="empty"></span></p></div><p>æ¬¢è¿å…³æ³¨ã€Œ<strong>ç«¯å°å¼ºçš„åšå®¢</strong>ã€å¾®ä¿¡å…¬ä¼—å·ï¼Œä¼šä¸å®šæœŸåˆ†äº«æ—¥å¸¸å­¦ä¹ å’Œå·¥ä½œç»éªŒï¼Œæ¬¢è¿å¤§å®¶å…³æ³¨äº¤æµã€‚</p><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/wechat/gongzhonghao.png" alt="å¾®ä¿¡å…¬ä¼—å·"></p><div class="article-footer fs14"><section id="references"><div class="header"><span>å‚è€ƒèµ„æ–™</span></div><div class="body"><ul><li class="post-title"><p><a target="_blank" rel="noopener" href="https://matt33.com/2019/03/17/apache-calcite-planner/">Apache Calcite ä¼˜åŒ–å™¨è¯¦è§£ï¼ˆäºŒï¼‰</a></p></li><li class="post-title"><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/640328243">ä¸‡å­—è¯¦è§£ Calcite Volcano ä¼˜åŒ–å™¨</a></p></li><li class="post-title"><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/283362100">Apache Calcite VolcanoPlanner ä¼˜åŒ–è¿‡ç¨‹è§£æ</a></p></li><li class="post-title"><p><a target="_blank" rel="noopener" href="https://aaaaaaron.github.io/2020/02/09/Calcite-Volcano-Planner/">Calcite Volcano Planner</a></p></li><li class="post-title"><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fxjwind/p/11325753.html">Calcite åˆ†æ - Volcano æ¨¡å‹</a></p></li><li class="post-title"><p><a target="_blank" rel="noopener" href="https://note.youdao.com/s/2FGoKAwV">Traditional Query Optimization</a></p></li><li class="post-title"><p><a target="_blank" rel="noopener" href="https://cn.pingcap.com/blog/tidb-cascades-planner/">æ­ç§˜ TiDB æ–°ä¼˜åŒ–å™¨ï¼šCascades Planner åŸç†è§£æ</a></p></li><li class="post-title"><p><a target="_blank" rel="noopener" href="https://15721.courses.cs.cmu.edu/spring2019/papers/22-optimizer1/graefe-icde1993.pdf">The Volcano Optimizer Generator: Extensibility and Efficient Search</a></p></li><li class="post-title"><p><a target="_blank" rel="noopener" href="https://15721.courses.cs.cmu.edu/spring2018/papers/15-optimizer1/graefe-ieee1995.pdf">The Cascades Framework for Query Optimization</a></p></li></ul></div></section><section id="license"><div class="header"><span>è®¸å¯åè®®</span></div><div class="body"><p>æœ¬æ–‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…</a> è®¸å¯åè®®ï¼Œæœªç»æˆæƒè¯·å‹¿è½¬è½½ã€‚</p></div></section><section id="share"><div class="header"><span>åˆ†äº«æ–‡ç« </span></div><div class="body"><div class="link"><input class="copy-area" readonly id="copy-link" value="https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner.html"></div><div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot;)"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg"></a><a class="social share-item weibo" target="_blank" rel="external nofollow noopener noreferrer" href="https://service.weibo.com/share/share.php?url=https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner.html&title=æ·±å…¥ç†è§£ Apache Calcite ValcanoPlanner ä¼˜åŒ–å™¨ - ç«¯å°å¼ºçš„åšå®¢&pics=/assets/blog/2022/04/05/1649126780.jpg&summary=
æ³¨æ„ï¼šæœ¬æ–‡åŸºäº Calcite 1.35.0 ç‰ˆæœ¬æºç è¿›è¡Œå­¦ä¹ ç ”ç©¶ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šå­˜åœ¨å®ç°é€»è¾‘å·®å¼‚ï¼Œå¯¹æºç æ„Ÿå…´è¶£çš„è¯»è€…è¯·æ³¨æ„ç‰ˆæœ¬é€‰æ‹©ã€‚

 å‰è¨€
åœ¨ä¸Šä¸€ç¯‡æ·±å…¥ç†è§£ Apache Calcite HepPlanner ä¼˜åŒ–å™¨ä¸€æ–‡ä¸­ï¼Œæˆ‘..."><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/80c07e4dbb303.svg"></a><a class="social share-item email" href="mailto:?subject=æ·±å…¥ç†è§£ Apache Calcite ValcanoPlanner ä¼˜åŒ–å™¨ - ç«¯å°å¼ºçš„åšå®¢&amp;body=https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner.html"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/a1b00e20f425d.svg"></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;å¤åˆ¶æˆåŠŸ&quot;)"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg"></a></div><div class="qrcode" id="qrcode-wechat" style="opacity:0;height:0"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=https://strongduanmu.com/blog/deep-understand-of-apache-calcite-volcano-planner.html"></div></div></section></div></article><div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">è¾ƒæ–°æ–‡ç« </div><a href="/blog/cornerstone-of-cbo-optimization-apache-calcite-statistics-and-cost-model.html">CBO ä¼˜åŒ–çš„åŸºçŸ³â€”â€”Apache Calcite ç»Ÿè®¡ä¿¡æ¯å’Œä»£ä»·æ¨¡å‹è¯¦è§£</a></div><div class="item" id="next"><div class="note">è¾ƒæ—©æ–‡ç« </div><a href="/blog/use-wireshark-to-solve-benchmarksql-exception-with-shardingsphere-proxy.html">ä½¿ç”¨ Wireshark è§£å†³ BenchmarkSQL å‹æµ‹ Proxy å¼‚å¸¸</a></div></section></div><div class="related-wrap md-text" id="comments"><section class="header cmt-title cap theme"><p>å¿«æ¥å‚ä¸è®¨è®ºå§~</p></section><section class="body cmt-body giscus"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg><div id="giscus" src="https://giscus.app/client.js" data-repo="strongduanmu/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkzNzQwMDk3Njg=" data-category="Announcements" data-category-id="DIC_kwDOFkrvqM4CZIsa" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div></section></div><footer class="page-footer footnote"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs15">åšå®¢</span><a href="/categories/">åˆ†ç±»</a><a href="/tags/">æ ‡ç­¾</a><a href="/archives/">å½’æ¡£</a></div><div class="sitemap-group"><span class="fs15">æ–‡æ¡£</span><a href="/wiki/calcite/background.html">Calcite</a><a href="/wiki/cmu_15_445/index.html">CMU 15-445</a><a href="/wiki/cmu_15_721/index.html">CMU 15-721</a></div><div class="sitemap-group"><span class="fs15">ä¾¿ç¬º</span><a href="/notes/">Common</a><a href="/notes/docker.html">Docker</a><a href="/notes/git.html">Git</a></div><div class="sitemap-group"><span class="fs15">æ›´å¤š</span><a href="/more/">å…³äº</a><a href="/more/news/">åŠ¨æ€</a></div></div><div class="text"><p>æœ¬ç«™ç”± <a target="_blank" rel="noopener" href="https://github.com/strongduanmu">@strongduanmu</a> ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> ä¸»é¢˜åˆ›å»ºï¼Œä½¿ç”¨ <a target="_blank" rel="noopener" href="https://vercel.com/">Vercel</a> ç½‘ç«™éƒ¨ç½²ã€‚<br>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚<br>æœ¬ç«™æ€»è®¿é—®é‡ <span id="vercount_value_site_pv"></span> æ¬¡ï¼Œæœ¬ç«™è®¿å®¢æ•° <span id="vercount_value_site_uv"></span> äººæ¬¡ã€‚</p></div></footer><div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right"><div class="widgets"><widget class="widget-wrapper tagcloud"><div class="widget-header dis-select"><span class="name">æ ‡ç­¾äº‘</span></div><div class="widget-body fs14"><a href="/tags/Antlr/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">Antlr</a> <a href="/tags/Calcite/" style="font-size:20px;color:#6f86d6" class="tag -10">Calcite</a> <a href="/tags/CentOS/" style="font-size:12px;color:#48c6ef" class="tag -0">CentOS</a> <a href="/tags/Charles/" style="font-size:12px;color:#48c6ef" class="tag -0">Charles</a> <a href="/tags/Distributed-Transaction/" style="font-size:12px;color:#48c6ef" class="tag -0">Distributed Transaction</a> <a href="/tags/Docker/" style="font-size:12px;color:#48c6ef" class="tag -0">Docker</a> <a href="/tags/FFmpeg/" style="font-size:12px;color:#48c6ef" class="tag -0">FFmpeg</a> <a href="/tags/GraalVM/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">GraalVM</a> <a href="/tags/In-Action/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">In Action</a> <a href="/tags/JVM/" style="font-size:17.33px;color:#629bde" class="tag -7">JVM</a> <a href="/tags/Java/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">Java</a> <a href="/tags/Java8/" style="font-size:12px;color:#48c6ef" class="tag -0">Java8</a> <a href="/tags/JavaCC/" style="font-size:12px;color:#48c6ef" class="tag -0">JavaCC</a> <a href="/tags/Kernel/" style="font-size:14.67px;color:#55b1e7" class="tag -3">Kernel</a> <a href="/tags/Linux/" style="font-size:12px;color:#48c6ef" class="tag -0">Linux</a> <a href="/tags/MySQL/" style="font-size:16px;color:#5ca6e3" class="tag -5">MySQL</a> <a href="/tags/Paper/" style="font-size:12px;color:#48c6ef" class="tag -0">Paper</a> <a href="/tags/PolarDB-X/" style="font-size:12px;color:#48c6ef" class="tag -0">PolarDB-X</a> <a href="/tags/Query-Optimization/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">Query Optimization</a> <a href="/tags/Remote-Debugging/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">Remote Debugging</a> <a href="/tags/SQLLine/" style="font-size:12px;color:#48c6ef" class="tag -0">SQLLine</a> <a href="/tags/SQLancer/" style="font-size:12px;color:#48c6ef" class="tag -0">SQLancer</a> <a href="/tags/ShardingSphere/" style="font-size:18.67px;color:#6991da" class="tag -8">ShardingSphere</a> <a href="/tags/Transaction/" style="font-size:12px;color:#48c6ef" class="tag -0">Transaction</a> <a href="/tags/VirtualBox/" style="font-size:12px;color:#48c6ef" class="tag -0">VirtualBox</a> <a href="/tags/Wireshark/" style="font-size:12px;color:#48c6ef" class="tag -0">Wireshark</a></div></widget><widget class="widget-wrapper markdown"><div class="widget-header dis-select"><span class="name">èµåŠ©å•†</span></div><div class="widget-body fs14"><p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9880881761323734" data-ad-slot="1987141063" data-ad-format="auto" data-full-width-responsive="true"></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></widget></div></aside><div class="float-panel blur"><button type="button" style="display:none" class="laptop-only rightbar-toggle mobile" onclick="sidebar.rightbar()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></button> <button type="button" style="display:none" class="mobile-only leftbar-toggle mobile" onclick="sidebar.leftbar()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg></button></div></div><div class="scripts"><script>let ctx={date_suffix:{just:"åˆšåˆš",min:"åˆ†é’Ÿå‰",hour:"å°æ—¶å‰",day:"å¤©å‰"},root:"/",tag_plugins:{chat:Object.assign({api:"https://siteinfo.listentothewind.cn/api/v1"})},search:{}};if((ctx.search.service="local_search")==ctx.search.service){let e=Object.assign({},'{"field":"all","path":"/search.json","content":true,"skip_search":null,"codeblock":true,"sort":"-date"}');ctx.search[ctx.search.service]=e}let def={avatar:"/assets/placeholder/avatar.svg",cover:"/assets/placeholder/cover.svg"},deps={jquery:"https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js",marked:"https://cdn.jsdelivr.net/npm/marked@13.0.1/lib/marked.umd.min.js"}</script><script>function RunItem(){function n(e,t){this.name=t||e.name,this.run=()=>{try{e()}catch(e){console.log(e)}}}this.list=[],this.start=()=>{for(var e=0;e<this.list.length;e++)this.list[e].run()},this.push=(e,t,r=!0)=>{let s=e,i=new n(s=r?()=>{utils.requestAnimationFrame(e)}:s,t);this.list.push(i)},this.remove=t=>{for(let e=0;e<this.list.length;e++)this.list[e].name==t&&this.list.splice(e,1)}}let utils={css:(e,t,r,s)=>{var i,n,a=window.document,o=a.createElement("link"),d=(n=t||(i=(a.body||a.getElementsByTagName("head")[0]).childNodes)[i.length-1],a.styleSheets);if(s)for(var l in s)s.hasOwnProperty(l)&&o.setAttribute(l,s[l]);o.rel="stylesheet",o.href=e,o.media="only x",function e(t){if(a.body)return t();setTimeout(function(){e(t)})}(function(){n.parentNode.insertBefore(o,t?n:n.nextSibling)});function u(e){for(var t=o.href,r=d.length;r--;)if(d[r].href===t)return e();setTimeout(function(){u(e)})}function h(){o.addEventListener&&o.removeEventListener("load",h),o.media=r||"all"}return o.addEventListener&&o.addEventListener("load",h),o.onloadcssdefined=u,u(h),o},js:(i,n)=>new Promise((t,e)=>{var r=document.createElement("script");if(i.startsWith("/")&&(i=ctx.root+i.substring(1)),r.src=i,n)for(var s of Object.keys(n))r[s]=n[s];else r.async=!0;r.onerror=e,r.onload=r.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(r.onload=r.onreadystatechange=null,t())},document.head.appendChild(r)}),jq:e=>{"undefined"==typeof jQuery?utils.js(deps.jquery).then(e):e()},onLoading:e=>{e&&$(e).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>')},onLoadSuccess:e=>{e&&$(e).find(".loading-wrap").remove()},onLoadFailure:e=>{e&&($(e).find(".loading-wrap svg").remove(),$(e).find(".loading-wrap").append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>'),$(e).find(".loading-wrap").addClass("error"))},request:(n,a,o,d)=>{let l=3;utils.onLoading(n),function i(){new Promise((t,e)=>{let r=0,s=setTimeout(()=>{0===r&&(r=2,s=null,e("è¯·æ±‚è¶…æ—¶"),0==l)&&d()},5e3);fetch(a).then(function(e){if(2!==r&&(clearTimeout(s),t(e),s=null,r=1),e.ok)return e.json();throw new Error("Network response was not ok.")}).then(function(e){l=0,utils.onLoadSuccess(n),o(e)}).catch(function(e){0<l?(--l,setTimeout(()=>{i()},5e3)):(utils.onLoadFailure(n),d())})})}()},requestAnimationFrame:e=>{window.requestAnimationFrame||(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame),window.requestAnimationFrame(e)},dark:{}};utils.dark.method={toggle:new RunItem},utils.dark=Object.assign(utils.dark,{push:utils.dark.method.toggle.push})</script><script>let sidebar={leftbar:()=>{l_body&&(l_body.toggleAttribute("leftbar"),l_body.removeAttribute("rightbar"))},rightbar:()=>{l_body&&(l_body.toggleAttribute("rightbar"),l_body.removeAttribute("leftbar"))},dismiss:()=>{l_body&&(l_body.removeAttribute("leftbar"),l_body.removeAttribute("rightbar"))},toggleTOC:()=>{document.querySelector("#data-toc").classList.toggle("collapse")}}</script><script>(()=>{var e;for(e of document.querySelectorAll(".tag-subtree.parent-tag > a > .tag-switcher-wrapper"))e.addEventListener("click",e=>{e.target.closest(".tag-subtree.parent-tag").classList.toggle("expanded"),e.preventDefault()});var t=new URLSearchParams(window.location.search).get("tag");if(t){let e=document.querySelector(`.tag-subtree[data-tag="${t}"]`);if(e)for(e.querySelector("a").classList.add("active");e;)e.classList.add("expanded"),e=e.parentElement.closest(".tag-subtree.parent-tag")}})()</script><script src="/js/main.js?v=1.30.1" defer></script><script>let applyTheme=e=>{"auto"===e?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme",e),applyThemeToGiscus(e)},applyThemeToGiscus=e=>{e="auto"===e?"preferred_color_scheme":e;var t=document.getElementById("giscus"),t=(t&&t.setAttribute("data-theme",e),document.querySelector("#comments > section.giscus > iframe"));t&&(e=t.src.replace(/theme=[\w]+/,"theme="+e),t.src=e)},switchTheme=()=>{let e;switch(document.documentElement.getAttribute("data-theme")){case"light":e="dark";break;case"dark":e="auto";break;default:e="light"}applyTheme(e),window.localStorage.setItem("Stellar.theme",e),utils.dark.mode="auto"===e?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e,utils.dark.method.toggle.start(),hud?.toast?.({light:"åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼",dark:"åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼",auto:"åˆ‡æ¢åˆ°è·Ÿéšç³»ç»Ÿé…è‰²"}[e])};(()=>{var e=window.localStorage.getItem("Stellar.theme");null!==e?applyTheme(e):utils.dark.mode=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",utils.dark.method.toggle.start()})()</script><script type="module">const el = document.querySelector('#comments #giscus');
  util.viewportLazyload(el, load_discus, false);

  function load_discus() {
    if (!el) return;
    try {
        el.innerHTML = '';
      } catch (error) {
        console.error(error);
      }
      const script = document.createElement('script');
      script.async = true;
      for (const key of Object.keys(el.attributes)) {
        const attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
  }</script><script defer>window.addEventListener("DOMContentLoaded",e=>{ctx.services=Object.assign({},JSON.parse('{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"}}'));for(let s of Object.keys(ctx.services)){let e=ctx.services[s].js;"siteinfo"==s?(ctx.cardlinks=document.querySelectorAll("a.link-card[cardlink]"),0<ctx.cardlinks?.length&&utils.js(e,{defer:!0}).then(function(){setCardLink(ctx.cardlinks)})):"voice"==s?(ctx.voiceAudios=document.querySelectorAll(".voice>audio"),0<ctx.voiceAudios?.length&&utils.js(e,{defer:!0}).then(function(){createVoiceDom(ctx.voiceAudios)})):"video"==s?(ctx.videos=document.querySelectorAll(".video>video"),0<ctx.videos?.length&&utils.js(e,{defer:!0}).then(function(){videoEvents(ctx.videos)})):"download-file"==s?(ctx.files=document.querySelectorAll(".file"),0<ctx.files?.length&&utils.js(e,{defer:!0}).then(function(){downloadFileEvent(ctx.files)})):0<document.getElementsByClassName("ds-"+s)?.length&&utils.jq(()=>{s,utils.js(deps.marked).then(function(){utils.js(e,{defer:!0})})})}let n=document.querySelectorAll(".chat .status-bar .time");var s,t;function i(){for(let e=0;e<n.length;++e){var s=n[e],t=new Date,i=t.getHours(),t=t.getMinutes();s.innerHTML=o(i)+":"+o(t)}}function o(e){return e<10?"0"+e:e}0<n.length&&(i(),s=(new Date).getSeconds(),t=setInterval(function(){i(),clearInterval(t),setInterval(i,6e4)},1e3*(60-s)));let c=new IntersectionObserver((e,t)=>{e.filter(e=>e.isIntersecting).sort((e,s)=>e.intersectionRect.y!==s.intersectionRect.y?e.intersectionRect.y-s.intersectionRect.y:e.intersectionRect.x-s.intersectionRect.x).forEach((e,s)=>{t.unobserve(e.target),setTimeout(()=>{e.target.classList.add("quote-blink"),setTimeout(()=>{e.target.classList.remove("quote-blink")},1e3)},Math.max(100,16)*(s+1))})}),r=document.querySelectorAll(".chat .talk .quote");r.forEach(i=>{i.addEventListener("click",function(){var e,s,t=document.getElementById("quote-"+i.getAttribute("quotedCellTag"));t&&(s=(e=t.parentElement).clientHeight/2,t.offsetTop>s-t.clientHeight/2?e.scrollTo({top:t.offsetTop-s+t.clientHeight/2,behavior:"smooth"}):e.scrollTo({top:0,behavior:"smooth"}),c.observe(t))})})})</script><script>window.addEventListener("DOMContentLoaded",e=>{ctx.search={path:"/search.json"},utils.js("/js/search/local-search.js",{defer:!0})})</script><script>window.FPConfig={delay:0,ignoreKeywords:[],maxRPS:5,hoverDelay:25}</script><script defer src="/js/flying-pages.min.js"></script><script defer src="/js/lazyload.min.js"></script><script>window.lazyLoadOptions={elements_selector:".lazy"},window.addEventListener("LazyLoad::Initialized",function(n){window.lazyLoadInstance=n.detail.instance},!1),document.addEventListener("DOMContentLoaded",function(){window.lazyLoadInstance?.update()})</script><script>ctx.fancybox={selector:"article.md-text img:not(.post-cover img):not(.cover img):not(.card-link img):not(.image-bg img):not(.social img):not(.preview img)",css:"/css/fancybox.min.css",js:"/js/fancybox.umd.min.js"};var selector="[data-fancybox]:not(.error)",needFancybox=(ctx.fancybox.selector&&(selector+=", "+ctx.fancybox.selector),0!==document.querySelectorAll(selector).length);if(!needFancybox){let e=document.getElementsByClassName("ds-memos");null!=e&&0<e.length&&(needFancybox=!0)}needFancybox&&(utils.css(ctx.fancybox.css),utils.js(ctx.fancybox.js,{defer:!0}).then(function(){Fancybox.bind(selector,{hideScrollbar:!1,Thumbs:{autoStart:!1},caption:(e,t)=>t.triggerEl.alt||t.triggerEl.dataset.caption||null})}))</script><script>window.addEventListener("DOMContentLoaded",e=>{let i=document.getElementById("swiper-api");null!=i&&(utils.css("/css/swiper-bundle.min.css"),utils.js("/js/swiper-bundle.min.js",{defer:!0}).then(function(){var e=i.getAttribute("effect")||"";new Swiper(".swiper#swiper-api",{slidesPerView:"auto",spaceBetween:8,centeredSlides:!0,effect:e,rewind:!0,pagination:{el:".swiper-pagination",clickable:!0},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"}})}))})</script><script>document.addEventListener("DOMContentLoaded",function(){window.codeElements=document.querySelectorAll(".code"),0<window.codeElements.length&&(ctx.copycode={default_text:"å¤åˆ¶ä»£ç ",success_text:"å¤åˆ¶æˆåŠŸ",toast:"å¤åˆ¶æˆåŠŸ"},utils.js("/js/plugins/copycode.js"))})</script><script async>((a,t,c)=>{t.ChatraID="PHWnu7Bamcwtbnx2d";var h=a.createElement("script");t[c]=t[c]||function(){(t[c].q=t[c].q||[]).push(arguments)},h.async=!0,h.src="https://call.chatra.io/chatra.js",a.head&&a.head.appendChild(h)})(document,window,"Chatra")</script><script defer src="https://cn.vercount.one/js"></script><link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"></noscript><script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous" onload="renderMathInElement(document.body)"></script><script>window.va=window.va||function(){(window.vaq=window.vaq||[]).push(arguments)}</script><script defer src="/_vercel/insights/script.js"></script><script>window.si=window.si||function(){(window.siq=window.siq||[]).push(arguments)}</script><script defer src="/_vercel/speed-insights/script.js"></script><script>function change_banner(){$(".banner img.bg").attr("src","/assets/banner/banner_"+Math.floor(20*Math.random()+1)+".jpg")}setTimeout("change_banner()",250)</script><script>function add_page_pv(){$("#post-meta").after('<div class="flex-row" id="post-meta"><span class="text created">æœ¬æ–‡æ€»é˜…è¯»é‡ <span id="vercount_value_page_pv"></span> æ¬¡</span></div>')}setTimeout("add_page_pv()",500)</script><script>function change_img_alt(){$("article.md-text img:not(.post-cover img):not(.cover img):not(.card-link img):not(.image-bg img):not(.social img):not(.preview img)").each(function(t){$(this).after("<div class='image-meta' style='text-align:center;'><span class='image-caption center' style='display:inline-block;font-size:.8125rem;color:var(--text-p2);line-height:1.5;text-align:justify;'>"+($(this).attr("title")||$(this).attr("alt"))+"</span></div>")})}setTimeout("change_img_alt()",1e3)</script></div></body></html>