<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.30.1" theme-name="Stellar" theme-version="1.30.1"><meta name="generator" content="Hexo 7.3.0"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin><link rel="preconnect" href="https://googleads.g.doubleclick.net" crossorigin><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="theme-color" content="#f9fafb"><title>Apache Calcite Catalog æ‹¾é—ä¹‹ UDF å‡½æ•°å®ç°å’Œæ‰©å±• - ç«¯å°å¼ºçš„åšå®¢</title><meta name="description" content="æ³¨æ„ï¼šæœ¬æ–‡åŸºäº Calcite main åˆ†æ”¯ 60e0a3f ç‰ˆæœ¬æºç è¿›è¡Œå­¦ä¹ ç ”ç©¶ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šå­˜åœ¨å®ç°é€»è¾‘å·®å¼‚ï¼Œå¯¹æºç æ„Ÿå…´è¶£çš„è¯»è€…è¯·æ³¨æ„ç‰ˆæœ¬é€‰æ‹©ã€‚   å‰è¨€ æœ€è¿‘ï¼Œå¾ˆå¤šæœ‹å‹å’¨è¯¢å…³äº Calcite UDF å®ç°å’Œæ‰©å±•çš„é—®é¢˜ï¼Œåœ¨ä¹‹å‰ Apache Calcite System Catalog å®ç°æ¢ç©¶ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬ç®€å•ä»‹ç»è¿‡ Catalog ä¸­çš„ Function å¯¹è±¡ï¼Œä¹Ÿäº†è§£åˆ° Calcit"><meta property="og:type" content="article"><meta property="og:title" content="Apache Calcite Catalog æ‹¾é—ä¹‹ UDF å‡½æ•°å®ç°å’Œæ‰©å±•"><meta property="og:url" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension.html"><meta property="og:site_name" content="ç«¯å°å¼ºçš„åšå®¢"><meta property="og:description" content="æ³¨æ„ï¼šæœ¬æ–‡åŸºäº Calcite main åˆ†æ”¯ 60e0a3f ç‰ˆæœ¬æºç è¿›è¡Œå­¦ä¹ ç ”ç©¶ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šå­˜åœ¨å®ç°é€»è¾‘å·®å¼‚ï¼Œå¯¹æºç æ„Ÿå…´è¶£çš„è¯»è€…è¯·æ³¨æ„ç‰ˆæœ¬é€‰æ‹©ã€‚   å‰è¨€ æœ€è¿‘ï¼Œå¾ˆå¤šæœ‹å‹å’¨è¯¢å…³äº Calcite UDF å®ç°å’Œæ‰©å±•çš„é—®é¢˜ï¼Œåœ¨ä¹‹å‰ Apache Calcite System Catalog å®ç°æ¢ç©¶ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬ç®€å•ä»‹ç»è¿‡ Catalog ä¸­çš„ Function å¯¹è±¡ï¼Œä¹Ÿäº†è§£åˆ° Calcit"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/calcite-function-inherit-class.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/scalar-function-inherit-class.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/aggregate-function-inherit-class.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/table-function-marco-inherit-class.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/function-parse-result.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/validated-sql-node.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/sql-operator-function-inherited-class.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/convertlet_table_map.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/concat_ws_function_call.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/select-user-defined-function-parse-result.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/lookup-user-defined-function.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/implement-scalar-function.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/udf-without-parentheses.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/udtf-parse-result.png"><meta property="og:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/validated-udtf-sqlnode.png"><meta property="og:image" content="https://strongduanmu.com/assets/xingqiu/calcite_xingqiu.png"><meta property="og:image" content="https://strongduanmu.com/assets/wechat/gongzhonghao.png"><meta property="article:published_time" content="2024-09-23T00:00:00.000Z"><meta property="article:modified_time" content="2024-10-23T00:00:00.000Z"><meta property="article:author" content="ç«¯å°å¼º"><meta property="article:tag" content="Calcite"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension/calcite-function-inherit-class.png"><meta name="twitter:creator" content="@strongduanmu"><meta name="keywords" content="Calcite"><link rel="alternate" href="/atom.xml" title="ç«¯å°å¼ºçš„åšå®¢" type="application/atom+xml"><link rel="stylesheet" href="/css/main.css?v=1.30.1"><link rel="shortcut icon" href="/assets/placeholder/favicon.ico"><meta name="baidu-site-verification" content="codeva-sIRwgTpHve"><link rel="apple-touch-icon" sizes="180x180" href="/assets/placeholder/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/placeholder/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/placeholder/favicon-16x16.png"><link rel="manifest" href="/assets/placeholder/site.webmanifest"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/lxgwwenkaimono-bold.css" media="print" onload='this.media="all"'><noscript><link rel="stylesheet" href="/css/lxgwwenkaimono-bold.css"></noscript><link rel="stylesheet" href="/css/lxgwwenkaiscreen.css" media="print" onload='this.media="all"'><noscript><link rel="stylesheet" href="/css/lxgwwenkaiscreen.css"></noscript><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="preconnect" href="https://pagead2.googlesyndication.com"><link rel="dns-prefetch" href="https://pagead2.googlesyndication.com"><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9880881761323734" crossorigin="anonymous"></script><script src="/js/plugins/article-bottom-ad.js"></script><script src="/js/plugins/sticky-adsense.js"></script><script src="/js/plugins/adblock-detector.js"></script><style>.widget-wrapper.adsense{background:0 0!important}.widget-wrapper.adsense .widget-body{padding:0!important;background:0 0!important}.widget-wrapper.adsense .widget-body p{margin:0!important}.widget-wrapper.adsense ins.adsbygoogle{display:block;border-radius:12px;overflow:hidden}.article-bottom-ad{margin:2rem 0;padding:1rem;text-align:center}.article-bottom-ad .ad-container{max-width:100%;margin:0 auto}.article-bottom-ad ins.adsbygoogle{display:block;background:0 0}</style></head><body><div class="l_body content tech" id="start" layout="post"><aside class="l_left"><div class="leftbar-container"><header class="header"><div class="logo-wrap"><a class="avatar" href="/more/"><div class="bg" style="opacity:0;background-image:url(/assets/placeholder/rainbow64@3x.webp)"></div><img no-lazy class="avatar" src="/assets/placeholder/avatar.png" onerror="javascript:this.classList.add('error');this.src='/assets/placeholder/image.svg';"></a><a class="title" href="/"><div class="main" ff="title">ç«¯å°å¼ºçš„åšå®¢</div><div class="sub normal cap">ä¸ç§¯è·¬æ­¥ï¼Œæ— ä»¥è‡³åƒé‡Œ ğŸ¤”</div><div class="sub hover cap" style="opacity:0">ä¸ç§¯å°æµï¼Œæ— ä»¥æˆæ±Ÿæµ· ğŸ˜ƒ</div></a></div></header><div class="nav-area"><div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="ç«™å†…æœç´¢"></form><div id="search-result"></div><div class="search-no-result">æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼</div></div><nav class="menu dis-select"><a class="nav-item active" title="åšå®¢" href="/"><span>åšå®¢</span></a><a class="nav-item" title="æ–‡æ¡£" href="/wiki/"><span>æ–‡æ¡£</span></a><a class="nav-item" title="ä¾¿ç¬º" href="/notes/"><span>ä¾¿ç¬º</span></a><a class="nav-item" title="æ›´å¤š" href="/more/"><span>æ›´å¤š</span></a></nav></div><div class="widgets"><widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">æœ¬æ–‡ç›®å½•</span><a class="cap-action" onclick="sidebar.toggleTOC()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#calcite-%E5%87%BD%E6%95%B0%E7%AE%80%E4%BB%8B"><span class="toc-text">Calcite å‡½æ•°ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E6%8E%A2%E7%A9%B6"><span class="toc-text">å†…ç½®å‡½æ•°å®ç°æ¢ç©¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E9%87%8F%E5%87%BD%E6%95%B0"><span class="toc-text">æ ‡é‡å‡½æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="toc-text">èšåˆå‡½æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E5%87%BD%E6%95%B0-%E8%A1%A8%E5%AE%8F"><span class="toc-text">è¡¨å‡½æ•° &amp; è¡¨å®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">å‡½æ•°æ‰§è¡Œæµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sqlvalidator-%E5%87%BD%E6%95%B0%E6%B3%A8%E5%86%8C"><span class="toc-text">SqlValidator å‡½æ•°æ³¨å†Œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%90%E5%92%8C%E6%A0%A1%E9%AA%8C"><span class="toc-text">å‡½æ•°è§£æå’Œæ ¡éªŒ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sql-%E4%BC%98%E5%8C%96%E5%92%8C%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C"><span class="toc-text">SQL ä¼˜åŒ–å’Œå‡½æ•°æ‰§è¡Œ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#udf-%E5%87%BD%E6%95%B0%E6%89%A9%E5%B1%95%E5%AE%9E%E8%B7%B5"><span class="toc-text">UDF å‡½æ•°æ‰©å±•å®è·µ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#udf-%E6%A0%87%E9%87%8F%E5%87%BD%E6%95%B0%E6%89%A9%E5%B1%95"><span class="toc-text">UDF æ ‡é‡å‡½æ•°æ‰©å±•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#udaf-%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0%E6%89%A9%E5%B1%95"><span class="toc-text">UDAF èšåˆå‡½æ•°æ‰©å±•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#udtf-%E8%A1%A8%E5%87%BD%E6%95%B0-%E8%A1%A8%E5%AE%8F%E6%89%A9%E5%B1%95"><span class="toc-text">UDTF è¡¨å‡½æ•° &amp; è¡¨å®æ‰©å±•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-text">ç»“è¯­</span></a></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>å›åˆ°é¡¶éƒ¨</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>å‚ä¸è®¨è®º</span></a></div></widget><widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">ä¸“æ ï¼šCalcite</span></div><div class="widget-body"><a class="item" href="/blog/speed-up-by-100x-shardingsphere-sql-federation-in-predicate-deep-optimization-practice.html"><span class="title">ç™¾å€æé€Ÿï¼ShardingSphere è”é‚¦æŸ¥è¯¢æ‰¹é‡ IN æŸ¥è¯¢æ·±åº¦ä¼˜åŒ–</span></a><a class="item" href="/blog/analyze-wrong-result-for-shardingsphere-sql-federation-grouping-function.html"><span class="title">ShardingSphere è”é‚¦æŸ¥è¯¢ GROUPING èšåˆç»“æœé—®é¢˜åˆ†æ</span></a><a class="item" href="/blog/apache-calcite-catalog-type-system-implementation.html"><span class="title">Apache Calcite Catalog æ‹¾é—ä¹‹ç±»å‹ç³»ç»Ÿå®ç°</span></a><a class="item" href="/blog/using-calcite-as-an-example-to-explore-the-common-implementation-of-join-operators.html"><span class="title">ä»¥ Calcite ä¸ºä¾‹æ¢ç©¶ Join ç®—å­çš„å¸¸ç”¨å®ç°</span></a><a class="item" href="/blog/explore-the-practice-of-apache-calcite-in-mycat2.html"><span class="title">Apache Calcite åœ¨ MyCat2 ä¸­çš„å®è·µæ¢ç©¶</span></a><a class="item" href="/blog/calcite-udf-in-action-shardingsphere-sql-federation-adapte-to-mysql-bit-count.html"><span class="title">Calcite UDF å®æˆ˜ä¹‹ ShardingSphere è”é‚¦æŸ¥è¯¢é€‚é… MySQL BIT_COUNT</span></a><a class="item active" href="/blog/apache-calcite-catalog-udf-function-implementation-and-extension.html"><span class="title">Apache Calcite Catalog æ‹¾é—ä¹‹ UDF å‡½æ•°å®ç°å’Œæ‰©å±•</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a><a class="item" href="/blog/in-depth-exploration-of-implementation-principle-of-apache-calcite-sql-validator.html"><span class="title">æ·±åº¦æ¢ç©¶ Apache Calcite SQL æ ¡éªŒå™¨å®ç°åŸç†</span></a><a class="item" href="/blog/cornerstone-of-cbo-optimization-apache-calcite-statistics-and-cost-model.html"><span class="title">CBO ä¼˜åŒ–çš„åŸºçŸ³â€”â€”Apache Calcite ç»Ÿè®¡ä¿¡æ¯å’Œä»£ä»·æ¨¡å‹è¯¦è§£</span></a><a class="item" href="/blog/deep-understand-of-apache-calcite-volcano-planner.html"><span class="title">æ·±å…¥ç†è§£ Apache Calcite ValcanoPlanner ä¼˜åŒ–å™¨</span></a><a class="item" href="/blog/deep-understand-of-apache-calcite-hep-planner.html"><span class="title">æ·±å…¥ç†è§£ Apache Calcite HepPlanner ä¼˜åŒ–å™¨</span></a><a class="item" href="/blog/explore-apache-calcite-system-catalog-implementation.html"><span class="title">Apache Calcite System Catalog å®ç°æ¢ç©¶</span></a><a class="item" href="/blog/implementation-principle-of-apache-calcite-sql-parser.html"><span class="title">Apache Calcite SQL Parser åŸç†å‰–æ</span></a><a class="item" href="/blog/apache-calcite-quick-start-guide.html"><span class="title">Apache Calcite å¿«é€Ÿå…¥é—¨æŒ‡å—</span></a><a class="item" href="/blog/apache-calcite-learning-materials.html"><span class="title">Apache Calcite å­¦ä¹ èµ„æ–™æ•´ç†</span></a></div></widget></div><footer class="footer dis-select"><div class="social-wrap"><a class="social" href="mailto:duanzhengqiang@apache.org" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/email.svg"></a><a class="social" href="https://github.com/strongduanmu" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/github.svg"></a><a class="social" href="/sitemap.xml" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/sitemap.svg"></a><a class="social" href="/atom.xml" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/rss.svg"></a></div></footer></div></aside><div class="l_main" id="main"><div class="article banner top"><img class="bg lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/banner/banner_9.jpg"><div class="content"><div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">ä¸»é¡µ</a> <span class="sep"></span><a class="cap breadcrumb" id="menu" href="/topic">ä¸“æ </a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/blog/speed-up-by-100x-shardingsphere-sql-federation-in-predicate-deep-optimization-practice.html">Calcite</a></div><div class="flex-row" id="post-meta"><span class="text created">å‘å¸ƒäºï¼š<time datetime="2024-09-23T00:00:00.000Z">2024-09-23</time></span><span class="sep updated"></span><span class="text updated">æ›´æ–°äºï¼š<time datetime="2024-10-23T00:00:00.000Z">2024-10-23</time></span></div></div></div><div class="bottom only-title"><div class="text-area"><h1 class="text title"><span>Apache Calcite Catalog æ‹¾é—ä¹‹ UDF å‡½æ•°å®ç°å’Œæ‰©å±•</span></h1></div></div></div></div><article class="md-text content"><blockquote><p>æ³¨æ„ï¼šæœ¬æ–‡åŸºäº <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/commit/60e0a3f441a009e55a36cac192253a436bec3f6d">Calcite main åˆ†æ”¯ 60e0a3f</a> ç‰ˆæœ¬æºç è¿›è¡Œå­¦ä¹ ç ”ç©¶ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šå­˜åœ¨å®ç°é€»è¾‘å·®å¼‚ï¼Œå¯¹æºç æ„Ÿå…´è¶£çš„è¯»è€…<strong>è¯·æ³¨æ„ç‰ˆæœ¬é€‰æ‹©</strong>ã€‚</p></blockquote><h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2><p>æœ€è¿‘ï¼Œå¾ˆå¤šæœ‹å‹å’¨è¯¢å…³äº <code>Calcite UDF</code> å®ç°å’Œæ‰©å±•çš„é—®é¢˜ï¼Œåœ¨ä¹‹å‰ <a href="https://strongduanmu.com/blog/explore-apache-calcite-system-catalog-implementation.html">Apache Calcite System Catalog å®ç°æ¢ç©¶</a>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬ç®€å•ä»‹ç»è¿‡ <code>Catalog</code> ä¸­çš„ <code>Function</code> å¯¹è±¡ï¼Œä¹Ÿäº†è§£åˆ° Calcite å†…ç½®äº†å¾ˆå¤šå‡½æ•°å®ç°ï¼Œä½†åœ¨å®é™…ä½¿ç”¨ä¸­å†…ç½®å‡½æ•°å¾€å¾€æ— æ³•æ»¡è¶³è¦æ±‚ï¼Œç”¨æˆ·éœ€è¦èƒ½å¤Ÿæ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œçµæ´»åœ°æ³¨å†Œæ–°çš„å‡½æ•°ã€‚Caclite å…è®¸ç”¨æˆ·åŠ¨æ€æ³¨å†Œ UDF å‡½æ•°ï¼Œä»è€Œå®ç°æ›´åŠ å¤æ‚çš„ SQL é€»è¾‘ï¼Œä¸‹é¢æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ Calcite å‡½æ•°çš„å®ç°åŸç†ï¼Œä»¥åŠ UDF å‡½æ•°çš„æ‰©å±•æ–¹å¼ï¼Œå¸®åŠ©å¤§å®¶æ›´å¥½åœ°åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ Calcite UDFã€‚</p><h2 id="calcite-å‡½æ•°ç®€ä»‹"><a class="markdownIt-Anchor" href="#calcite-å‡½æ•°ç®€ä»‹"></a> Calcite å‡½æ•°ç®€ä»‹</h2><p>åœ¨æ—¥å¸¸å¼€å‘ã€æ•°æ®åˆ†æå·¥ä½œä¸­ï¼Œæˆ‘ä»¬é™¤äº†ä¼šä½¿ç”¨å¸¸ç”¨çš„ SQL è¯­å¥å¤–ï¼Œè¿˜ä¼šç»å¸¸ç”¨åˆ°å‡½æ•°æ¥å®ç°ä¸€äº›ç‰¹æ®ŠåŠŸèƒ½ï¼Œå‡½æ•°åŠŸèƒ½çš„å¼ºå¼±ç›´æ¥ä¼šå½±å“æˆ‘ä»¬çš„å¼€å‘æ•ˆç‡ã€‚Calcite ä½œä¸ºå½“å‰æµè¡Œçš„è®¡ç®—å¼•æ“ï¼Œå¯¹å‡½æ•°åŠŸèƒ½ä¹Ÿæœ‰è¾ƒå¥½çš„æ”¯æŒï¼Œå®ƒå†…ç½®äº†ä¸åŒæ•°æ®åº“çš„ä¸Šç™¾ç§å¸¸ç”¨å‡½æ•°ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨æ‰§è¡Œã€‚æ­¤å¤–ï¼ŒCalcite ä¹Ÿæä¾›äº† UDF è‡ªå®šä¹‰å‡½æ•°èƒ½åŠ›ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ Schema æ³¨å†Œ UDFï¼Œä»è€Œå®ç°æ›´çµæ´»åœ° SQL è¿ç®—é€»è¾‘ã€‚</p><p>åœ¨äº†è§£ UDF å‡½æ•°å®ç°å’Œæ‰©å±•å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹ Calcite å‡½æ•°çš„åŸºæœ¬æ¦‚å¿µã€‚Calcite å¯¹å‡½æ•°çš„å®šä¹‰æ˜¯ï¼š<strong>æ¥å—å‚æ•°å¹¶è¿”å›ç»“æœçš„å‘½åè¡¨è¾¾å¼</strong>ï¼Œå‡½æ•°ä¸€èˆ¬é€šè¿‡ Schema è¿›è¡Œæ³¨å†Œï¼Œç„¶åä½¿ç”¨ <code>Schema#getFunctions</code> è·å–å‡½æ•°ï¼Œè·å–å‡½æ•°æ—¶ä¼šæ ¹æ®å‚æ•°ç±»å‹è¿›è¡Œè¿‡æ»¤ã€‚ä¸‹é¢æ˜¯ Schema ä¸­ <code>Function</code> æ¥å£å£°æ˜ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Function</span> &#123;</span><br><span class="line">    List&lt;FunctionParameter&gt; <span class="title function_">getParameters</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Function æ¥å£æä¾›äº† <code>getParameters</code> è·å–å‡½æ•°å‚æ•°çš„æ–¹æ³•ï¼Œå®ƒåŒ…å«äº† <code>ScalarFunction</code>ã€<code>AggregateFunction</code>ã€<code>TableFunction</code> å’Œ <code>TableMarco</code> ç­‰å‡ ä¸ªä¸»è¦çš„å­æ¥å£ã€‚ScalarFunction å¯¹åº”æ ‡é‡å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å‡½æ•°è¿”å›çš„ç»“æœä¸ºä¸€ä¸ªæ ‡é‡ï¼ŒAggregateFunction å¯¹åº”èšåˆå‡½æ•°ï¼Œä¼šå°†å¤šä¸ªå€¼èšåˆè®¡ç®—ä¸ºä¸€ä¸ªæ ‡é‡è¿”å›ã€‚</p><p>TableFunction å’Œ TableMacro éƒ½å¯¹åº”äº†è¡¨å‡½æ•°ï¼Œä¼šè¿”å›ä¸€ä¸ªè¡¨ï¼Œä»–ä»¬çš„åŒºåˆ«æ˜¯ TableMacro ä¼šåœ¨ç¼–è¯‘æœŸé—´è¿›è¡Œè°ƒç”¨ï¼Œç¼–è¯‘æœŸå±•å¼€è¡¨è¾¾å¼å…è®¸ Calcite å®ç°æ›´åŠ å¼ºå¤§çš„æŸ¥è¯¢ä¼˜åŒ–ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥å¯¹è§†å›¾åœ¨ç¼–è¯‘æœŸè¿›è¡Œå±•å¼€ã€‚ç›¸æ¯”äº TableMacroï¼ŒTableFunction åˆ™éœ€è¦åœ¨æ‰§è¡Œé˜¶æ®µæ‰èƒ½çŸ¥é“è¡¨çš„ç»“æœã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº† Function çš„ç»§æ‰¿ä½“ç³»ï¼ŒFunction æ¥å£çš„ 4 ä¸ªå­æ¥å£ <code>ScalarFunction</code>ã€<code>AggregateFunction</code>ã€<code>TableFunction</code> å’Œ <code>TableMarco</code>ï¼Œä»–ä»¬éƒ½æœ‰å¯¹åº”çš„ <code>Impl</code> å®ç°ç±»ï¼Œå®ç°ç±»ä¸­å®šä¹‰äº†å¾ˆå¤šå‡½æ•°å¤„ç†ç›¸å…³çš„æ–¹æ³•ï¼Œä¸‹é¢å°èŠ‚æˆ‘ä»¬å°†åˆ†åˆ«å¯¹è¿™å‡ ç±»å‡½æ•°çš„å†…éƒ¨å®ç°è¿›è¡Œæ¢ç©¶ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/calcite-function-inherit-class.png" title="Calcite Function ç»§æ‰¿ä½“ç³»"><div class="article-inline-ad-wrapper"><div class="article-inline-ad-container"><ins class="adsbygoogle" style="display:block;text-align:center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9880881761323734" data-ad-slot="7617691942"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="article-inline-ad-label">èµåŠ©å•†</div></div><h2 id="å†…ç½®å‡½æ•°å®ç°æ¢ç©¶"><a class="markdownIt-Anchor" href="#å†…ç½®å‡½æ•°å®ç°æ¢ç©¶"></a> å†…ç½®å‡½æ•°å®ç°æ¢ç©¶</h2><h3 id="æ ‡é‡å‡½æ•°"><a class="markdownIt-Anchor" href="#æ ‡é‡å‡½æ•°"></a> æ ‡é‡å‡½æ•°</h3><p>æ ‡é‡å‡½æ•°ï¼ˆ<code>ScalarFunction</code>ï¼‰æ˜¯æŒ‡<strong>å°†è¾“å…¥æ•°æ®è½¬æ¢ä¸ºè¾“å‡ºæ•°æ®çš„å‡½æ•°ï¼Œé€šå¸¸ç”¨äºå¯¹å•ä¸ªå­—æ®µå€¼è¿›è¡Œè®¡ç®—å’Œè½¬æ¢</strong>ã€‚ä¾‹å¦‚ï¼š<code>ABS(num)</code> å‡½æ•°ï¼Œå®ƒè´Ÿè´£å°†æ¯è¡Œè¾“å…¥çš„ <code>num</code> å­—æ®µå€¼è½¬æ¢ä¸ºç»å¯¹å€¼å†è¾“å‡ºã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†æ ‡é‡å‡½æ•°åœ¨ Schema å¯¹è±¡ä¸­çš„ç»§æ‰¿ä½“ç³»ï¼Œæ ¸å¿ƒçš„å®ç°é€»è¾‘åœ¨ <code>ScalarFunctionImpl</code> ç±»ä¸­ï¼Œå®ƒå®ç°äº† <code>ScalarFunction</code> å’Œ <code>ImplementableFunction</code> æ¥å£ï¼Œå¹¶ç»§æ‰¿äº† <code>ReflectiveFunctionBase</code> æŠ½è±¡ç±»ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¥ä»‹ç»ä¸‹è¿™äº›æ¥å£å’Œç±»çš„ä½œç”¨ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/scalar-function-inherit-class.png" title="æ ‡é‡å‡½æ•°ç»§æ‰¿ä½“ç³»"><ul><li>ScalarFunction æ¥å£ï¼š</li></ul><p><code>ScalarFunction</code> æ¥å£ç»§æ‰¿äº† <code>Function</code> æ¥å£ï¼Œå¹¶åœ¨æ¥å£ä¸­å£°æ˜äº† <code>getReturnType</code> æ–¹æ³•ï¼Œç”¨äºè¡¨ç¤ºæ ‡é‡å‡½æ•°è¿”å›å€¼çš„ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Function that returns a scalar result.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ScalarFunction</span> <span class="keyword">extends</span> <span class="title class_">Function</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the return type of this function, constructed using the given</span></span><br><span class="line"><span class="comment">     * type factory.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> typeFactory Type factory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RelDataType <span class="title function_">getReturnType</span><span class="params">(RelDataTypeFactory typeFactory)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ImplementableFunction æ¥å£ï¼š</li></ul><p><code>ImplementableFunction</code> æ¥å£ç”¨äºå£°æ˜è¯¥å‡½æ•°å¯ä»¥è½¬æ¢ä¸º Java ä»£ç è¿›è¡Œæ‰§è¡Œï¼Œæ¥å£ä¸­æä¾›äº† <code>getImplementor</code> æ–¹æ³•ï¼Œå¯ä»¥è¿”å›ä¸€ä¸ªå‡½æ•°å®ç°å™¨ <code>CallImplementor</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Function that can be translated to java code.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ScalarFunction</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> TableFunction</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ImplementableFunction</span> <span class="keyword">extends</span> <span class="title class_">Function</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns implementor that translates the function to linq4j expression.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> implementor that translates the function to linq4j expression.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CallImplementor <span class="title function_">getImplementor</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CallImplementor</code> æ¥å£ä¸­å£°æ˜äº† <code>implement</code> æ–¹æ³•ï¼Œå¯ä»¥å°†å‡½æ•°è½¬æ¢ä¸º <code>linq4j</code> è¡¨è¾¾å¼ï¼Œç”¨äºå‡½æ•°é€»è¾‘çš„è°ƒç”¨ï¼ˆ<code>linq4j</code> å‚è€ƒäº† <code>.NET</code> ä¸­çš„ <code>LINQï¼ˆLanguage-Integrated Queryï¼‰</code> åŠŸèƒ½ï¼Œå¯ä»¥å®ç°ç±»ä¼¼äº SQL çš„å£°æ˜å¼è¯­æ³•ï¼Œåç»­æˆ‘ä»¬ä¸“é—¨å†™ä¸€ç¯‡æ–‡ç« ä»‹ç» <code>linq4j</code>ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CallImplementor</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Implements a call.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> translator Translator for the call</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> call Call that should be implemented</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nullAs The desired mode of &#123;<span class="doctag">@code</span> null&#125; translation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Translated call</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Expression <span class="title function_">implement</span><span class="params">(RexToLixTranslator translator, RexCall call, RexImpTable.NullAs nullAs)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ReflectiveFunctionBase æŠ½è±¡ç±»ï¼š</li></ul><p><code>ReflectiveFunctionBase</code> æŠ½è±¡ç±»ç”¨äºå¤„ç†åŸºäºæ–¹æ³•å®ç°çš„å‡½æ•°ï¼Œè´Ÿè´£å°†æ–¹æ³•å‚æ•°æ˜ å°„ä¸º <code>List&lt;FunctionParameter&gt;</code>ã€‚åœ¨åˆå§‹åŒ– ReflectiveFunctionBase æ—¶ï¼Œä¼šä¼ å…¥å‡½æ•°é€»è¾‘å¯¹åº”çš„ <code>Method</code> å¯¹è±¡ï¼Œ<code>ParameterListBuilder</code> ç±»ä¼šæ ¹æ® method å¯¹è±¡æ„é€  <code>List&lt;FunctionParameter&gt;</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a ReflectiveFunctionBase.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> method Method that is used to get type information from</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">ReflectiveFunctionBase</span><span class="params">(Method method)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.method = method;</span><br><span class="line">    <span class="built_in">this</span>.parameters = builder().addMethodParameters(method).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ParameterListBuilder</code> ç±»çš„æ ¸å¿ƒé€»è¾‘ä¸º <code>addMethodParameters</code> æ–¹æ³•ï¼Œå†…éƒ¨ä¼šéå†æ–¹æ³•å‚æ•°ï¼Œé€šè¿‡ ReflectUtil å·¥å…·ç±»è·å–å‚æ•°åç§°ï¼ˆä¼˜å…ˆä» Parameter æ³¨è§£ä¸­è·å–åç§°ï¼Œæ— æ³¨è§£åˆ™ä½¿ç”¨å‚æ•°åï¼‰å’Œå‚æ•°æ˜¯å¦å¯é€‰ï¼ˆä¼˜å…ˆä» Parameter æ³¨è§£ä¸­è·å–æ˜¯å¦å¯é€‰ï¼Œæ— æ³¨è§£åˆ™ä¸º falseï¼‰ï¼Œç„¶åå°† <code>type</code>ã€<code>name</code> å’Œ <code>optional</code> å‚æ•°ä¼ å…¥ <code>add</code> æ–¹æ³•ï¼Œç”¨äºåˆ›å»º FunctionParameter å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ParameterListBuilder <span class="title function_">addMethodParameters</span><span class="params">(Method method)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt;[] types = method.getParameterTypes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; types.length; i++) &#123;</span><br><span class="line">        add(types[i], ReflectUtil.getParameterName(method, i), ReflectUtil.isParameterOptional(method, i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>add</code> æ–¹æ³•å®ç°é€»è¾‘å¦‚ä¸‹ï¼Œä¸»è¦å°†ä¼ å…¥çš„ <code>type</code> å‚æ•°é€šè¿‡ <code>typeFactory</code> æ„å»ºä¸º <code>RelDataType</code> ç±»å‹ï¼Œå°† <code>name</code> å’Œ <code>optional</code> å°è£…åˆ°å¯¹åº”çš„ <code>FunctionParameter</code> æ¥å£æ–¹æ³•ä¸­ã€‚æ­¤å¤–ï¼Œè¿˜æ ¹æ®å‚æ•°çš„ä¸ªæ•°ç”Ÿæˆäº† <code>ordinal</code> åºå·ï¼Œå¹¶å°è£…åˆ° <code>getOrdinal</code> æ–¹æ³•ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ParameterListBuilder <span class="title function_">add</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; type, <span class="keyword">final</span> String name, <span class="keyword">final</span> <span class="type">boolean</span> optional)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ordinal</span> <span class="operator">=</span> builder.size();</span><br><span class="line">    builder.add(<span class="keyword">new</span> <span class="title class_">FunctionParameter</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ordinal + <span class="string">&quot;: &quot;</span> + name + <span class="string">&quot; &quot;</span> + type.getSimpleName() + (optional ? <span class="string">&quot;?&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åŸºäº 0 çš„å‚æ•°åºå·</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrdinal</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ordinal;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å‚æ•°åç§°</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å‚æ•°ç±»å‹</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> RelDataType <span class="title function_">getType</span><span class="params">(RelDataTypeFactory typeFactory)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> typeFactory.createJavaType(type);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å‚æ•°æ˜¯å¦å¯é€‰ï¼Œå¯é€‰å‚æ•°å¯ä»¥åœ¨å‡½æ•°è°ƒç”¨æ—¶çœç•¥</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isOptional</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> optional;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº† FunctionParameter æ„å»ºé€»è¾‘å¤–ï¼ŒReflectiveFunctionBase è¿˜æä¾›äº† <code>classHasPublicZeroArgsConstructor</code> å’Œ <code>classHasPublicFunctionContextConstructor</code> æ–¹æ³•ï¼Œç”¨äºåˆ¤æ–­å‡½æ•°é€»è¾‘ç±»æ˜¯å¦æä¾›äº†æ— å…³æ„é€ æ–¹æ³•ï¼Œä»¥åŠåŒ…å« <code>FunctionContext</code>ï¼ˆæä¾›å‡½æ•°è°ƒç”¨çš„ç›¸å…³ä¿¡æ¯ï¼Œå¯ä»¥ä½¿å‡½æ•°åœ¨æ„é€ æœŸé—´æå‰æ‰§è¡Œï¼Œæ— éœ€æ¯æ¬¡è°ƒç”¨æ‰§è¡Œï¼Œå…·ä½“å¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/b2e9e6cba1e2ce28368d1281f527a9e53f4628ca/core/src/main/java/org/apache/calcite/schema/FunctionContext.java#L24-L85">FunctionContext</a>ï¼‰çš„æ„é€ æ–¹æ³•ï¼Œè¿™äº›æ„é€ æ–¹æ³•ä¼šåœ¨å‡½æ•°åˆå§‹åŒ–æ—¶è¿›è¡Œè°ƒç”¨ï¼Œä¸åŒ…å«å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><ul><li>ScalarFunctionImpl ç±»ï¼š</li></ul><p><code>ScalarFunctionImpl</code> ç±»å®ç°äº† ScalarFunction å’Œ ImplementableFunction æ¥å£ä¸­çš„ç›¸å…³æ–¹æ³•ï¼Œå†…éƒ¨æ–¹æ³•é€šè¿‡è°ƒç”¨å¦‚ä¸‹çš„ç§æœ‰æ„é€ æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚å¦‚ä¸‹å±•ç¤ºäº† ScalarFunctionImpl äº†çš„æ„é€ æ–¹æ³•ï¼Œé¦–å…ˆä¼šè°ƒç”¨ <code>super(method)</code> åˆå§‹åŒ–å‡½æ•°å‚æ•° <code>List&lt;FunctionParameter&gt;</code>ï¼Œç„¶åå°†å‡½æ•°å®ç°å™¨ CallImplementor å­˜å‚¨åœ¨æˆå‘˜å˜é‡ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Private constructor.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">ScalarFunctionImpl</span><span class="params">(Method method, CallImplementor implementor)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(method);</span><br><span class="line">    <span class="built_in">this</span>.implementor = implementor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ScalarFunctionImpl æ ¸å¿ƒçš„åˆ›å»ºé€»è¾‘æ˜¯ç”±å…¬å…±çš„ <code>create</code> æ–¹æ³•è§¦å‘çš„ï¼Œå¤–éƒ¨è°ƒç”¨å°†å‡½æ•°æ–¹æ³• Method å¯¹è±¡ä¼ é€’ç»™ <code>create</code> æ–¹æ³•ã€‚æ–¹æ³•å†…éƒ¨ä¼šå…ˆåˆ¤æ–­ Method æ˜¯å¦ä¸ºé™æ€æ–¹æ³•ï¼Œéé™æ€æ–¹æ³•å¦‚æœæ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•ï¼Œæˆ–è€…æ²¡æœ‰åŒ…å« FunctionContext çš„æ„é€ æ–¹æ³•ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><p>å¦‚æœæ£€æŸ¥é€šè¿‡ï¼Œåˆ™æ ¹æ® Method å¯¹è±¡åˆ›å»º CallImplementor å‡½æ•°å®ç°å™¨ï¼Œç„¶åè°ƒç”¨ç§æœ‰çš„ ScalarFunctionImpl æ„é€ æ–¹æ³•ï¼Œå°† Method å¯¹è±¡å’Œ CallImplementor å‡½æ•°å®ç°å™¨ä¼ é€’ç»™æ„é€ æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ScalarFunction <span class="title function_">create</span><span class="params">(Method method)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isStatic(method)) &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = method.getDeclaringClass();</span><br><span class="line">        <span class="keyword">if</span> (!classHasPublicZeroArgsConstructor(clazz) &amp;&amp; !classHasPublicFunctionContextConstructor(clazz)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> RESOURCE.requireDefaultConstructor(clazz.getName()).ex();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">CallImplementor</span> <span class="variable">implementor</span> <span class="operator">=</span> createImplementor(method);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ScalarFunctionImpl</span>(method, implementor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»º CallImplementor å‡½æ•°å®ç°å™¨çš„é€»è¾‘å¦‚ä¸‹ï¼Œé¦–å…ˆä¼šè°ƒç”¨ <code>getNullPolicy</code> æ–¹æ³•ï¼Œè¿”å› <code>NullPolicy</code> æšä¸¾ç±»å‹ç”¨äºæè¿°å‡½æ•°ï¼ˆæˆ–è¿ç®—ç¬¦ï¼‰ä½•æ—¶è¿”å› NULLã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> CallImplementor <span class="title function_">createImplementor</span><span class="params">(<span class="keyword">final</span> Method method)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">NullPolicy</span> <span class="variable">nullPolicy</span> <span class="operator">=</span> getNullPolicy(method);</span><br><span class="line">    <span class="keyword">return</span> RexImpTable.createImplementor(<span class="keyword">new</span> <span class="title class_">ReflectiveCallNotNullImplementor</span>(method), nullPolicy, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>NullPolicy</code> æšä¸¾ç±»åŒ…å«äº† <code>ALL</code>ã€<code>STRICT</code>ã€<code>SEMI_STRICT</code>ã€<code>ANY</code>ã€<code>ARG0</code> å’Œ <code>NONE</code>ã€‚<code>ALL</code> è¡¨ç¤ºåªæœ‰æ‰€æœ‰çš„å‚æ•°ä¸º NULLï¼Œå‡½æ•°ç»“æœé‡‡è¿”å› NULLã€‚<code>STRICT</code> è¡¨ç¤ºåªæœ‰ä¸€ä¸ªå‚æ•°ä¸º NULL ä½¿ï¼Œå‡½æ•°ç»“æœè¿”å› NULLã€‚<code>SEMI_STRICT</code> è¡¨ç¤ºæœ‰ 1 ä¸ªæˆ–å¤šä¸ªå‚æ•°ä¸º NULL æ—¶ï¼Œå‡½æ•°ç»“æœè¿”å› NULLã€‚<code>ANY</code> è¡¨ç¤ºåªè¦æœ‰ä»»æ„ä¸€ä¸ªå‚æ•°ä¸º NULLï¼Œåˆ™å‡½æ•°ç»“æœè¿”å› NULLï¼Œ<code>ANY</code> å’Œ <code>STRICT</code> æ¯”è¾ƒç±»ä¼¼ï¼ŒCaclite æ›´æ¨èä½¿ç”¨ <code>STRICT</code> ç±»å‹ã€‚<code>ARG0</code> è¡¨ç¤ºç¬¬ä¸€ä¸ªå‚æ•°ä¸º NULL æ—¶ï¼Œå‡½æ•°ç»“æœè¿”å› NULLã€‚<code>NONE</code> è¡¨ç¤ºä¸æŒ‡å®š NULL ç­–ç•¥ï¼Œç”±å‡½æ•°é€»è¾‘è¿›è¡Œå¤„ç†ã€‚</p><p>è¿™äº›æšä¸¾ç±»å‹ä¸­ï¼Œ<code>STRICT</code>ã€<code>SEMI_STRICT</code> æ¯”è¾ƒå¸¸ç”¨ï¼ŒCalcite åˆ†åˆ«ä¸ºä»–ä»¬æä¾›äº† <code>Strict</code> å’Œ <code>SemiStrict</code> æ³¨è§£ï¼Œå¯ä»¥æ ‡æ³¨åœ¨å‡½æ•°æ–¹æ³•æˆ–ç±»ä¸Šï¼Œç”¨æ¥å£°æ˜ NULL å€¼ç­–ç•¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">NullPolicy</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns null if and only if all of the arguments are null;</span></span><br><span class="line"><span class="comment">     * If all of the arguments are false return false otherwise true.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ALL,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns null if and only if one of the arguments are null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    STRICT,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns null if one of the arguments is null, and possibly other times.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SEMI_STRICT,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If any of the arguments are null, return null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ANY,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If the first argument is null, return null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ARG0, NONE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–åˆ° NullPolicy åï¼Œè°ƒç”¨ <code>RexImpTable.createImplementor()</code> æ–¹æ³•åˆ›å»ºå‡½æ•°å®ç°å™¨ï¼Œç”±äºå‡½æ•°å®ç°å™¨ä¸­çš„ <code>implement</code> æ–¹æ³•åœ¨æ‰§è¡Œé˜¶æ®µæ‰ä¼šè°ƒç”¨ï¼Œæˆ‘ä»¬å°†åœ¨åé¢çš„ ScalarFunction æ¡ˆä¾‹ä¸­è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚</p><h3 id="èšåˆå‡½æ•°"><a class="markdownIt-Anchor" href="#èšåˆå‡½æ•°"></a> èšåˆå‡½æ•°</h3><p>èšåˆå‡½æ•°ï¼ˆ<code>AggregateFunction</code>ï¼‰æ˜¯æŒ‡<strong>å°†å¤šä¸ªå€¼ç»„åˆè½¬æ¢ä¸ºæ ‡é‡å€¼è¾“å‡ºçš„å‡½æ•°</strong>ã€‚ä¾‹å¦‚ï¼š<code>SUM(num)</code> å‡½æ•°ï¼Œå®ƒè´Ÿè´£å°†æ¯è¡Œè¾“å…¥çš„ <code>num</code> å­—æ®µå€¼è¿›è¡Œç´¯åŠ ï¼Œæœ€ç»ˆè¾“å‡ºç´¯åŠ æ€»å’Œã€‚</p><p>Calcite èšåˆå‡½æ•°å†…éƒ¨åŒ…å«äº†ä¸€ä¸ªç´¯åŠ è¿‡ç¨‹ï¼Œå¦‚ä¸‹é¢çš„ä¼ªä»£ç æ‰€ç¤ºï¼Œ<code>Accumulator</code> ç´¯åŠ å™¨å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª <code>sum</code> å˜é‡ï¼Œç”¨äºå­˜å‚¨ <code>SUM</code> å‡½æ•°è®¡ç®—çš„ç´¯åŠ å€¼ã€‚èšåˆå‡½æ•°è°ƒç”¨ <code>init</code> æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ªç´¯åŠ å™¨å¯¹è±¡ï¼Œå¹¶å°† <code>sum</code> åˆå§‹åŒ–ä¸º 0ï¼Œç„¶åé€šè¿‡ <code>add</code> æ–¹æ³•å°†å½“å‰è¡Œçš„å€¼æ·»åŠ åˆ°ç´¯åŠ å™¨ä¸­è¿›è¡Œè®¡ç®—ã€‚å¦‚æœæœ‰å¤šä¸ªç´¯åŠ å™¨ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ <code>merge</code> æ–¹æ³•å°†ä¸¤ä¸ªç´¯åŠ å™¨ä¸­çš„å€¼åˆäºŒä¸ºä¸€ï¼Œæœ€åè®¡ç®—å®Œæˆå¯ä»¥é€šè¿‡ <code>result</code> æ–¹æ³•è¿”å›ç»“æœã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// èšåˆå‡½æ•°ç´¯åŠ å™¨</span></span><br><span class="line">struct Accumulator &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// èšåˆå‡½æ•°åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">Accumulator <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Accumulator</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// èšåˆå‡½æ•°ç´¯åŠ æ–¹æ³•</span></span><br><span class="line">Accumulator <span class="title function_">add</span><span class="params">(Accumulator a, <span class="type">int</span> x)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Accumulator</span>(a.sum + x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// èšåˆå‡½æ•°åˆå¹¶æ–¹æ³•</span></span><br><span class="line">Accumulator <span class="title function_">merge</span><span class="params">(Accumulator a, Accumulator a2)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Accumulator</span>(a.sum + a2.sum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// èšåˆå‡½æ•°è·å–ç»“æœæ–¹æ³•</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">result</span><span class="params">(Accumulator a)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a.sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹å›¾å±•ç¤ºäº†èšåˆå‡½æ•°åœ¨ Schema å¯¹è±¡ä¸­çš„ç»§æ‰¿ä½“ç³»ï¼Œæ ¸å¿ƒçš„å®ç°é€»è¾‘åœ¨ <code>AggregateFunctionImpl</code> ç±»ä¸­ï¼Œå®ƒå®ç°äº† <code>AggregateFunction</code> å’Œ <code>ImplementableAggFunction</code> æ¥å£ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¥ä»‹ç»ä¸‹è¿™äº›æ¥å£å’Œç±»çš„ä½œç”¨ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/aggregate-function-inherit-class.png" title="èšåˆå‡½æ•°ç»§æ‰¿ä½“ç³»"><ul><li>AggregateFunction æ¥å£ï¼š</li></ul><p><code>AggregateFunction</code> æ¥å£ç»§æ‰¿äº† <code>Function</code> æ¥å£ï¼Œå¹¶åœ¨æ¥å£ä¸­å£°æ˜äº† <code>getReturnType</code> æ–¹æ³•ï¼Œç”¨äºè¡¨ç¤ºèšåˆå‡½æ•°è¿”å›å€¼çš„ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Function that combines several values into a scalar result.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AggregateFunction</span> <span class="keyword">extends</span> <span class="title class_">Function</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the return type of this function, constructed using the given</span></span><br><span class="line"><span class="comment">     * type factory.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> typeFactory Type factory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RelDataType <span class="title function_">getReturnType</span><span class="params">(RelDataTypeFactory typeFactory)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ImplementableAggFunction æ¥å£ï¼š</li></ul><p><code>ImplementableAggFunction</code> æ¥å£ç”¨äºå£°æ˜è¯¥å‡½æ•°å¯ä»¥è½¬æ¢ä¸º Java ä»£ç è¿›è¡Œæ‰§è¡Œï¼Œæ¥å£ä¸­æä¾›äº† <code>getImplementor</code> æ–¹æ³•ï¼Œå¯ä»¥è¿”å›ä¸€ä¸ªèšåˆå‡½æ•°å®ç°å™¨ <code>AggImplementor</code>ï¼Œ<code>windowContext</code> ç”¨äºæ ‡è®°å½“å‰èšåˆå‡½æ•°æ˜¯å¦åŒ…å«åœ¨çª—å£è¿ç®—ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ImplementableAggFunction</span> <span class="keyword">extends</span> <span class="title class_">AggregateFunction</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns implementor that translates the function to linq4j expression.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> windowContext true when aggregate is used in window context</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> implementor that translates the function to linq4j expression.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    AggImplementor <span class="title function_">getImplementor</span><span class="params">(<span class="type">boolean</span> windowContext)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AggImplementor</code> æ¥å£å¯ä»¥å®ç°èšåˆå‡½æ•°æ‰€éœ€çš„åˆå§‹åŒ–ã€ç´¯åŠ ä»¥åŠè·å–ç»“æœæ–¹æ³•ï¼Œå¦‚ä¸‹å±•ç¤ºäº† <code>AggImplementor</code> æ¥å£ä¸­çš„æ–¹æ³•ï¼Œ<code>getStateType</code> æ–¹æ³•å¯ä»¥è¿”å›èšåˆå‡½æ•°å®ç°æ—¶ï¼Œä¸­é—´å˜é‡çš„ç±»å‹ï¼Œä¾‹å¦‚ï¼šå­—ç¬¦ä¸²è¿æ¥å‡½æ•°ï¼Œå®ƒçš„ä¸­é—´å˜é‡ç±»å‹å¯ä»¥æ˜¯ StringBuilderã€‚<code>implementReset</code>ã€<code>implementAdd</code> å’Œ <code>implementResult</code> åˆ†åˆ«å¯¹åº”äº†èšåˆå‡½æ•°çš„åˆå§‹åŒ–ã€ç´¯åŠ å’Œè·å–ç»“æœæ–¹æ³•ï¼ŒAggImplementor æ¥å£çš„å®ç°ç±»ï¼Œä¼šæ ¹æ®ä¸åŒçš„èšåˆå‡½æ•°ç±»å‹å®ç°å…¶é€»è¾‘ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AggImplementor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿”å›èšåˆå‡½æ•°å®ç°æ—¶ï¼Œä¸­é—´å˜é‡çš„ç±»å‹</span></span><br><span class="line">    <span class="comment">// ä¾‹å¦‚ï¼šå­—ç¬¦ä¸²è¿æ¥å‡½æ•°ï¼Œå®ƒçš„ä¸­é—´å˜é‡ç±»å‹å¯ä»¥æ˜¯ StringBuilder</span></span><br><span class="line">    List&lt;Type&gt; <span class="title function_">getStateType</span><span class="params">(AggContext info)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†ä¸­é—´å˜é‡é‡ç½®ä¸ºåˆè¯†çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// åº”ä½¿ç”¨ AggResetContext.accumulator() æ¥å¼•ç”¨çŠ¶æ€å˜é‡</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">implementReset</span><span class="params">(AggContext info, AggResetContext reset)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†æ–°å¢åŠ çš„å½“å‰å€¼ï¼Œç´¯åŠ åˆ°ä¸­é—´å˜é‡</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">implementAdd</span><span class="params">(AggContext info, AggAddContext add)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®ä¸­é—´å˜é‡è®¡ç®—ç»“æœå€¼</span></span><br><span class="line">    Expression <span class="title function_">implementResult</span><span class="params">(AggContext info, AggResultContext result)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>AggregateFunctionImpl ç±»ï¼š</li></ul><p><code>AggregateFunctionImpl</code> ç±»å®ç°äº† <code>AggregateFunction</code> å’Œ <code>ImplementableAggFunction</code> æ¥å£ï¼Œé€šè¿‡ç§æœ‰çš„æ„é€ æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œæ„é€ æ–¹æ³•å¦‚ä¸‹ï¼Œ<code>declaringClass</code> è¡¨ç¤ºèšåˆå‡½æ•°å¯¹åº”çš„å®ç°ç±»ï¼Œ<code>params</code> è¡¨ç¤ºèšåˆå‡½æ•°çš„å‚æ•°ï¼Œ<code>valueTypes</code> è¡¨ç¤ºèšåˆå‡½æ•°å‚æ•°çš„ç±»å‹ï¼Œ<code>accumulatorType</code> è¡¨ç¤ºèšåˆå™¨çš„ç±»å‹ï¼Œ<code>resultType</code> è¡¨ç¤ºå‡½æ•°ç»“æœç±»å‹ã€‚</p><p><code>initMethod</code>ã€<code>addMethod</code>ã€<code>mergeMethod</code> å’Œ <code>resultMethod</code> åˆ†åˆ«è¡¨ç¤ºèšåˆå‡½æ•°åˆå§‹åŒ–æ–¹æ³•ã€ç´¯åŠ æ–¹æ³•ã€åˆå¹¶æ–¹æ³•å’Œç»“æœæ–¹æ³•ï¼Œ<code>isStatic</code> è¡¨ç¤º <code>initMethod</code> æ˜¯å¦ä¸ºé™æ€æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">AggregateFunctionImpl</span><span class="params">(Class&lt;?&gt; declaringClass, List&lt;FunctionParameter&gt; params, List&lt;Class&lt;?&gt;&gt; valueTypes, Class&lt;?&gt; accumulatorType, Class&lt;?&gt; resultType, Method initMethod, Method addMethod, <span class="meta">@Nullable</span> Method mergeMethod, <span class="meta">@Nullable</span> Method resultMethod)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.declaringClass = declaringClass;</span><br><span class="line">    <span class="built_in">this</span>.valueTypes = ImmutableList.copyOf(valueTypes);</span><br><span class="line">    <span class="built_in">this</span>.parameters = params;</span><br><span class="line">    <span class="built_in">this</span>.accumulatorType = accumulatorType;</span><br><span class="line">    <span class="built_in">this</span>.resultType = resultType;</span><br><span class="line">    <span class="built_in">this</span>.initMethod = requireNonNull(initMethod, <span class="string">&quot;initMethod&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.addMethod = requireNonNull(addMethod, <span class="string">&quot;addMethod&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.mergeMethod = mergeMethod;</span><br><span class="line">    <span class="built_in">this</span>.resultMethod = resultMethod;</span><br><span class="line">    <span class="built_in">this</span>.isStatic = isStatic(initMethod);</span><br><span class="line">    <span class="keyword">assert</span> resultMethod != <span class="literal">null</span> || accumulatorType == resultType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äº AggregateFunctionImpl æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œé€šå¸¸ Calcite å†…éƒ¨éƒ½æ˜¯é€šè¿‡ <code>create</code> æ–¹æ³•æ¥åˆ›å»º AggregateFunctionImpl å¯¹è±¡ï¼Œ<code>create</code> æ–¹æ³•å®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates an aggregate function, or returns null.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> AggregateFunctionImpl <span class="title function_">create</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å‡½æ•°ç±»ä¸­çš„ init æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Method</span> <span class="variable">initMethod</span> <span class="operator">=</span> ReflectiveFunctionBase.findMethod(clazz, <span class="string">&quot;init&quot;</span>);</span><br><span class="line">    <span class="comment">// è·å–å‡½æ•°ç±»ä¸­çš„ add æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Method</span> <span class="variable">addMethod</span> <span class="operator">=</span> ReflectiveFunctionBase.findMethod(clazz, <span class="string">&quot;add&quot;</span>);</span><br><span class="line">    <span class="comment">// merge æ–¹æ³•æš‚æœªå®ç°</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Method</span> <span class="variable">mergeMethod</span> <span class="operator">=</span> <span class="literal">null</span>; <span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line">    <span class="comment">// è·å–å‡½æ•°ç±»ä¸­çš„ result æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Method</span> <span class="variable">resultMethod</span> <span class="operator">=</span> ReflectiveFunctionBase.findMethod(clazz, <span class="string">&quot;result&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (initMethod != <span class="literal">null</span> &amp;&amp; addMethod != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// A is return type of init by definition</span></span><br><span class="line">        <span class="comment">// A è¡¨ç¤º init æ–¹æ³•çš„è¿”å›ç±»å‹</span></span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; accumulatorType = initMethod.getReturnType();</span><br><span class="line">        <span class="comment">// R is return type of result by definition</span></span><br><span class="line">        <span class="comment">// R è¡¨ç¤º result æ–¹æ³•çš„è¿”å›ç±»å‹</span></span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; resultType = resultMethod != <span class="literal">null</span> ? resultMethod.getReturnType() : accumulatorType;</span><br><span class="line">        <span class="comment">// V is remaining args of add by definition</span></span><br><span class="line">        <span class="comment">// V è¡¨ç¤º add æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°ä¹‹å¤–çš„ç±»å‹</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;Class&gt; addParamTypes = ImmutableList.copyOf(addMethod.getParameterTypes());</span><br><span class="line">        <span class="comment">// æ£€æŸ¥ add æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°å’Œç´¯åŠ å™¨ç±»å‹æ˜¯å¦ä¸€è‡´</span></span><br><span class="line">        <span class="keyword">if</span> (addParamTypes.isEmpty() || addParamTypes.get(<span class="number">0</span>) != accumulatorType) &#123;</span><br><span class="line">            <span class="keyword">throw</span> RESOURCE.firstParameterOfAdd(clazz.getName()).ex();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> ReflectiveFunctionBase.<span class="type">ParameterListBuilder</span> <span class="variable">params</span> <span class="operator">=</span> ReflectiveFunctionBase.builder();</span><br><span class="line">        <span class="keyword">final</span> ImmutableList.Builder&lt;Class&lt;?&gt;&gt; valueTypes = ImmutableList.builder();</span><br><span class="line">        <span class="comment">// è·³è¿‡ç¬¬ä¸€ä¸ªæ„é€ å™¨å‚æ•°ï¼Œä»ç¬¬äºŒä¸ªå‚æ•°å¼€å§‹éå†</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; addParamTypes.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Class</span> <span class="variable">type</span> <span class="operator">=</span> addParamTypes.get(i);</span><br><span class="line">            <span class="comment">// è°ƒç”¨ ReflectUtil è·å–å‚æ•°åç§°å’Œå‚æ•°æ˜¯å¦å¯é€‰æ ‡è®°ï¼Œä¼˜å…ˆé€‰æ‹© Parameter æ³¨è§£å£°æ˜çš„ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> ReflectUtil.getParameterName(addMethod, i);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">optional</span> <span class="operator">=</span> ReflectUtil.isParameterOptional(addMethod, i);</span><br><span class="line">            params.add(type, name, optional);</span><br><span class="line">            valueTypes.add(type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚ä¸‹å±•ç¤ºäº†èšåˆå‡½æ•°ä¸­çš„æ–¹æ³•å’Œç±»å‹</span></span><br><span class="line">        <span class="comment">// A init()</span></span><br><span class="line">        <span class="comment">// A add(A, V)</span></span><br><span class="line">        <span class="comment">// A merge(A, A)</span></span><br><span class="line">        <span class="comment">// R result(A)        </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AggregateFunctionImpl</span>(clazz, params.build(), valueTypes.build(), accumulatorType, resultType, initMethod, addMethod, mergeMethod, resultMethod);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>create</code> æ–¹æ³•é¦–å…ˆä¼šä» <code>clazz</code> ç±»ä¸­è·å– <code>init</code>ã€<code>add</code>ã€<code>merge</code> å’Œ <code>result</code> å¯¹åº”çš„ Method å¯¹è±¡ï¼Œç›®å‰ <code>merge</code> æ–¹æ³•ä»ç„¶æ²¡æœ‰å®ç°ï¼Œ<code>init</code> å’Œ <code>add</code> æ–¹æ³•æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™ <code>create</code> æ–¹æ³•ä¼šç›´æ¥è¿”å› nullï¼Œå¤–éƒ¨è°ƒç”¨çš„åœ°æ–¹ä¼šåˆ¤æ–­æ˜¯å¦å…è®¸å‡½æ•°ä¸º nullã€‚</p><p>å¦‚æœ <code>init</code> å’Œ <code>add</code> æ–¹æ³•ä¸ä¸º nullï¼Œåˆ™ä¼šä» Method å¯¹è±¡ä¸­è·å–èšåˆå‡½æ•°ç›¸å…³çš„ç±»å‹åŠå‚æ•°ä¿¡æ¯ï¼Œä»£ç ä¸­ä½¿ç”¨ A è¡¨ç¤º init æ–¹æ³•çš„è¿”å›ç±»å‹ï¼Œä½¿ç”¨ R è¡¨ç¤º result æ–¹æ³•çš„è¿”å›ç±»å‹ï¼Œä½¿ç”¨ V è¡¨ç¤º add æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°ä¹‹å¤–çš„ç±»å‹ï¼Œå¹¶æ£€æŸ¥ add æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦å’Œç´¯åŠ å™¨ç±»å‹ä¸€è‡´ï¼Œä¸ä¸€è‡´åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>ç„¶åå¾ªç¯ <code>add</code> æ–¹æ³•çš„å‚æ•°ï¼Œå¾ªç¯æ—¶ä¼šè·³è¿‡ç¬¬ä¸€ä¸ªç´¯åŠ å™¨å‚æ•°ï¼Œä»ç¬¬äºŒä¸ªå‚æ•°å¼€å§‹éå†ï¼Œç„¶åä½¿ç”¨ <code>ReflectUtil</code> ä¼˜å…ˆä» <code>Parameter</code> æ³¨è§£ä¸­è·å–å‚æ•°åç§°å’Œå‚æ•°æ˜¯å¦å¯é€‰æ ‡è®°ï¼Œå¾ªç¯è¿‡ç¨‹ä¸­ä¼šæŠŠå‚æ•°å’Œå‚æ•°ç±»å‹å­˜å‚¨åœ¨ params å’Œ valueTypes ä¸­ï¼Œæœ€ç»ˆæ‰€æœ‰çš„å‚æ•°ä¼šä¼ é€’ç»™ <code>AggregateFunctionImpl</code> ç§æœ‰æ„é€ æ–¹æ³•ï¼Œç”¨äºåˆ›å»º AggregateFunctionImpl å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> AggImplementor <span class="title function_">getImplementor</span><span class="params">(<span class="type">boolean</span> windowContext)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RexImpTable</span>.UserDefinedAggReflectiveImplementor(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AggregateFunctionImpl#getImplementor</code> æ–¹æ³•ç”¨äºè·å–èšåˆå‡½æ•°å®ç°å™¨ï¼Œå‚æ•° <code>windowContext</code> è¡¨ç¤ºå½“å‰æ˜¯å¦æ˜¯ä½äºçª—å£è¿ç®—ä¸­ï¼Œèšåˆå‡½æ•°å®ç°å™¨ç›´æ¥è°ƒç”¨äº† <code>RexImpTable.UserDefinedAggReflectiveImplementor</code> æ„é€ æ–¹æ³•ï¼Œå¹¶å°†å½“å‰çš„èšåˆå‡½æ•°å®ç°ç±»å¯¹è±¡ä¼ é€’è¿›å»ï¼Œå®ç°å™¨å†…éƒ¨å…·ä½“çš„é€»è¾‘ï¼Œæˆ‘ä»¬åæ–‡å†è¯¦ç»†åˆ†æï¼Œæ­¤å¤„æš‚æ—¶è·³è¿‡ã€‚</p><h3 id="è¡¨å‡½æ•°-è¡¨å®"><a class="markdownIt-Anchor" href="#è¡¨å‡½æ•°-è¡¨å®"></a> è¡¨å‡½æ•° &amp; è¡¨å®</h3><p>è¡¨å‡½æ•°ï¼ˆ<code>TableFunction</code>ï¼‰æ˜¯æŒ‡<strong>åœ¨æ‰§è¡Œé˜¶æ®µå°†æŸäº›æ•°æ®è½¬æ¢ä¸ºè¡¨çš„å‡½æ•°</strong>ï¼Œè¡¨å®ï¼ˆ<code>TableMacro</code>ï¼‰æ˜¯æŒ‡<strong>åœ¨ç¼–è¯‘é˜¶æ®µå°†æŸäº›æ•°æ®è½¬æ¢ä¸ºè¡¨çš„å‡½æ•°</strong>ã€‚è¡¨å‡½æ•°æˆ–è€…è¡¨å®ï¼Œé€šå¸¸ä¼šä½¿ç”¨åœ¨ FROM å­å¥ä¸­ï¼Œä½œä¸ºä¸€å¼ è¡¨è¿›è¡Œä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š<code>SELECT * FROM XML_EXTRACT(&quot;/opt/csv/test.csv&quot;)</code>ï¼Œ<code>XML_EXTRACT</code> å°±æ˜¯ä¸€ä¸ªè¡¨å‡½æ•°ï¼Œå®ƒè´Ÿè´£ä» <code>test.csv</code> æ–‡ä»¶ä¸­è·å–æ•°æ®ï¼Œå¹¶è¿”å›ä¸€å¼ è¡¨ã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†è¡¨å‡½æ•°å’Œè¡¨å®åœ¨ Schema å¯¹è±¡ä¸­çš„ç»§æ‰¿ä½“ç³»ï¼Œè¡¨å‡½æ•°çš„æ ¸å¿ƒå®ç°é€»è¾‘åœ¨ <code>TableFunctionImpl</code> ç±»ä¸­ï¼Œå®ƒå®ç°äº† <code>ImplementableFunction</code> å’Œ <code>TableFunction</code> æ¥å£ï¼Œå¹¶ç»§æ‰¿äº† <code>ReflectiveFunctionBase</code> æŠ½è±¡ç±»ã€‚è¡¨å®çš„æ ¸å¿ƒå®ç°é€»è¾‘åœ¨ <code>TableMarcoImpl</code> ç±»ä¸­ï¼Œå®ƒå®ç°äº† <code>TableMarco</code> æ¥å£ï¼Œå¹¶ç»§æ‰¿äº† <code>ReflectiveFunctionBase</code> æŠ½è±¡ç±»ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¥ä»‹ç»ä¸‹è¿™äº›æ¥å£å’Œç±»çš„ä½œç”¨ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/table-function-marco-inherit-class.png" title="è¡¨å‡½æ•° &amp; è¡¨å®ç»§æ‰¿ä½“ç³»"><ul><li>TableFunction æ¥å£ï¼š</li></ul><p><code>TableFunction</code> æ¥å£ç»§æ‰¿äº† <code>Function</code> æ¥å£ï¼Œå¹¶åœ¨æ¥å£ä¸­å£°æ˜äº† <code>getRowType</code> æ–¹æ³•ï¼Œç”¨äºè¡¨ç¤ºè¡¨å‡½æ•°è¿”å›è¡¨çš„æ•°æ®è¡Œç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TableFunction</span> <span class="keyword">extends</span> <span class="title class_">Function</span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨æŒ‡å®šå‚æ•°äº§ç”Ÿçš„è¡¨å¯¹åº”çš„æ•°æ®è¡Œç±»å‹</span></span><br><span class="line">    RelDataType <span class="title function_">getRowType</span><span class="params">(RelDataTypeFactory typeFactory, List&lt;? extends <span class="meta">@Nullable</span> Object&gt; arguments)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–è¡¨å¯¹åº”çš„æ•°æ®è¡Œç±»å‹ï¼ˆJava ç±»å‹ï¼‰</span></span><br><span class="line">    Type <span class="title function_">getElementType</span><span class="params">(List&lt;? extends <span class="meta">@Nullable</span> Object&gt; arguments)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>TableFunctionImpl ç±»ï¼š</li></ul><p><code>TableFunctionImpl</code> ç±»å®ç°äº† <code>TableFunction</code> å’Œ <code>ImplementableFunction</code> æ¥å£ï¼Œå¹¶ç»§æ‰¿äº† <code>ReflectiveFunctionBase</code> æŠ½è±¡ç±»ï¼Œç§æœ‰æ„é€ æ–¹æ³•å…è®¸ä¼ å…¥å‡½æ•°å®ç°çš„ Method å¯¹è±¡ï¼Œä»¥åŠè°ƒç”¨å®ç°é€»è¾‘ CallImplementorï¼Œ<code>super(method)</code> ä¼šè°ƒç”¨ ReflectiveFunctionBase æŠ½è±¡ç±»çš„æ–¹æ³•ï¼Œå¯¹å‡½æ•°å‚æ•°è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">TableFunctionImpl</span><span class="params">(Method method, CallImplementor implementor)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(method);</span><br><span class="line">    <span class="built_in">this</span>.implementor = implementor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç§æœ‰æ„é€ æ–¹æ³•ä¼šè¢« <code>create</code> æ–¹æ³•è°ƒç”¨ï¼Œ<code>create</code> æ–¹æ³•ä¼šä¼ å…¥ä¸€ä¸ª <code>Class</code> å¯¹è±¡ï¼Œä»¥åŠå‡½æ•°æ–¹æ³•å <code>methodName</code>ï¼Œæ ¹æ®æ–¹æ³•åä¼šæŸ¥æ‰¾ <code>Method</code> å¯¹è±¡ï¼Œå¦‚æœå¯¹è±¡ä¸º nullï¼Œåˆ™è¿”å› TableFunction ä¸º nullã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a &#123;<span class="doctag">@link</span> TableFunctionImpl&#125; from a class, looking for a method</span></span><br><span class="line"><span class="comment"> * with a given name. Returns null if there is no such method.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> TableFunction <span class="title function_">create</span><span class="params">(Class&lt;?&gt; clazz, String methodName)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> findMethod(clazz, methodName);</span><br><span class="line">    <span class="keyword">if</span> (method == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> create(method);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>Method</code> å¯¹è±¡å­˜åœ¨ï¼Œåˆ™ç»§ç»­åˆ¤æ–­æ–¹æ³•æ˜¯å¦ä¸ºé™æ€ï¼Œå¦‚æœæ˜¯éé™æ€æ–¹æ³•ï¼Œåˆ™éœ€è¦æä¾›æ— å‚çš„æ„é€ æ–¹æ³•ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚æ­¤å¤–ï¼Œè¡¨å‡½æ•°è¿”å›å€¼éœ€è¦æ˜¯ <code>QueryableTable</code> æˆ–è€… <code>ScannableTable</code> ç±»å‹ï¼Œå¦åˆ™è¡¨å‡½æ•°ç›´æ¥è¿”å› nullã€‚<code>Method</code> å¯¹è±¡æ£€æŸ¥æ»¡è¶³æ¡ä»¶åï¼Œåˆ™è°ƒç”¨ <code>createImplementor</code> åˆ›å»ºæ–¹æ³•å®ç°å™¨ï¼Œå†è°ƒç”¨ç§æœ‰çš„ <code>TableFunctionImpl</code> æ„é€ æ–¹æ³•åˆ›å»ºè¡¨å‡½æ•°å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a &#123;<span class="doctag">@link</span> TableFunctionImpl&#125; from a method.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> TableFunction <span class="title function_">create</span><span class="params">(<span class="keyword">final</span> Method method)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºéé™æ€æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (!isStatic(method)) &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> method.getDeclaringClass();</span><br><span class="line">        <span class="comment">// éé™æ€æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰å…¬æœ‰çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (!classHasPublicZeroArgsConstructor(clazz)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> RESOURCE.requireDefaultConstructor(clazz.getName()).ex();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">    <span class="comment">// å¦‚æœè¡¨å‡½æ•°è¿”å›å€¼ä¸ä¸º QueryableTable æˆ–è€… ScannableTableï¼Œåˆ™ç›´æ¥è¿”å› null</span></span><br><span class="line">    <span class="keyword">if</span> (!QueryableTable.class.isAssignableFrom(returnType) &amp;&amp; !ScannableTable.class.isAssignableFrom(returnType)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºè°ƒç”¨å®ç°å™¨</span></span><br><span class="line">    <span class="type">CallImplementor</span> <span class="variable">implementor</span> <span class="operator">=</span> createImplementor(method);</span><br><span class="line">    <span class="comment">// åˆ›å»º TableFunctionImpl å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TableFunctionImpl</span>(method, implementor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>TableMacro æ¥å£ï¼š</li></ul><p><code>TableMacro</code> å’Œ <code>TableFunction</code> æ¥å£ç±»ä¼¼ï¼Œéƒ½ç»§æ‰¿äº† <code>Function</code> æ¥å£ï¼Œä½†æ˜¯å®ƒæ˜¯åœ¨ç¼–è¯‘æœŸé—´è¿›è¡Œè°ƒç”¨ï¼Œå¦‚ä¸‹å±•ç¤ºäº† TableMacro æ¥å£æä¾›çš„ <code>apply</code> æ–¹æ³•ï¼Œå®ƒå¯ä»¥æ ¹æ®ä¼ å…¥çš„å‚æ•°è½¬æ¢ä¸º TranslatableTableï¼Œé€šè¿‡ <code>TranslatableTable#toRel</code> æ–¹æ³•ï¼Œå¯ä»¥å¾—åˆ° <code>RelNode</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TableMacro</span> <span class="keyword">extends</span> <span class="title class_">Function</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Applies arguments to yield a table.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> arguments Arguments</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Table</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TranslatableTable <span class="title function_">apply</span><span class="params">(List&lt;? extends <span class="meta">@Nullable</span> Object&gt; arguments)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>TableMacroImpl ç±»ï¼š</li></ul><p><code>TableMacroImpl</code> ç±»å®ç°äº† <code>TableMacro</code> æ¥å£ï¼Œå¹¶ç»§æ‰¿äº† <code>ReflectiveFunctionBase</code> æŠ½è±¡ç±»ï¼Œç§æœ‰æ„é€ æ–¹æ³•æ¥å—ä¸€ä¸ª Method å‚æ•°ï¼Œå¹¶ä¼šè°ƒç”¨ <code>super(method)</code> æ–¹æ³•ï¼Œå¤„ç†å‡½æ•°å‚æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Private constructor; use &#123;<span class="doctag">@link</span> #create&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">TableMacroImpl</span><span class="params">(Method method)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(method);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Calcite å†…éƒ¨é€šè¿‡ <code>create</code> æ–¹æ³•åˆ›å»º <code>TableMacro</code> å¯¹è±¡ï¼Œå’Œ <code>TableFunction</code> ä¸€æ ·ï¼Œåœ¨åˆ›å»ºä¹‹å‰ä¼šåˆ¤æ–­æ–¹æ³•æ˜¯å¦ä¸ºéé™æ€æ–¹æ³•ï¼Œéé™æ€æ–¹æ³•å¿…é¡»æä¾›å…¬æœ‰æ— å‚æ„é€ æ–¹æ³•ã€‚ç„¶åæ£€æŸ¥ TableMacro å‡½æ•°è¿”å›å€¼ï¼Œå¿…é¡»ä¸º <code>TranslatableTable</code> ç±»å‹ï¼Œå¦åˆ™è¿”å› nullï¼Œæœ€åè°ƒç”¨ <code>TableMacroImpl</code> æ„é€ æ–¹æ³•åˆ›å»ºè¡¨å®å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a &#123;<span class="doctag">@code</span> TableMacro&#125; from a method.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> TableMacro <span class="title function_">create</span><span class="params">(<span class="keyword">final</span> Method method)</span> &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> method.getDeclaringClass();</span><br><span class="line">    <span class="comment">// éé™æ€æ–¹æ³•ï¼Œå¿…é¡»æä¾›å…¬æœ‰æ— å‚æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (!isStatic(method)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!classHasPublicZeroArgsConstructor(clazz)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> RESOURCE.requireDefaultConstructor(clazz.getName()).ex();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">    <span class="comment">// æ£€æŸ¥è¡¨å®è¿”å›å€¼æ˜¯å¦ä¸º TranslatableTable</span></span><br><span class="line">    <span class="keyword">if</span> (!TranslatableTable.class.isAssignableFrom(returnType)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TableMacroImpl</span>(method);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TableMacroImpl ç±»ä¸­çš„ <code>apply</code> æ–¹æ³•è´Ÿè´£è°ƒç”¨ method æ–¹æ³•ï¼Œå¹¶å°†å‚æ•° arguments ä¼ é€’ç»™è¯¥æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè¿”å› <code>TranslatableTable</code> å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> TranslatableTable <span class="title function_">apply</span><span class="params">(List&lt;? extends <span class="meta">@Nullable</span> Object&gt; arguments)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!isStatic(method)) &#123;</span><br><span class="line">            <span class="keyword">final</span> Constructor&lt;?&gt; constructor = method.getDeclaringClass().getConstructor();</span><br><span class="line">            o = constructor.newInstance();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (TranslatableTable) requireNonNull(method.invoke(o, arguments.toArray()), () -&gt; <span class="string">&quot;got null from &quot;</span> + method + <span class="string">&quot; with arguments &quot;</span> + arguments);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Expected &quot;</span> + Arrays.toString(method.getParameterTypes()) + <span class="string">&quot; actual &quot;</span> + arguments, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException | InvocationTargetException | NoSuchMethodException | InstantiationException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‡½æ•°æ‰§è¡Œæµç¨‹"><a class="markdownIt-Anchor" href="#å‡½æ•°æ‰§è¡Œæµç¨‹"></a> å‡½æ•°æ‰§è¡Œæµç¨‹</h3><p>å‰æ–‡æˆ‘ä»¬ä»‹ç»äº†æ ‡é‡å‡½æ•°ã€èšåˆå‡½æ•°ã€è¡¨å‡½æ•°å’Œè¡¨å®ä¸­çš„æ ¸å¿ƒç±»ï¼Œä¸‹é¢æˆ‘ä»¬å°†ç»“åˆ Calcite ä¸­çš„ CoreQuidemTestï¼ˆè¯¥æµ‹è¯•ä½¿ç”¨äº† <a target="_blank" rel="noopener" href="https://github.com/julianhyde/quidem">quidem</a> æµ‹è¯•æ¡†æ¶ï¼Œå¯ä»¥åƒç¼–å†™è„šæœ¬ä¸€æ ·ç¼–å†™æµ‹è¯•ç¨‹åºï¼‰ï¼Œä¸€èµ·æ¥çœ‹çœ‹ <code>functions.iq</code> ä¸­çš„å‡½æ•°æ˜¯å¦‚ä½•æ‰§è¡Œçš„ã€‚ä¸‹é¢çš„ SQL å–è‡ª <code>functions.iq</code> æ–‡ä»¶ï¼Œå®ƒåŒ…å«äº† <code>concat_ws</code> å’Œ <code>cast</code> ä¸¤ä¸ªå‡½æ•°ï¼Œä¼šå°†å‚æ•°æŒ‰ç…§åˆ†éš”ç¬¦è¿›è¡Œç»„è£…ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> concat_ws(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="built_in">cast</span>(<span class="keyword">null</span> <span class="keyword">as</span> <span class="type">varchar</span>), <span class="string">&#x27;b&#x27;</span>);</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç¨‹åºçš„å…¥å£åœ¨ <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/9f231cc5b91b100b6a6fbc3cd6324873529dbf49/testkit/src/main/java/org/apache/calcite/test/QuidemTest.java#L223">QuidemTest#test</a> æ–¹æ³•ï¼Œé€šè¿‡ <code>getPath</code> è·å– <code>functions.iq</code> æ–‡ä»¶è·¯å¾„ï¼Œç„¶åè°ƒç”¨ <code>checkRun</code> ä¸­çš„ <code>new Quidem(config).execute()</code> æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ <code>net/hydromatic/quidem/Quidem.java:285</code> ä½ç½®æ‰“æ–­ç‚¹ï¼Œç„¶åè®¾ç½®æ¡ä»¶æ–­ç‚¹â€”â€”<code>sqlCommand instanceof SqlCommand &amp;&amp; ((SqlCommand) sqlCommand).sql.equalsIgnoreCase(&quot;select concat_ws(',', 'a', cast(null as varchar), 'b')&quot;)</code>ï¼Œè¿™æ ·å¯ä»¥è·Ÿè¸ªä¸Šé¢æµ‹è¯• SQL çš„ <code>checkResult</code> æ–­è¨€é€»è¾‘ã€‚</p><h4 id="sqlvalidator-å‡½æ•°æ³¨å†Œ"><a class="markdownIt-Anchor" href="#sqlvalidator-å‡½æ•°æ³¨å†Œ"></a> SqlValidator å‡½æ•°æ³¨å†Œ</h4><p>SQL è¯­å¥åœ¨ Calcite ä¸­æ‰§è¡Œï¼Œé¦–å…ˆä¼šè°ƒç”¨ <a target="_blank" rel="noopener" href="https://calcite.apache.org/avatica/">Avatica</a> æä¾›çš„ JDBC æ¥å£ï¼Œå†…éƒ¨ä¼šå¯¹ SQL è¯­å¥è¿›è¡Œè§£æï¼Œå¾—åˆ° SqlNode å¯¹è±¡ã€‚ç„¶ååˆ›å»º <code>SqlValidator</code> è¿›è¡Œæ ¡éªŒï¼Œæ ¡éªŒå™¨åˆ›å»ºé€»è¾‘å…·ä½“å‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/b1308feff49c8b747b3bbb52e1519d334bc984ec/core/src/main/java/org/apache/calcite/prepare/CalcitePrepareImpl.java#L743">CalcitePrepareImpl#createSqlValidator</a>ï¼Œé¦–å…ˆä¼šæ ¹æ® <code>context.config()</code> ä¸­é…ç½®çš„ <code>fun</code> å±æ€§ï¼Œè·å–å¯¹åº”æ–¹è¨€ä¸­çš„å‡½æ•°æˆ–è¿ç®—ç¬¦ï¼Œå…·ä½“è°ƒç”¨çš„æ–¹æ³•æ˜¯ <code>SqlLibraryOperatorTableFactory.INSTANCE.getOperatorTable()</code>ï¼Œè¿”å›æ–¹è¨€å¯¹åº”çš„å‡½æ•°ã€è¿ç®—ç¬¦è¡¨å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="meta">@PolyNull</span> T <span class="title function_">fun</span><span class="params">(Class&lt;T&gt; operatorTableClass, <span class="meta">@PolyNull</span> T defaultOperatorTable)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">fun</span> <span class="operator">=</span> CalciteConnectionProperty.FUN.wrap(properties).getString();</span><br><span class="line">    <span class="keyword">if</span> (fun == <span class="literal">null</span> || fun.equals(<span class="string">&quot;&quot;</span>) || fun.equals(<span class="string">&quot;standard&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> defaultOperatorTable;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Parse the libraries</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;SqlLibrary&gt; libraryList = SqlLibrary.parse(fun);</span><br><span class="line">    <span class="comment">// Load standard plus the specified libraries. If &#x27;all&#x27; is among the</span></span><br><span class="line">    <span class="comment">// specified libraries, it is expanded to all libraries (except standard,</span></span><br><span class="line">    <span class="comment">// spatial, all).</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;SqlLibrary&gt; libraryList1 = SqlLibrary.expand(ConsList.of(SqlLibrary.STANDARD, libraryList));</span><br><span class="line">    <span class="comment">// æ ¹æ® libraries è·å–å¯¹åº”çš„ SqlLibraryOperatorTable</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">SqlOperatorTable</span> <span class="variable">operatorTable</span> <span class="operator">=</span> SqlLibraryOperatorTableFactory.INSTANCE.getOperatorTable(libraryList1);</span><br><span class="line">    <span class="keyword">return</span> operatorTableClass.cast(operatorTable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SqlLibraryOperatorTableFactory.INSTANCE.getOperatorTable()</code> æ–¹æ³•å†…éƒ¨ä¼šéå† <code>SqlLibraryOperators</code> ä¸­çš„æˆå‘˜å˜é‡ï¼Œè·å–ç±»å‹ä¸º <code>SqlOperator</code> çš„å˜é‡ï¼Œå¹¶åˆ¤æ–­ <code>LibraryOperator</code> æŒ‡å®šçš„æ–¹è¨€å’Œå½“å‰ <code>fun</code> æŒ‡å®šçš„æ–¹è¨€æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸åŒ¹é…åˆ™ç»§ç»­æ¯”è¾ƒæ–¹è¨€ç»§æ‰¿çš„çˆ¶ç±»æ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´åˆ™å°† SqlOperator æ·»åŠ åˆ°é›†åˆä¸­ï¼Œå¹¶ç»„è£…ä¸º SqlOperatorTable è¿”å›ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Class aClass : classes) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Field field : aClass.getFields()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (SqlOperator.class.isAssignableFrom(field.getType())) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">SqlOperator</span> <span class="variable">op</span> <span class="operator">=</span> (SqlOperator) requireNonNull(field.get(<span class="built_in">this</span>), () -&gt; <span class="string">&quot;null value of &quot;</span> + field + <span class="string">&quot; for &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">                <span class="comment">// åˆ¤æ–­ Library æ˜¯å¦ä¸€è‡´</span></span><br><span class="line">                <span class="keyword">if</span> (operatorIsInLibrary(op.getName(), field, librarySet)) &#123;</span><br><span class="line">                    list.add(op);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException | IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> Util.throwAsRuntime(Util.causeOrSelf(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœªé…ç½®æˆ–é…ç½®ä¸º <code>standard</code>ï¼Œåˆ™ä½¿ç”¨ <code>SqlStdOperatorTable.instance()</code> åˆ›å»º <code>SqlOperatorTable</code> æ ‡å‡†å‡½æ•°ã€è¿ç®—ç¬¦è¡¨å¯¹è±¡ã€‚ç„¶åä¼šå°† CalciteCatalogReader å¯¹è±¡æ·»åŠ åˆ°é›†åˆä¸­ï¼ŒCalciteCatalogReader å¯¹è±¡ä¹Ÿå®ç°äº† SqlOperatorTable æ¥å£ï¼Œæä¾›äº† <code>lookupOperatorOverloads</code> æŸ¥æ‰¾ Schema ä¸­æ³¨å†Œçš„å‡½æ•°å’Œè¿ç®—ç¬¦ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> SqlValidator <span class="title function_">createSqlValidator</span><span class="params">(Context context, CalciteCatalogReader catalogReader, UnaryOperator&lt;SqlValidator.Config&gt; configTransform)</span> &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ® context.config() ä¸­é…ç½®çš„ fun å±æ€§ï¼Œè·å–å¯¹åº”æ–¹è¨€ä¸­çš„å‡½æ•°æˆ–è¿ç®—ç¬¦</span></span><br><span class="line">    <span class="comment">// æœªé…ç½®æˆ–é…ç½®ä¸º standardï¼Œåˆ™ä½¿ç”¨ SqlStdOperatorTable.instance() åˆ›å»ºçš„æ ‡å‡†å‡½æ•°ã€è¿ç®—ç¬¦è¡¨å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">SqlOperatorTable</span> <span class="variable">opTab0</span> <span class="operator">=</span> context.config().fun(SqlOperatorTable.class, SqlStdOperatorTable.instance());</span><br><span class="line">    <span class="keyword">final</span> List&lt;SqlOperatorTable&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    list.add(opTab0);</span><br><span class="line">    <span class="comment">// æ·»åŠ  catalogReader</span></span><br><span class="line">    list.add(catalogReader);</span><br><span class="line">    <span class="comment">// ç»„è£…ä¸ºè°ƒç”¨é“¾ Chain</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">SqlOperatorTable</span> <span class="variable">opTab</span> <span class="operator">=</span> SqlOperatorTables.chain(list);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">JavaTypeFactory</span> <span class="variable">typeFactory</span> <span class="operator">=</span> context.getTypeFactory();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">CalciteConnectionConfig</span> <span class="variable">connectionConfig</span> <span class="operator">=</span> context.config();</span><br><span class="line">    <span class="keyword">final</span> SqlValidator.<span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> configTransform.apply(SqlValidator.Config.DEFAULT.withLenientOperatorLookup(connectionConfig.lenientOperatorLookup()).withConformance(connectionConfig.conformance()).withDefaultNullCollation(connectionConfig.defaultNullCollation()).withIdentifierExpansion(<span class="literal">true</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CalciteSqlValidator</span>(opTab, catalogReader, typeFactory, config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SqlOperatorTable</code> å¯¹è±¡å®ä¾‹æ˜¯ä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œåªæœ‰åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œ <code>ReflectiveSqlOperatorTable#init</code> æ–¹æ³•æ—¶æ‰ä¼šåˆ›å»ºï¼Œ<code>init</code> æ–¹æ³•ä¼šä½¿ç”¨åå°„è·å– <code>SqlStdOperatorTable</code> ç±»ä¸­çš„æˆå‘˜å˜é‡ï¼Œéå†æ—¶ä¼šåˆ¤æ–­å˜é‡æ˜¯å¦ä½¿ç”¨ <code>LibraryOperator</code> æ³¨è§£æ ‡æ³¨ï¼Œå¯¹äºæœ‰æ³¨è§£ä½†æ˜¯æ²¡æœ‰åŒ…å« STANDARD ç±»å‹çš„æ–¹è¨€å‡½æ•°ï¼Œç›´æ¥è·³è¿‡ã€‚å¤„ç†å®Œæˆåï¼Œä¼šå°† SqlOperator æ„å»ºä¸º Map ç»“æœï¼Œkey ä¸º SqlOperator å¤§å†™åç§°ï¼Œvalue ä¸º SqlOperator å¯¹è±¡ï¼Œå¹¶å­˜å‚¨åˆ° SqlStdOperatorTable ä¸­çš„ operators å¯¹è±¡ä¸­ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> SqlOperatorTable <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Use reflection to register the expressions stored in public fields.</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;SqlOperator&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Field field : getClass().getFields()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> field.get(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> SqlOperator) &#123;</span><br><span class="line">                <span class="comment">// Fields do not need the LibraryOperator tag, but if they have it,</span></span><br><span class="line">                <span class="comment">// we index them only if they contain STANDARD library.</span></span><br><span class="line">                <span class="comment">// è·å– LibraryOperator æ³¨è§£ï¼Œæœ‰æ³¨è§£ä½†æ˜¯æ²¡æœ‰ STANDARD ç±»å‹çš„å‡½æ•°ä¸ºæ–¹è¨€å‡½æ•°ï¼Œç›´æ¥è·³è¿‡</span></span><br><span class="line">                <span class="type">LibraryOperator</span> <span class="variable">libraryOperator</span> <span class="operator">=</span> field.getAnnotation(LibraryOperator.class);</span><br><span class="line">                <span class="keyword">if</span> (libraryOperator != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (Arrays.stream(libraryOperator.libraries()).noneMatch(library -&gt; library == SqlLibrary.STANDARD)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ ‡å‡†å‡½æ•°å¤§å¤šä¸ç”¨ LibraryOperator æ³¨è§£æ ‡è®°ï¼Œç›´æ¥æ·»åŠ åˆ°é›†åˆä¸­</span></span><br><span class="line">                list.add((SqlOperator) o);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException | IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> Util.throwAsRuntime(Util.causeOrSelf(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°† SqlOperator æ„å»ºä¸º Map ç»“æœï¼Œkey ä¸º SqlOperator å¤§å†™åç§°ï¼Œvalue ä¸º SqlOperator å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// å­˜å‚¨åˆ° SqlStdOperatorTable ä¸­çš„ operators å¯¹è±¡ä¸­</span></span><br><span class="line">    setOperators(buildIndex(list));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤å°±å®Œæˆäº† CalciteSqlValidator å‡½æ•°æ³¨å†Œæµç¨‹ï¼Œå‡½æ•°å’Œè¿ç®—ç¬¦ä¼šå­˜å‚¨åœ¨ SqlOperatorTable å¯¹è±¡ä¸­ï¼Œé€šè¿‡ <code>CalciteSqlValidator#getOperatorTable</code> æ–¹æ³•ï¼Œå¯ä»¥å¿«é€Ÿè·å–åˆ° SqlOperatorTable è¿›è¡Œå‡½æ•°å’Œè¿ç®—ç¬¦æŸ¥æ‰¾ã€‚</p><h4 id="å‡½æ•°è§£æå’Œæ ¡éªŒ"><a class="markdownIt-Anchor" href="#å‡½æ•°è§£æå’Œæ ¡éªŒ"></a> å‡½æ•°è§£æå’Œæ ¡éªŒ</h4><p>å‡½æ•°æ³¨å†Œå®Œæˆåï¼ŒæŒ‰ç…§ Calcite SQL æ‰§è¡Œçš„æµç¨‹ï¼Œä¼šå…ˆå¯¹ SQL è¯­å¥è¿›è¡Œè§£æï¼Œä¸‹å›¾å±•ç¤ºäº† SQL ä¸­å‡½æ•°è§£æçš„ç»“æœï¼Œ<code>CONCAT_WS</code> å‡½æ•°è¢«è§£æä¸º <code>SqlUnresolvedFunction</code>ï¼Œå®ƒè¡¨ç¤ºè¯¥å‡½æ•°åœ¨ SQL è§£æé˜¶æ®µæ— æ³•å¤„ç†ï¼Œéœ€è¦é€šè¿‡æ ¡éªŒå™¨ä» SqlOperatorTable ä¸­æŸ¥æ‰¾å¯¹åº”çš„å‡½æ•°ï¼Œå¹¶å°†å…¶æ”¹å†™ä¸ºå¯¹åº”çš„å‡½æ•°ç±»å‹ï¼Œ<code>CAST</code> å‡½æ•°è¢«è§£æä¸º <code>SqlCastFunction</code>ï¼Œåœ¨åç»­çš„æ ¡éªŒé˜¶æ®µæ— éœ€å†è¿›è¡Œå¤„ç†ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/function-parse-result.png" title="å‡½æ•°è§£æç»“æœ"><p>é‚£ä¹ˆï¼Œå“ªäº›å‡½æ•°ä¼šè¢«è§£æä¸º <code>SqlUnresolvedFunction</code> ç±»å‹å‘¢ï¼Ÿæ ¹æ® Julian åœ¨ <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/73066108/calcite-does-not-return-correct-sqlkind">Calcite does not return correct SqlKind</a> ä¸­çš„å›ç­”ï¼Œæ‰€æœ‰å‡½æ•°åœ¨è§£æé˜¶æ®µéƒ½ä¼šè¢«å¤„ç†ä¸º SqlUnresolvedFunction ç±»å‹ï¼Œè¿™æ ·èƒ½å¤Ÿä¿æŒè§£æå™¨ç®€å•ã€é«˜æ•ˆã€å¯é¢„æµ‹ï¼Œåœ¨ Calcite æ ¡éªŒé˜¶æ®µï¼Œä¼šä» SqlOperatorTable ä¸­æŸ¥æ‰¾å‡½æ•°ï¼Œå¹¶å°† SqlUnresolvedFunction è½¬æ¢ä¸ºå…·ä½“çš„ Function å¯¹è±¡ã€‚</p><p>ä½†æ˜¯å®é™…ä¸Šï¼Œä» Calcite <code>Parser.jj</code> æ–‡ä»¶æ¥çœ‹ï¼Œä¸è®ºæ˜¯æ ‡å‡†å‡½æ•°ï¼Œè¿˜æ˜¯æ–¹è¨€å‡½æ•°ï¼Œéƒ½æœ‰ç›´æ¥å¤„ç†ä¸ºå…·ä½“ Function å¯¹è±¡çš„æƒ…å†µï¼ŒSqlUnresolvedFunction åªæ˜¯ä½œä¸ºæœ€åçš„å¤„ç†æ–¹å¼ã€‚æ­¤å¤–ï¼ŒSqlUnresolvedFunction ä¹Ÿé€‚ç”¨äºè‡ªå®šä¹‰å‡½æ•°åœºæ™¯ï¼Œè¿™äº›è‡ªå®šä¹‰å‡½æ•°ï¼Œåœ¨ SQL è§£ææ—¶æ˜¯æ— æ³•çŸ¥é“å…·ä½“çš„å‡½æ•°å¯¹è±¡ã€‚</p><p>å®Œæˆ SQL è§£æåï¼ŒCalcite ä¼šè°ƒç”¨æ ¡éªŒå™¨å¯¹ SqlNode è¯­æ³•æ ‘è¿›è¡Œæ ¡éªŒï¼Œå‚è€ƒ<a href="https://strongduanmu.com/blog/in-depth-exploration-of-implementation-principle-of-apache-calcite-sql-validator.html#performunconditionalrewrites">æ·±åº¦æ¢ç©¶ Apache Calcite SQL æ ¡éªŒå™¨å®ç°åŸç†</a>ä¸€æ–‡ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨æ ¡éªŒé˜¶æ®µæ‰§è¡Œ <code>performUnconditionalRewrites</code> æ–¹æ³•æ—¶ï¼Œä¼šåˆ¤æ–­å½“å‰è¿ç®—ç¬¦æ˜¯å¦ä¸º <code>SqlUnresolvedFunction</code>ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ <code>SqlOperatorTable#lookupOperatorOverloads</code> æ–¹æ³•ï¼Œä» SqlOperatorTable ä¸­æŸ¥æ‰¾å‡½æ•°ï¼ŒæŸ¥æ‰¾çš„èŒƒå›´åŒ…æ‹¬å†…ç½®å‡½æ•°ä»¥åŠå…ƒæ•°æ®ä¸­æ³¨å†Œçš„å‡½æ•°ï¼Œç„¶åæ›¿æ¢ SqlNode ä¸­çš„å‡½æ•°å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ¤æ–­å½“å‰ SqlNode æ˜¯å¦ä¸º SqlCall</span></span><br><span class="line"><span class="keyword">if</span> (node <span class="keyword">instanceof</span> SqlCall) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">SqlCall</span> <span class="variable">call</span> <span class="operator">=</span> (SqlCall) node;</span><br><span class="line">    <span class="comment">// è·å– SqlKind ç±»å‹</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">SqlKind</span> <span class="variable">kind</span> <span class="operator">=</span> call.getKind();</span><br><span class="line">    <span class="comment">// è·å– SqlNode ä¸­åŒ…å«çš„è¿ç®—ç¬¦</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;SqlNode&gt; operands = call.getOperandList();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; operands.size(); i++) &#123;</span><br><span class="line">        <span class="type">SqlNode</span> <span class="variable">operand</span> <span class="operator">=</span> operands.get(i);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// æ¯ä¸€ä¸ªè¿ç®—æ³•è°ƒç”¨ performUnconditionalRewrites å¹¶è®¾ç½®åˆ° SqlCall ä¸­</span></span><br><span class="line">        <span class="type">SqlNode</span> <span class="variable">newOperand</span> <span class="operator">=</span> performUnconditionalRewrites(operand, childUnderFrom);</span><br><span class="line">        <span class="keyword">if</span> (newOperand != <span class="literal">null</span> &amp;&amp; newOperand != operand) &#123;</span><br><span class="line">            call.setOperand(i, newOperand);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰è¿ç®—ç¬¦ä¸ºæœªè§£æå‡½æ•° SqlUnresolvedFunction</span></span><br><span class="line">    <span class="keyword">if</span> (call.getOperator() <span class="keyword">instanceof</span> SqlUnresolvedFunction) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">SqlUnresolvedFunction</span> <span class="variable">function</span> <span class="operator">=</span> (SqlUnresolvedFunction) call.getOperator();</span><br><span class="line">        <span class="keyword">final</span> List&lt;SqlOperator&gt; overloads = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// ä» SqlOperatorTable ä¸­æŸ¥æ‰¾å‡½æ•°ï¼ŒæŸ¥æ‰¾çš„èŒƒå›´åŒ…æ‹¬å†…ç½®å‡½æ•°ä»¥åŠå…ƒæ•°æ®ä¸­æ³¨å†Œçš„å‡½æ•°</span></span><br><span class="line">        opTab.lookupOperatorOverloads(function.getNameAsId(), function.getFunctionType(), SqlSyntax.FUNCTION, overloads, catalogReader.nameMatcher());</span><br><span class="line">        <span class="keyword">if</span> (overloads.size() == <span class="number">1</span>) &#123;</span><br><span class="line">          	<span class="comment">// æŸ¥æ‰¾åˆ°å‡½æ•°åˆ™è®¾ç½®æ–°çš„è¿ç®—ç¬¦</span></span><br><span class="line">            ((SqlBasicCall) call).setOperator(overloads.get(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¡éªŒå®Œæˆåï¼Œå¯ä»¥çœ‹åˆ° <code>SqlUnresolvedFunction</code> è¢«æ›¿æ¢ä¸º <code>SqlBasicFunction</code>ï¼Œå®ƒæ˜¯ SqlFunction ç±»çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œä¸»è¦ç”¨æ¥å¤„ç†å¸¸è§„çš„å‡½æ•°æ ¼å¼ï¼Œä¾‹å¦‚ï¼š<code>NVL(value, value)</code>ã€<code>LENGTH(string)</code>ã€<code>LTRIM(string)</code> ç­‰ã€‚è€Œ <code>CAST(NULL AS VARCHAR)</code> ç”±äºåŒ…å«äº†ç±»å‹ä¿¡æ¯ï¼ŒSqlBasicFunction æ— æ³•å¤„ç†ï¼Œå› æ­¤éœ€è¦é¢å¤–å®šä¹‰ä¸€ä¸ª <code>SqlCastFunction</code>ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/validated-sql-node.png" title="æ£€éªŒåçš„ SqlNode"><p>åˆšå¥½èŠåˆ° <code>SqlFunction</code> å¯¹è±¡ï¼Œæˆ‘ä»¬ç»“åˆä¸‹å›¾ï¼Œä¸€èµ·æ¥çœ‹çœ‹ <code>SqlOperator</code> å’Œ <code>SqlFunction</code> ç»§æ‰¿ä½“ç³»ã€‚ä¸‹å›¾å±•ç¤ºäº†éƒ¨åˆ† SqlFunction å®ç°ç±»ï¼Œé™¤äº†æˆ‘ä»¬åˆšåˆšä»‹ç»çš„ <code>SqlBasicFunction</code>ã€<code>SqlCastFunction</code> å’Œ <code>SqlUnresolvedFunction</code> å¤–ï¼Œè¿˜æœ‰ <code>SqlUserDefinedFunction</code>ã€<code>SqlUserDefinedAggFunction</code>ã€<code>SqlUserDefinedTableFunction</code> å’Œ <code>SqlUserDefinedTableMacro</code>ï¼Œä»–ä»¬ç”¨äºå¤„ç†ç”¨æˆ·è‡ªå®šä¹‰çš„å‡½æ•°ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/sql-operator-function-inherited-class.png" title="SqlOperator &amp; SqlFunction ç»§æ‰¿ä½“ç³»"><ul><li>SqlOperator æŠ½è±¡ç±»ï¼š</li></ul><p><code>SqlOperator</code> ä»£è¡¨äº† SQL è¿ç®—ç¬¦ï¼Œå…·ä½“åŒ…æ‹¬å‡½æ•°ã€è¿ç®—ç¬¦ï¼ˆä¾‹å¦‚ï¼š<code>=</code>ï¼‰å’Œè¯­æ³•ç»“æ„ï¼ˆä¾‹å¦‚ï¼š<code>CASE</code> è¯­å¥ï¼‰ï¼Œè¿ç®—ç¬¦å¯ä»¥è¡¨ç¤ºæŸ¥è¯¢çº§è¡¨è¾¾å¼ï¼ˆä¾‹å¦‚ï¼š<code>SqlSelectOperator</code>ï¼‰ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºè¡Œçº§è¡¨è¾¾å¼ï¼ˆä¾‹å¦‚ï¼š<code>SqlBetweenOperator</code>ï¼‰ã€‚</p><p>SqlOperator ä¸æ˜¯ SQL è§£ææ ‘ä¸­çš„ SqlNode èŠ‚ç‚¹ï¼Œå®ƒå…·ä½“è¡¨ç¤ºäº† SqlNode æ‰€å¯¹åº”çš„è¿ç®—ç¬¦ç±»å‹ã€‚è¿ç®—ç¬¦ä¸­é€šå¸¸åŒ…å«äº†è‹¥å¹²ä¸ªæ“ä½œæ•°ï¼Œä¾‹å¦‚ï¼šé™¤æ³•è¿ç®—ç¬¦ä¸­åŒ…å«ä¸¤ä¸ªæ“ä½œæ•°ï¼Œåˆ†åˆ«æ˜¯åˆ†å­å’Œåˆ†æ¯ï¼Œè€Œåœ¨ SqlFunction å‡½æ•°ä¸­ï¼Œå‚æ•°åˆ™æ˜¯æ“ä½œæ•°ã€‚</p><p>å¦‚ä¸‹å±•ç¤ºäº† SqlOperator æŠ½è±¡ç±»çš„æ ¸å¿ƒå­—æ®µå’Œæ–¹æ³•ï¼ŒåŒ…å«äº† <code>name</code>ã€<code>kind</code> ç­‰è¡¨ç¤ºåç§°ã€ç±»å‹çš„åŸºç¡€å­—æ®µï¼Œä»¥åŠç”¨äºåŒºåˆ†è®¡ç®—ä¼˜å…ˆçº§çš„ <code>leftPrec</code> å’Œ <code>rightPrec</code>ï¼Œæ­¤å¤–ï¼Œè¿˜åŒ…å«äº† <code>returnTypeInference</code>ã€<code>operandTypeInference</code> å­—æ®µï¼Œåˆ†åˆ«ç”¨äºæ¨æ–­è¿”å›ç±»å‹ã€æ“ä½œæ•°ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">SqlOperator</span> &#123;</span><br><span class="line">    <span class="comment">// è¿ç®—ç¬¦/å‡½æ•°åç§°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="comment">// SqlNode ç±»å‹ï¼Œä¾‹å¦‚ï¼šEQUALSï¼Œå¯ä»¥ä½¿ç”¨ exp.isA(EQUALS) åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> SqlKind kind;</span><br><span class="line">    <span class="comment">// è¿ç®—ç¬¦ç»‘å®šåˆ°å·¦ä¾§è¡¨è¾¾å¼çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœè¿ç®—ç¬¦æ˜¯å·¦ç»“åˆï¼Œåˆ™æ­¤ä¼˜å…ˆçº§ä½äºå³ä¾§ä¼˜å…ˆçº§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> leftPrec;</span><br><span class="line">    <span class="comment">// è¿ç®—ç¬¦ç»‘å®šåˆ°å³ä¾§è¡¨è¾¾å¼çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœè¿ç®—ç¬¦æ˜¯å·¦ç»“åˆï¼Œåˆ™æ­¤ä¼˜å…ˆçº§é«˜äºå³ä¾§ä¼˜å…ˆçº§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> rightPrec;</span><br><span class="line">    <span class="comment">// æ¨æ–­è¿ç®—ç¬¦è°ƒç”¨åçš„è¿”å›ç±»å‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="meta">@Nullable</span> SqlReturnTypeInference returnTypeInference;</span><br><span class="line">    <span class="comment">// æ¨æ–­æ“ä½œæ•°çš„ç±»å‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="meta">@Nullable</span> SqlOperandTypeInference operandTypeInference;</span><br><span class="line">    <span class="comment">// ç”¨äºæ ¡éªŒæ“ä½œæ•°ç±»å‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="meta">@Nullable</span> SqlOperandTypeChecker operandTypeChecker;</span><br><span class="line">    <span class="comment">// è¿”å›è¿ç®—ç¬¦çš„è¯­æ³•ç±»å‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> SqlSyntax <span class="title function_">getSyntax</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// æ¨æ–­è¿ç®—ç¬¦è°ƒç”¨åçš„è¿”å›ç±»å‹ï¼Œä»…åœ¨æ“ä½œæ•°çš„æ•°é‡å’Œç±»å‹æ ¡éªŒåè°ƒç”¨</span></span><br><span class="line">    <span class="keyword">public</span> RelDataType <span class="title function_">inferReturnType</span><span class="params">(SqlOperatorBinding opBinding)</span> &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>SqlFunction ç±»ï¼š</li></ul><p><code>SqlFunction</code> ç»§æ‰¿äº† <code>SqlOperator</code>ï¼Œæ˜¯ç”¨æ¥è¡¨ç¤ºå‡½æ•°è°ƒç”¨è¯­æ³•çš„è¿ç®—ç¬¦ï¼ŒSqlFunction ä¸­é¢å¤–ç»´æŠ¤äº† <code>category</code> å’Œ <code>sqlIdentifier</code> å­—æ®µï¼Œcategory è¡¨ç¤ºå‡½æ•°çš„åˆ†ç±»ï¼Œä¸»è¦åŒ…æ‹¬ï¼š<code>STRING</code>ã€<code>NUMERIC</code>ã€<code>TIMEDATE</code>ã€<code>SYSTEM</code> ç­‰å‡½æ•°ç±»å‹ï¼Œå®Œæ•´å‡½æ•°ç±»å‹å¯æŸ¥çœ‹ <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/edbd35acf76dbd44cc148f036d0d02cbe2105c81/core/src/main/java/org/apache/calcite/sql/SqlFunctionCategory.java#L33">SqlFunctionCategory</a>ï¼ŒsqlIdentifier è¡¨ç¤ºå‡½æ•°çš„å…¨é™å®šåç§°ï¼Œå†…ç½®å‡½æ•°ä¸º <code>null</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlFunction</span> <span class="keyword">extends</span> <span class="title class_">SqlOperator</span> &#123;</span><br><span class="line">    <span class="comment">// SQL å‡½æ•°åˆ†ç±»</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SqlFunctionCategory category;</span><br><span class="line">    <span class="comment">// å‡½æ•°çš„å…¨é™å®šåç§°ï¼Œå†…ç½®å‡½æ•°ä¸º null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="meta">@Nullable</span> SqlIdentifier sqlIdentifier;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">SqlFunction</span><span class="params">(String name, <span class="meta">@Nullable</span> SqlIdentifier sqlIdentifier, SqlKind kind, <span class="meta">@Nullable</span> SqlReturnTypeInference returnTypeInference, <span class="meta">@Nullable</span> SqlOperandTypeInference operandTypeInference, <span class="meta">@Nullable</span> SqlOperandTypeChecker operandTypeChecker, SqlFunctionCategory category)</span> &#123;</span><br><span class="line">        <span class="comment">// SqlFunction é»˜è®¤ä¼ é€’ç»™çˆ¶ç±» SqlOperator çš„ leftPrec å’Œ rightPrec ä¸º 100</span></span><br><span class="line">        <span class="built_in">super</span>(name, kind, <span class="number">100</span>, <span class="number">100</span>, returnTypeInference, operandTypeInference, operandTypeChecker);</span><br><span class="line">        <span class="built_in">this</span>.sqlIdentifier = sqlIdentifier;</span><br><span class="line">        <span class="built_in">this</span>.category = requireNonNull(category, <span class="string">&quot;category&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–è¯­æ³•ç±»å‹ï¼ŒSqlSyntax.FUNCTION è¡¨ç¤º Foo(x, y) æ ¼å¼çš„å‡½æ•°</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SqlSyntax <span class="title function_">getSyntax</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SqlSyntax.FUNCTION;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>SqlBasicFunction ç±»ï¼š</li></ul><p><code>SqlBasicFunction</code> ç±»ç»§æ‰¿äº† <code>SqlFunction</code>ï¼Œå®ƒæ˜¯å¸¸è§„å‡½æ•°ï¼ˆä¾‹å¦‚ï¼š<code>NVL(value, value)</code>ã€<code>LENGTH(string)</code>ã€<code>LTRIM(string)</code>ï¼‰çš„å…·ä½“å®ç°ç±»ï¼Œç”±äºè¯¥ç±»å­—æ®µéƒ½æ˜¯ <code>final</code> ç±»å‹ï¼Œå› æ­¤ SqlFunction å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œåªå…è®¸é€šè¿‡ <code>with</code> æ–¹æ³•ä¿®æ”¹å­—æ®µï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚</p><p>SqlBasicFunction å­—æ®µä¸­è®°å½•äº† SqlSyntaxï¼Œå…è®¸æ³¨å†Œä¸åŒç±»å‹çš„å‡½æ•°è¯­æ³•ï¼Œå…¨éƒ¨è¯­æ³•ç±»å‹å¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/db60219198442f2c60345fda95a117d379d87a61/core/src/main/java/org/apache/calcite/sql/SqlSyntax.java#L28">SqlSyntax</a>ã€‚æ­¤å¤–ï¼Œè¿˜æä¾›äº† <code>deterministic</code> å’Œ <code>dynamic</code> ä¸¤ä¸ªå±æ€§ï¼Œ<code>deterministic</code> è¡¨ç¤ºæ˜¯å¦æ˜¯ç¡®å®šå‡½æ•°ï¼Œå³ï¼šæ˜¯å¦ä¼ å…¥ç›¸åŒæ“ä½œæ•°æ—¶è¿”å›ç›¸åŒç»“æœï¼Œé»˜è®¤ä¸º trueï¼Œ<code>dynamic</code> åˆ™è¡¨ç¤ºæ˜¯å¦æ˜¯åŠ¨æ€å‡½æ•°ï¼Œå³ï¼šæ˜¯å¦ä¼ å…¥ç›¸åŒæ“ä½œæ•°æ—¶è¿”å›ä¸åŒç»“æœï¼Œé»˜è®¤ä¸º falseï¼ŒåŠ¨æ€å‡½æ•°ä¸èƒ½è¢«ç¼“å­˜ã€‚<code>monotonicityInference</code> æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œç”¨äºæ¨æµ‹å‡½æ•°å•è°ƒæ€§çš„ç­–ç•¥ï¼Œå…¥å‚æ˜¯ SqlOperatorBindingï¼Œè¡¨ç¤º SqlOperator ä¸æ“ä½œæ•°ä¹‹é—´çš„ç»‘å®šå…³ç³»ï¼Œå‡ºå‚åˆ™æ˜¯ <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/571731b80a58eb095ebac7123285c375e7afff90/core/src/main/java/org/apache/calcite/sql/validate/SqlMonotonicity.java#L22">SqlMonotonicity</a>ï¼Œè¡¨ç¤º SQL ä¸­å€¼çš„å•è°ƒæ€§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlBasicFunction</span> <span class="keyword">extends</span> <span class="title class_">SqlFunction</span> &#123;</span><br><span class="line">    <span class="comment">// è¯­æ³•ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ withSyntax ä¿®æ”¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SqlSyntax syntax;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æ˜¯ç¡®å®šå‡½æ•°ï¼Œå³ï¼šæ˜¯å¦ä¼ å…¥ç›¸åŒæ“ä½œæ•°æ—¶è¿”å›ç›¸åŒç»“æœï¼Œé»˜è®¤ä¸º true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> deterministic;</span><br><span class="line">    <span class="comment">// æ“ä½œæ•°å¤„ç†å™¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SqlOperandHandler operandHandler;</span><br><span class="line">    <span class="comment">// æ ¡éªŒè°ƒç”¨çš„ç­–ç•¥ï¼Œç›®å‰æ²¡æœ‰å‘ç°ä½¿ç”¨åœºæ™¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> callValidator;</span><br><span class="line">    <span class="comment">// æ¨æ–­å‡½æ•°å•è°ƒæ€§çš„ç­–ç•¥</span></span><br><span class="line">    <span class="comment">// å…¥å‚æ˜¯ SqlOperatorBindingï¼Œè¡¨ç¤º SqlOperator ä¸æ“ä½œæ•°ä¹‹é—´çš„ç»‘å®šå…³ç³»</span></span><br><span class="line">    <span class="comment">// å‡ºå‚æ˜¯ SqlMonotonicityï¼Œè¡¨ç¤º SQL ä¸­å€¼çš„å•è°ƒæ€§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Function&lt;SqlOperatorBinding, SqlMonotonicity&gt; monotonicityInference;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æ˜¯åŠ¨æ€å‡½æ•°ï¼Œå³ï¼šæ˜¯å¦ä¼ å…¥ç›¸åŒæ“ä½œæ•°æ—¶è¿”å›ä¸åŒç»“æœï¼Œé»˜è®¤ä¸º falseï¼ŒåŠ¨æ€å‡½æ•°ä¸èƒ½è¢«ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> dynamic;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>SqlCastFunction ç±»ï¼š</li></ul><p><code>SqlCastFunction</code> ç±»å’Œ <code>SqlBasicFunction</code> å¹³çº§ï¼Œéƒ½ç»§æ‰¿äº† <code>SqlFunction</code>ï¼Œå®ƒè¡¨ç¤ºäº†å¸¸è§„å‡½æ•°ä¹‹å¤–çš„ç‰¹æ®Šå‡½æ•°ï¼Œæ­¤å¤„è¡¨ç¤º <code>CAST(NULL AS VARCHAR)</code> å‡½æ•°ï¼Œå…¶ä»–ç‰¹æ®Šå‡½æ•°ä¹Ÿæœ‰ç›¸åº”çš„å‡½æ•°ç±»è¡¨ç¤ºã€‚</p><p>å¦‚ä¸‹å±•ç¤ºäº† SqlCastFunction ä¸­çš„æ ¸å¿ƒæ–¹æ³•ï¼Œ<code>getSignatureTemplate</code> æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªæ¨¡æ¿ï¼Œæè¿°å¦‚ä½•æ„å»ºè¿ç®—ç¬¦ç­¾åï¼Œä»¥ CAST å‡½æ•°ä¸ºä¾‹ï¼Œ<code>&#123;0&#125;</code> è¡¨ç¤ºè¿ç®—ç¬¦ CASTï¼Œ<code>&#123;1&#125;</code>ã€<code>&#123;2&#125;</code>ã€<code>&#123;3&#125;</code> æ˜¯æ“ä½œæ•°ã€‚<code>getSyntax</code> æ–¹æ³•æ­¤å¤„è¿”å›çš„æ˜¯ <code>SqlSyntax.SPECIAL</code> è¯­æ³•ç±»å‹ï¼Œå®ƒè¡¨ç¤ºç‰¹æ®Šè¯­æ³•ï¼Œä¾‹å¦‚ï¼šCASEã€CAST è¿ç®—ç¬¦ã€‚<code>getMonotonicity</code> æ–¹æ³•ç”¨äºè·å–å‡½æ•°çš„å•è°ƒæ€§ï¼Œä¼šæ ¹æ®å‡½æ•°æ“ä½œæ•°ä¸­é…ç½®çš„æ’åºè§„åˆ™è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ’åºè§„åˆ™çš„æ¯”è¾ƒå™¨ä¸åŒï¼Œåˆ™è¿”å› NOT_MONOTONICï¼Œå¦‚æœæ“ä½œæ•°çš„ç±»å‹æ—åŒ…å«åœ¨ <code>nonMonotonicCasts</code> ä¸­ï¼ŒåŒæ ·ä¼šè¿”å› NOT_MONOTONIC å•è°ƒæ€§ï¼Œå¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œåˆ™ä¼šè¿”å›ç¬¬ä¸€ä¸ªæ“ä½œæ•°çš„å•è°ƒæ€§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlCastFunction</span> <span class="keyword">extends</span> <span class="title class_">SqlFunction</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰€æœ‰ä¸ä¿æŒå•è°ƒæ€§çš„ç±»å‹è½¬æ¢æ˜ å°„ï¼ŒgetMonotonicity æ–¹æ³•æ ¹æ® map åˆ¤æ–­ï¼ŒåŒ…å«åœ¨å…¶ä¸­çš„ï¼Œåˆ™è¿”å› NOT_MONOTONIC</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SetMultimap&lt;SqlTypeFamily, SqlTypeFamily&gt; nonMonotonicCasts = ImmutableSetMultimap.&lt;SqlTypeFamily, SqlTypeFamily&gt;builder().put(SqlTypeFamily.EXACT_NUMERIC, SqlTypeFamily.CHARACTER).put(SqlTypeFamily.NUMERIC, SqlTypeFamily.CHARACTER).put(SqlTypeFamily.APPROXIMATE_NUMERIC, SqlTypeFamily.CHARACTER).put(SqlTypeFamily.DATETIME_INTERVAL, SqlTypeFamily.CHARACTER).put(SqlTypeFamily.CHARACTER, SqlTypeFamily.EXACT_NUMERIC).put(SqlTypeFamily.CHARACTER, SqlTypeFamily.NUMERIC).put(SqlTypeFamily.CHARACTER, SqlTypeFamily.APPROXIMATE_NUMERIC).put(SqlTypeFamily.CHARACTER, SqlTypeFamily.DATETIME_INTERVAL).put(SqlTypeFamily.DATETIME, SqlTypeFamily.TIME).put(SqlTypeFamily.TIMESTAMP, SqlTypeFamily.TIME).put(SqlTypeFamily.TIME, SqlTypeFamily.DATETIME).put(SqlTypeFamily.TIME, SqlTypeFamily.TIMESTAMP).build();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•ä¼ å…¥ name å’Œ kindï¼ŒSAFE_CAST å’Œ CAST ç±»ä¼¼ï¼Œå®ƒè½¬æ¢å¤±è´¥æ—¶ä¼šè¿”å› NULLï¼Œè€Œä¸æ˜¯å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlCastFunction</span><span class="params">(String name, SqlKind kind)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name, kind, returnTypeInference(kind == SqlKind.SAFE_CAST), InferTypes.FIRST_KNOWN, <span class="literal">null</span>, SqlFunctionCategory.SYSTEM);</span><br><span class="line">        checkArgument(kind == SqlKind.CAST || kind == SqlKind.SAFE_CAST, kind);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿”å›ä¸€ä¸ªæ¨¡æ¿ï¼Œæè¿°å¦‚ä½•æ„å»ºè¿ç®—ç¬¦ç­¾åï¼Œä»¥ CAST å‡½æ•°ä¸ºä¾‹ï¼Œ&#123;0&#125; è¡¨ç¤ºè¿ç®—ç¬¦ CASTï¼Œ&#123;1&#125;ã€&#123;2&#125;ã€&#123;3&#125; æ˜¯æ“ä½œæ•°</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSignatureTemplate</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> operandsCount)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> operandsCount &lt;= <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;0&#125;(&#123;1&#125; AS &#123;2&#125; [FORMAT &#123;3&#125;])&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–è¯­æ³•ç±»å‹ï¼ŒSqlSyntax.SPECIAL è¡¨ç¤ºç‰¹æ®Šè¯­æ³•ï¼Œä¾‹å¦‚ï¼šCASEã€CAST è¿ç®—ç¬¦</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SqlSyntax <span class="title function_">getSyntax</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SqlSyntax.SPECIAL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SqlMonotonicity <span class="title function_">getMonotonicity</span><span class="params">(SqlOperatorBinding call)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ç¬¬ä¸€ä¸ªæ“ä½œæ•°ç±»å‹ï¼ŒCAST åŸå§‹ç±»å‹</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">RelDataType</span> <span class="variable">castFromType</span> <span class="operator">=</span> call.getOperandType(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// è·å–ç¬¬ä¸€ä¸ªæ“ä½œæ•°ç±»å‹æ—</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">RelDataTypeFamily</span> <span class="variable">castFromFamily</span> <span class="operator">=</span> castFromType.getFamily();</span><br><span class="line">        <span class="comment">// è·å–ç¬¬ä¸€ä¸ªæ“ä½œæ•°æ’åºè§„åˆ™å¯¹åº”çš„æ’åºå™¨</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Collator</span> <span class="variable">castFromCollator</span> <span class="operator">=</span> castFromType.getCollation() == <span class="literal">null</span> ? <span class="literal">null</span> : castFromType.getCollation().getCollator();</span><br><span class="line">        <span class="comment">// è·å–ç¬¬äºŒä¸ªæ“ä½œæ•°ç±»å‹ï¼ŒCAST ç›®æ ‡ç±»å‹</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">RelDataType</span> <span class="variable">castToType</span> <span class="operator">=</span> call.getOperandType(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// è·å–ç¬¬äºŒä¸ªæ“ä½œæ•°ç±»å‹æ—</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">RelDataTypeFamily</span> <span class="variable">castToFamily</span> <span class="operator">=</span> castToType.getFamily();</span><br><span class="line">        <span class="comment">// è·å–ç¬¬äºŒä¸ªæ“ä½œæ•°æ’åºè§„åˆ™å¯¹åº”çš„æ’åºå™¨</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Collator</span> <span class="variable">castToCollator</span> <span class="operator">=</span> castToType.getCollation() == <span class="literal">null</span> ? <span class="literal">null</span> : castToType.getCollation().getCollator();</span><br><span class="line">        <span class="comment">// å¦‚æœä¸¤ä¸ªæ“ä½œæ•°çš„æ’åºå™¨ä¸åŒï¼Œåˆ™è¿”å› NOT_MONOTONIC</span></span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(castFromCollator, castToCollator)) &#123;</span><br><span class="line">            <span class="comment">// Cast between types compared with different collators: not monotonic.</span></span><br><span class="line">            <span class="keyword">return</span> SqlMonotonicity.NOT_MONOTONIC;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸¤ä¸ªæ“ä½œæ•°çš„ç±»å‹æ—åŒ…å«åœ¨ nonMonotonicCasts ä¸­ï¼Œåˆ™è¿”å› NOT_MONOTONIC</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (castFromFamily <span class="keyword">instanceof</span> SqlTypeFamily &amp;&amp; castToFamily <span class="keyword">instanceof</span> SqlTypeFamily &amp;&amp; nonMonotonicCasts.containsEntry(castFromFamily, castToFamily)) &#123;</span><br><span class="line">            <span class="keyword">return</span> SqlMonotonicity.NOT_MONOTONIC;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦åˆ™è¿”å›ç¬¬ä¸€ä¸ªæ“ä½œæ•°çš„å•è°ƒæ€§ç­–ç•¥</span></span><br><span class="line">            <span class="keyword">return</span> call.getOperandMonotonicity(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†ä»¥ä¸Šä»‹ç»çš„ <code>SqlOperator</code>ã€<code>SqlFunction</code>ã€<code>SqlBasicFunction</code> ä»¥åŠ <code>SqlCastFunction</code>ï¼Œå…¶ä»–çš„å‡½æ•°è¿ç®—ç¬¦ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®å…´è¶£è¿›è¡Œæ¢ç´¢ï¼Œæœ¬æ–‡å°±ä¸å†ä¸€ä¸€ä»‹ç»ï¼Œä¸‹é¢çš„å°èŠ‚ï¼Œæˆ‘ä»¬å°†ç»§ç»­è·Ÿè¸ªå‡½æ•°è¯­å¥çš„æ‰§è¡Œã€‚</p><h4 id="sql-ä¼˜åŒ–å’Œå‡½æ•°æ‰§è¡Œ"><a class="markdownIt-Anchor" href="#sql-ä¼˜åŒ–å’Œå‡½æ•°æ‰§è¡Œ"></a> SQL ä¼˜åŒ–å’Œå‡½æ•°æ‰§è¡Œ</h4><p>å®Œæˆ SQL è¯­å¥çš„è§£æå’Œæ ¡éªŒåï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªåŒ…å«ä¸åŒ SqlFunction è¿ç®—ç¬¦çš„ SqlNode è¯­æ³•æ ‘ï¼ŒCaclite JDBC æµç¨‹ä¼šè°ƒç”¨ <code>sqlToRelConverter.convertQuery(sqlQuery, needsValidation, true)</code>ï¼Œå°† SqlNode è½¬æ¢ä¸ºå…³ç³»ä»£æ•°è¡¨è¾¾å¼ RelNodeã€‚</p><p>ç”±äºç¤ºä¾‹ SQL ä¸­çš„å‡½æ•°ä½äºæŠ•å½±åˆ—ä¸­ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å…³æ³¨ Projection è½¬æ¢é€»è¾‘å³å¯ï¼Œä¸‹é¢å±•ç¤ºäº† <code>SqlToRelConverter#convertSelectList</code> çš„éƒ¨åˆ†è½¬æ¢é€»è¾‘ï¼ŒæŠ•å½±åˆ—ä¼šè°ƒç”¨ <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/98b252b36c84c4715c5bbe8c8a65355c103b3f9e/core/src/main/java/org/apache/calcite/sql2rel/SqlToRelConverter.java#L5116">Blackboard</a> å¯¹è±¡çš„ <code>convertExpression</code> æ–¹æ³•ï¼Œè¯¥ç±»å®ç°äº† <code>SqlVisitor</code> æ¥å£ï¼Œå¯ä»¥ç”¨äºéå† AST å¤„ç†å¯¹åº” SqlNode è½¬æ¢ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Project select clause.</span></span><br><span class="line"><span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (SqlNode expr : selectList) &#123;</span><br><span class="line">    ++i;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">SqlNode</span> <span class="variable">measure</span> <span class="operator">=</span> SqlValidatorUtil.getMeasure(expr);</span><br><span class="line">    <span class="keyword">final</span> RexNode e;</span><br><span class="line">    <span class="keyword">if</span> (measure != <span class="literal">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ Blackboard å¯¹è±¡ convertExpression æ–¹æ³•ï¼Œè¯¥ç±»å®ç°äº† SqlVisitorï¼Œç”¨äºéå† AST å¤„ç†å¯¹åº” SqlCall è½¬æ¢</span></span><br><span class="line">        e = bb.convertExpression(expr);</span><br><span class="line">    &#125;</span><br><span class="line">    exprs.add(e);</span><br><span class="line">    fieldNames.add(deriveAlias(expr, aliases, i));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äº <code>expr</code> æ˜¯ä¸€ä¸ª <code>SqlBasicCall</code>ï¼Œéå†è¯­æ³•æ ‘æ—¶ä¼šè°ƒç”¨ <code>visit(SqlCall call)</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ <code>exprConverter.convertCall</code> æ–¹æ³•ï¼ŒexprConverter å¯¹åº”çš„ç±»æ˜¯ <code>SqlNodeToRexConverter</code> ç”¨äºå°† SqlNode è½¬æ¢ä¸º <code>RexNode</code> è¡Œè¡¨è¾¾å¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RexNode <span class="title function_">visit</span> <span class="params">(SqlCall call)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (agg != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">SqlOperator</span> <span class="variable">op</span> <span class="operator">=</span> call.getOperator();</span><br><span class="line">        <span class="keyword">if</span> (window == <span class="literal">null</span> &amp;&amp; (op.isAggregator() || op.getKind() == SqlKind.FILTER || op.getKind() == SqlKind.WITHIN_DISTINCT || op.getKind() == SqlKind.WITHIN_GROUP)) &#123;</span><br><span class="line">            <span class="keyword">return</span> requireNonNull(agg.lookupAggregates(call), () -&gt; <span class="string">&quot;agg.lookupAggregates for call &quot;</span> + call);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ SqlNodeToRexConverter#convertCall æ–¹æ³•ï¼ŒSqlNodeToRexConverter ç”¨äºå°† SqlNode è½¬æ¢ä¸º RexNode è¡Œè¡¨è¾¾å¼</span></span><br><span class="line">    <span class="keyword">return</span> exprConverter.convertCall(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">SqlCallBinding</span>(validator(), scope, call).permutedCall());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SqlNodeToRexConverter#convertCall</code> å†…éƒ¨åˆ™æ˜¯è°ƒç”¨ <code>convertletTable</code> è·å– <code>SqlRexConvertlet</code>ï¼Œç„¶åè°ƒç”¨ <code>SqlRexConvertlet#convertCall</code> è½¬æ¢ä¸º RexNodeã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/convertlet_table_map.png" title="convertletTable å†…éƒ¨ map ç»´æŠ¤çš„ SqlFunction æ˜ å°„"><p><code>SqlRexConvertlet#convertCall</code> é€šè¿‡åå°„è°ƒç”¨ <code>StandardConvertletTable#convertFunction</code> æ–¹æ³•ï¼Œ<code>CONCAT_WS</code> å‡½æ•°å°±ä¼šè°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œè½¬æ¢ï¼Œ<code>CAST</code> å‡½æ•°åˆ™ä¼šè°ƒç”¨ <code>StandardConvertletTable#convertCast</code> æ–¹æ³•ã€‚Calcite æ”¯æŒçš„è¿ç®—ç¬¦ã€å‡½æ•°è½¬æ¢é€»è¾‘ï¼Œå¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/strongduanmu/calcite/blob/c8cb56525dbc908da4a9081f062d87adfe27ab80/core/src/main/java/org/apache/calcite/sql2rel/StandardConvertletTable.java#L120">StandardConvertletTable</a> æ„é€ æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RexNode <span class="title function_">convertFunction</span><span class="params">(SqlRexContext cx, SqlFunction fun, SqlCall call)</span> &#123;</span><br><span class="line">    <span class="comment">// è½¬æ¢æ“ä½œæ•°ä¸º RexNode</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;RexNode&gt; exprs = convertOperands(cx, call, SqlOperandTypeChecker.Consistency.NONE);</span><br><span class="line">    <span class="keyword">if</span> (fun.getFunctionType() == SqlFunctionCategory.USER_DEFINED_CONSTRUCTOR) &#123;</span><br><span class="line">        <span class="keyword">return</span> makeConstructorCall(cx, fun, exprs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">RelDataType</span> <span class="variable">returnType</span> <span class="operator">=</span> cx.getValidator().getValidatedNodeTypeIfKnown(call);</span><br><span class="line">    <span class="keyword">if</span> (returnType == <span class="literal">null</span>) &#123;</span><br><span class="line">        returnType = cx.getRexBuilder().deriveReturnType(fun, exprs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ RexBuilder#makeCall è½¬æ¢</span></span><br><span class="line">    <span class="keyword">return</span> cx.getRexBuilder().makeCall(call.getParserPosition(), returnType, fun, exprs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è½¬æ¢å®Œæˆåï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†é€»è¾‘æ‰§è¡Œè®¡åˆ’æ ‘ <code>RelNode Tree</code>ï¼Œé€šè¿‡ <code>RelOptUtil.toString()</code> æ–¹æ³•è¾“å‡ºï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æ„ï¼Œ<code>CONCAT_WS</code> å‡½æ•°è¢«è½¬æ¢ä¸º <code>LogicalProject(EXPR$0=[CONCAT_WS(',', 'a', null:VARCHAR, 'b')])</code>ï¼Œè€Œ <code>CAST</code> å‡½æ•°åˆ™è½¬æ¢ä¸º <code>null:VARCHAR</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LogicalProject(EXPR$0=[CONCAT_WS(&#x27;,&#x27;, &#x27;a&#x27;, null:VARCHAR, &#x27;b&#x27;)])</span><br><span class="line">  LogicalValues(tuples=[[&#123; 0 &#125;]])</span><br></pre></td></tr></table></figure><p>ç»è¿‡ Calcite ä¼˜åŒ–åï¼Œé€»è¾‘æ‰§è¡Œè®¡åˆ’ä¼šè¢«è½¬æ¢ä¸ºç‰©ç†æ‰§è¡Œè®¡åˆ’ï¼Œå¦‚ä¸‹å±•ç¤ºäº†é€»è¾‘æ‰§è¡Œè®¡åˆ’çš„ç»“æ„ï¼Œ<code>CONCAT_WS</code> è¢«è½¬æ¢ä¸º <code>expr#5=[CONCAT_WS($t1, $t2, $t3, $t4)</code>ï¼Œ<code>CAST</code> å‡½æ•°è¢«è½¬æ¢ä¸º <code>expr#3=[null:VARCHAR]</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EnumerableCalc(expr#0=[&#123;inputs&#125;], expr#1=[&#x27;,&#x27;], expr#2=[&#x27;a&#x27;], expr#3=[null:VARCHAR], expr#4=[&#x27;b&#x27;], expr#5=[CONCAT_WS($t1, $t2, $t3, $t4)], EXPR$0=[$t5])</span><br><span class="line">  EnumerableValues(tuples=[[&#123; 0 &#125;]])</span><br></pre></td></tr></table></figure><p>ç”±äº Calcite JDBC é»˜è®¤ä½¿ç”¨ <code>Enumerable</code> è°ƒç”¨çº¦å®šï¼Œç”Ÿæˆçš„ç‰©ç†è¿ç®—ç¬¦éƒ½æ˜¯ <code>EnumerableRel</code>ï¼Œè°ƒç”¨ <code>implement</code> æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œä¼šè°ƒç”¨ <code>EnumerableInterpretable#toBindable</code> æ–¹æ³•ç”Ÿæˆ <code>Bindable</code> å¯¹è±¡ï¼Œ<a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/571731b80a58eb095ebac7123285c375e7afff90/core/src/main/java/org/apache/calcite/runtime/Bindable.java#L27">Bindable</a> ç±»å¯ä»¥ç»‘å®š DataContext ç”Ÿæˆ Enumerable è¿›è¡Œæ‰§è¡Œã€‚<code>EnumerableInterpretable#toBindable</code> æ–¹æ³•å®ç°é€»è¾‘å¦‚ä¸‹ï¼Œå®ƒä¼šè°ƒç”¨ <code>implementRoot</code> ç”Ÿæˆæ‰§è¡Œä»£ç ï¼Œç„¶åä½¿ç”¨ Janio å°†ä»£ç åº“ç¼–è¯‘ä¸º Bindable å®ç°ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Bindable <span class="title function_">toBindable</span><span class="params">(Map&lt;String, Object&gt; parameters, CalcitePrepare.<span class="meta">@Nullable</span> SparkHandler spark, EnumerableRel rel, EnumerableRel.Prefer prefer)</span> &#123;</span><br><span class="line">    <span class="type">EnumerableRelImplementor</span> <span class="variable">relImplementor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EnumerableRelImplementor</span>(rel.getCluster().getRexBuilder(), parameters);</span><br><span class="line">    <span class="comment">// è°ƒç”¨ implementRoot ç”Ÿæˆæ‰§è¡Œä»£ç </span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ClassDeclaration</span> <span class="variable">expr</span> <span class="operator">=</span> relImplementor.implementRoot(rel, prefer);</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> Expressions.toString(expr.memberDeclarations, <span class="string">&quot;\n&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (spark != <span class="literal">null</span> &amp;&amp; spark.enabled()) &#123;</span><br><span class="line">            <span class="keyword">return</span> spark.compile(expr, s);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ Janio ç¼–è¯‘ä»£ç ä¸º Bindable å®ç°ç±»</span></span><br><span class="line">            <span class="keyword">return</span> getBindable(expr, s, rel.getRowType().getFieldCount());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> Helper.INSTANCE.wrap(<span class="string">&quot;Error while compiling generated Java code:\n&quot;</span> + s, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>implementRoot</code> æ–¹æ³•æ ¹æ®ç‰©ç†è®¡åˆ’æ ‘è¿›è¡Œéå†ï¼Œé¦–å…ˆè°ƒç”¨ <code>EnumerableValues#implement</code> æ–¹æ³•ï¼Œç”Ÿæˆçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> org.apache.calcite.linq4j.Linq4j.asEnumerable(<span class="keyword">new</span> <span class="title class_">Integer</span>[] &#123;</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åä¼šå›åˆ° <code>EnumerableCalc#implement</code> ç»§ç»­æ‰§è¡Œï¼ŒEnumerableValues ç”Ÿæˆçš„ç»“æœä¼šä½œä¸º EnumerableCalc æ‰§è¡Œä»£ç çš„ä¸€éƒ¨åˆ†ï¼ŒEnumerableCalc æ ¸å¿ƒç”ŸæˆæŠ•å½±åˆ—å‡½æ•°æ‰§è¡Œä»£ç çš„é€»è¾‘å¦‚ä¸‹ï¼Œä¼šè°ƒç”¨ <code>RexToLixTranslator#translateProjects</code> æ–¹æ³•è¿›è¡Œè½¬æ¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EnumerableValues#implement() æ–¹æ³•</span></span><br><span class="line">List&lt;Expression&gt; expressions = RexToLixTranslator.translateProjects(program, typeFactory, conformance, builder3, <span class="literal">null</span>, physType, DataContext.ROOT, <span class="keyword">new</span> <span class="title class_">RexToLixTranslator</span>.InputGetterImpl(input, result.physType), implementor.allCorrelateVariables);</span><br><span class="line">builder3.add(Expressions.return_(<span class="literal">null</span>, physType.record(expressions)));</span><br></pre></td></tr></table></figure><p><code>RexToLixTranslator#translateProjects</code> å†…éƒ¨åˆ™ä¼šç»§ç»­è°ƒç”¨ <code>RexToLixTranslator#translateList</code> æ–¹æ³•ï¼ŒtranslateList æ–¹æ³•ä¼šéå†è¿ç®—ç¬¦çš„æ“ä½œæ•°ï¼Œæ­¤æ¡ˆä¾‹ä¸­æ“ä½œæ•°å¯¹è±¡ä¸º <code>RexLocalRef</code> ç±»å‹ï¼Œå†…å®¹ä¸º <code>$t5</code>ï¼Œè¡¨ç¤ºå¼•ç”¨ <code>expr#5=[CONCAT_WS($t1, $t2, $t3, $t4)]</code>ï¼Œè·å–åˆ° RexNode åï¼Œä¼šç»§ç»­å†…éƒ¨çš„è°ƒç”¨ translate æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…ä¼šä½¿ç”¨ RexToLixTranslatorï¼ˆå®ç°äº† <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/6f64865eb8c71a65bde60a19de2de42775fae4ed/core/src/main/java/org/apache/calcite/rex/RexVisitor.java#L33">RexVisitor</a> æ¥å£ï¼‰è®¿é—® RexNodeï¼Œè¯¥æ–¹æ³•ä¼šè®¿é—® <code>RexToLixTranslator#visitLocalRef</code> æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Expression&gt; <span class="title function_">translateList</span><span class="params">(List&lt;? extends RexNode&gt; operandList, <span class="meta">@Nullable</span> List&lt;? extends <span class="meta">@Nullable</span> Type&gt; storageTypes)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;Expression&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(operandList.size());</span><br><span class="line">    <span class="comment">// éå†æŠ•å½±åˆ—æ“ä½œæ•°</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; operandList.size(); i++) &#123;</span><br><span class="line">        <span class="comment">// è¿”å› RexLocalRef ç±»å‹ï¼Œå†…å®¹ä¸º $t5ï¼Œè¡¨ç¤ºå¼•ç”¨ expr#5=[CONCAT_WS($t1, $t2, $t3, $t4)]</span></span><br><span class="line">        <span class="type">RexNode</span> <span class="variable">rex</span> <span class="operator">=</span> operandList.get(i);</span><br><span class="line">        <span class="type">Type</span> <span class="variable">desiredType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (storageTypes != <span class="literal">null</span>) &#123;</span><br><span class="line">            desiredType = storageTypes.get(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç»§ç»­è°ƒç”¨ translate æ–¹æ³•è½¬æ¢å‡½æ•°</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Expression</span> <span class="variable">translate</span> <span class="operator">=</span> translate(rex, desiredType);</span><br><span class="line">        list.add(translate);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Expression <span class="title function_">translate</span><span class="params">(RexNode expr, RexImpTable.NullAs nullAs, <span class="meta">@Nullable</span> Type storageType)</span> &#123;</span><br><span class="line">    currentStorageType = storageType;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ RexToLixTranslator éå† RexNodeï¼Œè¯¥æ–¹æ³•ä¼šè®¿é—® RexToLixTranslator#visitLocalRef æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> expr.accept(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Expression</span> <span class="variable">translated</span> <span class="operator">=</span> requireNonNull(EnumUtils.toInternal(result.valueVariable, storageType));</span><br><span class="line">    <span class="comment">// When we asked for not null input that would be stored as box, avoid unboxing</span></span><br><span class="line">    <span class="keyword">if</span> (RexImpTable.NullAs.NOT_POSSIBLE == nullAs &amp;&amp; translated.type.equals(storageType)) &#123;</span><br><span class="line">        <span class="keyword">return</span> translated;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nullAs.handle(translated);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>visitLocalRef</code> æ–¹æ³•ä¼šæ ¹æ® <code>RexLocalRef</code> ä¸­è®°å½•çš„å¼•ç”¨ä¸‹æ ‡ï¼Œå°†å¯¹è±¡è½¬æ¢ä¸º <code>RexCall</code>ï¼Œç„¶åç»§ç»­ä½¿ç”¨ RexToLixTranslator è¿›è¡Œè®¿é—®ï¼Œæœ€ç»ˆé€»è¾‘ä¼šæ‰§è¡Œåˆ° <code>RexToLixTranslator#visitCall</code> æ–¹æ³•ã€‚æ­£å¦‚ä¸‹é¢ Calcite java doc ä¸­è¯´æ˜çš„é‚£æ ·ï¼Œå¤§éƒ¨åˆ†çš„è¿ç®—ç¬¦å®ç°æ—¶éƒ½ä¼šä» <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/60e0a3f441a009e55a36cac192253a436bec3f6d/core/src/main/java/org/apache/calcite/adapter/enumerable/RexImpTable.java#L521">RexImpTable</a> ä¸­è·å–å®ç°å™¨ï¼Œä½†ä¹Ÿæœ‰äº›ç‰¹æ®Šçš„å‡½æ•°éœ€è¦å•ç‹¬å®ç°ï¼Œä¾‹å¦‚ <code>CASE</code> è¯­å¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Visit &#123;<span class="doctag">@code</span> RexCall&#125;. For most &#123;<span class="doctag">@code</span> SqlOperator&#125;s, we can get the implementor</span></span><br><span class="line"><span class="comment"> * from &#123;<span class="doctag">@code</span> RexImpTable&#125;. Several operators (e.g., CaseWhen) with special semantics</span></span><br><span class="line"><span class="comment"> * need to be implemented separately.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">visitCall</span><span class="params">(RexCall call)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// ä» RexImpTable ä¸­è·å–è¿ç®—ç¬¦å®ç°å™¨</span></span><br><span class="line">    <span class="keyword">final</span> RexImpTable.<span class="type">RexCallImplementor</span> <span class="variable">implementor</span> <span class="operator">=</span> RexImpTable.INSTANCE.get(operator);</span><br><span class="line">    <span class="keyword">if</span> (implementor == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;cannot translate call &quot;</span> + call);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–æ“ä½œæ•°</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;RexNode&gt; operandList = call.getOperands();</span><br><span class="line">    <span class="keyword">final</span> List&lt;<span class="meta">@Nullable</span> Type&gt; storageTypes = EnumUtils.internalTypes(operandList);</span><br><span class="line">    <span class="keyword">final</span> List&lt;Result&gt; operandResults = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// éå†æ“ä½œæ•°ï¼Œè°ƒç”¨å„è‡ªçš„ implement æ–¹æ³•ç”Ÿæˆä»£ç </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; operandList.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Result</span> <span class="variable">operandResult</span> <span class="operator">=</span> implementCallOperand(operandList.get(i), storageTypes.get(i), <span class="built_in">this</span>);</span><br><span class="line">        operandResults.add(operandResult);</span><br><span class="line">    &#125;</span><br><span class="line">    callOperandResultMap.put(call, operandResults);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> implementor.implement(<span class="built_in">this</span>, call, operandResults);</span><br><span class="line">    rexResultMap.put(call, result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹å›¾å±•ç¤ºäº†ä» RexImpTable ä¸­è·å–çš„è¿ç®—ç¬¦å®ç°å™¨ï¼Œå¯ä»¥çœ‹åˆ°å®ç°å™¨ä¸­åŒ…å«äº† <code>CONCAT_WS</code> å‡½æ•°å¯¹åº”çš„å®ç°æ–¹æ³• <code>SqlFunctions.concatMultiWithSeparator()</code>ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/concat_ws_function_call.png" title="CONCAT_WS å‡½æ•°è°ƒç”¨"><p>æœ€ç»ˆï¼ŒCaclite ä¼šç”Ÿæˆå¦‚ä¸‹çš„ä»£ç ï¼Œå¯¹å‡½æ•°çš„è°ƒç”¨é€»è¾‘ä½äº <code>current()</code> æ–¹æ³•ä¸­ï¼Œ<code>CONCAT_WS</code> å‡½æ•°ä¼šè°ƒç”¨ <code>SqlFunctions.concatMultiWithSeparator()</code> æ–¹æ³•ï¼Œå¹¶å°† SQL ä¸­çš„å‚æ•°ä¼ é€’ç»™å‡½æ•°æ–¹æ³•ã€‚<code>CAST</code> å‡½æ•°ç”±äºå…¥å‚ä¸º <code>null</code>ï¼Œå› æ­¤æ— éœ€è°ƒç”¨å…·ä½“çš„å‡½æ•°ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œ <code>(String) null</code> è¿›è¡Œè½¬æ¢ã€‚<code>getElementType</code> ç”¨äºè¿”å› SQL æ‰§è¡Œç»“æœçš„ç±»å‹ï¼Œç¤ºä¾‹ SQL è¿”å›ç»“æœä¸º String ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> org.apache.calcite.linq4j.Enumerable <span class="title function_">bind</span><span class="params">(<span class="keyword">final</span> org.apache.calcite.DataContext root)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> org.apache.calcite.linq4j.<span class="type">Enumerable</span> <span class="variable">_inputEnumerable</span> <span class="operator">=</span> org.apache.calcite.linq4j.Linq4j.asEnumerable(<span class="keyword">new</span> <span class="title class_">Integer</span>[] &#123;</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">org</span>.apache.calcite.linq4j.AbstractEnumerable() &#123;</span><br><span class="line">        <span class="keyword">public</span> org.apache.calcite.linq4j.Enumerator <span class="title function_">enumerator</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">org</span>.apache.calcite.linq4j.Enumerator() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">final</span> org.apache.calcite.linq4j.<span class="type">Enumerator</span> <span class="variable">inputEnumerator</span> <span class="operator">=</span> _inputEnumerable.enumerator();</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reset</span><span class="params">()</span> &#123;</span><br><span class="line">                    inputEnumerator.reset();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">moveNext</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> inputEnumerator.moveNext();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">                    inputEnumerator.close();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">public</span> Object <span class="title function_">current</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> org.apache.calcite.runtime.SqlFunctions.concatMultiWithSeparator(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123;</span><br><span class="line">                        <span class="string">&quot;,&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;a&quot;</span>, (String) <span class="literal">null</span>,</span><br><span class="line">                        <span class="string">&quot;b&quot;</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Class <span class="title function_">getElementType</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> java.lang.String.class;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€å Caclite JDBC ä¼šè°ƒç”¨ <code>Bindable#bind</code> æ–¹æ³•æ‰§è¡Œï¼Œä¼šè¿”å›ä¸€ä¸ª Enumerable æšä¸¾å¯¹è±¡ï¼Œä½¿ç”¨æšä¸¾å¯¹è±¡å°±å¯ä»¥å¾ˆå®¹æ˜“åœ°è·å–åˆ°æŸ¥è¯¢ç»“æœé›†ã€‚</p><h2 id="udf-å‡½æ•°æ‰©å±•å®è·µ"><a class="markdownIt-Anchor" href="#udf-å‡½æ•°æ‰©å±•å®è·µ"></a> UDF å‡½æ•°æ‰©å±•å®è·µ</h2><p>å‰æ–‡æˆ‘ä»¬ä»‹ç»äº† Caclite å‡½æ•°ç›¸å…³çš„å®ç°ç±»ï¼Œå¸¦é¢†å¤§å®¶ä¸€èµ·æ¢ç©¶äº†æ ‡é‡å‡½æ•°ã€èšåˆå‡½æ•°ã€è¡¨å‡½æ•° &amp; è¡¨å®åœ¨ Schema ä¸­çš„å®ç°ï¼Œå¹¶ç»“åˆ Calcite å‡½æ•°æµ‹è¯• Caseï¼Œä¸€èµ·è·Ÿè¸ªäº†å‡½æ•°çš„æ‰§è¡Œæµç¨‹ã€‚<strong>UDF å‡½æ•°å’Œ Calcite å†…ç½®å‡½æ•°ç±»ä¼¼ï¼Œåªæ˜¯å®ç°é€»è¾‘ç”±ç”¨æˆ·æä¾›å¹¶æ³¨å†Œåˆ° Schema ä¸­ï¼ŒCalcite åœ¨æ‰§è¡Œæ—¶ä¼šä» Schema ä¸­æ‰¾åˆ°å‡½æ•°å®ç°ç±»ï¼Œå¹¶ç”Ÿæˆå¯æ‰§è¡Œä»£ç </strong>ã€‚ä¸‹é¢å°èŠ‚ï¼Œæˆ‘ä»¬ç»“åˆä¸€äº› UDF æ¡ˆä¾‹ï¼Œä¸ºå¤§å®¶ä»‹ç»ä¸‹ä¸åŒç±»å‹çš„ UDF å‡½æ•°å¦‚ä½•æ‰©å±•ã€‚</p><h3 id="udf-æ ‡é‡å‡½æ•°æ‰©å±•"><a class="markdownIt-Anchor" href="#udf-æ ‡é‡å‡½æ•°æ‰©å±•"></a> UDF æ ‡é‡å‡½æ•°æ‰©å±•</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„æ ‡é‡å‡½æ•° <code>INDEX_OF</code>ï¼Œç”¨äºä» <code>content</code> ä¸­æŸ¥æ‰¾ <code>target</code> å­—ç¬¦ä¸²ï¼Œå¹¶è¿”å›å…¶ä½ç½®ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒUDF å‡½æ•°æœ€é‡è¦çš„æ˜¯å‡½æ•°å®ç°é€»è¾‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥å®ç°å¦‚ä¸‹çš„ <code>indexOf</code> æ–¹æ³•ï¼Œå†…éƒ¨å®ç°é€»è¾‘å¾ˆç®€å•ï¼Œè°ƒç”¨ <code>String#indexOf</code> å®ç°å­—ç¬¦ä¸²ä½ç½®æŸ¥æ‰¾ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;unused&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UDFRegistry</span> &#123;</span><br><span class="line">    <span class="comment">// ä» content ä¸­æŸ¥æ‰¾ target å­—ç¬¦ä¸²ï¼Œå¹¶è¿”å›å…¶ä½ç½®</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">indexOf</span><span class="params">(String content, String target)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> content.indexOf(target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°å‡½æ•°é€»è¾‘åï¼Œç¬¬äºŒæ­¥éœ€è¦æ³¨å†Œå‡½æ•°å®ç°åˆ° Schema ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™å¦‚ä¸‹çš„é€»è¾‘ï¼Œä» <code>calciteConnection</code> ä¸­è·å– <code>SchemaPlus</code> å¯¹è±¡ï¼Œç„¶åé€šè¿‡ <code>add</code> æ–¹æ³•å°† <code>Function</code> å¯¹è±¡æ·»åŠ åˆ° Schema ä¸­ã€‚<code>ScalarFunctionImpl#create</code> æ–¹æ³•è´Ÿè´£ <code>Function</code> å¯¹è±¡è´Ÿè´£å‡½æ•°å¯¹è±¡çš„åˆ›å»ºï¼Œå®ƒçš„å†…éƒ¨å®ç°é€»è¾‘æˆ‘ä»¬å‰æ–‡å·²ç»ä»‹ç»ï¼Œå†…éƒ¨ä½¿ç”¨åå°„è·å– Method å¯¹è±¡ï¼Œç„¶ååˆ›å»º CallImplementor å­˜å‚¨åœ¨ ScalarFunctionImpl ä¸­ï¼Œç”¨äºåç»­çš„å‡½æ•°æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">UDFExample</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class.forName(<span class="string">&quot;org.apache.calcite.jdbc.Driver&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(<span class="string">&quot;jdbc:calcite:&quot;</span>, initProps())) &#123;</span><br><span class="line">            <span class="type">CalciteConnection</span> <span class="variable">calciteConnection</span> <span class="operator">=</span> connection.unwrap(CalciteConnection.class);</span><br><span class="line">            <span class="type">SchemaPlus</span> <span class="variable">rootSchema</span> <span class="operator">=</span> calciteConnection.getRootSchema();</span><br><span class="line">            <span class="type">Schema</span> <span class="variable">schema</span> <span class="operator">=</span> createSchema(rootSchema);</span><br><span class="line">            rootSchema.add(<span class="string">&quot;calcite_function&quot;</span>, schema);</span><br><span class="line">            rootSchema.add(<span class="string">&quot;INDEX_OF&quot;</span>, Objects.requireNonNull(ScalarFunctionImpl.create(UDFRegistry.class, <span class="string">&quot;indexOf&quot;</span>)));</span><br><span class="line">            executeQuery(calciteConnection, <span class="string">&quot;SELECT INDEX_OF(user_name, &#x27;san&#x27;) FROM calcite_function.t_user&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œ<strong>è‡ªå®šä¹‰å‡½æ•°åœ¨æ‰§è¡Œé˜¶æ®µå’Œå†…ç½®å‡½æ•°åˆæœ‰ä»€ä¹ˆä¸åŒå‘¢</strong>ï¼Ÿæˆ‘ä»¬æ¥è·Ÿè¸ªä¸‹è¿™æ®µä»£ç ï¼Œä¸€èµ·æ¥çœ‹çœ‹å†…éƒ¨å®ç°æœ‰å“ªäº›å·®å¼‚ã€‚é¦–å…ˆï¼ŒSchema ä¸­æ³¨å†Œçš„ Function å¯¹è±¡ï¼Œä¼šåœ¨ Calcite JDBC æ‰§è¡Œæ—¶ï¼Œå°è£…åˆ° <code>CalciteCatalogReader</code> å¯¹è±¡ä¸­ï¼Œå¹¶æä¾›äº† <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/b1308feff49c8b747b3bbb52e1519d334bc984ec/core/src/main/java/org/apache/calcite/prepare/CalciteCatalogReader.java#L254">lookupOperatorOverloads</a> ç”¨äºæŸ¥æ‰¾å†…ç½®å’Œè‡ªå®šä¹‰å‡½æ•°ã€‚ç„¶åä¼šåˆ›å»º <code>SqlValidator</code> å¯¹è±¡ï¼Œæ­¤æ—¶ä¼šå°† <code>CalciteCatalogReader</code> å¯¹è±¡å°è£…åˆ° <code>SqlOperatorTable</code> å¯¹è±¡ä¸­ï¼Œç”¨äºåç»­è¿ç®—ç¬¦å’Œå‡½æ•°çš„æŸ¥æ‰¾ï¼Œä¹ŸåŒ…å«äº†è‡ªå®šä¹‰å‡½æ•°çš„æŸ¥æ‰¾ã€‚</p><p>Calcite SQL è§£æå™¨ä¼šå°† <code>SELECT INDEX_OF(user_name, 'san') FROM calcite_function.t_user</code> è§£æä¸º SqlNode æŠ½è±¡è¯­æ³•æ ‘ï¼Œæ­¤æ—¶å¯ä»¥çœ‹åˆ° <code>INDEX_OF</code> å‡½æ•°è¢«è§£æä¸º SqlUnresolvedFunction å¯¹è±¡ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/select-user-defined-function-parse-result.png" title="ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°è§£æ AST"><p>è§£æå®Œæˆåï¼Œä¼šç»§ç»­æ‰§è¡Œ SQL æ ¡éªŒï¼Œæ­¤æ—¶ä¼šè°ƒç”¨ <code>SqlValidatorImpl#performUnconditionalRewrites</code> æ–¹æ³•ï¼Œæ­¤æ—¶ä¼šåˆ¤æ–­è¿ç®—ç¬¦æ˜¯å¦ä¸º SqlUnresolvedFunctionï¼Œæ˜¯åˆ™ä» opTab ä¸­çš„ CalciteCatalogReader æŸ¥æ‰¾è‡ªå®šä¹‰å‡½æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (call.getOperator() <span class="keyword">instanceof</span> SqlUnresolvedFunction) &#123;</span><br><span class="line">    <span class="keyword">assert</span> call <span class="keyword">instanceof</span> SqlBasicCall;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">SqlUnresolvedFunction</span> <span class="variable">function</span> <span class="operator">=</span> (SqlUnresolvedFunction) call.getOperator();</span><br><span class="line">    <span class="comment">// This function hasn&#x27;t been resolved yet.  Perform</span></span><br><span class="line">    <span class="comment">// a half-hearted resolution now in case it&#x27;s a</span></span><br><span class="line">    <span class="comment">// builtin function requiring special casing.  If it&#x27;s</span></span><br><span class="line">    <span class="comment">// not, we&#x27;ll handle it later during overload resolution.</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;SqlOperator&gt; overloads = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    opTab.lookupOperatorOverloads(function.getNameAsId(), function.getFunctionType(), SqlSyntax.FUNCTION, overloads, catalogReader.nameMatcher());</span><br><span class="line">    <span class="keyword">if</span> (overloads.size() == <span class="number">1</span>) &#123;</span><br><span class="line">        ((SqlBasicCall) call).setOperator(overloads.get(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆä» Schema ä¸­æŸ¥æ‰¾åˆ°äº†å¦‚ä¸‹çš„è‡ªå®šä¹‰å‡½æ•°å¯¹è±¡ï¼š</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/lookup-user-defined-function.png" title="Schema ä¸­æŸ¥æ‰¾åˆ°çš„è‡ªå®šä¹‰å‡½æ•°å¯¹è±¡"><p>ç„¶åè°ƒç”¨ <code>CalciteCatalogReader#toOp</code> å°† Function å¯¹è±¡è½¬æ¢ä¸º SQL è¿ç®—ç¬¦ï¼Œå†…éƒ¨ä¼šæ ¹æ® function ç±»å‹è½¬æ¢ä¸ºä¸åŒå‡½æ•°è¿ç®—ç¬¦ï¼Œæ ‡é‡å‡½æ•°ä¼šè½¬æ¢ä¸º <code>SqlUserDefinedFunction</code> å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (function <span class="keyword">instanceof</span> ScalarFunction) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">SqlReturnTypeInference</span> <span class="variable">returnTypeInference</span> <span class="operator">=</span> infer((ScalarFunction) function);</span><br><span class="line">    <span class="comment">// æ ‡é‡å‡½æ•°è½¬æ¢ä¸º SqlUserDefinedFunction</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlUserDefinedFunction</span>(name, kind, returnTypeInference, operandTypeInference, operandMetadata, function);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (function <span class="keyword">instanceof</span> AggregateFunction) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">SqlReturnTypeInference</span> <span class="variable">returnTypeInference</span> <span class="operator">=</span> infer((AggregateFunction) function);</span><br><span class="line">    <span class="comment">// èšåˆå‡½æ•°è½¬æ¢ä¸º SqlUserDefinedAggFunction</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlUserDefinedAggFunction</span>(name, kind, returnTypeInference, operandTypeInference, operandMetadata, (AggregateFunction) function, <span class="literal">false</span>, <span class="literal">false</span>, Optionality.FORBIDDEN);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (function <span class="keyword">instanceof</span> TableMacro) &#123;</span><br><span class="line">    <span class="comment">// è¡¨å®è½¬æ¢ä¸º SqlUserDefinedTableMacro</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlUserDefinedTableMacro</span>(name, kind, ReturnTypes.CURSOR, operandTypeInference, operandMetadata, (TableMacro) function);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (function <span class="keyword">instanceof</span> TableFunction) &#123;</span><br><span class="line">    <span class="comment">// è¡¨å‡½æ•°è½¬æ¢ä¸º SqlUserDefinedTableFunction</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlUserDefinedTableFunction</span>(name, kind, ReturnTypes.CURSOR, operandTypeInference, operandMetadata, (TableFunction) function);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(<span class="string">&quot;unknown function type &quot;</span> + function);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¡éªŒå®Œæˆåï¼ŒCalcite ä¼šè°ƒç”¨ SqlToRelConverter å°† SqlNode è½¬æ¢ä¸º RelNodeï¼Œè½¬æ¢çš„æµç¨‹å’Œå†…ç½®å‡½æ•°ç±»ä¼¼ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/c8cb56525dbc908da4a9081f062d87adfe27ab80/core/src/main/java/org/apache/calcite/sql2rel/StandardConvertletTable.java#L936">StandardConvertletTable#convertFunction</a> æ–¹æ³•ï¼Œå°†å‡½æ•°è¿ç®—ç¬¦è½¬æ¢ä¸º RexCallï¼Œå®Œæ•´çš„ RelNode æ ‘å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LogicalProject(EXPR$0=[INDEX_OF($1, &#x27;san&#x27;)])</span><br><span class="line">  JdbcTableScan(table=[[calcite_function, t_user]])</span><br></pre></td></tr></table></figure><p>ç»è¿‡ Calcite å†…ç½®çš„ä¼˜åŒ–å™¨å’Œä¼˜åŒ–è§„åˆ™ä¼˜åŒ–ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„ç‰©ç†æ‰§è¡Œè®¡åˆ’ï¼Œæœ€åº•å±‚ä½¿ç”¨äº† <code>JdbcTableScan</code> è¿ç®—ç¬¦æ‰«æè¡¨ä¸­çš„æ•°æ®ï¼Œç„¶åä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/b1308feff49c8b747b3bbb52e1519d334bc984ec/core/src/main/java/org/apache/calcite/adapter/jdbc/JdbcToEnumerableConverter.java#L72">JdbcToEnumerableConverter</a> å°† JdbcConvention è½¬æ¢ä¸º EnumerableConventionï¼Œè½¬æ¢åæ•°æ®å°±å¯ä»¥ä¼ é€’ç»™ <code>EnumerableCalc</code> è¿ç®—ç¬¦è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EnumerableCalc(expr#0..3=[&#123;inputs&#125;], expr#4=[&#x27;san&#x27;], expr#5=[INDEX_OF($t1, $t4)], EXPR$0=[$t5])</span><br><span class="line">  JdbcToEnumerableConverter</span><br><span class="line">    JdbcTableScan(table=[[calcite_function, t_user]])</span><br></pre></td></tr></table></figure><p>æœ€åä¼šè°ƒç”¨ <code>CalcitePrepareImpl#implement</code> æ–¹æ³•ç”Ÿæˆæ‰§è¡Œé€»è¾‘ï¼Œå†…éƒ¨ç”Ÿæˆè‡ªå®šä¹‰å‡½æ•°é€»è¾‘æ—¶ä¼šè°ƒç”¨ <code>ReflectiveCallNotNullImplementor#implement</code> æ–¹æ³•ï¼Œå¹¶è¿”å›ä¸€ä¸ª MethodCallExpression å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«äº†å¯¹ UDF å‡½æ•°çš„è°ƒç”¨ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/implement-scalar-function.png" title="å®ç° INDEX_OF æ ‡é‡å‡½æ•°"><p>UDF å‡½æ•°ç”Ÿæˆçš„ä»£ç é€»è¾‘å¦‚ä¸‹ï¼Œè¯¥é€»è¾‘ä¼šåµŒå…¥åˆ°æœ€ç»ˆçš„æ‰§è¡Œé€»è¾‘ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ¯è¡Œè®°å½•è·å–æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ä¸€æ¬¡ UDF å‡½æ•°ï¼Œå› æ­¤æ•°æ®é‡è¶Šå¤§ï¼ŒUDF å‡½æ•°æ‰§è¡Œæ¶ˆè€—çš„æ—¶é—´è¶Šå¤šã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">final</span> Object[] current = (Object[]) inputEnumerator.current();</span><br><span class="line">    <span class="keyword">return</span> com.strongduanmu.udf.UDFRegistry.indexOf(current[<span class="number">1</span>] == <span class="literal">null</span> ? <span class="literal">null</span> : current[<span class="number">1</span>].toString(), <span class="string">&quot;san&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆ SQL æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># è¡¨ä¸­çš„ user_name è®°å½•</span><br><span class="line">19:46:54.104 [main] INFO com.strongduanmu.udf.UDFExample - ColumnLabel: USER_NAME, ColumnValue: zhangsan</span><br><span class="line">19:46:54.104 [main] INFO com.strongduanmu.udf.UDFExample - ColumnLabel: USER_NAME, ColumnValue: lisi</span><br><span class="line">19:46:54.104 [main] INFO com.strongduanmu.udf.UDFExample - ColumnLabel: USER_NAME, ColumnValue: wangwu</span><br><span class="line"># user_name index_of æ‰§è¡Œç»“æœ</span><br><span class="line">19:43:32.790 [main] INFO com.strongduanmu.udf.UDFExample - ColumnLabel: EXPR$0, ColumnValue: 5</span><br><span class="line">19:43:32.790 [main] INFO com.strongduanmu.udf.UDFExample - ColumnLabel: EXPR$0, ColumnValue: -1</span><br><span class="line">19:43:32.790 [main] INFO com.strongduanmu.udf.UDFExample - ColumnLabel: EXPR$0, ColumnValue: -1</span><br></pre></td></tr></table></figure><p>é™¤äº†å‰é¢ä»‹ç»çš„ UDF æ ‡é‡å‡½æ•°å¤–ï¼ŒCalcite ç¤¾åŒºçš„åŒå­¦ä¹‹å‰è¿˜å’¨è¯¢å…³äº Oracle <code>ROWNUM</code>ã€<code>SYSDATE</code> è¿™äº›ç‰¹æ®Šå‡½æ•°ï¼Œåœ¨ Oracle ä¸­æ— å‚æ•°çš„å‡½æ•°ä¸èƒ½å†™æ‹¬å·ï¼Œæ— å‚æ•°çš„å‡½æ•°é€šå¸¸ä¹Ÿå«åš <a target="_blank" rel="noopener" href="https://aplwiki.com/wiki/Niladic_function">Niladic Function</a>ï¼Œåœ¨ Calcite ä¸­ä½¿ç”¨ <code>allowNiladicParentheses</code> å±æ€§æ§åˆ¶æ— å‚å‡½æ•°æ˜¯å¦å¯ä»¥ä½¿ç”¨æ‹¬å·ï¼Œåƒ MySQLã€Apache Phoenix å°±å…è®¸ä½¿ç”¨æ‹¬å·ï¼Œè€Œ Oracleã€PostgreSQLã€SQL Server åˆ™ä¸æ”¯æŒæ‹¬å·ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/udf-without-parentheses.png" title="æ— æ‹¬å· UDF å‡½æ•°"><p>æˆ‘ä»¬å°†ä¸Šé¢çš„ç¤ºä¾‹è¿›è¡Œä¸€äº›æ”¹é€ ï¼Œè®¾ç½® Calcite JDBC ä¸­çš„ <code>conformance</code> å±æ€§ä¸º <code>ORACLE_12</code>ï¼Œå®ƒå¯¹åº”çš„ <code>allowNiladicParentheses</code> å®ç°ä¸º <code>false</code>ã€‚ç„¶ååœ¨ UDFRegistry ç±»ä¸­å¢åŠ ä¸€ä¸ª <code>sysDate</code> å‡½æ•°å®ç°ï¼Œå¹¶ä½¿ç”¨ <code>rootSchema.add(&quot;SYS_DATE&quot;, Objects.requireNonNull(ScalarFunctionImpl.create(UDFRegistry.class, &quot;sysDate&quot;)));</code> å°† <code>SYS_DATE</code> å‡½æ•°æ³¨å†Œåˆ° Schema ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> LocalDate <span class="title function_">sysDate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> LocalDate.now();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰§è¡Œ <code>SELECT SYS_DATE FROM calcite_function.t_user</code> è¯­å¥ï¼ŒæŒ‰ç…§é¢„æœŸ Calcite åº”å½“èƒ½å¤Ÿæ­£ç¡®æ‰§è¡Œè¯¥ SQLï¼Œå¹¶è¿”å›ç»“æœã€‚ä½†æ˜¯æ‰§è¡Œä¹‹åï¼ŒCalcite å´æŠ›å‡ºäº†å¼‚å¸¸ï¼Œå…·ä½“å¼‚å¸¸å †æ ˆä¿¡æ¯å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.apache.calcite.runtime.CalciteContextException: From line 1, column 8 to line 1, column 15: Column &#x27;SYS_DATE&#x27; not found in any table</span><br><span class="line">	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)</span><br><span class="line">	at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">	at java.lang.reflect.Constructor.newInstance(Constructor.java:423)</span><br><span class="line">	at org.apache.calcite.runtime.Resources$ExInstWithCause.ex(Resources.java:511)</span><br><span class="line">	at org.apache.calcite.sql.SqlUtil.newContextException(SqlUtil.java:952)</span><br><span class="line">	at org.apache.calcite.sql.SqlUtil.newContextException(SqlUtil.java:937)</span><br><span class="line">	at org.apache.calcite.sql.validate.SqlValidatorImpl.newValidationError(SqlValidatorImpl.java:5899)</span><br><span class="line">	at org.apache.calcite.sql.validate.DelegatingScope.fullyQualify(DelegatingScope.java:293)</span><br><span class="line">	at org.apache.calcite.sql.validate.SqlValidatorImpl$Expander.visit(SqlValidatorImpl.java:7105)</span><br><span class="line">	at org.apache.calcite.sql.validate.SqlValidatorImpl$SelectExpander.visit(SqlValidatorImpl.java:7276)</span><br><span class="line">	at org.apache.calcite.sql.validate.SqlValidatorImpl$SelectExpander.visit(SqlValidatorImpl.java:7261)</span><br><span class="line">	at org.apache.calcite.sql.SqlIdentifier.accept(SqlIdentifier.java:324)</span><br><span class="line">	at org.apache.calcite.sql.validate.SqlValidatorImpl$Expander.go(SqlValidatorImpl.java:7094)</span><br><span class="line">	at org.apache.calcite.sql.validate.SqlValidatorImpl.expandSelectExpr(SqlValidatorImpl.java:6665)</span><br><span class="line">	at org.apache.calcite.sql.validate.SqlValidatorImpl.expandSelectItem(SqlValidatorImpl.java:481)</span><br><span class="line">	at org.apache.calcite.sql.validate.SqlValidatorImpl.validateSelectList(SqlValidatorImpl.java:5015)</span><br><span class="line">	at org.apache.calcite.sql.validate.SqlValidatorImpl.validateSelect(SqlValidatorImpl.java:4096)</span><br><span class="line">	at org.apache.calcite.sql.validate.SelectNamespace.validateImpl(SelectNamespace.java:62)</span><br><span class="line">	at org.apache.calcite.sql.validate.AbstractNamespace.validate(AbstractNamespace.java:95)</span><br><span class="line">	at org.apache.calcite.sql.validate.SqlValidatorImpl.validateNamespace(SqlValidatorImpl.java:1206)</span><br><span class="line">	at org.apache.calcite.sql.validate.SqlValidatorImpl.validateQuery(SqlValidatorImpl.java:1177)</span><br><span class="line">	at org.apache.calcite.sql.SqlSelect.validate(SqlSelect.java:282)</span><br><span class="line">	at org.apache.calcite.sql.validate.SqlValidatorImpl.validateScopedExpression(SqlValidatorImpl.java:1143)</span><br><span class="line">	at org.apache.calcite.sql.validate.SqlValidatorImpl.validate(SqlValidatorImpl.java:849)</span><br><span class="line">	at org.apache.calcite.sql2rel.SqlToRelConverter.convertQuery(SqlToRelConverter.java:624)</span><br><span class="line">	at org.apache.calcite.prepare.Prepare.prepareSql(Prepare.java:257)</span><br><span class="line">	at org.apache.calcite.prepare.Prepare.prepareSql(Prepare.java:220)</span><br><span class="line">	at org.apache.calcite.prepare.CalcitePrepareImpl.prepare2_(CalcitePrepareImpl.java:673)</span><br><span class="line">	at org.apache.calcite.prepare.CalcitePrepareImpl.prepare_(CalcitePrepareImpl.java:524)</span><br><span class="line">	at org.apache.calcite.prepare.CalcitePrepareImpl.prepareSql(CalcitePrepareImpl.java:492)</span><br><span class="line">	at org.apache.calcite.jdbc.CalciteConnectionImpl.parseQuery(CalciteConnectionImpl.java:237)</span><br><span class="line">	at org.apache.calcite.jdbc.CalciteMetaImpl.prepareAndExecute(CalciteMetaImpl.java:702)</span><br><span class="line">	at org.apache.calcite.avatica.AvaticaConnection.prepareAndExecuteInternal(AvaticaConnection.java:677)</span><br><span class="line">	at org.apache.calcite.avatica.AvaticaStatement.executeInternal(AvaticaStatement.java:157)</span><br><span class="line">	... 3 more</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨ <code>SqlValidatorImpl.java:7105</code> ä½ç½®è®¾ç½®æ–­ç‚¹ï¼Œå¯ä»¥å‘ç°åœ¨æ ¡éªŒ SYS_DATE å‡½æ•°æ ‡è¯†ç¬¦æ—¶ï¼Œä¼šè°ƒç”¨ <code>validator.makeNullaryCall(id)</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨åŠ è½½å®Œå‡½æ•°åï¼Œä¼šåˆ¤æ–­è¿ç®—ç¬¦çš„è¯­æ³•ç±»å‹æ˜¯å¦ä¸º <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/db60219198442f2c60345fda95a117d379d87a61/core/src/main/java/org/apache/calcite/sql/SqlSyntax.java#L139">SqlSyntax.FUNCTION_ID</a>ï¼Œè€Œ FUNCTION_ID ä»£è¡¨çš„å°±æ˜¯ç±»ä¼¼äº CURRENTTIME å’Œ SYS_DATE è¿™æ ·æ— æ‹¬å·çš„å‡½æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SqlValidatorImpl#Expander ç±» visit æ–¹æ³•</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> SqlNode <span class="title function_">visit</span><span class="params">(SqlIdentifier id)</span> &#123;</span><br><span class="line">    <span class="comment">// First check for builtin functions which don&#x27;t have</span></span><br><span class="line">    <span class="comment">// parentheses, like &quot;LOCALTIME&quot;.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">SqlCall</span> <span class="variable">call</span> <span class="operator">=</span> validator.makeNullaryCall(id);</span><br><span class="line">    <span class="keyword">if</span> (call != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> call.accept(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">SqlIdentifier</span> <span class="variable">fqId</span> <span class="operator">=</span> getScope().fullyQualify(id).identifier;</span><br><span class="line">    <span class="type">SqlNode</span> <span class="variable">expandedExpr</span> <span class="operator">=</span> expandDynamicStar(id, fqId);</span><br><span class="line">    validator.setOriginal(expandedExpr, id);</span><br><span class="line">    <span class="keyword">return</span> expandedExpr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SqlValidatorImpl ç±» makeNullaryCall æ–¹æ³•</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> SqlCall <span class="title function_">makeNullaryCall</span><span class="params">(SqlIdentifier id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (id.names.size() == <span class="number">1</span> &amp;&amp; !id.isComponentQuoted(<span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;SqlOperator&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        opTab.lookupOperatorOverloads(id, <span class="literal">null</span>, SqlSyntax.FUNCTION, list, catalogReader.nameMatcher());</span><br><span class="line">        <span class="keyword">for</span> (SqlOperator operator : list) &#123;</span><br><span class="line">            <span class="keyword">if</span> (operator.getSyntax() == SqlSyntax.FUNCTION_ID) &#123;</span><br><span class="line">                <span class="comment">// Even though this looks like an identifier, it is a</span></span><br><span class="line">                <span class="comment">// actually a call to a function. Construct a fake</span></span><br><span class="line">                <span class="comment">// call to this function, so we can use the regular</span></span><br><span class="line">                <span class="comment">// operator validation.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlBasicCall</span>(operator, ImmutableList.of(), id.getParserPosition(), <span class="literal">null</span>).withExpanded(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆé—®é¢˜çš„æ ¹æºå°±å˜æˆäº†ï¼Œä¸ºä»€ä¹ˆè‡ªå®šä¹‰å‡½æ•°è½¬æ¢ä¸ºè¿ç®—ç¬¦åï¼Œå®ƒçš„è¯­æ³•ç±»å‹ä¸æ˜¯ FUNCTION_IDï¼Ÿæˆ‘ä»¬å›é¡¾ä¸‹å‰é¢ä»‹ç»çš„ <code>INDEX_OF</code> å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ï¼Œåœ¨ SQL æ ¡éªŒé˜¶æ®µï¼Œä¼šå°† ScalarFunction è½¬æ¢ä¸º SqlUserDefinedFunction è¿ç®—ç¬¦ï¼Œè€Œå®ƒåˆ™ç»§æ‰¿äº† SqlFunction ç±»ï¼Œ<a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/ba36004fb1e52b9bfb06623c7d869e6e01e25082/core/src/main/java/org/apache/calcite/sql/SqlFunction.java#L140">SqlFunction#getSyntax</a> æ–¹æ³•é»˜è®¤è¿”å› SqlSyntax.FUNCTIONã€‚ç¬”è€…æ’æŸ¥äº† SqlUserDefinedFunction ç±»ï¼Œå‘ç° Calcite æ²¡æœ‰æä¾›ç”¨æˆ·è‡ªå®šä¹‰è¯­æ³•ç±»å‹çš„ APIï¼Œå¦‚æœæƒ³è¦æ”¯æŒè¿™ç§ä¸å¸¦æ‹¬å·çš„å†™æ³•ï¼Œéœ€è¦ä¿®æ”¹æºç è°ƒæ•´ CalciteCatalogReader ç±»ä¸­çš„ <code>toOp</code> æ–¹æ³•ã€‚</p><p>æœ¬åœ°å°è¯•ä¿®æ”¹äº†ä¸‹ Calcite CalciteCatalogReader ç±»æºç ï¼Œåœ¨ <code>toOp</code> æ–¹æ³•è½¬æ¢æ—¶ï¼Œåˆ¤æ–­å‚æ•°ä¸ªæ•°ä»¥åŠ allowNiladicParentheses å±æ€§ï¼Œå¦‚æœæ— å‚æ•°å¹¶ä¸” allowNiladicParentheses è®¾ç½®ä¸º falseï¼Œåˆ™å°†è¯­æ³•ç±»å‹è®¾ç½®ä¸º FUNCTION_IDã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (function <span class="keyword">instanceof</span> ScalarFunction) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">SqlReturnTypeInference</span> <span class="variable">returnTypeInference</span> <span class="operator">=</span> infer((ScalarFunction) function);</span><br><span class="line">    <span class="type">SqlSyntax</span> <span class="variable">syntax</span> <span class="operator">=</span> function.getParameters().isEmpty() &amp;&amp; config.conformance().allowNiladicParentheses() ? SqlSyntax.FUNCTION : SqlSyntax.FUNCTION_ID;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlUserDefinedFunction</span>(name, kind, returnTypeInference, operandTypeInference, operandMetadata, function, syntax);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å®Œæˆåï¼Œä½¿ç”¨ <code>./gradlew publishToMavenLocal</code> å‘å¸ƒåˆ°æœ¬åœ° Maven ä»“åº“è¿›è¡Œæµ‹è¯•ï¼Œç„¶åå¼•å…¥æ–°ç‰ˆæœ¬æµ‹è¯• <code>SELECT SYS_DATE FROM calcite_function.t_user</code>ï¼Œæ­¤æ—¶å¯ä»¥æ­£ç¡®æ‰§è¡Œå¹¶è¿”å›ç»“æœã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">08:49:17.625 [main] INFO com.strongduanmu.udf.UDFExample - ColumnLabel: SYS_DATE, ColumnValue: 2024-10-18</span><br><span class="line">08:49:17.648 [main] INFO com.strongduanmu.udf.UDFExample - ColumnLabel: SYS_DATE, ColumnValue: 2024-10-18</span><br><span class="line">08:49:17.668 [main] INFO com.strongduanmu.udf.UDFExample - ColumnLabel: SYS_DATE, ColumnValue: 2024-10-18</span><br></pre></td></tr></table></figure><p>ç›®å‰ï¼Œè¯¥ PR è¿˜å­˜åœ¨éƒ¨åˆ†å•æµ‹å¼‚å¸¸ï¼Œç¬”è€…ç¨åä¿®å¤åä¼šæäº¤åˆ° Calcite ä»“åº“ï¼Œäº‰å–ä¸‹ä¸ªç‰ˆæœ¬èƒ½å¤Ÿæ”¯æŒè‡ªå®šä¹‰å‡½æ•°ä¸å¸¦æ‹¬å·çš„å†™æ³•ã€‚</p><h3 id="udaf-èšåˆå‡½æ•°æ‰©å±•"><a class="markdownIt-Anchor" href="#udaf-èšåˆå‡½æ•°æ‰©å±•"></a> UDAF èšåˆå‡½æ•°æ‰©å±•</h3><p>èšåˆå‡½æ•°çš„æ‰©å±•å’Œæ ‡é‡å‡½æ•°ç¨æœ‰ä¸åŒï¼Œèšåˆå‡½æ•°ä¼šå°†å¤šä¸ªå€¼ç»„åˆè½¬æ¢ä¸ºæ ‡é‡å€¼ï¼Œå› æ­¤åœ¨èšåˆå‡½æ•°å†…éƒ¨éœ€è¦ç»´æŠ¤ä¸€ä¸ªç´¯åŠ å™¨ï¼Œè´Ÿè´£å°†æ•°æ®è¡Œçš„å€¼è¿›è¡Œç´¯åŠ ï¼Œå½“æ‰€æœ‰æ•°æ®è¡Œéå†å®Œæˆåï¼Œè¾“å‡ºèšåˆå‡½æ•°çš„ç»“æœã€‚å› æ­¤ï¼Œæ‰©å±•èšåˆå‡½æ•°éœ€è¦å®ç° <code>init</code>ã€<code>add</code> å’Œ <code>result</code> æ–¹æ³•ï¼Œå¦‚ä¸‹å±•ç¤ºäº†ä¸€ä¸ªå°†è®°å½•èšåˆä¸ºé›†åˆçš„å‡½æ•°å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;unused&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UDAFRegistry</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Collection&lt;Object&gt; <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Collection&lt;Object&gt; <span class="title function_">add</span><span class="params">(<span class="keyword">final</span> Collection&lt;Object&gt; accumulator, <span class="keyword">final</span> Object newElement)</span> &#123;</span><br><span class="line">        accumulator.add(newElement);</span><br><span class="line">        <span class="keyword">return</span> accumulator;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Collection&lt;Object&gt; <span class="title function_">result</span><span class="params">(<span class="keyword">final</span> Collection&lt;Object&gt; accumulator)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accumulator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>init</code> æ–¹æ³•ä¸­åˆå§‹åŒ–äº†ä¸€ä¸ª <code>Collection&lt;Object&gt;</code> å®¹å™¨ï¼Œæ‰§è¡Œæ—¶æ¯è¡Œæ•°æ®éƒ½ä¼šè°ƒç”¨ <code>add</code> æ–¹æ³•ï¼Œå¹¶å°† <code>Collection&lt;Object&gt;</code> å®¹å™¨å’Œå½“å‰è¡Œçš„å…ƒç´ ä¼ é€’è¿›æ¥ï¼Œæ­¤æ—¶å¯ä»¥å°†æ–°å…ƒæ•°æ®æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼Œç„¶åè¿”å›å®¹å™¨å¯¹è±¡ï¼Œæœ€åæ‰€æœ‰è¡Œéå†å®Œæˆåï¼Œä¼šè°ƒç”¨ <code>result</code> æ–¹æ³•ï¼Œæ­¤æ—¶ä¼šè¿”å›å®¹å™¨å¯¹è±¡ï¼Œå®¹å™¨ä¸­è®°å½•äº†æ‰€æœ‰å…ƒç´ ã€‚</p><p>å®ç°å®Œ UDAF åï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ <code>AggregateFunctionImpl#create</code> æ–¹æ³•ï¼Œå°†å…¶æ³¨å†Œåˆ° Scehma ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rootSchema.add(<span class="string">&quot;CONCAT_TO_LIST&quot;</span>, Objects.requireNonNull(AggregateFunctionImpl.create(UDAFRegistry.class)));</span><br><span class="line">CalciteJDBCUtils.executeQuery(calciteConnection, <span class="string">&quot;SELECT CONCAT_TO_LIST(user_name) FROM calcite_function.t_user&quot;</span>);</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬æ‰§è¡Œ <code>SELECT CONCAT_TO_LIST(user_name) FROM calcite_function.t_user</code> è¯­å¥è¿›è¡Œæµ‹è¯•ï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥å‘ç° <code>user_name</code> åˆ—ä¸­çš„å€¼è¢«è½¬æ¢ä¸ºæ•°ç»„è¿›è¡Œè¾“å‡ºã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">50</span>:<span class="number">18.709</span> [main] INFO com.strongduanmu.udaf.UDAFExample <span class="operator">-</span> ColumnLabel: EXPR$<span class="number">0</span>, ColumnValue: [zhangsan, lisi, wangwu]</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ‰§è¡Œè®¡åˆ’ï¼Œå¯ä»¥å‘ç°èšåˆå‡½æ•°ä½äº LogicalAggregate è¿ç®—ç¬¦ä¸­ï¼Œå¹¶ä¸”æ²¡æœ‰æŒ‡å®šåˆ†ç»„æ¡ä»¶ï¼Œä¼šå¯¹æ‰€æœ‰æ•°æ®è¡Œè¿›è¡Œèšåˆè®¡ç®—ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># é€»è¾‘æ‰§è¡Œè®¡åˆ’</span><br><span class="line">LogicalAggregate(<span class="keyword">group</span><span class="operator">=</span>[&#123;&#125;], EXPR$<span class="number">0</span><span class="operator">=</span>[CONCAT_TO_LIST($<span class="number">0</span>)])</span><br><span class="line">  LogicalProject(user_name<span class="operator">=</span>[$<span class="number">1</span>])</span><br><span class="line">    JdbcTableScan(<span class="keyword">table</span><span class="operator">=</span>[[calcite_function, t_user]])</span><br><span class="line"></span><br><span class="line"># ç‰©ç†æ‰§è¡Œè®¡åˆ’</span><br><span class="line">EnumerableAggregate(<span class="keyword">group</span><span class="operator">=</span>[&#123;&#125;], EXPR$<span class="number">0</span><span class="operator">=</span>[CONCAT_TO_LIST($<span class="number">1</span>)])</span><br><span class="line">  JdbcToEnumerableConverter</span><br><span class="line">    JdbcTableScan(<span class="keyword">table</span><span class="operator">=</span>[[calcite_function, t_user]])</span><br></pre></td></tr></table></figure><p>è·Ÿè¸ª Calcite ç”Ÿæˆçš„æ‰§è¡Œä»£ç ï¼Œä¼šä¾æ¬¡è°ƒç”¨ <code>apply()</code> æ–¹æ³•åˆå§‹åŒ–ï¼Œå†…éƒ¨è°ƒç”¨çš„æ˜¯ <code>UDAFRegistry#init</code> æ–¹æ³•ï¼Œç„¶åè°ƒç”¨ <code>accumulatorAdder()</code> æ–¹æ³•æ‰§è¡Œèšåˆé€»è¾‘ï¼Œæ¯è¡Œæ•°æ®éƒ½ä¼šè°ƒç”¨ <code>UDAFRegistry#add</code> æ–¹æ³•ï¼Œæœ€åè°ƒç”¨ <code>singleGroupResultSelector</code> è·å–ç»“æœï¼Œå†…éƒ¨è°ƒç”¨çš„æ˜¯ <code>UDAFRegistry#result</code> æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">java.util.<span class="type">List</span> <span class="variable">accumulatorAdders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.LinkedList();</span><br><span class="line">accumulatorAdders.add(<span class="keyword">new</span> <span class="title class_">org</span>.apache.calcite.linq4j.function.Function2() &#123;</span><br><span class="line">    <span class="keyword">public</span> Record3_0 <span class="title function_">apply</span><span class="params">(Record3_0 acc, Object[] in )</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!( in [<span class="number">1</span>] == <span class="literal">null</span> || in [<span class="number">1</span>].toString() == <span class="literal">null</span>)) &#123;</span><br><span class="line">            acc.f2 = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// è°ƒç”¨ add æ–¹æ³•ï¼Œå¢åŠ æ–°å…ƒæ•°æ®</span></span><br><span class="line">            acc.f0 = acc.f1.add(acc.f0, in [<span class="number">1</span>] == <span class="literal">null</span> ? <span class="literal">null</span> : in [<span class="number">1</span>].toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> acc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Record3_0 <span class="title function_">apply</span><span class="params">(Object acc, Object in )</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> apply(</span><br><span class="line">            (Record3_0) acc, (Object[]) in );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">org.apache.calcite.adapter.enumerable.<span class="type">AggregateLambdaFactory</span> <span class="variable">lambdaFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">org</span>.apache.calcite.adapter.enumerable.BasicAggregateLambdaFactory(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">org</span>.apache.calcite.linq4j.function.Function0() &#123;</span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">apply</span><span class="params">()</span> &#123;</span><br><span class="line">            java.util.Collection a0s0;</span><br><span class="line">            com.strongduanmu.udaf.UDAFRegistry a0s1;</span><br><span class="line">            <span class="type">boolean</span> a0s2;</span><br><span class="line">            a0s2 = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// åˆ›å»º UDAFRegistry å¯¹è±¡</span></span><br><span class="line">            a0s1 = <span class="keyword">new</span> <span class="title class_">com</span>.strongduanmu.udaf.UDAFRegistry();</span><br><span class="line">            <span class="comment">// è°ƒç”¨ init æ–¹æ³•åˆå§‹åŒ–</span></span><br><span class="line">            a0s0 = a0s1.init();</span><br><span class="line">            Record3_0 record0;</span><br><span class="line">            <span class="comment">// å°†èšåˆå‡½æ•°çš„ç´¯åŠ å™¨ã€UDF å¯¹è±¡ã€æ˜¯å¦è®¡ç®—å®Œæˆæ ‡è®°è®°å½•åˆ° Record3_0 çš„ f0ã€f1 å’Œ f2 ä¸­</span></span><br><span class="line">            record0 = <span class="keyword">new</span> <span class="title class_">Record3_0</span>();</span><br><span class="line">            record0.f0 = a0s0;</span><br><span class="line">            record0.f1 = a0s1;</span><br><span class="line">            record0.f2 = a0s2;</span><br><span class="line">            <span class="keyword">return</span> record0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    accumulatorAdders);</span><br><span class="line"><span class="comment">// å…ˆè°ƒç”¨ apply() åˆå§‹åŒ–ï¼Œç„¶åè°ƒç”¨ accumulatorAdder() æ‰§è¡Œèšåˆé€»è¾‘ï¼Œæœ€åè°ƒç”¨ singleGroupResultSelector è·å–ç»“æœ</span></span><br><span class="line"><span class="keyword">return</span> org.apache.calcite.linq4j.Linq4j.singletonEnumerable(enumerable.aggregate(lambdaFactory.accumulatorInitializer().apply(), lambdaFactory.accumulatorAdder(), lambdaFactory.singleGroupResultSelector(<span class="keyword">new</span> <span class="title class_">org</span>.apache.calcite.linq4j.function.Function1() &#123;</span><br><span class="line">                    <span class="keyword">public</span> Object <span class="title function_">apply</span><span class="params">(Record3_0 acc)</span> &#123;</span><br><span class="line">                        <span class="comment">// åˆ¤æ–­æ˜¯å¦è®¡ç®—å®Œæˆï¼Œå®Œæˆåˆ™è°ƒç”¨ result æ–¹æ³•</span></span><br><span class="line">                        <span class="keyword">return</span> acc.f2 ? acc.f1.result(acc.f0) : <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">public</span> Object <span class="title function_">apply</span><span class="params">(Object acc)</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> apply(</span><br><span class="line">                            (Record3_0) acc);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure><h3 id="udtf-è¡¨å‡½æ•°-è¡¨å®æ‰©å±•"><a class="markdownIt-Anchor" href="#udtf-è¡¨å‡½æ•°-è¡¨å®æ‰©å±•"></a> UDTF è¡¨å‡½æ•° &amp; è¡¨å®æ‰©å±•</h3><p>æ ¹æ®å‰æ–‡ä»‹ç»ï¼ŒUDTF è¡¨å‡½æ•°æ˜¯æŒ‡<strong>åœ¨æ‰§è¡Œé˜¶æ®µå°†æŸäº›æ•°æ®è½¬æ¢ä¸ºè¡¨çš„å‡½æ•°</strong>ï¼Œè€Œè¡¨å®åˆ™æ˜¯æŒ‡<strong>åœ¨ç¼–è¯‘é˜¶æ®µå°†æŸäº›æ•°æ®è½¬æ¢ä¸ºè¡¨çš„å‡½æ•°</strong>ï¼Œä¸¤è€…éƒ½å¯ä»¥ç”¨äº FROM å­å¥ä¸­ï¼Œä½œä¸ºä¸€å¼ è¡¨è¿›è¡Œä½¿ç”¨ã€‚æœ¬å°èŠ‚é‡ç‚¹æ¢ç©¶ä¸‹ UDTF è¡¨å‡½æ•°çš„æ‰©å±•ï¼Œæ¥å®ç°ä¸€ä¸ªå°† <code>java=1,go=2,scala=3</code> ç»“æ„æ•°æ®ï¼Œæ‹†åˆ†ä¸ºä¸¤åˆ—ä¸‰è¡Œè¡¨ç»“æ„çš„è¡¨å‡½æ•°ï¼Œè¡¨å®çš„æ‰©å±•æ–¹å¼ç±»ä¼¼ï¼Œç•™ç»™å¤§å®¶è‡ªè¡Œæ¢ç©¶ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®ç°è¡¨å‡½æ•°çš„é€»è¾‘ï¼Œæ ¹æ®å‰é¢ä»‹ç»ï¼Œè¡¨å‡½æ•°éœ€è¦å®ç° <code>QueryableTable</code> æˆ–è€… <code>ScannableTable</code> æ¥å£ï¼Œç„¶åæ‰å¯ä»¥åˆ›å»ºå‡º TableFunction å®ç°å¯¹è±¡ï¼Œåœ¨å‰é¢å¾ˆå¤šæ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»è¿‡ ScannableTableï¼Œæœ¬æ¬¡æˆ‘ä»¬ä½¿ç”¨ QueryableTable æ¥å®ç°è¡¨å‡½æ•°é€»è¾‘ã€‚</p><p>UDTF å‡½æ•°çš„å®ç°é€»è¾‘å¦‚ä¸‹ï¼Œ<code>eval</code> æ–¹æ³•æ˜¯å‡½æ•°çš„ä¸»ä½“é€»è¾‘ï¼Œå®ƒæ¥æ”¶ <code>content</code> å­—ç¬¦ä¸²ä»¥åŠ <code>columnSize</code> æ•°å€¼ä¸¤ä¸ªå‚æ•°ï¼Œå¹¶è¿”å› <code>QueryableTable</code> å®ç°å¯¹è±¡ã€‚<code>eval</code> æ–¹æ³•å†…éƒ¨æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª <code>AbstractQueryableTable</code> å¯¹è±¡ï¼Œæ„é€ æ–¹æ³•ä¸­ä¼ é€’äº†å‡½æ•°çš„è¿”å›ç±»å‹ï¼Œæ˜¯ä¸€ä¸ªå¯¹è±¡æ•°ç»„ <code>Object[].class</code>ã€‚</p><p><a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/66caa54c5e272f8287ca132ca012733898a38768/core/src/main/java/org/apache/calcite/adapter/java/AbstractQueryableTable.java#L30">AbstractQueryableTable</a> ä¸­éœ€è¦å®ç° <code>asQueryable</code> å’Œ <code>getRowType</code> æ–¹æ³•ï¼ŒasQueryable æ–¹æ³•è´Ÿè´£å°†æ•°æ®è½¬æ¢ä¸ºå¯ä»¥éå†çš„å¯¹è±¡ï¼Œå†…éƒ¨å¯ä»¥è¦†ç›– <code>enumerator</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨å‡½æ•°ä¼šå¯¹ä¼ å…¥çš„ <code>content</code> å­—æ®µè¿›è¡Œåˆ‡å‰²å¤„ç†ï¼Œå¹¶æ ¹æ® <code>columnSize</code> ç»„è£…ç»“æœé›†çš„åˆ—æ•°ï¼Œ<code>moveNext</code> æ–¹æ³•ä¼šé¦–å…ˆè¢«è°ƒç”¨ï¼Œå°†æ¸¸æ ‡ç§»åŠ¨åˆ°ç»“æœé›†çš„ç¬¬ä¸€ä½ï¼Œç„¶åè°ƒç”¨ <code>current</code> æ–¹æ³•è·å–å½“å‰è®°å½•ï¼Œç„¶åå¾ªç¯è°ƒç”¨ <code>moveNext</code> å’Œ <code>current</code> ç›´åˆ°æ‰€æœ‰è®°å½•éå†å®Œæˆï¼Œæœ€åä¼šè°ƒç”¨ <code>reset</code> å’Œ <code>close</code> æ–¹æ³•é‡ç½®å’Œå…³é—­èµ„æºã€‚<code>getRowType</code> æ–¹æ³•ç”¨äºè¿”å› UDTF è®¡ç®—ç»“æœé›†çš„ç±»å‹ï¼Œæœ¬æ¡ˆä¾‹ä¸­è¡¨å‡½æ•°è¿”å› keyã€value ä¸¤åˆ—ï¼Œåˆ†åˆ«ä¸º String å’Œ int ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unused&quot;, &quot;unchecked&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UDTFRegistry</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Method</span> <span class="variable">UDTF_METHOD</span> <span class="operator">=</span> Types.lookupMethod(UDTFRegistry.class, <span class="string">&quot;eval&quot;</span>, String.class, <span class="type">int</span>.class);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> QueryableTable <span class="title function_">eval</span><span class="params">(<span class="keyword">final</span> String content, <span class="keyword">final</span> <span class="type">int</span> columnSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AbstractQueryableTable</span>(Object[].class) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> &lt;T&gt; Queryable&lt;T&gt; <span class="title function_">asQueryable</span><span class="params">(<span class="keyword">final</span> QueryProvider queryProvider, <span class="keyword">final</span> SchemaPlus schema, <span class="keyword">final</span> String tableName)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> (Queryable&lt;T&gt;) <span class="keyword">new</span> <span class="title class_">BaseQueryable</span>&lt;Object[]&gt;(queryProvider, String.class, <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Enumerator&lt;Object[]&gt; enumerator() &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Enumerator</span>&lt;Object[]&gt;() &#123;</span><br><span class="line">                            String[] rows = content.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                            </span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> Object[] current() &#123;</span><br><span class="line">                                <span class="type">String</span> <span class="variable">row</span> <span class="operator">=</span> rows[index];</span><br><span class="line">                                Object[] result = <span class="keyword">new</span> <span class="title class_">Object</span>[columnSize];</span><br><span class="line">                                String[] columns = row.split(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">                                Preconditions.checkArgument(columns.length == <span class="number">2</span>, String.format(<span class="string">&quot;Invalid row: %s, row must constains %d columns.&quot;</span>, row, columnSize));</span><br><span class="line">                                <span class="keyword">return</span> columns;</span><br><span class="line">                            &#125;</span><br><span class="line">                            </span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">moveNext</span><span class="params">()</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (index &lt; rows.length - <span class="number">1</span>) &#123;</span><br><span class="line">                                    index++;</span><br><span class="line">                                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            </span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reset</span><span class="params">()</span> &#123;</span><br><span class="line">                            &#125;</span><br><span class="line">                            </span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> RelDataType <span class="title function_">getRowType</span><span class="params">(<span class="keyword">final</span> RelDataTypeFactory typeFactory)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> typeFactory.createStructType(Arrays.asList(typeFactory.createJavaType(String.class), typeFactory.createJavaType(String.class)), Arrays.asList(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°å®Œ UDTF é€»è¾‘åï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>TableFunctionImpl#create</code> æ–¹æ³•ï¼Œå°† UDTF å‡½æ•°æ³¨å†Œåˆ° Schema ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rootSchema.add(<span class="string">&quot;EXTRACT_FROM_CSV&quot;</span>, Objects.requireNonNull(TableFunctionImpl.create(UDTFRegistry.UDTF_METHOD)));</span><br><span class="line">CalciteJDBCUtils.executeQuery(calciteConnection, <span class="string">&quot;SELECT * FROM EXTRACT_FROM_CSV(&#x27;java=1,go=2,scala=3&#x27;, 2)&quot;</span>);</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬æ‰§è¡Œ <code>SELECT * FROM EXTRACT_FROM_CSV('java=1,go=2,scala=3', 2)</code> è¯­å¥ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœï¼Œå¯ä»¥çœ‹åˆ°åŸå…ˆçš„å­—ç¬¦ä¸²ï¼Œè¢«è¡¨å‡½æ•°æŒ‰ç…§ <code>,</code> æ‹†åˆ†ä¸º 3 è¡Œï¼Œæ¯è¡ŒåˆæŒ‰ç…§ <code>=</code> æ‹†åˆ†ä¸º 2 åˆ—ï¼Œåˆ—åä¹Ÿæ˜¯æˆ‘ä»¬æŒ‡å®šçš„ <code>key</code> å’Œ <code>value</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">08:33:14.584 [main] INFO com.strongduanmu.common.CalciteJDBCUtils - ColumnLabel: key, ColumnValue: java</span><br><span class="line">08:33:14.584 [main] INFO com.strongduanmu.common.CalciteJDBCUtils - ColumnLabel: value, ColumnValue: 1</span><br><span class="line">08:33:14.584 [main] INFO com.strongduanmu.common.CalciteJDBCUtils - ColumnLabel: key, ColumnValue: go</span><br><span class="line">08:33:14.584 [main] INFO com.strongduanmu.common.CalciteJDBCUtils - ColumnLabel: value, ColumnValue: 2</span><br><span class="line">08:33:14.584 [main] INFO com.strongduanmu.common.CalciteJDBCUtils - ColumnLabel: key, ColumnValue: scala</span><br><span class="line">08:33:14.584 [main] INFO com.strongduanmu.common.CalciteJDBCUtils - ColumnLabel: value, ColumnValue: 3</span><br></pre></td></tr></table></figure><p>è·Ÿè¸ª UDTF å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° Calcite è§£æåå¢åŠ äº†ä¸€ä¸ª TABLE å‡½æ•°åµŒå¥—åœ¨ <code>EXTRACT_FROM_CSV</code> å¤–éƒ¨ï¼Œç”¨äºæ ‡è®°è¿™æ˜¯ä¸€ä¸ªè¡¨å‡½æ•°ï¼Œå†…éƒ¨çš„å‡½æ•°å’Œå…¶ä»–è‡ªå®šä¹‰å‡½æ•°ä¸€æ ·ï¼Œæ˜¯ SqlUnresolvedFunction ç±»å‹ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/udtf-parse-result.png" title="UDTF å‡½æ•°è§£æç»“æœ"><p>åœ¨æ ¡éªŒé˜¶æ®µï¼ŒTABLE å‡½æ•°ä¼šè¢«è½¬æ¢ä¸º <code>SqlCollectionTableOperator</code>ï¼Œæ ¹æ® Calcite æ³¨é‡Šè¯´æ˜ï¼Œå®ƒè¡¨ç¤ºè¡¨å‡½æ•°æ´¾ç”Ÿè¡¨è¿ç®—ç¬¦ï¼Œç”¨äºå°†è¡¨å‡½æ•°çš„å€¼è½¬æ¢ä¸ºå…³ç³» Relationï¼ŒEXTRACT_FROM_CSV å‡½æ•°è¢«è½¬æ¢ä¸º SqlUserDefinedTableFunction å¯¹è±¡ã€‚</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/apache-calcite-catalog-udf-function-implementation-and-extension/validated-udtf-sqlnode.png" title="ç»è¿‡æ ¡éªŒçš„ UTDF SqlNode"><p>æ ¡éªŒå®Œæˆåï¼ŒCalcite åˆç”Ÿæˆäº†å¦‚ä¸‹çš„é€»è¾‘æ‰§è¡Œè®¡åˆ’å’Œç‰©ç†æ‰§è¡Œè®¡åˆ’ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆç‰©ç†æ‰§è¡Œè®¡åˆ’åªåŒ…å«äº† EnumerableTableFunctionScanï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä½¿ç”¨ <code>*</code> æŸ¥è¯¢ï¼Œæœ€ç»ˆçš„æŠ•å½±åˆ—å’Œ EnumerableTableFunctionScan ä¸€è‡´ï¼Œå› æ­¤æ— éœ€å†è¿›è¡ŒæŠ•å½±è®¡ç®—ã€‚EnumerableTableFunctionScan ä¸­è¿˜åŒ…å«äº†å‡½æ•°è°ƒç”¨ä¿¡æ¯ï¼Œä»¥åŠè¿”å›ç»“æœç±»å‹ä¿¡æ¯ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># é€»è¾‘æ‰§è¡Œè®¡åˆ’</span><br><span class="line">LogicalProject(key<span class="operator">=</span>[$<span class="number">0</span>], <span class="keyword">value</span><span class="operator">=</span>[$<span class="number">1</span>])</span><br><span class="line">  LogicalTableFunctionScan(invocation<span class="operator">=</span>[EXTRACT_FROM_CSV(<span class="string">&#x27;java=1,go=2,scala=3&#x27;</span>, <span class="number">2</span>)], rowType<span class="operator">=</span>[RecordType(JavaType(class java.lang.String) key, JavaType(class java.lang.String) <span class="keyword">value</span>)], elementType<span class="operator">=</span>[class [Ljava.lang.Object;])</span><br><span class="line"></span><br><span class="line"># ç‰©ç†æ‰§è¡Œè®¡åˆ’</span><br><span class="line">EnumerableTableFunctionScan(invocation<span class="operator">=</span>[EXTRACT_FROM_CSV(<span class="string">&#x27;java=1,go=2,scala=3&#x27;</span>, <span class="number">2</span>)], rowType<span class="operator">=</span>[RecordType(JavaType(class java.lang.String) key, JavaType(class java.lang.String) <span class="keyword">value</span>)], elementType<span class="operator">=</span>[class [Ljava.lang.Object;])</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆé€šè¿‡ Calcite ä»£ç ç”Ÿæˆï¼Œç”Ÿæˆçš„å¯æ‰§è¡Œé€»è¾‘å¦‚ä¸‹ï¼Œåœ¨è°ƒç”¨ <code>bind</code> æ–¹æ³•æ—¶ï¼Œå†…éƒ¨ä¼šè°ƒç”¨åˆ° <code>UDTFRegistry#eval</code> æ–¹æ³•ï¼Œå¹¶è½¬æ¢ä¸ºå¯æšä¸¾çš„ Enumerable å¯¹è±¡ï¼Œæœ€ç»ˆé€šè¿‡ Calcite JDBC æä¾›æŸ¥è¯¢ç»“æœã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> org.apache.calcite.linq4j.Enumerable <span class="title function_">bind</span><span class="params">(<span class="keyword">final</span> org.apache.calcite.DataContext root)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> com.strongduanmu.udtf.<span class="type">UDTFRegistry</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">com</span>.strongduanmu.udtf.UDTFRegistry();</span><br><span class="line">    <span class="keyword">return</span> f.eval(<span class="string">&quot;java=1,go=2,scala=3&quot;</span>, <span class="number">2</span>).asQueryable(root.getQueryProvider(), (org.apache.calcite.schema.SchemaPlus) <span class="literal">null</span>, <span class="string">&quot;EXTRACT_FROM_CSV&quot;</span>).asEnumerable();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Class <span class="title function_">getElementType</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> java.lang.Object[].class;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç»“è¯­"><a class="markdownIt-Anchor" href="#ç»“è¯­"></a> ç»“è¯­</h2><p>æœ¬æ–‡é¦–å…ˆä»‹ç»äº† Calcite å‡½æ•°ç›¸å…³çš„æ¦‚å¿µå’Œæ„æˆä½“ç³»ï¼Œç„¶åæŒ‰ç…§å‡½æ•°çš„åˆ†ç±»ï¼š<strong>æ ‡é‡å‡½æ•°ã€èšåˆå‡½æ•°ä»¥åŠè¡¨å‡½æ•°/è¡¨å®</strong>ï¼Œä¸ºå¤§å®¶ä»‹ç»äº†è¿™äº›å‡½æ•°å†…éƒ¨çš„å®ç°ç»†èŠ‚ï¼Œå¹¶é€šè¿‡ Calcite <code>functions.iq</code> æµ‹è¯•ç”¨ä¾‹ä¸­çš„ä¸€ä¸ªå…¸å‹æ¡ˆä¾‹ï¼Œå’Œå¤§å®¶ä¸€èµ·è·Ÿè¸ªäº†å‡½æ•°çš„æ‰§è¡Œæµç¨‹ã€‚</p><p>Calcite å‡½æ•°æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆä¼šåˆ›å»º <code>SqlValidator</code> å¯¹è±¡ï¼Œæ­¤æ—¶ä¼šå°† Calcite å†…ç½®å‡½æ•°ä»¥åŠç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°æ³¨å†Œè¿›æ¥ã€‚ç„¶åä¼šä¾æ¬¡è¿›è¡Œ SQL è§£æå’Œ SQL æ ¡éªŒï¼Œé€šå¸¸å‡½æ•°éƒ½ä¼šè¢«è§£æä¸º <code>SqlUnresolvedFunction</code> å¯¹è±¡ï¼Œå¹¶åœ¨ SQL æ ¡éªŒæ—¶ï¼Œé€šè¿‡æŸ¥æ‰¾å‡½æ•°æ³¨å†Œè¡¨å°† SqlUnresolvedFunction è½¬æ¢ä¸º SqlBasicFunction æˆ–å…¶ä»–å‡½æ•°è¿ç®—ç¬¦å¯¹è±¡ã€‚SQL æ ¡éªŒå®Œæˆåï¼ŒCalcite ä¼šç»§ç»­è¿›è¡Œ SQL ä¼˜åŒ–å’Œ SQL æ‰§è¡Œï¼Œä¼˜åŒ–é˜¶æ®µä¼šè°ƒç”¨ <code>StandardConvertletTable#convertFunction</code> æ–¹æ³•ï¼Œå°†å‡½æ•°è¿ç®—ç¬¦è½¬æ¢ä¸º RexNodeï¼Œå¹¶å’Œå…¶ä»– SQL éƒ¨åˆ†ä¸€èµ·æ„æˆä¸€ä¸ª RelNode æ‰§è¡Œè®¡åˆ’æ ‘ã€‚æœ€å Calcite ä¼šè°ƒç”¨ <code>implement</code> æ–¹æ³•ç”Ÿæˆå¯æ‰§è¡Œä»£ç ï¼Œæ­¤æ—¶ä¼šå°†å†…ç½®å‡½æ•°æˆ–è‡ªå®šä¹‰å‡½æ•°çš„å®ç°é€»è¾‘ï¼ŒåµŒå…¥åˆ°æ•´ä¸ªå¯æ‰§è¡Œä»£ç ä¸­ï¼Œé€šè¿‡ Janio å°†ä»£ç ç¼–è¯‘ä¸ºå¯æ‰§è¡Œçš„å¯¹è±¡ï¼Œè¿™æ ·å°±å®Œæˆäº†æ•´ä¸ª SQL æ‰§è¡Œé€»è¾‘ã€‚</p><p>åœ¨æ–‡ç« çš„æœ€åéƒ¨åˆ†ï¼Œæˆ‘ä»¬åˆä»‹ç»äº†ä¸åŒç±»å‹å‡½æ•°çš„æ‰©å±•æ–¹å¼ã€‚Calcite æ‰©å±•å‡½æ•°éå¸¸ç®€å•ï¼Œç”¨æˆ·åªéœ€æŒ‰ç…§è§„èŒƒç¼–å†™å‡½æ•°é€»è¾‘ï¼Œç„¶åé€šè¿‡ Schema API æ³¨å†Œåˆ° Calcite ä¸­ï¼Œå°±å¯ä»¥æˆåŠŸæ‰§è¡Œå‡½æ•°é€»è¾‘ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒæ–‡ä¸­çš„ä»£ç ç¤ºä¾‹ï¼Œå°è¯•å®ç°ä¸åŒé€»è¾‘çš„è‡ªå®šä¹‰å‡½æ•°ã€‚</p><p>æ ¹æ® <a href="https://strongduanmu.com/blog/explore-apache-calcite-system-catalog-implementation.html">Apache Calcite System Catalog å®ç°æ¢ç©¶</a>ä¸­ä»‹ç»ï¼ŒCalcite Catalog ä¸­é™¤äº†å‡½æ•°å¤–ï¼Œè¿˜åŒ…å«äº†<strong>ç±»å‹ç³»ç»Ÿã€è§†å›¾ã€ç‰©åŒ–è§†å›¾ç­‰</strong>å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡åœ¨æ—¥å¸¸æ•°æ®å¤„ç†ä¸­ä¹Ÿéƒ½éå¸¸é‡è¦ï¼Œæˆ‘ä»¬å°†åœ¨åç»­æ–‡ç« ä¸­ç»§ç»­æ¢ç©¶å­¦ä¹ ï¼Œæ¬¢è¿æ„Ÿå…´è¶£çš„æœ‹å‹æŒç»­å…³æ³¨ã€‚</p><div class="tag-plugin quot"><p class="content" type="text"><span class="empty"></span><span class="text">å†™åœ¨æœ€å</span><span class="empty"></span></p></div><p>ç¬”è€…å› ä¸ºå·¥ä½œåŸå› æ¥è§¦åˆ° Calciteï¼Œå‰æœŸå­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œæ·±æ„Ÿ Calcite å­¦ä¹ èµ„æ–™ä¹‹åŒ®ä¹ï¼Œå› æ­¤åˆ›å»ºäº† <a target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/group/51128414222814">Calcite ä»å…¥é—¨åˆ°ç²¾é€šçŸ¥è¯†æ˜Ÿçƒ</a>ï¼Œå¸Œæœ›èƒ½å¤Ÿå°†å­¦ä¹ è¿‡ç¨‹ä¸­çš„èµ„æ–™å’Œç»éªŒæ²‰æ·€ä¸‹æ¥ï¼Œä¸ºæ›´å¤šæƒ³è¦å­¦ä¹  Calcite çš„æœ‹å‹æä¾›ä¸€äº›å¸®åŠ©ã€‚</p><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/xingqiu/calcite_xingqiu.png" alt="Calcite ä»å…¥é—¨åˆ°ç²¾é€š"></p><div class="tag-plugin quot"><p class="content" type="text"><span class="empty"></span><span class="text">æ¬¢è¿å…³æ³¨</span><span class="empty"></span></p></div><p>æ¬¢è¿å…³æ³¨ã€Œ<strong>ç«¯å°å¼ºçš„åšå®¢</strong>ã€å¾®ä¿¡å…¬ä¼—å·ï¼Œä¼šä¸å®šæœŸåˆ†äº«æ—¥å¸¸å­¦ä¹ å’Œå·¥ä½œç»éªŒï¼Œæ¬¢è¿å¤§å®¶å…³æ³¨äº¤æµã€‚</p><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/wechat/gongzhonghao.png" alt="å¾®ä¿¡å…¬ä¼—å·"></p><div class="article-footer fs14"><section id="references"><div class="header"><span>å‚è€ƒèµ„æ–™</span></div><div class="body"><ul><li class="post-title"><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/it_dx/article/details/117948590">Apache Calciteâ€”â€”æ–°å¢åŠ¨æ€ UDF æ”¯æŒ</a></p></li><li class="post-title"><p><a href="https://strongduanmu.com/wiki/calcite/adapters.html#%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7">Calcite å®˜æ–¹æ–‡æ¡£ä¸­æ–‡ç‰ˆ-é€‚é…å™¨-å¯æ‰©å±•æ€§</a></p></li><li class="post-title"><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/65472726">å¦‚ä½•åœ¨ Calcite æ³¨å†Œå‡½æ•°</a></p></li><li class="post-title"><p><a target="_blank" rel="noopener" href="https://articles.zsxq.com/id_sl3habfw53xv.html">Calcite çš„åˆæ­¥ä½¿ç”¨â€”â€”Calcite æ·»åŠ è‡ªå®šä¹‰å‡½æ•°</a></p></li></ul></div></section><section id="license"><div class="header"><span>è®¸å¯åè®®</span></div><div class="body"><p>æœ¬æ–‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…</a> è®¸å¯åè®®ï¼Œæœªç»æˆæƒè¯·å‹¿è½¬è½½ã€‚</p></div></section><section id="share"><div class="header"><span>åˆ†äº«æ–‡ç« </span></div><div class="body"><div class="link"><input class="copy-area" readonly id="copy-link" value="https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension.html"></div><div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot;)"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg"></a><a class="social share-item weibo" target="_blank" rel="external nofollow noopener noreferrer" href="https://service.weibo.com/share/share.php?url=https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension.html&title=Apache Calcite Catalog æ‹¾é—ä¹‹ UDF å‡½æ•°å®ç°å’Œæ‰©å±• - ç«¯å°å¼ºçš„åšå®¢&pics=/assets/cover/calcite.jpg&summary=
æ³¨æ„ï¼šæœ¬æ–‡åŸºäº Calcite main åˆ†æ”¯ 60e0a3f ç‰ˆæœ¬æºç è¿›è¡Œå­¦ä¹ ç ”ç©¶ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šå­˜åœ¨å®ç°é€»è¾‘å·®å¼‚ï¼Œå¯¹æºç æ„Ÿå…´è¶£çš„è¯»è€…è¯·æ³¨æ„ç‰ˆæœ¬é€‰æ‹©ã€‚

 å‰è¨€
æœ€è¿‘ï¼Œå¾ˆå¤šæœ‹å‹å’¨è¯¢å…³äº Calcite UDF å®ç°å’Œæ‰©å±•çš„é—®é¢˜ï¼Œåœ¨..."><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/80c07e4dbb303.svg"></a><a class="social share-item email" href="mailto:?subject=Apache Calcite Catalog æ‹¾é—ä¹‹ UDF å‡½æ•°å®ç°å’Œæ‰©å±• - ç«¯å°å¼ºçš„åšå®¢&amp;body=https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension.html"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/a1b00e20f425d.svg"></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;å¤åˆ¶æˆåŠŸ&quot;)"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg"></a></div><div class="qrcode" id="qrcode-wechat" style="opacity:0;height:0"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=https://strongduanmu.com/blog/apache-calcite-catalog-udf-function-implementation-and-extension.html"></div></div></section></div></article><div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">è¾ƒæ–°æ–‡ç« </div><a href="/blog/shardingsphere-proxy-adapt-mysql-add-batch-execute-batch-return-int-array-in-action.html">ShardingSphere Proxy é€‚é… MySQL addBatch/executeBatch æ•°ç»„ç»“æœå®æˆ˜</a></div><div class="item" id="next"><div class="note">è¾ƒæ—©æ–‡ç« </div><a href="/blog/graalvm-compilation-of-dynamic-link-library-mysql-udf-implementation.html">GraalVM ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“ä¹‹ MySQL UDF å®ç°</a></div></section></div><div class="related-wrap md-text" id="comments"><section class="header cmt-title cap theme"><p>å¿«æ¥å‚ä¸è®¨è®ºå§~</p></section><section class="body cmt-body giscus"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg><div id="giscus" src="https://giscus.app/client.js" data-repo="strongduanmu/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkzNzQwMDk3Njg=" data-category="Announcements" data-category-id="DIC_kwDOFkrvqM4CZIsa" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div></section></div><footer class="page-footer footnote"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs15">åšå®¢</span><a href="/categories/">åˆ†ç±»</a><a href="/tags/">æ ‡ç­¾</a><a href="/archives/">å½’æ¡£</a></div><div class="sitemap-group"><span class="fs15">æ–‡æ¡£</span><a href="/wiki/calcite/background.html">Calcite</a><a href="/wiki/cmu_15_445/index.html">CMU 15-445</a><a href="/wiki/cmu_15_721/index.html">CMU 15-721</a></div><div class="sitemap-group"><span class="fs15">ä¾¿ç¬º</span><a href="/notes/">Common</a><a href="/notes/docker.html">Docker</a><a href="/notes/git.html">Git</a></div><div class="sitemap-group"><span class="fs15">æ›´å¤š</span><a href="/more/">å…³äº</a><a href="/more/news/">åŠ¨æ€</a></div></div><div class="text"><p>æœ¬ç«™ç”± <a target="_blank" rel="noopener" href="https://github.com/strongduanmu">@strongduanmu</a> ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> ä¸»é¢˜åˆ›å»ºï¼Œä½¿ç”¨ <a target="_blank" rel="noopener" href="https://vercel.com/">Vercel</a> ç½‘ç«™éƒ¨ç½²ã€‚<br>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚<br>æœ¬ç«™æ€»è®¿é—®é‡ <span id="vercount_value_site_pv"></span> æ¬¡ï¼Œæœ¬ç«™è®¿å®¢æ•° <span id="vercount_value_site_uv"></span> äººæ¬¡ã€‚</p></div></footer><div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right"><div class="widgets"><widget class="widget-wrapper tagcloud"><div class="widget-header dis-select"><span class="name">æ ‡ç­¾äº‘</span></div><div class="widget-body fs14"><a href="/tags/Antlr/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">Antlr</a> <a href="/tags/Calcite/" style="font-size:20px;color:#6f86d6" class="tag -10">Calcite</a> <a href="/tags/CentOS/" style="font-size:12px;color:#48c6ef" class="tag -0">CentOS</a> <a href="/tags/Charles/" style="font-size:12px;color:#48c6ef" class="tag -0">Charles</a> <a href="/tags/Distributed-Transaction/" style="font-size:12px;color:#48c6ef" class="tag -0">Distributed Transaction</a> <a href="/tags/Docker/" style="font-size:12px;color:#48c6ef" class="tag -0">Docker</a> <a href="/tags/FFmpeg/" style="font-size:12px;color:#48c6ef" class="tag -0">FFmpeg</a> <a href="/tags/GraalVM/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">GraalVM</a> <a href="/tags/In-Action/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">In Action</a> <a href="/tags/JVM/" style="font-size:17.33px;color:#629bde" class="tag -7">JVM</a> <a href="/tags/Java/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">Java</a> <a href="/tags/Java8/" style="font-size:12px;color:#48c6ef" class="tag -0">Java8</a> <a href="/tags/JavaCC/" style="font-size:12px;color:#48c6ef" class="tag -0">JavaCC</a> <a href="/tags/Kernel/" style="font-size:14.67px;color:#55b1e7" class="tag -3">Kernel</a> <a href="/tags/Linux/" style="font-size:12px;color:#48c6ef" class="tag -0">Linux</a> <a href="/tags/MySQL/" style="font-size:16px;color:#5ca6e3" class="tag -5">MySQL</a> <a href="/tags/Paper/" style="font-size:12px;color:#48c6ef" class="tag -0">Paper</a> <a href="/tags/PolarDB-X/" style="font-size:12px;color:#48c6ef" class="tag -0">PolarDB-X</a> <a href="/tags/Query-Optimization/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">Query Optimization</a> <a href="/tags/Remote-Debugging/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">Remote Debugging</a> <a href="/tags/SQLLine/" style="font-size:12px;color:#48c6ef" class="tag -0">SQLLine</a> <a href="/tags/SQLancer/" style="font-size:12px;color:#48c6ef" class="tag -0">SQLancer</a> <a href="/tags/ShardingSphere/" style="font-size:18.67px;color:#6991da" class="tag -8">ShardingSphere</a> <a href="/tags/Transaction/" style="font-size:12px;color:#48c6ef" class="tag -0">Transaction</a> <a href="/tags/VirtualBox/" style="font-size:12px;color:#48c6ef" class="tag -0">VirtualBox</a> <a href="/tags/Wireshark/" style="font-size:12px;color:#48c6ef" class="tag -0">Wireshark</a></div></widget><widget class="widget-wrapper markdown"><div class="widget-header dis-select"><span class="name">èµåŠ©å•†</span></div><div class="widget-body fs14"><p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9880881761323734" data-ad-slot="1987141063" data-ad-format="auto" data-full-width-responsive="true"></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></widget></div></aside><div class="float-panel blur"><button type="button" style="display:none" class="laptop-only rightbar-toggle mobile" onclick="sidebar.rightbar()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></button> <button type="button" style="display:none" class="mobile-only leftbar-toggle mobile" onclick="sidebar.leftbar()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg></button></div></div><div class="scripts"><script>let ctx={date_suffix:{just:"åˆšåˆš",min:"åˆ†é’Ÿå‰",hour:"å°æ—¶å‰",day:"å¤©å‰"},root:"/",tag_plugins:{chat:Object.assign({api:"https://siteinfo.listentothewind.cn/api/v1"})},search:{}};if((ctx.search.service="local_search")==ctx.search.service){let e=Object.assign({},'{"field":"all","path":"/search.json","content":true,"skip_search":null,"codeblock":true,"sort":"-date"}');ctx.search[ctx.search.service]=e}let def={avatar:"/assets/placeholder/avatar.svg",cover:"/assets/placeholder/cover.svg"},deps={jquery:"https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js",marked:"https://cdn.jsdelivr.net/npm/marked@13.0.1/lib/marked.umd.min.js"}</script><script>function RunItem(){function n(e,t){this.name=t||e.name,this.run=()=>{try{e()}catch(e){console.log(e)}}}this.list=[],this.start=()=>{for(var e=0;e<this.list.length;e++)this.list[e].run()},this.push=(e,t,r=!0)=>{let s=e,i=new n(s=r?()=>{utils.requestAnimationFrame(e)}:s,t);this.list.push(i)},this.remove=t=>{for(let e=0;e<this.list.length;e++)this.list[e].name==t&&this.list.splice(e,1)}}let utils={css:(e,t,r,s)=>{var i,n,a=window.document,o=a.createElement("link"),d=(n=t||(i=(a.body||a.getElementsByTagName("head")[0]).childNodes)[i.length-1],a.styleSheets);if(s)for(var l in s)s.hasOwnProperty(l)&&o.setAttribute(l,s[l]);o.rel="stylesheet",o.href=e,o.media="only x",function e(t){if(a.body)return t();setTimeout(function(){e(t)})}(function(){n.parentNode.insertBefore(o,t?n:n.nextSibling)});function u(e){for(var t=o.href,r=d.length;r--;)if(d[r].href===t)return e();setTimeout(function(){u(e)})}function h(){o.addEventListener&&o.removeEventListener("load",h),o.media=r||"all"}return o.addEventListener&&o.addEventListener("load",h),o.onloadcssdefined=u,u(h),o},js:(i,n)=>new Promise((t,e)=>{var r=document.createElement("script");if(i.startsWith("/")&&(i=ctx.root+i.substring(1)),r.src=i,n)for(var s of Object.keys(n))r[s]=n[s];else r.async=!0;r.onerror=e,r.onload=r.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(r.onload=r.onreadystatechange=null,t())},document.head.appendChild(r)}),jq:e=>{"undefined"==typeof jQuery?utils.js(deps.jquery).then(e):e()},onLoading:e=>{e&&$(e).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>')},onLoadSuccess:e=>{e&&$(e).find(".loading-wrap").remove()},onLoadFailure:e=>{e&&($(e).find(".loading-wrap svg").remove(),$(e).find(".loading-wrap").append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>'),$(e).find(".loading-wrap").addClass("error"))},request:(n,a,o,d)=>{let l=3;utils.onLoading(n),function i(){new Promise((t,e)=>{let r=0,s=setTimeout(()=>{0===r&&(r=2,s=null,e("è¯·æ±‚è¶…æ—¶"),0==l)&&d()},5e3);fetch(a).then(function(e){if(2!==r&&(clearTimeout(s),t(e),s=null,r=1),e.ok)return e.json();throw new Error("Network response was not ok.")}).then(function(e){l=0,utils.onLoadSuccess(n),o(e)}).catch(function(e){0<l?(--l,setTimeout(()=>{i()},5e3)):(utils.onLoadFailure(n),d())})})}()},requestAnimationFrame:e=>{window.requestAnimationFrame||(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame),window.requestAnimationFrame(e)},dark:{}};utils.dark.method={toggle:new RunItem},utils.dark=Object.assign(utils.dark,{push:utils.dark.method.toggle.push})</script><script>let sidebar={leftbar:()=>{l_body&&(l_body.toggleAttribute("leftbar"),l_body.removeAttribute("rightbar"))},rightbar:()=>{l_body&&(l_body.toggleAttribute("rightbar"),l_body.removeAttribute("leftbar"))},dismiss:()=>{l_body&&(l_body.removeAttribute("leftbar"),l_body.removeAttribute("rightbar"))},toggleTOC:()=>{document.querySelector("#data-toc").classList.toggle("collapse")}}</script><script>(()=>{var e;for(e of document.querySelectorAll(".tag-subtree.parent-tag > a > .tag-switcher-wrapper"))e.addEventListener("click",e=>{e.target.closest(".tag-subtree.parent-tag").classList.toggle("expanded"),e.preventDefault()});var t=new URLSearchParams(window.location.search).get("tag");if(t){let e=document.querySelector(`.tag-subtree[data-tag="${t}"]`);if(e)for(e.querySelector("a").classList.add("active");e;)e.classList.add("expanded"),e=e.parentElement.closest(".tag-subtree.parent-tag")}})()</script><script src="/js/main.js?v=1.30.1" defer></script><script>let applyTheme=e=>{"auto"===e?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme",e),applyThemeToGiscus(e)},applyThemeToGiscus=e=>{e="auto"===e?"preferred_color_scheme":e;var t=document.getElementById("giscus"),t=(t&&t.setAttribute("data-theme",e),document.querySelector("#comments > section.giscus > iframe"));t&&(e=t.src.replace(/theme=[\w]+/,"theme="+e),t.src=e)},switchTheme=()=>{let e;switch(document.documentElement.getAttribute("data-theme")){case"light":e="dark";break;case"dark":e="auto";break;default:e="light"}applyTheme(e),window.localStorage.setItem("Stellar.theme",e),utils.dark.mode="auto"===e?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e,utils.dark.method.toggle.start(),hud?.toast?.({light:"åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼",dark:"åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼",auto:"åˆ‡æ¢åˆ°è·Ÿéšç³»ç»Ÿé…è‰²"}[e])};(()=>{var e=window.localStorage.getItem("Stellar.theme");null!==e?applyTheme(e):utils.dark.mode=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",utils.dark.method.toggle.start()})()</script><script type="module">const el = document.querySelector('#comments #giscus');
  util.viewportLazyload(el, load_discus, false);

  function load_discus() {
    if (!el) return;
    try {
        el.innerHTML = '';
      } catch (error) {
        console.error(error);
      }
      const script = document.createElement('script');
      script.async = true;
      for (const key of Object.keys(el.attributes)) {
        const attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
  }</script><script defer>window.addEventListener("DOMContentLoaded",e=>{ctx.services=Object.assign({},JSON.parse('{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"}}'));for(let s of Object.keys(ctx.services)){let e=ctx.services[s].js;"siteinfo"==s?(ctx.cardlinks=document.querySelectorAll("a.link-card[cardlink]"),0<ctx.cardlinks?.length&&utils.js(e,{defer:!0}).then(function(){setCardLink(ctx.cardlinks)})):"voice"==s?(ctx.voiceAudios=document.querySelectorAll(".voice>audio"),0<ctx.voiceAudios?.length&&utils.js(e,{defer:!0}).then(function(){createVoiceDom(ctx.voiceAudios)})):"video"==s?(ctx.videos=document.querySelectorAll(".video>video"),0<ctx.videos?.length&&utils.js(e,{defer:!0}).then(function(){videoEvents(ctx.videos)})):"download-file"==s?(ctx.files=document.querySelectorAll(".file"),0<ctx.files?.length&&utils.js(e,{defer:!0}).then(function(){downloadFileEvent(ctx.files)})):0<document.getElementsByClassName("ds-"+s)?.length&&utils.jq(()=>{s,utils.js(deps.marked).then(function(){utils.js(e,{defer:!0})})})}let n=document.querySelectorAll(".chat .status-bar .time");var s,t;function i(){for(let e=0;e<n.length;++e){var s=n[e],t=new Date,i=t.getHours(),t=t.getMinutes();s.innerHTML=o(i)+":"+o(t)}}function o(e){return e<10?"0"+e:e}0<n.length&&(i(),s=(new Date).getSeconds(),t=setInterval(function(){i(),clearInterval(t),setInterval(i,6e4)},1e3*(60-s)));let c=new IntersectionObserver((e,t)=>{e.filter(e=>e.isIntersecting).sort((e,s)=>e.intersectionRect.y!==s.intersectionRect.y?e.intersectionRect.y-s.intersectionRect.y:e.intersectionRect.x-s.intersectionRect.x).forEach((e,s)=>{t.unobserve(e.target),setTimeout(()=>{e.target.classList.add("quote-blink"),setTimeout(()=>{e.target.classList.remove("quote-blink")},1e3)},Math.max(100,16)*(s+1))})}),r=document.querySelectorAll(".chat .talk .quote");r.forEach(i=>{i.addEventListener("click",function(){var e,s,t=document.getElementById("quote-"+i.getAttribute("quotedCellTag"));t&&(s=(e=t.parentElement).clientHeight/2,t.offsetTop>s-t.clientHeight/2?e.scrollTo({top:t.offsetTop-s+t.clientHeight/2,behavior:"smooth"}):e.scrollTo({top:0,behavior:"smooth"}),c.observe(t))})})})</script><script>window.addEventListener("DOMContentLoaded",e=>{ctx.search={path:"/search.json"},utils.js("/js/search/local-search.js",{defer:!0})})</script><script>window.FPConfig={delay:0,ignoreKeywords:[],maxRPS:5,hoverDelay:25}</script><script defer src="/js/flying-pages.min.js"></script><script defer src="/js/lazyload.min.js"></script><script>window.lazyLoadOptions={elements_selector:".lazy"},window.addEventListener("LazyLoad::Initialized",function(n){window.lazyLoadInstance=n.detail.instance},!1),document.addEventListener("DOMContentLoaded",function(){window.lazyLoadInstance?.update()})</script><script>ctx.fancybox={selector:"article.md-text img:not(.post-cover img):not(.cover img):not(.card-link img):not(.image-bg img):not(.social img):not(.preview img)",css:"/css/fancybox.min.css",js:"/js/fancybox.umd.min.js"};var selector="[data-fancybox]:not(.error)",needFancybox=(ctx.fancybox.selector&&(selector+=", "+ctx.fancybox.selector),0!==document.querySelectorAll(selector).length);if(!needFancybox){let e=document.getElementsByClassName("ds-memos");null!=e&&0<e.length&&(needFancybox=!0)}needFancybox&&(utils.css(ctx.fancybox.css),utils.js(ctx.fancybox.js,{defer:!0}).then(function(){Fancybox.bind(selector,{hideScrollbar:!1,Thumbs:{autoStart:!1},caption:(e,t)=>t.triggerEl.alt||t.triggerEl.dataset.caption||null})}))</script><script>window.addEventListener("DOMContentLoaded",e=>{let i=document.getElementById("swiper-api");null!=i&&(utils.css("/css/swiper-bundle.min.css"),utils.js("/js/swiper-bundle.min.js",{defer:!0}).then(function(){var e=i.getAttribute("effect")||"";new Swiper(".swiper#swiper-api",{slidesPerView:"auto",spaceBetween:8,centeredSlides:!0,effect:e,rewind:!0,pagination:{el:".swiper-pagination",clickable:!0},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"}})}))})</script><script>document.addEventListener("DOMContentLoaded",function(){window.codeElements=document.querySelectorAll(".code"),0<window.codeElements.length&&(ctx.copycode={default_text:"å¤åˆ¶ä»£ç ",success_text:"å¤åˆ¶æˆåŠŸ",toast:"å¤åˆ¶æˆåŠŸ"},utils.js("/js/plugins/copycode.js"))})</script><script async>((a,t,c)=>{t.ChatraID="PHWnu7Bamcwtbnx2d";var h=a.createElement("script");t[c]=t[c]||function(){(t[c].q=t[c].q||[]).push(arguments)},h.async=!0,h.src="https://call.chatra.io/chatra.js",a.head&&a.head.appendChild(h)})(document,window,"Chatra")</script><script defer src="https://cn.vercount.one/js"></script><link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"></noscript><script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous" onload="renderMathInElement(document.body)"></script><script>window.va=window.va||function(){(window.vaq=window.vaq||[]).push(arguments)}</script><script defer src="/_vercel/insights/script.js"></script><script>window.si=window.si||function(){(window.siq=window.siq||[]).push(arguments)}</script><script defer src="/_vercel/speed-insights/script.js"></script><script>function change_banner(){$(".banner img.bg").attr("src","/assets/banner/banner_"+Math.floor(20*Math.random()+1)+".jpg")}setTimeout("change_banner()",250)</script><script>function add_page_pv(){$("#post-meta").after('<div class="flex-row" id="post-meta"><span class="text created">æœ¬æ–‡æ€»é˜…è¯»é‡ <span id="vercount_value_page_pv"></span> æ¬¡</span></div>')}setTimeout("add_page_pv()",500)</script><script>function change_img_alt(){$("article.md-text img:not(.post-cover img):not(.cover img):not(.card-link img):not(.image-bg img):not(.social img):not(.preview img)").each(function(t){$(this).after("<div class='image-meta' style='text-align:center;'><span class='image-caption center' style='display:inline-block;font-size:.8125rem;color:var(--text-p2);line-height:1.5;text-align:justify;'>"+($(this).attr("title")||$(this).attr("alt"))+"</span></div>")})}setTimeout("change_img_alt()",1e3)</script></div></body></html>