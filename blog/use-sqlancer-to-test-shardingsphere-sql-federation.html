<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.30.1" theme-name="Stellar" theme-version="1.30.1"><meta name="generator" content="Hexo 7.3.0"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin><link rel="preconnect" href="https://googleads.g.doubleclick.net" crossorigin><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="theme-color" content="#f9fafb"><title>使用 SQLancer 测试 ShardingSphere 联邦查询 - 端小强的博客</title><meta name="description" content="前言 在上一篇文章 ShardingSphere 联邦查询 GROUPING 聚合结果问题分析中，我们详细介绍了联邦查询引擎实现 GROUPING 聚合函数存在的问题，当时笔者曾提到 SQLancer 测试工具，它能够通过一些科学的方法来发现 SQL 逻辑问题，帮助提升联邦查询引擎的 SQL 支持度。本文将为大家详细介绍 SQLancer 测试工具，以及工具中内置的几种测试方法，然后我们会使用"><meta property="og:type" content="article"><meta property="og:title" content="使用 SQLancer 测试 ShardingSphere 联邦查询"><meta property="og:url" content="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation.html"><meta property="og:site_name" content="端小强的博客"><meta property="og:description" content="前言 在上一篇文章 ShardingSphere 联邦查询 GROUPING 聚合结果问题分析中，我们详细介绍了联邦查询引擎实现 GROUPING 聚合函数存在的问题，当时笔者曾提到 SQLancer 测试工具，它能够通过一些科学的方法来发现 SQL 逻辑问题，帮助提升联邦查询引擎的 SQL 支持度。本文将为大家详细介绍 SQLancer 测试工具，以及工具中内置的几种测试方法，然后我们会使用"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation/what_is_logical_bugs.png"><meta property="og:image" content="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation/sqlancer-pivoted-query-synthesis-technique.png"><meta property="og:image" content="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation/test-with-qps.png"><meta property="og:image" content="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation/sqlancer-norec-technique.png"><meta property="og:image" content="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation/test-with-norec.png"><meta property="og:image" content="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation/sqlancer-tlp-technique.png"><meta property="og:image" content="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation/sql-feature-tlp-oracles-design-to-test.png"><meta property="og:image" content="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation/test-with-tlp.png"><meta property="og:image" content="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation/sqlancer-dqe-technique.png"><meta property="og:image" content="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation/test-with-dqe.png"><meta property="og:image" content="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation/use-sqlancer-to-test-shardingsphere-sql-federation.png"><meta property="og:image" content="https://strongduanmu.com/assets/wechat/gongzhonghao.png"><meta property="article:published_time" content="2025-12-10T00:24:20.000Z"><meta property="article:modified_time" content="2025-12-29T00:30:00.000Z"><meta property="article:author" content="端小强"><meta property="article:tag" content="ShardingSphere"><meta property="article:tag" content="SQLancer"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation/what_is_logical_bugs.png"><meta name="twitter:creator" content="@strongduanmu"><meta name="keywords" content="ShardingSphere,SQLancer"><link rel="alternate" href="/atom.xml" title="端小强的博客" type="application/atom+xml"><link rel="stylesheet" href="/css/main.css?v=1.30.1"><link rel="shortcut icon" href="/assets/placeholder/favicon.ico"><meta name="baidu-site-verification" content="codeva-sIRwgTpHve"><link rel="apple-touch-icon" sizes="180x180" href="/assets/placeholder/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/placeholder/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/placeholder/favicon-16x16.png"><link rel="manifest" href="/assets/placeholder/site.webmanifest"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/lxgwwenkaimono-bold.css" media="print" onload='this.media="all"'><noscript><link rel="stylesheet" href="/css/lxgwwenkaimono-bold.css"></noscript><link rel="stylesheet" href="/css/lxgwwenkaiscreen.css" media="print" onload='this.media="all"'><noscript><link rel="stylesheet" href="/css/lxgwwenkaiscreen.css"></noscript><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="preconnect" href="https://pagead2.googlesyndication.com"><link rel="dns-prefetch" href="https://pagead2.googlesyndication.com"><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9880881761323734" crossorigin="anonymous"></script><script src="/js/plugins/article-bottom-ad.js"></script><script src="/js/plugins/sticky-adsense.js"></script><script src="/js/plugins/adblock-detector.js"></script><style>.widget-wrapper.adsense{background:0 0!important}.widget-wrapper.adsense .widget-body{padding:0!important;background:0 0!important}.widget-wrapper.adsense .widget-body p{margin:0!important}.widget-wrapper.adsense ins.adsbygoogle{display:block;border-radius:12px;overflow:hidden}.article-bottom-ad{margin:2rem 0;padding:1rem;text-align:center}.article-bottom-ad .ad-container{max-width:100%;margin:0 auto}.article-bottom-ad ins.adsbygoogle{display:block;background:0 0}</style></head><body><div class="l_body content tech" id="start" layout="post"><aside class="l_left"><div class="leftbar-container"><header class="header"><div class="logo-wrap"><a class="avatar" href="/more/"><div class="bg" style="opacity:0;background-image:url(/assets/placeholder/rainbow64@3x.webp)"></div><img no-lazy class="avatar" src="/assets/placeholder/avatar.png" onerror="javascript:this.classList.add('error');this.src='/assets/placeholder/image.svg';"></a><a class="title" href="/"><div class="main" ff="title">端小强的博客</div><div class="sub normal cap">不积跬步，无以至千里 🤔</div><div class="sub hover cap" style="opacity:0">不积小流，无以成江海 😃</div></a></div></header><div class="nav-area"><div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div><nav class="menu dis-select"><a class="nav-item active" title="博客" href="/"><span>博客</span></a><a class="nav-item" title="文档" href="/wiki/"><span>文档</span></a><a class="nav-item" title="便笺" href="/notes/"><span>便笺</span></a><a class="nav-item" title="更多" href="/more/"><span>更多</span></a></nav></div><div class="widgets"><widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-sqlancer"><span class="toc-text">什么是 SQLancer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pqs-%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95"><span class="toc-text">PQS 测试方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#norec-%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95"><span class="toc-text">NoREC 测试方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tlp-%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95"><span class="toc-text">TLP 测试方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dqe-%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95"><span class="toc-text">DQE 测试方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%94%E9%82%A6%E6%9F%A5%E8%AF%A2%E6%B5%8B%E8%AF%95%E5%AE%9E%E6%88%98"><span class="toc-text">联邦查询测试实战</span></a></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget></div><footer class="footer dis-select"><div class="social-wrap"><a class="social" href="mailto:duanzhengqiang@apache.org" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/email.svg"></a><a class="social" href="https://github.com/strongduanmu" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/github.svg"></a><a class="social" href="/sitemap.xml" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/sitemap.svg"></a><a class="social" href="/atom.xml" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/rss.svg"></a></div></footer></div></aside><div class="l_main" id="main"><div class="article banner top"><img class="bg lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/banner/banner_12.jpg"><div class="content"><div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a> <span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/ShardingSphere/">ShardingSphere</a></div><div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2025-12-10T00:24:20.000Z">2025-12-10</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2025-12-29T00:30:00.000Z">2025-12-29</time></span></div></div></div><div class="bottom only-title"><div class="text-area"><h1 class="text title"><span>使用 SQLancer 测试 ShardingSphere 联邦查询</span></h1></div></div></div></div><article class="md-text content"><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>在上一篇文章 <a target="_blank" rel="noopener" href="http://localhost:4000/blog/analyze-wrong-result-for-shardingsphere-sql-federation-grouping-function.html">ShardingSphere 联邦查询 GROUPING 聚合结果问题分析</a>中，我们详细介绍了联邦查询引擎实现 <code>GROUPING</code> 聚合函数存在的问题，当时笔者曾提到 <a target="_blank" rel="noopener" href="https://github.com/sqlancer/sqlancer">SQLancer</a> 测试工具，它能够通过一些科学的方法来发现 SQL 逻辑问题，帮助提升联邦查询引擎的 SQL 支持度。本文将为大家详细介绍 SQLancer 测试工具，以及工具中内置的几种测试方法，然后我们会使用 SQLancer 工具，直接对联邦查询引擎进行测试，看看这个工具是否能够达到预期的测试效果，发现一些有价值的 SQL 漏洞。</p><h2 id="什么是-sqlancer"><a class="markdownIt-Anchor" href="#什么是-sqlancer"></a> 什么是 SQLancer</h2><p><a target="_blank" rel="noopener" href="https://github.com/sqlancer/sqlancer">SQLancer</a> 项目，是由 <a target="_blank" rel="noopener" href="https://www.manuelrigger.at/">Manuel Rigger</a> 教授创建的，旨在发现数据库 SQL 引擎的逻辑 BUG，Manuel Rigger 教授曾在 Andy 组织的线上分享中介绍过 SQLancer，感兴趣的朋友可以观看 <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Np46NQ6lqP8">Finding Logic Bugs in Database Management Systems</a> 视频了解。</p><blockquote><p>SQLancer is a tool to automatically test Database Management Systems (DBMSs) in order to find bugs in their implementation. That is, it finds bugs in the code of the DBMS implementation, rather than in queries written by the user. SQLancer has found hundreds of bugs in mature and widely-known DBMSs.</p></blockquote><p>根据官方文档介绍，SQLancer 是一款用于自动测试数据库管理系统的工具，用于查找<strong>数据库实现逻辑中的错误</strong>。它查找的是 <strong>DBMS 实现代码中的错误</strong>，而不是用户编写 SQL 中的错误。目前，SQLancer 已在众多主流的 DBMS 中发现了数百个错误。</p><p>下图展示了一个具体的逻辑错误：当用户输入 SQL 语句查询数据时，原本数据库中存在 2 条匹配的数据，但由于数据库的 SQL 引擎存在<strong>逻辑错误</strong>，最终只返回了 1 条数据。除了<strong>少返回数据行</strong>外，逻辑错误还包含：<strong>错误返回过滤条件外的结果</strong>，<strong>返回的数据行内容错误</strong>等。</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/use-sqlancer-to-test-shardingsphere-sql-federation/what_is_logical_bugs.png" title="什么是逻辑错误"><p><strong>数据库逻辑错误</strong>相比于<strong>语法错误</strong>危害性更大，语法错误会在执行阶段通过异常码反馈出来，中断当前的 SQL 执行，逻辑错误则会返回不正确的查询结果，用户无法通过任何信息识别出当前的逻辑错误，最终可能会导致严重的业务错误。</p><p>使用 SQLancer 测试工具，可以快速发现 SQL 逻辑问题，帮助提升 SQL 引擎的正确性，下面我们将分别介绍 SQLancer 常用的几种测试方法，看看这些方法是如何检测 SQL 逻辑问题。</p><div class="article-inline-ad-wrapper"><div class="article-inline-ad-container"><ins class="adsbygoogle" style="display:block;text-align:center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9880881761323734" data-ad-slot="7617691942"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="article-inline-ad-label">赞助商</div></div><h2 id="pqs-测试方法"><a class="markdownIt-Anchor" href="#pqs-测试方法"></a> PQS 测试方法</h2><p>PQS 全称为 <code>Pivoted Query Synthesis（枢轴查询合成）</code>，该方法详细的介绍可以参考论文——<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2001.04174">Testing Database Engines via<br>Pivoted Query Synthesis</a>。它的<strong>核心思想</strong>是：<strong>随机选择一条记录（即枢轴记录），然后基于这条记录生成过滤条件和查询语句，再去 DBMS 中执行查询，如果 DBMS 返回的结果集没有包含这条记录，则说明 DBMS 存在问题</strong>。</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/use-sqlancer-to-test-shardingsphere-sql-federation/sqlancer-pivoted-query-synthesis-technique.png" title="SQLancer PQS 测试原理"><p>上图展示了 PQS 测试方法的详细步骤，总结下来包括如下 7 个步骤：</p><ol><li>随机生成一些表（<code>t0</code> 和 <code>t1</code> 表）和数据行（<code>t0</code> 表 <code>c0:3, c1:TRUE</code> 数据行，<code>t1</code> 表 <code>c0:-5</code> 数据行）；</li><li>从每张表中随机的选择一行数据，将这行数据作为基准行；</li><li>基于选择的基准行，随机生成表达式，并根据基准行的值计算出表达式结果；</li><li>根据表达式的计算结果调整表达式，直到表达式的计算结果为 <code>TRUE</code>，例如：上图步骤 3 中表达式计算结果为 <code>FALSE</code>，步骤 4 中通过增加 <code>NOT</code> 将计算结果调整为 <code>TRUE</code>；</li><li>基于表达式随机生成查询语句，表达式使用在查询的 <code>WHERE</code> 或者 <code>JOIN</code> 子句中，查询语句会返回基准行对应的列（<code>SELECT t0.c0, t0.c1, t1.c0</code>）；</li><li>将查询语句提交到 DBMS 中执行，获取返回的结果集；</li><li>校验结果集是否包含最初选择的基准行，如果不包含，说明 DBMS 可能存在缺陷。</li></ol><p>PQS 测试方法是 SQLancer 支持的第一个测试方法，它支持 <code>SQLite（3.28）</code>、<code>MySQL（8.0.16）</code> 及 <code>PostgreSQL（11.4）</code> 数据库，由于该测试方法实现的工作量巨大，需要为每个 DB 实现 AST 解释器，并且无法支持聚合函数、窗口函数测试，目前 <strong>SQLancer 已经不再维护</strong>，官方推荐使用其他测试方法。如果大家对这个测试方法感兴趣，仍然可以使用如下的命令执行 PQS 测试，<code>--oracle pqs</code> 属性用于指定测试预言机的类型。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar sqlancer-*.jar --num-threads 4 --port 3306 --username root --password 123456 mysql --oracle pqs</span><br></pre></td></tr></table></figure><p>下图展示了使用 SQLancer PQS 方法测试 MySQL 的截图，测试出的不支持 SQL 可以在 <code>target/logs</code> 目录下查看。</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/use-sqlancer-to-test-shardingsphere-sql-federation/test-with-qps.png" title="使用 SQLancer PQS 方法测试 MySQL"><h2 id="norec-测试方法"><a class="markdownIt-Anchor" href="#norec-测试方法"></a> NoREC 测试方法</h2><p><code>NoREC</code> 是 SQLancer 支持的第二个测试方法，全称是 <code>Non-Optimizing Reference Engine Construction（非优化参考引擎构造）</code>，该方法的详细内容可参考论文——<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2007.08292">Detecting Optimization Bugs in Database Engines via Non-Optimizing Reference Engine Construction</a>。</p><p><code>NoREC</code> 的<strong>核心思想</strong>是：<strong>通过对比优化查询与非优化查询的结果差异，来检测 SQL 优化可能存在的漏洞</strong>。优化查询具体指：<code>SELECT * FROM t0 WHERE φ</code>，这条 SQL 可能会被 SQL 引擎优化，<code>NoREC</code> 测试方法会将这条 SQL 转换为非优化查询——<code>SELECT (φ IS TRUE) FROM t0</code>，将过滤条件移动到投影列中。通过 <code>NoREC</code> 测试方法，可以测试出数据库管理系统中的优化错误。</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/use-sqlancer-to-test-shardingsphere-sql-federation/sqlancer-norec-technique.png" title="SQLancer NoREC 测试原理"><p>上图展示了 NoREC 测试方法的详细步骤，测试逻辑非常简单，具体如下：</p><ol><li>随机生成一条较高优化潜力的 SQL（数据库中大多数优化都和过滤相关，因此生成包含 WHERE 条件的 SQL，预期将会被数据库管理系统进行优化），例如：<code>SELECT * FROM t0 WHERE φ</code>；</li><li>将优化 SQL 转换为无法优化的形式，具体来说，是将 WHERE 条件中的表达式移动到投影列中，例如：<code>SELECT (φ IS TRUE) FROM t0</code>，这种查询缺乏 WHERE 条件，数据库管理系统必须检索所有记录；</li><li>执行优化 SQL 和未优化 SQL 并比较结果集，如果未优化 SQL 返回 TRUE 的行数不等于优化 SQL 返回行数，则说明存在 BUG。</li></ol><p>NoREC 测试方法支持 <code>SQLite</code>、<code>MariaDB</code>、<code>PostgreSQL</code> 和 <code>CockroachDB</code> 数据库，支持 <code>WHERE</code>、<code>JOIN</code>、<code>ORDER BY</code> 等子句测试，暂不支持 <code>DISTINCT</code>、<code>窗口函数</code> 测试。相比于 PQS，NoREC 增加了对聚合函数的支持，并且可以检测重复记录错误。执行如下的命令测试 NoREC 方法，通过 <code>--oracle norec</code> 参数指定 NoREC 方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar sqlancer-*.jar --num-threads 4 --port 3344 --username root --password 123456 mariadb --oracle norec</span><br></pre></td></tr></table></figure><p>下图展示了使用 SQLancer PQS 方法测试 MariaDB 的截图，测试出的不支持 SQL 可以在 <code>target/logs</code> 目录下查看。</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/use-sqlancer-to-test-shardingsphere-sql-federation/test-with-norec.png" title="使用 SQLancer PQS 方法测试 MariaDB"><h2 id="tlp-测试方法"><a class="markdownIt-Anchor" href="#tlp-测试方法"></a> TLP 测试方法</h2><p><code>TLP</code> 测试方法全称为 <code>Ternary Logic Partitioning（三元逻辑分区）</code>，该方法的详细介绍可以参考论文——<a target="_blank" rel="noopener" href="https://dl.acm.org/doi/pdf/10.1145/3428279">Finding bugs in database systems via query partitioning</a>。</p><p><code>TLP</code> 测试方法的<strong>核心思想</strong>是：将一个原始查询分解为多个分区查询，每个分区查询计算原始查询结果的一个子集，然后通过组合操作将这些子集合并，验证合并结果是否与原始查询结果一致，不一致则说明存在 BUG。从 <code>TLP</code> 的命名我们可以看出，在进行分区查询时，该方法采用了<strong>三元逻辑分区</strong>，基于 SQL 的三值逻辑（<code>TRUE</code>、<code>FALSE</code>、<code>NULL</code>），将原始查询分解为三个分区查询，分别对应谓词为 <code>TRUE</code>、<code>FALSE</code> 和 <code>NULL</code> 的情况。</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/use-sqlancer-to-test-shardingsphere-sql-federation/sqlancer-tlp-technique.png" title="SQLancer TLP 测试原理"><p>上图展示了 TLP 测试方法的实现原理，具体测试流程如下：</p><ol><li>随机生成数据库和查询语句；</li><li>根据原始查询生成分区查询，例如：<code>WHERE p</code>、<code>WHERE NOT p</code>、<code>WHERE p IS NULL</code>；</li><li>执行分区查询并合并查询结果；</li><li>与原始查询结果对比，不一致则发现 DB BUG。</li></ol><p>如下表所示，<code>TLP</code> 测试方法相比 <code>PQS</code>（主要测试 WHERE）和 <code>NoREC</code>（主要测试 WHERE，部分聚合），能够支持更多的语法类型，包括：<code>WHERE</code>、<code>GROUP BY</code>、<code>HAVING</code>、聚合函数（如 <code>MIN</code>、<code>MAX</code>、<code>SUM</code>、<code>COUNT</code>、<code>AVG</code>）和 <code>DISTINCT</code> 查询。目前，<code>TLP</code> 测试方法已经支持了 <code>SQLite</code>、<code>MySQL</code>、<code>PostgreSQL</code> 等多种数据库，可以将 <code>TLP</code> 和其他测试方法结合，覆盖更多的测试场景。</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/use-sqlancer-to-test-shardingsphere-sql-federation/sql-feature-tlp-oracles-design-to-test.png" title="TLP 测试方法覆盖的 SQL 语法"><p>执行如下的命令测试 TLP 方法，通过 <code>--oracle tlp_where</code> 参数指定 TLP 方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar sqlancer-*.jar --num-threads 4 --port 3306 --username root --password 123456 mysql --oracle tlp_where</span><br></pre></td></tr></table></figure><p>下图展示了使用 SQLancer TLP 方法测试 MySQL 的截图，测试出的不支持 SQL 可以在 <code>target/logs</code> 目录下查看。</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/use-sqlancer-to-test-shardingsphere-sql-federation/test-with-tlp.png" title="使用 SQLancer TLP 方法测试 MySQL"><h2 id="dqe-测试方法"><a class="markdownIt-Anchor" href="#dqe-测试方法"></a> DQE 测试方法</h2><p><code>DQE</code> 测试方法全称为 <code>Differential Query Execution（差分查询执行）</code>，该方法由国内研究团队提出，详细论文内容可以参考——<a target="_blank" rel="noopener" href="https://share.note.youdao.com/s/1IGOxnvZ">Testing Database Systems via Differential Query Execution</a>。</p><p><code>DQE</code> 测试方法的<strong>核心思想</strong>是：使用相同谓词（WHERE 条件）生成 <code>SELECT</code>、<code>UPDATE</code> 和 <code>DELETE</code> 语句，然后分别执行这 3 条语句，观察他们操作的数据行，如果操作的数据行不一致，则可能存在逻辑错误。</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/use-sqlancer-to-test-shardingsphere-sql-federation/sqlancer-dqe-technique.png" title="SQLancer DQE 测试原理"><p>上图展示了 DQE 测试方法的详细流程，具体测试细节如下：</p><ol><li>生成随机的库（<code>t1</code>、<code>t2</code>）和表（<code>c1</code>、<code>c2</code>）；</li><li>生成随机谓词，例如：<code>NOT t1.c1</code>；</li><li>基于相同的谓词，生成一个查询元组，包含 <code>SELECT</code>、<code>UPDATE</code> 和 <code>DELETE</code> 语句；</li><li>在相同的数据库状态下，执行 <code>SELECT</code>、<code>UPDATE</code> 和 <code>DELETE</code> 语句；</li><li>获取 <code>SELECT</code>、<code>UPDATE</code> 和 <code>DELETE</code> 语句执行结果；</li><li>比较执行结果：<code>SELECT</code> 语句返回 <code>rowId</code>，确定访问的数据行范围。<code>UPDATE</code> 语句除了更新常规字段外，还额外更新 <code>updated</code> 为 1，执行后检查 <code>updated = 1</code> 的数据行及其 <code>rowId</code>，确认修改行是否和 <code>SELECT</code> 一致。<code>DELETE</code> 语句执行前记录所有 <code>rowId</code>，执行后比较出删除的 <code>rowId</code> 范围，并和 <code>SELECT</code> 语句对比是否一致。</li></ol><p><code>DQE</code> 相比前文提到的其他测试方法，首次提出了针对 <code>UPDATE</code> 和 <code>DELETE</code> 语句逻辑错误的检测方法，并且支持 <code>MySQL</code>、<code>MariaDB</code>、<code>CockroachDB</code> 等数据库，完善了 SQLancer 测试工具覆盖的 SQL 场景。但是差分测试也存在一定的局限性，例如：无法测试出 <code>SELECT</code>、<code>UPDATE</code> 和 <code>DELETE</code> 语句同时出现相同错误的场景，不支持 <code>DISTINCT</code>、<code>GROUP BY</code> 等语法，以及包含非确定函数的场景（例如：<code>RAND</code> 函数）。</p><p>执行如下的命令测试 DQE 方法，通过 <code>--oracle dqe</code> 参数指定 DQE 方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar sqlancer-*.jar --num-threads 4 --port 3306 --username root --password 123456 mysql --oracle dqe</span><br></pre></td></tr></table></figure><p>下图展示了使用 SQLancer DQE 方法测试 MySQL 的截图，测试出的不支持 SQL 可以在 <code>target/logs</code> 目录下查看。</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/use-sqlancer-to-test-shardingsphere-sql-federation/test-with-dqe.png" title="使用 SQLancer DQE 方法测试 MySQL"><h2 id="联邦查询测试实战"><a class="markdownIt-Anchor" href="#联邦查询测试实战"></a> 联邦查询测试实战</h2><p>前文我们介绍了 SQLancer 常用的 4 种测试方法，通过这 4 种方法，可以较为全面地覆盖 <code>SELECT</code>、<code>UPDATE</code> 和 <code>DELETE</code> 语句，测试出 SQL 引擎的逻辑错误。本小节我们再来研究下，如何将 SQLancer 应用到 ShardingSphere 联邦查询功能中，帮助我们发现更多联邦查询的功能漏洞。</p><p>在开始测试联邦查询前，我们先了解下 SQLancer 工具如何使用，按照如下的命令克隆源码（Fork 仓库增加了对 ShardingSphere 的适配），然后进行编译打包，最后执行 <code>java -jar sqlancer-*.jar --num-threads 4 sqlite3 --oracle NoREC</code> 命令来开始测试。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@github.com:strongduanmu/sqlancer.git</span><br><span class="line"><span class="built_in">cd</span> sqlancer</span><br><span class="line">mvn package -DskipTests</span><br><span class="line"><span class="built_in">cd</span> target</span><br><span class="line">java -jar sqlancer-*.jar --num-threads 4 sqlite3 --oracle NoREC</span><br></pre></td></tr></table></figure><p>执行 <code>java -jar sqlancer-*.jar -h</code> 命令可以查看 SQLancer 所有命令参数及说明，下面展示的内容进行了一些截取，重点展示 SQLancer 全局选项（<code>options</code>） 以及 MySQL 数据库的参数选项。从 Usage 格式可以看出（<code>Usage: SQLancer [options] [command] [command options]</code>），SQLancer 命令需要先指定全局选项 <code>options</code>（例如：<code>--num-threads 4</code>），然后再指定数据库专属命令 <code>command</code>（例如：<code>sqlite3</code>） 以及数据库专属选项 <code>command options</code>（例如：<code>--oracle NoREC</code>）。</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Usage</span>: <span class="string">SQLancer [options] [command] [command options]</span></span><br><span class="line">  <span class="attr">Options</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">--canonicalize-sql-strings</span></span><br><span class="line"><span class="comment">      # 自动给 SQL 末尾加分号，适配严格要求语句结束符的 DBMS</span></span><br><span class="line">      <span class="attr">Should</span> <span class="string">canonicalize query string (add &#x27;;&#x27; at the end</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">true</span></span><br><span class="line">    <span class="attr">--database-prefix</span></span><br><span class="line"><span class="comment">      # 生成数据库的名称前缀，便于识别测试库（如 database_1、database_2）</span></span><br><span class="line">      <span class="attr">The</span> <span class="string">prefix used for each database created</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">database</span></span><br><span class="line">    <span class="attr">--help,</span> <span class="string">-h</span></span><br><span class="line">      <span class="attr">Lists</span> <span class="string">all supported options and commands</span></span><br><span class="line">    <span class="attr">--host</span></span><br><span class="line"><span class="comment">      # 数据库服务器地址</span></span><br><span class="line">      <span class="attr">The</span> <span class="string">host used to log into the DBMS</span></span><br><span class="line">    <span class="attr">--max-expression-depth</span></span><br><span class="line"><span class="comment">      # 随机生成表达式的最大嵌套深度，增大值（如 5）可测试复杂表达式</span></span><br><span class="line">      <span class="attr">Specifies</span> <span class="string">the maximum depth of randomly-generated expressions</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">3</span></span><br><span class="line">    <span class="attr">--max-num-inserts</span></span><br><span class="line"><span class="comment">      # 每个测试周期执行的 INSERT 语句数，控制测试数据量</span></span><br><span class="line">      <span class="attr">Specifies</span> <span class="string">how many INSERT statements should be issued</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">30</span></span><br><span class="line">    <span class="attr">--num-queries</span></span><br><span class="line"><span class="comment">      # 每个数据库执行的查询数，达到该数量后自动创建新数据库继续测试</span></span><br><span class="line">      <span class="attr">Specifies</span> <span class="string">the number of queries to be issued to a database before </span></span><br><span class="line">      <span class="attr">creating</span> <span class="string">a new database</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">100000</span></span><br><span class="line">    <span class="attr">--num-threads</span></span><br><span class="line"><span class="comment">      # 并发测试的线程数，线程数越多测试效率越高，但需避免 DBMS 资源耗尽</span></span><br><span class="line">      <span class="attr">How</span> <span class="string">many threads should run concurrently to test separate databases</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">16</span></span><br><span class="line">    <span class="attr">--num-tries</span></span><br><span class="line"><span class="comment">      # 发现错误后停止测试的阈值，找到 100 个错误即终止，可设更大值（如 1000）延长测试</span></span><br><span class="line">      <span class="attr">Specifies</span> <span class="string">after how many found errors to stop testing</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">100</span></span><br><span class="line">    <span class="attr">--password</span></span><br><span class="line"><span class="comment">      # 登录数据库的密码</span></span><br><span class="line">      <span class="attr">The</span> <span class="string">password used to log into the DBMS</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">sqlancer</span></span><br><span class="line">    <span class="attr">--port</span></span><br><span class="line"><span class="comment">      # 数据库端口</span></span><br><span class="line">      <span class="attr">The</span> <span class="string">port used to log into the DBMS</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">-1</span></span><br><span class="line">    <span class="attr">--pqs-test-aggregates</span></span><br><span class="line"><span class="comment">      # 仅当表只有 1 行时，测试聚合函数（非 PQS 测试方法特有属性）</span></span><br><span class="line">      <span class="attr">Partially</span> <span class="string">test aggregate functions when all tables contain only a single </span></span><br><span class="line">      <span class="attr">row.</span> <span class="string"></span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">false</span></span><br><span class="line">    <span class="attr">--print-progress-information</span></span><br><span class="line"><span class="comment">      # 打印进度（生成的数据库数 / 执行的查询数），用于监控测试进度</span></span><br><span class="line">      <span class="attr">Whether</span> <span class="string">to print progress information such as the number of databases </span></span><br><span class="line">      <span class="attr">generated</span> <span class="string">or queries issued</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">true</span></span><br><span class="line">    <span class="attr">--print-progress-summary</span></span><br><span class="line"><span class="comment">      # 退出时打印执行汇总（总查询数 / 错误数等），测试结束后统计结果</span></span><br><span class="line">      <span class="attr">Whether</span> <span class="string">to print an execution summary when exiting SQLancer</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">true</span></span><br><span class="line">    <span class="attr">--random-seed</span></span><br><span class="line"><span class="comment">      # 随机种子，设为非 -1 值（如 12345）可复现测试过程（确定性生成）</span></span><br><span class="line">      <span class="attr">A</span> <span class="string">seed value != -1 that can be set to make the query and database </span></span><br><span class="line">      <span class="attr">generation</span> <span class="string">deterministic</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">-1</span></span><br><span class="line">    <span class="attr">--random-string-generation</span></span><br><span class="line"><span class="comment">      # 随机字符串生成策略，NUMERIC（纯数字）、ALPHANUMERIC（字母数字）、ALPHANUMERIC_SPECIALCHAR（含特殊字符）、SOPHISTICATED（复杂混合）</span></span><br><span class="line">      <span class="attr">Select</span> <span class="string">the random-string eneration approach</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">SOPHISTICATED</span></span><br><span class="line">      <span class="attr">Possible</span> <span class="string">Values: [NUMERIC, ALPHANUMERIC, ALPHANUMERIC_SPECIALCHAR, SOPHISTICATED]</span></span><br><span class="line">    <span class="attr">--serialize-reproduce-state</span></span><br><span class="line"><span class="comment">      # 序列化测试状态，用于测出 BUG 后复现问题</span></span><br><span class="line">      <span class="attr">Serialize</span> <span class="string">the state to reproduce</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">false</span></span><br><span class="line">    <span class="attr">--storage-unit-host</span></span><br><span class="line"><span class="comment">      # ShardingSphere 存储单元数据库服务器地址</span></span><br><span class="line">      <span class="attr">Storage</span> <span class="string">unit host for ShardingSphere</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">127.0.0.1</span></span><br><span class="line">    <span class="attr">--storage-unit-password</span></span><br><span class="line"><span class="comment">      # ShardingSphere 存储单元密码</span></span><br><span class="line">      <span class="attr">Storage</span> <span class="string">unit password for ShardingSphere</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">123456</span></span><br><span class="line">    <span class="attr">--storage-unit-port</span></span><br><span class="line"><span class="comment">      # ShardingSphere 存储单元端口</span></span><br><span class="line">      <span class="attr">Storage</span> <span class="string">unit port for ShardingSphere</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">3306</span></span><br><span class="line">    <span class="attr">--storage-unit-username</span></span><br><span class="line"><span class="comment">      # ShardingSphere 存储单元用户名</span></span><br><span class="line">      <span class="attr">Storage</span> <span class="string">unit username for ShardingSphere</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">root</span></span><br><span class="line">    <span class="attr">--string-constant-max-length</span></span><br><span class="line"><span class="comment">      # 生成字符串常量的最大长度，增大值（如 50）可测试长字符串场景</span></span><br><span class="line">      <span class="attr">Specify</span> <span class="string">the maximum-length of generated string constants</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">10</span></span><br><span class="line">    <span class="attr">--username</span></span><br><span class="line"><span class="comment">      # 数据库用户名</span></span><br><span class="line">      <span class="attr">The</span> <span class="string">user name used to log into the DBMS</span></span><br><span class="line">      <span class="attr">Default</span>: <span class="string">sqlancer</span></span><br><span class="line">  <span class="attr">Commands</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">mysql</span>      <span class="string">MySQL (default port: 3306, default host: localhost)</span></span><br><span class="line">      <span class="attr">Usage</span>: <span class="string">mysql [options]</span></span><br><span class="line">        <span class="attr">Options</span>:<span class="string"></span></span><br><span class="line"><span class="comment">          # 指定 MySQL 测试使用的测试预言机，默认值 为 TLP_WHERE</span></span><br><span class="line">          <span class="attr">--oracle</span></span><br><span class="line">            <span class="attr">Default</span>: <span class="string">[TLP_WHERE]</span></span><br></pre></td></tr></table></figure><p>由于 ShardingSphere 有逻辑库和存储单元（物理库）的概念，因此需要对 SQLancer 进行一些改造，才能测试 ShardingSphere 联邦查询。从上面的属性可以看出，我们新增了 <code>storage-unit-host</code>、<code>storage-unit-port</code>、<code>storage-unit-username</code> 和 <code>storage-unit-password</code> 属性，用于指定 ShardingSphere 存储单元的连接信息。而 SQLancer 原有的属性 <code>host</code>、<code>port</code>、<code>username</code>、<code>password</code>，则用于连接 ShardingSphere Proxy 接入端。</p><p>当 SQLancer 工具创建测试库时，不仅会在 Proxy 接入端创建逻辑库，还会额外通过 DistSQL 注册物理存储单元，然后再进行建表、生成数据和 SQL 测试等操作。我们执行如下的命令测试 ShardingSphere 联邦查询，<code>--storage-unit-*</code> 属性用于指定存储单元的连接信息，<code>--num-threads</code> 用来指定测试线程数，<code>--num-tries</code> 则用于控制发现多少个错误则终止测试。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java -jar sqlancer-*.jar \</span><br><span class="line">  --port 3307 \</span><br><span class="line">  --username root \</span><br><span class="line">  --password root \</span><br><span class="line">  --storage-unit-port 3306 \</span><br><span class="line">  --storage-unit-username root \</span><br><span class="line">  --storage-unit-password 123456 \</span><br><span class="line">  --num-threads 1 \</span><br><span class="line">  --num-tries 1000 \</span><br><span class="line">  mysql \</span><br><span class="line">  --oracle tlp_where</span><br></pre></td></tr></table></figure><p>ShardingSphere 商业联邦查询的配置可以参考<a target="_blank" rel="noopener" href="https://docs.sphere-ex.com/sphereex-dbplussuite/master/zh/docs/plugin-guide/sql-federation/#%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B">联邦查询-配置示例</a>文档，首先在 Proxy 端执行以下的 DistSQL 开启联邦查询，<code>ALL_QUERY_USE_SQL_FEDERATION</code> 设置为 <code>true</code>，保证所有的 DML SQL 使用联邦查询引擎执行。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> SQL_FEDERATION RULE (</span><br><span class="line">    SQL_FEDERATION_ENABLED<span class="operator">=</span><span class="literal">true</span>,</span><br><span class="line">    ALL_QUERY_USE_SQL_FEDERATION<span class="operator">=</span><span class="literal">true</span>,</span><br><span class="line">    EXECUTION_PLAN_CACHE(INITIAL_CAPACITY<span class="operator">=</span><span class="number">2000</span>, MAXIMUM_SIZE<span class="operator">=</span><span class="number">65535</span>, TTL_MILLI_SECONDS<span class="operator">=</span><span class="number">86400000</span>),</span><br><span class="line">    MAX_USAGE_MEMORY_PER_QUERY<span class="operator">=</span><span class="string">&#x27;10M&#x27;</span>,</span><br><span class="line">    SPILL_ENABLED<span class="operator">=</span><span class="literal">true</span>,</span><br><span class="line">    SPILL_PATH<span class="operator">=</span>&quot;file:///tmp/dbplusengine/spill&quot;,</span><br><span class="line">    SPILL_COMPRESSION_ENABLED<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>然后我们再开启统计信息收集功能，支持 SQLancer 对库、表、列等信息的查询，确保 SQLancer 测试逻辑能够正常运行。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> STATISTICS_STORAGE RULE (</span><br><span class="line">    NAME_PREFIX<span class="operator">=</span>sphereex,</span><br><span class="line">    STORAGE UNIT (</span><br><span class="line">        URL <span class="operator">=</span> &quot;jdbc:mysql://127.0.0.1:3306?serverTimezone=UTC&amp;useSSL=false&amp;allowPublicKeyRetrieval=true&quot;,</span><br><span class="line">        <span class="keyword">USER</span> <span class="operator">=</span> &quot;root&quot;,</span><br><span class="line">        PASSWORD <span class="operator">=</span> &quot;123456&quot;,</span><br><span class="line">        PROPERTIES(&quot;minPoolSize&quot;<span class="operator">=</span><span class="number">1</span>, &quot;maxPoolSize&quot;<span class="operator">=</span><span class="number">2</span>)</span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>开启统计信息收集，需要在 MySQL 中执行 Grant 语句给 <code>STATISTICS_STORAGE Rule</code> 中的账号赋权（如下数据库账号按照实际情况修改）。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">CREATE</span>, <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span>, <span class="keyword">DROP</span> <span class="keyword">ON</span> sphereex_information_schema.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">CREATE</span>, <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span>, <span class="keyword">DROP</span> <span class="keyword">ON</span> sphereex_shardingsphere.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure><p>再执行 DistSQL 设置统计信息收集间隔，并开启统计信息收集功能。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> DIST VARIABLE proxy_meta_data_collector_cron <span class="operator">=</span> <span class="string">&#x27;0 0/30 * * * ?&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> DIST VARIABLE proxy_meta_data_collector_enabled <span class="operator">=</span> <span class="string">&#x27;true&#x27;</span>;</span><br></pre></td></tr></table></figure><p>首次开启统计信息功能，我们可以主动执行 <code>REFRESH STATISTICS METADATA;</code> 更新统计信息。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REFRESH STATISTICS METADATA;</span><br></pre></td></tr></table></figure><p>配置完联邦查询功能，并开启统计信息收集后，我们可以执行前面的 SQLancer 命令，来测试下 ShardingSphere 联邦查询功能，很快我们就测试出了第一个联邦查询不支持的 Case——<code>IS UNKNOWN</code> 语法（异常 Case 会输出到 <code>target/logs/mysql</code> 目录下）。</p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/blog/use-sqlancer-to-test-shardingsphere-sql-federation/use-sqlancer-to-test-shardingsphere-sql-federation.png" title="使用 SQLancer 测试 ShardingSphere 联邦查询"><p>SQLancer 提供的报错信息很全面，不仅包含了异常堆栈信息，还提供了复现这个异常所需的 SQL 操作步骤，我们依次执行 SQL 语句，就可以快速复现异常。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">java.lang.AssertionError: <span class="keyword">SELECT</span> <span class="keyword">ALL</span> t2.c1 <span class="keyword">AS</span> ref0 <span class="keyword">FROM</span> t2 <span class="keyword">WHERE</span> <span class="keyword">NULL</span> <span class="keyword">UNION</span> <span class="keyword">ALL</span> <span class="keyword">SELECT</span> t2.c1 <span class="keyword">AS</span> ref0 <span class="keyword">FROM</span> t2 <span class="keyword">WHERE</span> (<span class="keyword">NOT</span> (<span class="keyword">NULL</span>)) <span class="keyword">UNION</span> <span class="keyword">ALL</span> <span class="keyword">SELECT</span> t2.c1 <span class="keyword">AS</span> ref0 <span class="keyword">FROM</span> t2 <span class="keyword">WHERE</span> (<span class="keyword">NULL</span>) <span class="keyword">IS</span> <span class="literal">UNKNOWN</span>;</span><br><span class="line">        <span class="keyword">at</span> sqlancer.common.query.SQLQueryAdapter.checkException(SQLQueryAdapter.java:<span class="number">166</span>)</span><br><span class="line">        <span class="keyword">at</span> sqlancer.common.query.SQLQueryAdapter.internalExecuteAndGet(SQLQueryAdapter.java:<span class="number">207</span>)</span><br><span class="line">        <span class="keyword">at</span> sqlancer.common.query.SQLQueryAdapter.executeAndGet(SQLQueryAdapter.java:<span class="number">177</span>)</span><br><span class="line">        <span class="keyword">at</span> sqlancer.common.query.SQLQueryAdapter.executeAndGet(SQLQueryAdapter.java:<span class="number">172</span>)</span><br><span class="line">        <span class="keyword">at</span> sqlancer.ComparatorHelper.getResultSetFirstColumnAsString(ComparatorHelper.java:<span class="number">56</span>)</span><br><span class="line">        <span class="keyword">at</span> sqlancer.ComparatorHelper.getCombinedResultSet(ComparatorHelper.java:<span class="number">151</span>)</span><br><span class="line">        <span class="keyword">at</span> sqlancer.common.oracle.TLPWhereOracle.check(TLPWhereOracle.java:<span class="number">110</span>)</span><br><span class="line">        <span class="keyword">at</span> sqlancer.ProviderAdapter.generateAndTestDatabase(ProviderAdapter.java:<span class="number">61</span>)</span><br><span class="line">        <span class="keyword">at</span> sqlancer.Main$DBMSExecutor.run(Main.java:<span class="number">467</span>)</span><br><span class="line">        <span class="keyword">at</span> sqlancer.Main$<span class="number">2.</span>run(Main.java:<span class="number">684</span>)</span><br><span class="line">        <span class="keyword">at</span> sqlancer.Main$<span class="number">2.</span>runThread(Main.java:<span class="number">666</span>)</span><br><span class="line">        <span class="keyword">at</span> sqlancer.Main$<span class="number">2.</span>run(Main.java:<span class="number">657</span>)</span><br><span class="line">        <span class="keyword">at</span> java.base<span class="operator">/</span>java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1136</span>)</span><br><span class="line">        <span class="keyword">at</span> java.base<span class="operator">/</span>java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">635</span>)</span><br><span class="line">        <span class="keyword">at</span> java.base<span class="operator">/</span>java.lang.Thread.run(Thread.java:<span class="number">840</span>)</span><br><span class="line">Caused <span class="keyword">by</span>: java.sql.SQLSyntaxErrorException: Unsupported <span class="keyword">SQL</span> operator: `<span class="keyword">IS</span>`</span><br><span class="line">        <span class="keyword">at</span> com.mysql.cj.jdbc.exceptions.SQLError.createSQLException(SQLError.java:<span class="number">120</span>)</span><br><span class="line">        <span class="keyword">at</span> com.mysql.cj.jdbc.exceptions.SQLExceptionsMapping.translateException(SQLExceptionsMapping.java:<span class="number">122</span>)</span><br><span class="line">        <span class="keyword">at</span> com.mysql.cj.jdbc.StatementImpl.executeQuery(StatementImpl.java:<span class="number">1200</span>)</span><br><span class="line">        <span class="keyword">at</span> sqlancer.common.query.SQLQueryAdapter.internalExecuteAndGet(SQLQueryAdapter.java:<span class="number">196</span>)</span><br><span class="line">        ... <span class="number">13</span> more</span><br><span class="line"><span class="comment">--java.lang.AssertionError: SELECT ALL t2.c1 AS ref0 FROM t2 WHERE NULL UNION ALL SELECT t2.c1 AS ref0 FROM t2 WHERE (NOT (NULL)) UNION ALL SELECT t2.c1 AS ref0 FROM t2 WHERE (NULL) IS UNKNOWN;</span></span><br><span class="line"><span class="comment">--      at sqlancer.common.query.SQLQueryAdapter.checkException(SQLQueryAdapter.java:166)</span></span><br><span class="line"><span class="comment">--      at sqlancer.common.query.SQLQueryAdapter.internalExecuteAndGet(SQLQueryAdapter.java:207)</span></span><br><span class="line"><span class="comment">--      at sqlancer.common.query.SQLQueryAdapter.executeAndGet(SQLQueryAdapter.java:177)</span></span><br><span class="line"><span class="comment">--      at sqlancer.common.query.SQLQueryAdapter.executeAndGet(SQLQueryAdapter.java:172)</span></span><br><span class="line"><span class="comment">--      at sqlancer.ComparatorHelper.getResultSetFirstColumnAsString(ComparatorHelper.java:56)</span></span><br><span class="line"><span class="comment">--      at sqlancer.ComparatorHelper.getCombinedResultSet(ComparatorHelper.java:151)</span></span><br><span class="line"><span class="comment">--      at sqlancer.common.oracle.TLPWhereOracle.check(TLPWhereOracle.java:110)</span></span><br><span class="line"><span class="comment">--      at sqlancer.ProviderAdapter.generateAndTestDatabase(ProviderAdapter.java:61)</span></span><br><span class="line"><span class="comment">--      at sqlancer.Main$DBMSExecutor.run(Main.java:467)</span></span><br><span class="line"><span class="comment">--      at sqlancer.Main$2.run(Main.java:684)</span></span><br><span class="line"><span class="comment">--      at sqlancer.Main$2.runThread(Main.java:666)</span></span><br><span class="line"><span class="comment">--      at sqlancer.Main$2.run(Main.java:657)</span></span><br><span class="line"><span class="comment">--      at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)</span></span><br><span class="line"><span class="comment">--      at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)</span></span><br><span class="line"><span class="comment">--      at java.base/java.lang.Thread.run(Thread.java:840)</span></span><br><span class="line"><span class="comment">--Caused by: java.sql.SQLSyntaxErrorException: Unsupported SQL operator: `IS`</span></span><br><span class="line"><span class="comment">--      at com.mysql.cj.jdbc.exceptions.SQLError.createSQLException(SQLError.java:120)</span></span><br><span class="line"><span class="comment">--      at com.mysql.cj.jdbc.exceptions.SQLExceptionsMapping.translateException(SQLExceptionsMapping.java:122)</span></span><br><span class="line"><span class="comment">--      at com.mysql.cj.jdbc.StatementImpl.executeQuery(StatementImpl.java:1200)</span></span><br><span class="line"><span class="comment">--      at sqlancer.common.query.SQLQueryAdapter.internalExecuteAndGet(SQLQueryAdapter.java:196)</span></span><br><span class="line"><span class="comment">--      ... 13 more</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- Time: 2025/12/28 20:31:14</span></span><br><span class="line"><span class="comment">-- Database: database0</span></span><br><span class="line"><span class="comment">-- Database version: 5.7.22-DBPlusEngine-Proxy 5.5.3-SNAPSHOT-82e26ad</span></span><br><span class="line"><span class="comment">-- seed value: 1766925060265</span></span><br><span class="line"><span class="keyword">DROP</span> DATABASE IF <span class="keyword">EXISTS</span> database0;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE database0;</span><br><span class="line">USE database0;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> t0(c0 <span class="type">VARCHAR</span>(<span class="number">500</span>)  COMMENT <span class="string">&#x27;asdf&#x27;</span>  <span class="keyword">NULL</span> COLUMN_FORMAT <span class="keyword">DEFAULT</span>, c1 <span class="type">DECIMAL</span>  STORAGE MEMORY) ;</span><br><span class="line"><span class="keyword">INSERT INTO</span> t0(c0) <span class="keyword">VALUES</span>(<span class="number">0.5415928422036966</span>);</span><br><span class="line"><span class="keyword">UPDATE</span> t0 <span class="keyword">SET</span> c1<span class="operator">=</span><span class="number">0.6302674886178765</span>, c0<span class="operator">=</span>&quot;0.6302674886178765&quot;;</span><br><span class="line"><span class="keyword">INSERT</span> DELAYED <span class="keyword">INTO</span> t0(c1, c0) <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>, <span class="string">&#x27;h&#123;|Ij#k&#125;&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> t0(c1) <span class="keyword">VALUES</span>(<span class="number">0.3379070670876593</span>);</span><br><span class="line"><span class="keyword">UPDATE</span> t0 <span class="keyword">SET</span> c1<span class="operator">=</span><span class="number">-947955752</span> <span class="keyword">WHERE</span> <span class="built_in">CAST</span>(<span class="string">&#x27; *Y&#x27;</span> <span class="keyword">AS</span> SIGNED);</span><br><span class="line"><span class="keyword">UPDATE</span> t0 <span class="keyword">SET</span> c1<span class="operator">=</span>(<span class="keyword">NOT</span> ( <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">wHERE</span> <span class="literal">FALSE</span>))), c0<span class="operator">=</span>t0.c0;</span><br><span class="line"><span class="keyword">INSERT INTO</span> t0(c1) <span class="keyword">VALUES</span>(&quot;(g&quot;);</span><br><span class="line"><span class="keyword">INSERT</span> IGNORE <span class="keyword">INTO</span> t0(c1) <span class="keyword">VALUES</span>(&quot;9&quot;);</span><br><span class="line"><span class="keyword">DELETE</span> IGNORE <span class="keyword">FROM</span> t0;</span><br><span class="line"><span class="keyword">INSERT</span> IGNORE <span class="keyword">INTO</span> t0(c1) <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>), (<span class="keyword">NULL</span>), (<span class="number">0.2584659624758967</span>), (<span class="keyword">NULL</span>), (&quot;i|&amp;&quot;);</span><br><span class="line"><span class="keyword">DELETE</span> IGNORE <span class="keyword">FROM</span> t0;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> t0 DELAY_KEY_WRITE <span class="number">0</span>, COMPRESSION <span class="string">&#x27;ZLIB&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"><span class="keyword">INSERT</span> HIGH_PRIORITY IGNORE <span class="keyword">INTO</span> t0(c1) <span class="keyword">VALUES</span>(<span class="number">1634001425</span>);</span><br><span class="line"><span class="keyword">INSERT</span> LOW_PRIORITY <span class="keyword">INTO</span> t0(c0) <span class="keyword">VALUES</span>(&quot;&quot;);</span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"><span class="keyword">UPDATE</span> t0 <span class="keyword">SET</span> c0<span class="operator">=</span><span class="number">-1148055694</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> t0 <span class="keyword">SET</span> c0<span class="operator">=</span><span class="number">17125872</span>;</span><br><span class="line"><span class="keyword">INSERT</span> IGNORE <span class="keyword">INTO</span> t0(c1, c0) <span class="keyword">VALUES</span>(<span class="number">0.3283236604697395</span>, <span class="keyword">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> t0(c1) <span class="keyword">VALUES</span>(<span class="number">0.048050841555574375</span>);</span><br><span class="line"><span class="keyword">ALTER TABLE</span> t0 <span class="keyword">DROP</span> c0, FORCE, CHECKSUM <span class="number">1</span>;</span><br><span class="line"><span class="keyword">INSERT</span> LOW_PRIORITY <span class="keyword">INTO</span> t0(c1) <span class="keyword">VALUES</span>(<span class="number">0.07787208116702882</span>);</span><br><span class="line"><span class="keyword">DELETE</span> LOW_PRIORITY QUICK IGNORE <span class="keyword">FROM</span> t0;</span><br><span class="line"><span class="keyword">INSERT</span> IGNORE <span class="keyword">INTO</span> t0(c1) <span class="keyword">VALUES</span>(<span class="number">829218842</span>);</span><br><span class="line"><span class="keyword">INSERT</span> LOW_PRIORITY <span class="keyword">INTO</span> t0(c1) <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> IGNORE <span class="keyword">INTO</span> t0(c1) <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> t0(c1) <span class="keyword">VALUES</span>(<span class="number">0.02242428818878528</span>);</span><br><span class="line"><span class="keyword">DELETE</span> QUICK IGNORE <span class="keyword">FROM</span> t0;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> t0 INSERT_METHOD <span class="keyword">FIRST</span>, PACK_KEYS <span class="number">1</span>, DISABLE KEYS, COMPRESSION <span class="string">&#x27;NONE&#x27;</span>, ROW_FORMAT FIXED, CHECKSUM <span class="number">0</span>, STATS_PERSISTENT <span class="keyword">DEFAULT</span>, FORCE, RENAME <span class="keyword">AS</span> t0, DELAY_KEY_WRITE <span class="number">0</span>, ALGORITHM <span class="keyword">DEFAULT</span>, STATS_AUTO_RECALC <span class="keyword">DEFAULT</span>;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> t0 ENABLE KEYS, ALGORITHM INPLACE, STATS_PERSISTENT <span class="number">0</span>, CHECKSUM <span class="number">0</span>, PACK_KEYS <span class="number">0</span>, INSERT_METHOD <span class="keyword">LAST</span>;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> t0 FORCE, ROW_FORMAT REDUNDANT, INSERT_METHOD <span class="keyword">NO</span>, STATS_AUTO_RECALC <span class="keyword">DEFAULT</span>, PACK_KEYS <span class="number">0</span>, ENABLE KEYS, STATS_PERSISTENT <span class="number">1</span>, RENAME <span class="keyword">AS</span> t0, ALGORITHM <span class="keyword">DEFAULT</span>;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> t0 PACK_KEYS <span class="number">0</span>, STATS_PERSISTENT <span class="keyword">DEFAULT</span>, ENABLE KEYS, ALGORITHM <span class="keyword">COPY</span>, ROW_FORMAT <span class="keyword">DYNAMIC</span>, RENAME t2, CHECKSUM <span class="number">0</span>, COMPRESSION <span class="string">&#x27;NONE&#x27;</span>, STATS_AUTO_RECALC <span class="number">1</span>, DELAY_KEY_WRITE <span class="number">0</span>, INSERT_METHOD <span class="keyword">NO</span>, FORCE;</span><br><span class="line"><span class="keyword">INSERT</span> HIGH_PRIORITY IGNORE <span class="keyword">INTO</span> t2(c1) <span class="keyword">VALUES</span>(<span class="number">-1656112204</span>);</span><br><span class="line"><span class="keyword">UPDATE</span> t2 <span class="keyword">SET</span> c1<span class="operator">=</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">wHERE</span> <span class="literal">FALSE</span>);</span><br><span class="line"><span class="keyword">INSERT</span> DELAYED IGNORE <span class="keyword">INTO</span> t2(c1) <span class="keyword">VALUES</span>(<span class="string">&#x27;1e500&#x27;</span>);</span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"><span class="keyword">INSERT</span> HIGH_PRIORITY IGNORE <span class="keyword">INTO</span> t2(c1) <span class="keyword">VALUES</span>(<span class="number">0.9546301382857064</span>);</span><br></pre></td></tr></table></figure><p>另外，我们还可以根据 <code>seed value: 1766925060265</code> 来控制 SQLancer 生成的 Case，使用相同的种子值（通过参数 <code>--random-seed 1766925060265</code> 控制），可以生成相同的测试 Case，这样我们就可以稳定复现异常。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">java -jar sqlancer-*.jar \</span><br><span class="line">  --port 3307 \</span><br><span class="line">  --username root \</span><br><span class="line">  --password root \</span><br><span class="line">  --storage-unit-port 3306 \</span><br><span class="line">  --storage-unit-username root \</span><br><span class="line">  --storage-unit-password 123456 \</span><br><span class="line">  --random-seed 1766925060265 \</span><br><span class="line">  --num-threads 1 \</span><br><span class="line">  --num-tries 1000 \</span><br><span class="line">  mysql \</span><br><span class="line">  --oracle tlp_where</span><br></pre></td></tr></table></figure><p>SQLancer 测试工具功能强大，目前已经测试出一批 ShardingSphere 联邦查询不支持的 Case，由于篇幅限制，本文就不一一介绍了，笔者会根据这些异常信息，逐个进行分析和修复，不断提升 ShardingSphere 联邦查询的 SQL 支持度。大家如果有 SQL 引擎的测试需求，不妨也尝试下 SQLancer，相信它一定能够发现更多潜在的问题，帮助大家提升 SQL 引擎的稳定性。由于笔者也是初次探索和使用 SQLancer，如果文章有错误之处，或者其他 SQLancer 使用技巧，欢迎大家留言指导。</p><div class="tag-plugin quot"><p class="content" type="text"><span class="empty"></span><span class="text">欢迎关注</span><span class="empty"></span></p></div><p>欢迎关注「<strong>端小强的博客</strong>」微信公众号，会不定期分享日常学习和工作经验，欢迎大家关注交流。</p><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/wechat/gongzhonghao.png" alt="微信公众号"></p><div class="article-footer fs14"><section id="references"><div class="header"><span>参考资料</span></div><div class="body"><ul><li class="post-title"><p><a target="_blank" rel="noopener" href="https://github.com/sqlancer/sqlancer">SQLancer 官方文档</a></p></li><li class="post-title"><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Np46NQ6lqP8">Finding Logic Bugs in Database Management Systems (Manuel Rigger, ETH SQLancer)</a></p></li><li class="post-title"><p><a target="_blank" rel="noopener" href="https://techcommunity.microsoft.com/blog/adforpostgresql/mining-for-logic-bugs-in-the-citus-extension-to-postgres-with-sqlancer/1634393">Mining for logic bugs in the Citus extension to Postgres with SQLancer</a></p></li><li class="post-title"><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/144725800">数据库进阶测试三部曲 - 从 PQS 到 NoREC 再到 TLP</a></p></li></ul></div></section><section id="license"><div class="header"><span>许可协议</span></div><div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh">署名-非商业性使用-禁止演绎 4.0 国际</a> 许可协议，未经授权请勿转载。</p></div></section><section id="share"><div class="header"><span>分享文章</span></div><div class="body"><div class="link"><input class="copy-area" readonly id="copy-link" value="https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation.html"></div><div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot;)"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg"></a><a class="social share-item weibo" target="_blank" rel="external nofollow noopener noreferrer" href="https://service.weibo.com/share/share.php?url=https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation.html&title=使用 SQLancer 测试 ShardingSphere 联邦查询 - 端小强的博客&pics=/assets/blog/blog/sqlancer-logo.png&summary= 前言
在上一篇文章 ShardingSphere 联邦查询 GROUPING 聚合结果问题分析中，我们详细介绍了联邦查询引擎实现 GROUPING 聚合函数存在的问题，当时笔者曾提到 SQLancer 测试工具，它能够通过一些科学的..."><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/80c07e4dbb303.svg"></a><a class="social share-item email" href="mailto:?subject=使用 SQLancer 测试 ShardingSphere 联邦查询 - 端小强的博客&amp;body=https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation.html"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/a1b00e20f425d.svg"></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;复制成功&quot;)"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg"></a></div><div class="qrcode" id="qrcode-wechat" style="opacity:0;height:0"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=https://strongduanmu.com/blog/use-sqlancer-to-test-shardingsphere-sql-federation.html"></div></div></section></div></article><div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/blog/speed-up-by-100x-shardingsphere-sql-federation-in-predicate-deep-optimization-practice.html">百倍提速！ShardingSphere 联邦查询批量 IN 查询深度优化</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/blog/analyze-wrong-result-for-shardingsphere-sql-federation-grouping-function.html">ShardingSphere 联邦查询 GROUPING 聚合结果问题分析</a></div></section></div><div class="related-wrap md-text" id="comments"><section class="header cmt-title cap theme"><p>快来参与讨论吧~</p></section><section class="body cmt-body giscus"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg><div id="giscus" src="https://giscus.app/client.js" data-repo="strongduanmu/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkzNzQwMDk3Njg=" data-category="Announcements" data-category-id="DIC_kwDOFkrvqM4CZIsa" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div></section></div><footer class="page-footer footnote"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs15">博客</span><a href="/categories/">分类</a><a href="/tags/">标签</a><a href="/archives/">归档</a></div><div class="sitemap-group"><span class="fs15">文档</span><a href="/wiki/calcite/background.html">Calcite</a><a href="/wiki/cmu_15_445/index.html">CMU 15-445</a><a href="/wiki/cmu_15_721/index.html">CMU 15-721</a></div><div class="sitemap-group"><span class="fs15">便笺</span><a href="/notes/">Common</a><a href="/notes/docker.html">Docker</a><a href="/notes/git.html">Git</a></div><div class="sitemap-group"><span class="fs15">更多</span><a href="/more/">关于</a><a href="/more/news/">动态</a></div></div><div class="text"><p>本站由 <a target="_blank" rel="noopener" href="https://github.com/strongduanmu">@strongduanmu</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> 主题创建，使用 <a target="_blank" rel="noopener" href="https://vercel.com/">Vercel</a> 网站部署。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。<br>本站总访问量 <span id="vercount_value_site_pv"></span> 次，本站访客数 <span id="vercount_value_site_uv"></span> 人次。</p></div></footer><div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right"><div class="widgets"><widget class="widget-wrapper tagcloud"><div class="widget-header dis-select"><span class="name">标签云</span></div><div class="widget-body fs14"><a href="/tags/Antlr/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">Antlr</a> <a href="/tags/Calcite/" style="font-size:20px;color:#6f86d6" class="tag -10">Calcite</a> <a href="/tags/CentOS/" style="font-size:12px;color:#48c6ef" class="tag -0">CentOS</a> <a href="/tags/Charles/" style="font-size:12px;color:#48c6ef" class="tag -0">Charles</a> <a href="/tags/Distributed-Transaction/" style="font-size:12px;color:#48c6ef" class="tag -0">Distributed Transaction</a> <a href="/tags/Docker/" style="font-size:12px;color:#48c6ef" class="tag -0">Docker</a> <a href="/tags/FFmpeg/" style="font-size:12px;color:#48c6ef" class="tag -0">FFmpeg</a> <a href="/tags/GraalVM/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">GraalVM</a> <a href="/tags/In-Action/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">In Action</a> <a href="/tags/JVM/" style="font-size:17.33px;color:#629bde" class="tag -7">JVM</a> <a href="/tags/Java/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">Java</a> <a href="/tags/Java8/" style="font-size:12px;color:#48c6ef" class="tag -0">Java8</a> <a href="/tags/JavaCC/" style="font-size:12px;color:#48c6ef" class="tag -0">JavaCC</a> <a href="/tags/Kernel/" style="font-size:14.67px;color:#55b1e7" class="tag -3">Kernel</a> <a href="/tags/Linux/" style="font-size:12px;color:#48c6ef" class="tag -0">Linux</a> <a href="/tags/MySQL/" style="font-size:16px;color:#5ca6e3" class="tag -5">MySQL</a> <a href="/tags/Paper/" style="font-size:12px;color:#48c6ef" class="tag -0">Paper</a> <a href="/tags/PolarDB-X/" style="font-size:12px;color:#48c6ef" class="tag -0">PolarDB-X</a> <a href="/tags/Query-Optimization/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">Query Optimization</a> <a href="/tags/Remote-Debugging/" style="font-size:13.33px;color:#4fbbeb" class="tag -2">Remote Debugging</a> <a href="/tags/SQLLine/" style="font-size:12px;color:#48c6ef" class="tag -0">SQLLine</a> <a href="/tags/SQLancer/" style="font-size:12px;color:#48c6ef" class="tag -0">SQLancer</a> <a href="/tags/ShardingSphere/" style="font-size:18.67px;color:#6991da" class="tag -8">ShardingSphere</a> <a href="/tags/Transaction/" style="font-size:12px;color:#48c6ef" class="tag -0">Transaction</a> <a href="/tags/VirtualBox/" style="font-size:12px;color:#48c6ef" class="tag -0">VirtualBox</a> <a href="/tags/Wireshark/" style="font-size:12px;color:#48c6ef" class="tag -0">Wireshark</a></div></widget><widget class="widget-wrapper markdown"><div class="widget-header dis-select"><span class="name">赞助商</span></div><div class="widget-body fs14"><p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9880881761323734" data-ad-slot="1987141063" data-ad-format="auto" data-full-width-responsive="true"></ins></p><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></widget></div></aside><div class="float-panel blur"><button type="button" style="display:none" class="laptop-only rightbar-toggle mobile" onclick="sidebar.rightbar()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></button> <button type="button" style="display:none" class="mobile-only leftbar-toggle mobile" onclick="sidebar.leftbar()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg></button></div></div><div class="scripts"><script>let ctx={date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前"},root:"/",tag_plugins:{chat:Object.assign({api:"https://siteinfo.listentothewind.cn/api/v1"})},search:{}};if((ctx.search.service="local_search")==ctx.search.service){let e=Object.assign({},'{"field":"all","path":"/search.json","content":true,"skip_search":null,"codeblock":true,"sort":"-date"}');ctx.search[ctx.search.service]=e}let def={avatar:"/assets/placeholder/avatar.svg",cover:"/assets/placeholder/cover.svg"},deps={jquery:"https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js",marked:"https://cdn.jsdelivr.net/npm/marked@13.0.1/lib/marked.umd.min.js"}</script><script>function RunItem(){function n(e,t){this.name=t||e.name,this.run=()=>{try{e()}catch(e){console.log(e)}}}this.list=[],this.start=()=>{for(var e=0;e<this.list.length;e++)this.list[e].run()},this.push=(e,t,r=!0)=>{let s=e,i=new n(s=r?()=>{utils.requestAnimationFrame(e)}:s,t);this.list.push(i)},this.remove=t=>{for(let e=0;e<this.list.length;e++)this.list[e].name==t&&this.list.splice(e,1)}}let utils={css:(e,t,r,s)=>{var i,n,a=window.document,o=a.createElement("link"),d=(n=t||(i=(a.body||a.getElementsByTagName("head")[0]).childNodes)[i.length-1],a.styleSheets);if(s)for(var l in s)s.hasOwnProperty(l)&&o.setAttribute(l,s[l]);o.rel="stylesheet",o.href=e,o.media="only x",function e(t){if(a.body)return t();setTimeout(function(){e(t)})}(function(){n.parentNode.insertBefore(o,t?n:n.nextSibling)});function u(e){for(var t=o.href,r=d.length;r--;)if(d[r].href===t)return e();setTimeout(function(){u(e)})}function h(){o.addEventListener&&o.removeEventListener("load",h),o.media=r||"all"}return o.addEventListener&&o.addEventListener("load",h),o.onloadcssdefined=u,u(h),o},js:(i,n)=>new Promise((t,e)=>{var r=document.createElement("script");if(i.startsWith("/")&&(i=ctx.root+i.substring(1)),r.src=i,n)for(var s of Object.keys(n))r[s]=n[s];else r.async=!0;r.onerror=e,r.onload=r.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(r.onload=r.onreadystatechange=null,t())},document.head.appendChild(r)}),jq:e=>{"undefined"==typeof jQuery?utils.js(deps.jquery).then(e):e()},onLoading:e=>{e&&$(e).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>')},onLoadSuccess:e=>{e&&$(e).find(".loading-wrap").remove()},onLoadFailure:e=>{e&&($(e).find(".loading-wrap svg").remove(),$(e).find(".loading-wrap").append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>'),$(e).find(".loading-wrap").addClass("error"))},request:(n,a,o,d)=>{let l=3;utils.onLoading(n),function i(){new Promise((t,e)=>{let r=0,s=setTimeout(()=>{0===r&&(r=2,s=null,e("请求超时"),0==l)&&d()},5e3);fetch(a).then(function(e){if(2!==r&&(clearTimeout(s),t(e),s=null,r=1),e.ok)return e.json();throw new Error("Network response was not ok.")}).then(function(e){l=0,utils.onLoadSuccess(n),o(e)}).catch(function(e){0<l?(--l,setTimeout(()=>{i()},5e3)):(utils.onLoadFailure(n),d())})})}()},requestAnimationFrame:e=>{window.requestAnimationFrame||(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame),window.requestAnimationFrame(e)},dark:{}};utils.dark.method={toggle:new RunItem},utils.dark=Object.assign(utils.dark,{push:utils.dark.method.toggle.push})</script><script>let sidebar={leftbar:()=>{l_body&&(l_body.toggleAttribute("leftbar"),l_body.removeAttribute("rightbar"))},rightbar:()=>{l_body&&(l_body.toggleAttribute("rightbar"),l_body.removeAttribute("leftbar"))},dismiss:()=>{l_body&&(l_body.removeAttribute("leftbar"),l_body.removeAttribute("rightbar"))},toggleTOC:()=>{document.querySelector("#data-toc").classList.toggle("collapse")}}</script><script>(()=>{var e;for(e of document.querySelectorAll(".tag-subtree.parent-tag > a > .tag-switcher-wrapper"))e.addEventListener("click",e=>{e.target.closest(".tag-subtree.parent-tag").classList.toggle("expanded"),e.preventDefault()});var t=new URLSearchParams(window.location.search).get("tag");if(t){let e=document.querySelector(`.tag-subtree[data-tag="${t}"]`);if(e)for(e.querySelector("a").classList.add("active");e;)e.classList.add("expanded"),e=e.parentElement.closest(".tag-subtree.parent-tag")}})()</script><script src="/js/main.js?v=1.30.1" defer></script><script>let applyTheme=e=>{"auto"===e?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme",e),applyThemeToGiscus(e)},applyThemeToGiscus=e=>{e="auto"===e?"preferred_color_scheme":e;var t=document.getElementById("giscus"),t=(t&&t.setAttribute("data-theme",e),document.querySelector("#comments > section.giscus > iframe"));t&&(e=t.src.replace(/theme=[\w]+/,"theme="+e),t.src=e)},switchTheme=()=>{let e;switch(document.documentElement.getAttribute("data-theme")){case"light":e="dark";break;case"dark":e="auto";break;default:e="light"}applyTheme(e),window.localStorage.setItem("Stellar.theme",e),utils.dark.mode="auto"===e?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e,utils.dark.method.toggle.start(),hud?.toast?.({light:"切换到浅色模式",dark:"切换到深色模式",auto:"切换到跟随系统配色"}[e])};(()=>{var e=window.localStorage.getItem("Stellar.theme");null!==e?applyTheme(e):utils.dark.mode=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",utils.dark.method.toggle.start()})()</script><script type="module">const el = document.querySelector('#comments #giscus');
  util.viewportLazyload(el, load_discus, false);

  function load_discus() {
    if (!el) return;
    try {
        el.innerHTML = '';
      } catch (error) {
        console.error(error);
      }
      const script = document.createElement('script');
      script.async = true;
      for (const key of Object.keys(el.attributes)) {
        const attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
  }</script><script defer>window.addEventListener("DOMContentLoaded",e=>{ctx.services=Object.assign({},JSON.parse('{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"}}'));for(let s of Object.keys(ctx.services)){let e=ctx.services[s].js;"siteinfo"==s?(ctx.cardlinks=document.querySelectorAll("a.link-card[cardlink]"),0<ctx.cardlinks?.length&&utils.js(e,{defer:!0}).then(function(){setCardLink(ctx.cardlinks)})):"voice"==s?(ctx.voiceAudios=document.querySelectorAll(".voice>audio"),0<ctx.voiceAudios?.length&&utils.js(e,{defer:!0}).then(function(){createVoiceDom(ctx.voiceAudios)})):"video"==s?(ctx.videos=document.querySelectorAll(".video>video"),0<ctx.videos?.length&&utils.js(e,{defer:!0}).then(function(){videoEvents(ctx.videos)})):"download-file"==s?(ctx.files=document.querySelectorAll(".file"),0<ctx.files?.length&&utils.js(e,{defer:!0}).then(function(){downloadFileEvent(ctx.files)})):0<document.getElementsByClassName("ds-"+s)?.length&&utils.jq(()=>{s,utils.js(deps.marked).then(function(){utils.js(e,{defer:!0})})})}let n=document.querySelectorAll(".chat .status-bar .time");var s,t;function i(){for(let e=0;e<n.length;++e){var s=n[e],t=new Date,i=t.getHours(),t=t.getMinutes();s.innerHTML=o(i)+":"+o(t)}}function o(e){return e<10?"0"+e:e}0<n.length&&(i(),s=(new Date).getSeconds(),t=setInterval(function(){i(),clearInterval(t),setInterval(i,6e4)},1e3*(60-s)));let c=new IntersectionObserver((e,t)=>{e.filter(e=>e.isIntersecting).sort((e,s)=>e.intersectionRect.y!==s.intersectionRect.y?e.intersectionRect.y-s.intersectionRect.y:e.intersectionRect.x-s.intersectionRect.x).forEach((e,s)=>{t.unobserve(e.target),setTimeout(()=>{e.target.classList.add("quote-blink"),setTimeout(()=>{e.target.classList.remove("quote-blink")},1e3)},Math.max(100,16)*(s+1))})}),r=document.querySelectorAll(".chat .talk .quote");r.forEach(i=>{i.addEventListener("click",function(){var e,s,t=document.getElementById("quote-"+i.getAttribute("quotedCellTag"));t&&(s=(e=t.parentElement).clientHeight/2,t.offsetTop>s-t.clientHeight/2?e.scrollTo({top:t.offsetTop-s+t.clientHeight/2,behavior:"smooth"}):e.scrollTo({top:0,behavior:"smooth"}),c.observe(t))})})})</script><script>window.addEventListener("DOMContentLoaded",e=>{ctx.search={path:"/search.json"},utils.js("/js/search/local-search.js",{defer:!0})})</script><script>window.FPConfig={delay:0,ignoreKeywords:[],maxRPS:5,hoverDelay:25}</script><script defer src="/js/flying-pages.min.js"></script><script defer src="/js/lazyload.min.js"></script><script>window.lazyLoadOptions={elements_selector:".lazy"},window.addEventListener("LazyLoad::Initialized",function(n){window.lazyLoadInstance=n.detail.instance},!1),document.addEventListener("DOMContentLoaded",function(){window.lazyLoadInstance?.update()})</script><script>ctx.fancybox={selector:"article.md-text img:not(.post-cover img):not(.cover img):not(.card-link img):not(.image-bg img):not(.social img):not(.preview img)",css:"/css/fancybox.min.css",js:"/js/fancybox.umd.min.js"};var selector="[data-fancybox]:not(.error)",needFancybox=(ctx.fancybox.selector&&(selector+=", "+ctx.fancybox.selector),0!==document.querySelectorAll(selector).length);if(!needFancybox){let e=document.getElementsByClassName("ds-memos");null!=e&&0<e.length&&(needFancybox=!0)}needFancybox&&(utils.css(ctx.fancybox.css),utils.js(ctx.fancybox.js,{defer:!0}).then(function(){Fancybox.bind(selector,{hideScrollbar:!1,Thumbs:{autoStart:!1},caption:(e,t)=>t.triggerEl.alt||t.triggerEl.dataset.caption||null})}))</script><script>window.addEventListener("DOMContentLoaded",e=>{let i=document.getElementById("swiper-api");null!=i&&(utils.css("/css/swiper-bundle.min.css"),utils.js("/js/swiper-bundle.min.js",{defer:!0}).then(function(){var e=i.getAttribute("effect")||"";new Swiper(".swiper#swiper-api",{slidesPerView:"auto",spaceBetween:8,centeredSlides:!0,effect:e,rewind:!0,pagination:{el:".swiper-pagination",clickable:!0},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"}})}))})</script><script>document.addEventListener("DOMContentLoaded",function(){window.codeElements=document.querySelectorAll(".code"),0<window.codeElements.length&&(ctx.copycode={default_text:"复制代码",success_text:"复制成功",toast:"复制成功"},utils.js("/js/plugins/copycode.js"))})</script><script async>((a,t,c)=>{t.ChatraID="PHWnu7Bamcwtbnx2d";var h=a.createElement("script");t[c]=t[c]||function(){(t[c].q=t[c].q||[]).push(arguments)},h.async=!0,h.src="https://call.chatra.io/chatra.js",a.head&&a.head.appendChild(h)})(document,window,"Chatra")</script><script defer src="https://cn.vercount.one/js"></script><link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"></noscript><script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous" onload="renderMathInElement(document.body)"></script><script>window.va=window.va||function(){(window.vaq=window.vaq||[]).push(arguments)}</script><script defer src="/_vercel/insights/script.js"></script><script>window.si=window.si||function(){(window.siq=window.siq||[]).push(arguments)}</script><script defer src="/_vercel/speed-insights/script.js"></script><script>function change_banner(){$(".banner img.bg").attr("src","/assets/banner/banner_"+Math.floor(20*Math.random()+1)+".jpg")}setTimeout("change_banner()",250)</script><script>function add_page_pv(){$("#post-meta").after('<div class="flex-row" id="post-meta"><span class="text created">本文总阅读量 <span id="vercount_value_page_pv"></span> 次</span></div>')}setTimeout("add_page_pv()",500)</script><script>function change_img_alt(){$("article.md-text img:not(.post-cover img):not(.cover img):not(.card-link img):not(.image-bg img):not(.social img):not(.preview img)").each(function(t){$(this).after("<div class='image-meta' style='text-align:center;'><span class='image-caption center' style='display:inline-block;font-size:.8125rem;color:var(--text-p2);line-height:1.5;text-align:justify;'>"+($(this).attr("title")||$(this).attr("alt"))+"</span></div>")})}setTimeout("change_img_alt()",1e3)</script></div></body></html>