<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.30.1" theme-name="Stellar" theme-version="1.30.1"><meta name="generator" content="Hexo 7.3.0"><meta http-equiv="x-dns-prefetch-control" content="on"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="theme-color" content="#f9fafb"><title>Calcite：适配器 - 端小强的博客</title><meta name="description" content="原文链接：https:&#x2F;&#x2F;calcite.apache.org&#x2F;docs&#x2F;adapter.html   模式适配器 模式适配器允许 Calcite 读取特定类型的数据，并将这些数据显示为模式中的表。  Cassandra 适配器（calcite-cassandra）； CSV 适配器（示例&#x2F;csv）； Druid 适配器（calcite-druid）； Elasticsearch 适配器（cal"><meta property="og:type" content="website"><meta property="og:title" content="适配器"><meta property="og:url" content="https://strongduanmu.com/wiki/calcite/adapters.html"><meta property="og:site_name" content="端小强的博客"><meta property="og:description" content="原文链接：https:&#x2F;&#x2F;calcite.apache.org&#x2F;docs&#x2F;adapter.html   模式适配器 模式适配器允许 Calcite 读取特定类型的数据，并将这些数据显示为模式中的表。  Cassandra 适配器（calcite-cassandra）； CSV 适配器（示例&#x2F;csv）； Druid 适配器（calcite-druid）； Elasticsearch 适配器（cal"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://strongduanmu.com/assets/blog/blog/202309210909027.png"><meta property="article:published_time" content="2021-12-12T03:15:27.000Z"><meta property="article:modified_time" content="2021-12-12T03:15:27.000Z"><meta property="article:author" content="端小强"><meta property="article:tag" content="ShardingSphere"><meta property="article:tag" content="Calcite"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://strongduanmu.com/assets/blog/blog/202309210909027.png"><meta name="twitter:creator" content="@strongduanmu"><meta name="keywords" content="ShardingSphere,Calcite"><link rel="alternate" href="/atom.xml" title="端小强的博客" type="application/atom+xml"><link rel="stylesheet" href="/css/main.css?v=1.30.1"><link rel="shortcut icon" href="/assets/placeholder/favicon.ico"><meta name="baidu-site-verification" content="codeva-sIRwgTpHve"><link rel="apple-touch-icon" sizes="180x180" href="/assets/placeholder/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/placeholder/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/placeholder/favicon-16x16.png"><link rel="manifest" href="/assets/placeholder/site.webmanifest"><link rel="stylesheet" href="/css/custom.css" media="all" onload='this.media="all"'><link rel="stylesheet" href="/css/lxgwwenkaimono-bold.css" media="all" onload='this.media="all"'><link rel="stylesheet" href="/css/lxgwwenkaiscreen.css" media="all" onload='this.media="all"'></head><body><div class="l_body content tech" id="start" layout="wiki"><aside class="l_left"><div class="leftbar-container"><header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="/assets/blog/2021/07/01/1625102427.jpg" onerror="javascript:this.classList.add('error');this.src='/assets/placeholder/image.svg';"></div><a class="title" href="/wiki/calcite/background.html"><div class="main" ff="title">Calcite</div><div class="sub normal cap">最流行的 Java 优化器框架</div><div class="sub hover cap" style="opacity:0">学习数据库内核的绝佳案例</div></a></div></header><div class="nav-area"><div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" data-filter="/wiki/calcite/" placeholder="在 Calcite 中搜索..."></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div><nav class="menu dis-select"><a class="nav-item" title="博客" href="/"><span>博客</span></a><a class="nav-item active" title="文档" href="/wiki/"><span>文档</span></a><a class="nav-item" title="便笺" href="/notes/"><span>便笺</span></a><a class="nav-item" title="更多" href="/more/"><span>更多</span></a></nav></div><div class="widgets"><widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">概述</span></div><div class="widget-body fs14"><a class="link" href="/wiki/calcite/background.html#start"><span class="toc-text">背景</span></a><a class="link" href="/wiki/calcite/tutorial.html"><span class="toc-text">教程</span></a><a class="link" href="/wiki/calcite/algebra.html"><span class="toc-text">代数</span></a></div><div class="widget-header dis-select"><span class="name">高级主题</span></div><div class="widget-body fs14"><a class="link active" href="/wiki/calcite/adapters.html"><span class="toc-text">适配器</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a><a class="link" href="/wiki/calcite/spatial.html"><span class="toc-text">空间</span></a><a class="link" href="/wiki/calcite/stream.html"><span class="toc-text">流式查询</span></a><a class="link" href="/wiki/calcite/materialized-views.html"><span class="toc-text">物化视图</span></a><a class="link" href="/wiki/calcite/lattice.html"><span class="toc-text">Lattice 格</span></a></div><div class="widget-header dis-select"><span class="name">参考指南</span></div><div class="widget-body fs14"><a class="link" href="/wiki/calcite/reference.html"><span class="toc-text">参考指南</span></a><a class="link" href="/wiki/calcite/model.html"><span class="toc-text">JSON/YAML 模型</span></a><a class="link" href="/wiki/calcite/howto.html"><span class="toc-text">如何参与</span></a><a class="link" href="/wiki/calcite/develop.html"><span class="toc-text">开发 Calcite</span></a></div></widget></div><footer class="footer dis-select"><div class="social-wrap"><a class="social" href="mailto:duanzhengqiang@apache.org" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/email.svg"></a><a class="social" href="https://github.com/strongduanmu" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/github.svg"></a><a class="social" href="/sitemap.xml" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/sitemap.svg"></a><a class="social" href="/atom.xml" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/rss.svg"></a></div></footer></div></aside><div class="l_main" id="main"><div class="article banner top"><img class="bg lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/banner/banner_5.jpg"><div class="content"><div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a> <span class="sep"></span><a class="cap breadcrumb" id="menu" href="/wiki">文档</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/wiki/calcite/background.html">Calcite</a></div><div class="flex-row" id="post-meta"><span class="text created">更新于：<time datetime="2021-12-12T03:15:27.000Z">2021-12-12</time></span></div></div></div><div class="bottom only-title"><div class="text-area"><h1 class="text title"><span>适配器</span></h1></div></div></div></div><article class="md-text content"><blockquote><p>原文链接：<a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/adapter.html">https://calcite.apache.org/docs/adapter.html</a></p></blockquote><h2 id="模式适配器"><a class="markdownIt-Anchor" href="#模式适配器"></a> 模式适配器</h2><p>模式适配器允许 <code>Calcite</code> 读取特定类型的数据，并将这些数据显示为模式中的表。</p><ul><li><a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/cassandra_adapter.html">Cassandra 适配器</a>（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/cassandra/package-summary.html">calcite-cassandra</a>）；</li><li>CSV 适配器（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/csv/package-summary.html">示例/csv</a>）；</li><li><a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/druid_adapter.html">Druid 适配器</a>（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/druid/package-summary.html">calcite-druid</a>）；</li><li><a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/elasticsearch_adapter.html">Elasticsearch 适配器</a>（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/elasticsearch/package-summary.html">calcite-elasticsearch</a>）；</li><li><a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/file_adapter.html">文件适配器</a>（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/file/package-summary.html">calcite-file</a>）；</li><li><a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/geode_adapter.html">Geode 适配器</a>（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/geode/package-summary.html">calcite-geode</a>）；</li><li><a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/innodb_adapter.html">InnoDB 适配器</a>（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/innodb/package-summary.html">calcite-innodb</a>）；</li><li>JDBC 适配器（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/jdbc/package-summary.html">calcite-core</a> 的一部分）；</li><li>MongoDB 适配器（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/mongodb/package-summary.html">calcite-mongodb</a>）；</li><li><a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/os_adapter.html">操作系统适配器</a>（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/os/package-summary.html">calcite-os</a>）；</li><li><a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/pig_adapter.html">Pig 适配器</a>（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/pig/package-summary.html">calcite-pig</a>）；</li><li><a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/redis_adapter.html">Redis 适配器</a>（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/redis/package-summary.html">calcite-redis</a>）；</li><li>Solr cloud 适配器（<a target="_blank" rel="noopener" href="https://github.com/bluejoe2008/solr-sql">solr-sql</a>）；</li><li>Spark 适配器（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/spark/package-summary.html">calcite-spark</a>）；</li><li>Splunk 适配器（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/splunk/package-summary.html">calcite-splunk</a>）；</li><li>Eclipse 内存分析器 (MAT) 适配器（<a target="_blank" rel="noopener" href="https://github.com/vlsi/mat-calcite-plugin">mat-calcite-plugin</a>）；</li><li><a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/kafka_adapter.html">Apache Kafka 适配器</a>。</li></ul><h3 id="其他语言接口"><a class="markdownIt-Anchor" href="#其他语言接口"></a> 其他语言接口</h3><ul><li>Piglet（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/piglet/package-summary.html">calcite-piglet</a>）在 <a target="_blank" rel="noopener" href="https://pig.apache.org/docs/latest/basic.html">Pig Latin</a> 的子集中运行查询；</li></ul><h2 id="引擎"><a class="markdownIt-Anchor" href="#引擎"></a> 引擎</h2><p>许多项目和产品使用 <code>Apache Calcite</code> 进行 <code>SQL 解析</code>、<code>查询优化</code>、<code>数据虚拟化/联邦查询</code> 和 <code>物化视图重写</code>。他们中的一些列在了 <a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/powered_by.html">由 Calcite 提供支持</a> 页面上。</p><h2 id="驱动"><a class="markdownIt-Anchor" href="#驱动"></a> 驱动</h2><p>驱动允许你从应用程序连接到 Calcite。</p><ul><li><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/jdbc/package-summary.html">JDBC 驱动程序</a>；</li></ul><p>JDBC 驱动由 <a target="_blank" rel="noopener" href="https://calcite.apache.org/avatica/docs/">Avatica</a> 提供支持。连接可以是本地连接或远程连接（基于 HTTP 协议传输的 <code>JSON</code> 或 <code>Protobuf</code>）。</p><p>JDBC 连接字符串的基本格式如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:calcite:property=value;property2=value2</span><br></pre></td></tr></table></figure><p>其中 <code>property</code>，<code>property2</code> 是下面描述的这些属性。连接字符串遵循 <code>OLE DB</code> 连接字符串语法，由 Avatica 的 <a target="_blank" rel="noopener" href="https://calcite.apache.org/avatica/javadocAggregate/org/apache/calcite/avatica/ConnectStringParser.html">ConnectStringParser</a> 实现。</p><h2 id="jdbc-连接字符串参数"><a class="markdownIt-Anchor" href="#jdbc-连接字符串参数"></a> JDBC 连接字符串参数</h2><table><thead><tr><th style="text-align:left">属性</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#APPROXIMATE_DECIMAL">approximateDecimal</a></td><td style="text-align:left">是否可以接受 <code>DECIMAL</code> 类型聚合函数返回近似结果。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#APPROXIMATE_DISTINCT_COUNT">approximateDistinctCount</a></td><td style="text-align:left">是否可以接受 <code>COUNT(DISTINCT ...)</code> 聚合函数返回近似结果。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#APPROXIMATE_TOP_N">approximateTopN</a></td><td style="text-align:left">是否可以接受 Top N 查询（<code>ORDER BY aggFun() DESC LIMIT n</code>）返回近似结果。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#CASE_SENSITIVE">caseSensitive</a></td><td style="text-align:left">标识符匹配是否区分大小写。如果未指定，将会使用 <code>lex</code> 中的值。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#CONFORMANCE">conformance</a></td><td style="text-align:left">SQL 一致性级别。包含如下值：<code>DEFAULT</code>（默认值，类似于 <code>PRAGMATIC_2003</code>）、<code>LENIENT</code>、<code>MYSQL_5</code>、<code>ORACLE_10</code>、<code>ORACLE_12</code>、<code>PRAGMATIC_99</code>、<code>PRAGMATIC_2003</code>、<code>STRICT_92</code>、<code>STRICT_99</code>、<code>STRICT_2003</code>、<code>SQL_SERVER_2008</code>。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#CREATE_MATERIALIZATIONS">createMaterializations</a></td><td style="text-align:left">Calcite 是否应该创建物化视图。默认为 false。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#DEFAULT_NULL_COLLATION">defaultNullCollation</a></td><td style="text-align:left">如果查询中既未指定 <code>NULLS FIRST</code> 也未指定 <code>NULLS LAST</code>，应该如何对 <code>NULL</code> 值进行排序。默认值为 HIGH，对 NULL 值的排序与 Oracle 相同。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#DRUID_FETCH">druidFetch</a></td><td style="text-align:left">执行 SELECT 查询时，Druid 适配器应当一次获取多少行记录。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#FORCE_DECORRELATE">forceDecorrelate</a></td><td style="text-align:left">优化器是否应该尽可能地尝试去除相关子查询。默认为 true。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#FUN">fun</a></td><td style="text-align:left">内置函数和运算符的集合。有效值为 <code>standard</code>（默认值）、<code>oracle</code>、<code>spatial</code>，并且可以使用逗号组合，例如 <code>oracle,spatial</code>。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#LEX">lex</a></td><td style="text-align:left">词法分析策略。有效值为 <code>BIG_QUERY</code>、<code>JAVA</code>、<code>MYSQL</code>、<code>MYSQL_ANSI</code>、<code>ORACLE</code>（默认）、<code>SQL_SERVER</code>。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#MATERIALIZATIONS_ENABLED">materializationsEnabled</a></td><td style="text-align:left">Calcite 是否应该使用物化视图。默认为 false。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#MODEL">model</a></td><td style="text-align:left">JSON/YAML 模型文件的 URI 或内联的 JSON（例如：<code>inline:&#123;...&#125;</code>） 、内联的 YAML（例如： <code>inline:...</code>）。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#PARSER_FACTORY">parserFactory</a></td><td style="text-align:left">解析器工厂。实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/sql/parser/SqlParserImplFactory.html"><code>interface SqlParserImplFactory</code></a> 并具有公共默认构造函数或 <code>INSTANCE</code> 常量的类的名称。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#QUOTING">quoting</a></td><td style="text-align:left">如何引用标识符。值为 DOUBLE_QUOTE、BACK_TICK、BACK_TICK_BACKSLASH、BRACKET。如果未指定，则使用 <code>lex</code> 中的值。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#QUOTED_CASING">quotedCasing</a></td><td style="text-align:left">如果标识符被引用，设置如何存储标识符。值为 UNCHANGED、TO_UPPER、TO_LOWER。如果未指定，则使用 <code>lex</code> 中的值。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#SCHEMA">schema</a></td><td style="text-align:left">初始模式的名称。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#SCHEMA_FACTORY">schemaFactory</a></td><td style="text-align:left">模式工厂。实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/schema/SchemaFactory.html"><code>interface SchemaFactory</code></a> 并具有公共默认构造函数或 <code>INSTANCE</code> 常量的类的名称。如果指定了 <code>model</code> 则忽略该参数。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#SCHEMA_TYPE">schemaType</a></td><td style="text-align:left">模式类型。值必须是 <code>MAP</code>（默认值）、<code>JDBC</code> 或 <code>CUSTOM</code>（如果指定了 <code>schemaFactory</code> 则隐式设置为 CUSTOM）。如果指定了 <code>model</code> 则忽略该参数。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#SPARK">spark</a></td><td style="text-align:left">指定是否应使用 Spark 作为引擎来处理无法推送到源系统的处理。如果为 false（默认值），Calcite 会生成实现 Enumerable 接口的代码。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#TIME_ZONE">timeZone</a></td><td style="text-align:left">时区，例如 <code>gmt-3</code>。默认是 JVM 的时区。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#TYPE_SYSTEM">typeSystem</a></td><td style="text-align:left">类型系统。实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/type/RelDataTypeSystem.html"><code>interface RelDataTypeSystem</code></a> 并具有公共默认构造函数或 <code>INSTANCE</code> 常量的类的名称。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#UNQUOTED_CASING">unquotedCasing</a></td><td style="text-align:left">如果标识符未加引号，设置如何存储标识符。值为 <code>UNCHANGED</code>、<code>TO_UPPER</code>、<code>TO_LOWER</code>。如果未指定，则使用 <code>lex</code> 中的值。</td></tr><tr><td style="text-align:left"><a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#TYPE_COERCION">typeCoercion</a></td><td style="text-align:left">sql 节点校验时，如果类型不匹配是否进行隐式类型强转，默认为 true。</td></tr></tbody></table><p>要基于内置模式类型连接到单个模式，你不需要指定 model 参数。例如，通过映射到 foodmart 数据库的 JDBC 模式适配器创建一个模式，并使用这个模式创建一个数据库连接。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:calcite:schemaType=JDBC; schema.jdbcUser=SCOTT; schema.jdbcPassword=TIGER; schema.jdbcUrl=jdbc:hsqldb:res:foodmart</span><br></pre></td></tr></table></figure><p>同样，你可以基于用户定义的模式适配器连接到单个模式。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:calcite:schemaFactory=org.apache.calcite.adapter.cassandra.CassandraSchemaFactory; schema.host=localhost; schema.keyspace=twissandra</span><br></pre></td></tr></table></figure><p>与 Cassandra 适配器建立连接，可以通过编写如下的模型文件实现：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;defaultSchema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foodmart&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;schemas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      type<span class="punctuation">:</span> &#x27;custom&#x27;<span class="punctuation">,</span></span><br><span class="line">      name<span class="punctuation">:</span> &#x27;twissandra&#x27;<span class="punctuation">,</span></span><br><span class="line">      factory<span class="punctuation">:</span> &#x27;org.apache.calcite.adapter.cassandra.CassandraSchemaFactory&#x27;<span class="punctuation">,</span></span><br><span class="line">      operand<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        host<span class="punctuation">:</span> &#x27;localhost&#x27;<span class="punctuation">,</span></span><br><span class="line">        keyspace<span class="punctuation">:</span> &#x27;twissandra&#x27;</span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>请注意 <code>operand</code> 部分中的每个键，在连接字符串中使用都需要加上 <code>schema.</code> 前缀。</p><h2 id="服务器"><a class="markdownIt-Anchor" href="#服务器"></a> 服务器</h2><p>Calcite 的核心模块 (<code>calcite-core</code>) 支持 SQL 查询 (<code>SELECT</code>) 和 DML 操作 (<code>INSERT</code>， <code>UPDATE</code>， <code>DELETE</code>， <code>MERGE</code>)，但不支持 <code>CREATE SCHEMA</code> 或 <code>CREATE TABLE</code> 等 DDL 操作。正如我们将看到的，DDL 使元数据库中的状态模型变得复杂，并使解析器更难以扩展，因此我们将 DDL 排除在核心之外。</p><p>服务器模块 (<code>calcite-server</code>) 为 Calcite 添加了 DDL 支持。它扩展了 SQL 解析器，<a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/adapter.html#extending-the-parser">使用与子项目相同的机制</a>，添加了一些 DDL 命令：</p><ul><li><code>CREATE</code> 和 <code>DROP SCHEMA</code>；</li><li><code>CREATE</code> 和 <code>DROP FOREIGN SCHEMA</code>；</li><li><code>CREATE</code> 和 <code>DROP TABLE</code>（包括 <code>CREATE TABLE ... AS SELECT</code>）；</li><li><code>CREATE</code> 和 <code>DROP MATERIALIZED VIEW</code>；</li><li><code>CREATE</code> 和 <code>DROP VIEW</code>；</li><li><code>CREATE</code> 和 <code>DROP FUNCTION</code>；</li><li><code>CREATE</code> 和 <code>DROP TYPE</code>。</li></ul><p><a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/reference.html#ddl-extensions">SQL 参考</a>中描述了这些命令。</p><p>要启用 Calite 服务器模块，请将 <code>calcite-server.jar</code> 包含在你的类路径中，并添加 <code>parserFactory=org.apache.calcite.sql.parser.ddl.SqlDdlParserImpl#FACTORY</code> 到 JDBC 连接字符串（请参阅连接字符串属性 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/config/CalciteConnectionProperty.html#PARSER_FACTORY">parserFactory</a>）。下面是一个使用 <code>sqlline</code> shell 的示例。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ .<span class="operator">/</span>sqlline</span><br><span class="line">sqlline version <span class="number">1.3</span><span class="number">.0</span></span><br><span class="line"><span class="operator">&gt;</span> <span class="operator">!</span><span class="keyword">connect</span> jdbc:calcite:parserFactory<span class="operator">=</span>org.apache.calcite.sql.parser.ddl.SqlDdlParserImpl#FACTORY sa &quot;&quot;</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">CREATE TABLE</span> t (i <span class="type">INTEGER</span>, j <span class="type">VARCHAR</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.293</span> seconds)</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">INSERT INTO</span> t <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>), (<span class="number">2</span>, <span class="string">&#x27;bc&#x27;</span>);</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> affected (<span class="number">0.873</span> seconds)</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v <span class="keyword">AS</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> i <span class="operator">&gt;</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.072</span> seconds)</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> v;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span>       EXPR$<span class="number">0</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.148</span> seconds)</span><br><span class="line"><span class="operator">&gt;</span> <span class="operator">!</span>quit</span><br></pre></td></tr></table></figure><p><code>calcite-server</code> 模块是可选的。它的目标之一是使用可以从 SQL 命令行尝试的简单示例，来展示 Calcite 的功能（例如物化视图、外部表和自动生成列）。 <code>calcite-server</code> 使用的所有功能都可以通过 <code>calcite-core</code> 中的 API 获得。</p><p>如果你是子项目的作者，你的语法扩展不太可能与 <code>calcite-server</code> 中的语法扩展匹配，因此我们建议你通过<a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/adapter.html#extending-the-parser">扩展核心解析器来</a>添加 SQL 语法扩展。如果你需要 DDL 命令，你可以将 <code>calcite-server</code> 复制粘贴到你的项目中。</p><p>目前，元数据库尚未持久化。当你执行 DDL 命令时，你正在通过添加和删除可从根 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/schema/Schema.html"><code>Schema</code></a> 访问的对象，来修改内存元数据库。同一 SQL 会话中的所有命令都将看到这些对象。你可以通过执行相同的 SQL 命令脚本在将来的会话中创建相同的对象。</p><p>Calcite 还可以充当数据虚拟化或联邦查询的服务器：Calcite 管理多个外部模式中的数据，但对于客户端而言，这些数据似乎都在同一个地方。Calcite 选择应在何处进行处理，以及是否创建数据副本以提高效率。<code>calcite-server</code> 模块是朝着这一目标迈出的一步；行业级解决方案需要进一步打包（使 Calcite 作为服务运行）、元数据库持久性、授权和安全性。</p><h2 id="可扩展性"><a class="markdownIt-Anchor" href="#可扩展性"></a> 可扩展性</h2><p>还有许多其他 API 允许你扩展 Calcite 的功能。</p><p>在本节中，我们将简要描述这些 API，让你了解可能发生的情况。要充分使用这些 API，你需要阅读其他文档，例如接口的 javadoc，并可能查找我们为它们编写的测试。</p><h3 id="函数和运算符"><a class="markdownIt-Anchor" href="#函数和运算符"></a> 函数和运算符</h3><p>有多种方法可以向 Calcite 添加运算符或函数。我们将首先描述最简单的（也是最不强大的）。</p><p>用户定义的函数是最简单的（但功能最弱）。它们编写起来很简单（你只需编写一个 Java 类并将其注册到你的模式中），但在参数的数量和类型、解析重载函数或派生的返回类型方面没有提供太多灵活性。</p><p>如果你想要这种灵活性，你可能需要编写一个用户定义的运算符（请参考 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/sql/SqlOperator.html"><code>interface SqlOperator</code></a> ）。</p><p>如果你的运算符不遵守标准 SQL 函数语法 <code>f(arg1, arg2, ...)</code>，那么你需要去 <a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/adapter.html#extending-the-parser">扩展解析器</a>。</p><p>测试中有很多好的例子：<a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/master/core/src/test/java/org/apache/calcite/test/UdfTest.java"><code>class UdfTest</code></a> 测试了用户定义函数和用户定义聚合函数。</p><h3 id="聚合函数"><a class="markdownIt-Anchor" href="#聚合函数"></a> 聚合函数</h3><p>用户定义的聚合函数与用户定义的函数类似，但每个函数都有几个相应的 Java 方法，用于聚合生命周期中的每个阶段：</p><ul><li><code>init</code> 创建一个累加器；</li><li><code>add</code> 将一行的值添加到累加器中；</li><li><code>merge</code> 将两个累加器合二为一；</li><li><code>result</code> 完成累加器并将其转换为结果。</li></ul><p>举个例子，<code>SUM(int)</code> 的方法（伪代码）如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">struct Accumulator &#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">int</span> sum;</span><br><span class="line">&#125;</span><br><span class="line">Accumulator <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Accumulator</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">Accumulator <span class="title function_">add</span><span class="params">(Accumulator a, <span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Accumulator</span>(a.sum + x);</span><br><span class="line">&#125;</span><br><span class="line">Accumulator <span class="title function_">merge</span><span class="params">(Accumulator a, Accumulator a2)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Accumulator</span>(a.sum + a2.sum);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">result</span><span class="params">(Accumulator a)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a.sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以下是计算列值为 4 和 7 的两行之和的调用序列：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = init()    # a = &#123;<span class="number">0</span>&#125;</span><br><span class="line">a = add(a, <span class="number">4</span>) # a = &#123;<span class="number">4</span>&#125;</span><br><span class="line">a = add(a, <span class="number">7</span>) # a = &#123;<span class="number">11</span>&#125;</span><br><span class="line"><span class="keyword">return</span> result(a) # returns <span class="number">11</span></span><br></pre></td></tr></table></figure><h3 id="窗口函数"><a class="markdownIt-Anchor" href="#窗口函数"></a> 窗口函数</h3><p>窗口函数类似于聚合函数，但它应用于由 <code>OVER</code> 子句而不是 <code>GROUP BY</code> 子句收集的一组行。每个聚合函数都可以用作窗口函数，但存在一些关键区别。窗口函数看到的行可能是有序的，并且依赖于顺序的窗口函数（例如 <code>RANK</code> ）不能用作聚合函数。</p><p>另一个区别是窗口可以是相交的（<code>non-disjoint</code>）：特定行可以出现在多个窗口中。例如，<code>10:37</code> 既可以出现在 <code>9:00-10:00</code> 时间段，也可以出现在 <code>9:15-9:45</code> 时间段。</p><p>窗口函数是动态计算的：当时钟从 <code>10:14</code> 跳转到 <code>10:15</code> 时，可能有两行进入窗口，而三行离开。为此，窗口函数有一个额外的生命周期操作：</p><ul><li><code>remove</code> 从累加器中删除一个值。</li></ul><p>它的伪代码 <code>SUM(int)</code> 是：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Accumulator <span class="title function_">remove</span><span class="params">(Accumulator a, <span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Accumulator</span>(a.sum - x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以下是计算前 2 行动态求和（<code>SUM</code>）的调用顺序，其中 4 行的数值为 4、7、2 和 3：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a = init()       # a = &#123;<span class="number">0</span>&#125;</span><br><span class="line">a = add(a, <span class="number">4</span>)    # a = &#123;<span class="number">4</span>&#125;</span><br><span class="line">emit <span class="title function_">result</span><span class="params">(a)</span>   # emits <span class="number">4</span></span><br><span class="line">a = add(a, <span class="number">7</span>)    # a = &#123;<span class="number">11</span>&#125;</span><br><span class="line">emit <span class="title function_">result</span><span class="params">(a)</span>   # emits <span class="number">11</span></span><br><span class="line">a = remove(a, <span class="number">4</span>) # a = &#123;<span class="number">7</span>&#125;</span><br><span class="line">a = add(a, <span class="number">2</span>)    # a = &#123;<span class="number">9</span>&#125;</span><br><span class="line">emit <span class="title function_">result</span><span class="params">(a)</span>   # emits <span class="number">9</span></span><br><span class="line">a = remove(a, <span class="number">7</span>) # a = &#123;<span class="number">2</span>&#125;</span><br><span class="line">a = add(a, <span class="number">3</span>)    # a = &#123;<span class="number">5</span>&#125;</span><br><span class="line">emit <span class="title function_">result</span><span class="params">(a)</span>   # emits <span class="number">5</span></span><br></pre></td></tr></table></figure><h3 id="分组窗口函数"><a class="markdownIt-Anchor" href="#分组窗口函数"></a> 分组窗口函数</h3><p>分组窗口函数是操作 <code>GROUP BY</code> 子句并将记录聚集成集合的函数。内置的分组窗口函数是 <code>HOP</code>、<code>TUMBLE</code> 和 <code>SESSION</code>。你可以通过实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/sql/SqlGroupedWindowFunction.html"><code>interface SqlGroupedWindowFunction</code></a> 来定义其他函数。</p><h3 id="表函数和表宏"><a class="markdownIt-Anchor" href="#表函数和表宏"></a> 表函数和表宏</h3><p>用户自定义表函数的定义方式，与常用的<strong>标量</strong>用户自定义函数类似，但在查询的 <code>FROM</code> 子句中使用。以下查询使用名为 <code>Ramp</code> 的表函数：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(Ramp(<span class="number">3</span>, <span class="number">4</span>))</span><br></pre></td></tr></table></figure><p>用户自定义表宏使用与表函数相同的 SQL 语法，但定义不同。它们不是生成数据，而是生成关系表达式。在查询准备期间调用表宏，然后可以优化它们生成的关系表达式。（Calcite 的视图实现使用表宏）</p><p><a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/master/core/src/test/java/org/apache/calcite/test/TableFunctionTest.java"><code>class TableFunctionTest</code></a> 测试了表函数并包含几个有用的示例。</p><h3 id="扩展解析器"><a class="markdownIt-Anchor" href="#扩展解析器"></a> 扩展解析器</h3><p>假设你需要在保持语法兼容的情况下，扩展 Calcite 的 SQL 语法。在你的项目中复制 <code>Parser.jj</code> 语法文件将是愚蠢的，因为语法经常被编辑。</p><p>幸运的是，<code>Parser.jj</code> 实际上是一个 <a target="_blank" rel="noopener" href="https://freemarker.apache.org/">Apache FreeMarker</a> 模板，其中包含可以替换的变量。<code>calcite-core</code> 中的解析器使用变量的默认值（通常为空）实例化模板，但你也可以覆盖这些变量。如果你的项目需要不同的解析器，你可以提供自己的 <code>config.fmpp</code> 和 <code>parserImpls.ftl</code> 文件，从而生成扩展解析器。</p><p><code>calcite-server</code> 模块是在 <a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/CALCITE-707">CALCITE-707</a> 中创建的，并添加了 DDL 语句，例如 <code>CREATE TABLE</code>，是你可以参考的示例。另外可以参考 <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/master/core/src/test/java/org/apache/calcite/sql/parser/parserextensiontesting/ExtensionSqlParserTest.java"><code>class ExtensionSqlParserTest</code></a>。</p><h3 id="自定义接受和生成的-sql-方言"><a class="markdownIt-Anchor" href="#自定义接受和生成的-sql-方言"></a> 自定义接受和生成的 SQL 方言</h3><p>要自定义解析器应接受的 SQL 扩展，请实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/sql/validate/SqlConformance.html"><code>interface SqlConformance</code></a> 或使用 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/sql/validate/SqlConformanceEnum.html"><code>enum SqlConformanceEnum</code></a>.</p><p>要控制如何为外部数据库生成 SQL（通常通过 JDBC 适配器），请使用 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/sql/SqlDialect.html"><code>class SqlDialect</code></a>。方言还描述了引擎的功能，例如它是否支持 <code>OFFSET</code> 和 <code>FETCH</code> 子句。</p><h3 id="定义自定义模式"><a class="markdownIt-Anchor" href="#定义自定义模式"></a> 定义自定义模式</h3><p>要定义自定义模式，你需要实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/schema/SchemaFactory.html"><code>interface SchemaFactory</code></a>。</p><p>在查询准备期间，Calcite 将调用此接口，来查找自定义模式包含哪些表和子模式。当查询引用了模式中的表时，Calcite 将要求自定义模式创建 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/schema/Table.html"><code>interface Table</code></a>。</p><p>表将被包装在 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/TableScan.html"><code>TableScan</code></a> 中，并将经历查询优化过程。</p><h3 id="反射模式"><a class="markdownIt-Anchor" href="#反射模式"></a> 反射模式</h3><p>反射模式（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/java/ReflectiveSchema.html"><code>class ReflectiveSchema</code></a>）是一种包装 Java 对象以使其显示为模式的方法。其中的集合字段将展示为表格。</p><p>它不是一个模式工厂，而是一个实际的模式。你必须创建对象并通过调用 API 将其包装在模式中。</p><p>参考 <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/master/core/src/test/java/org/apache/calcite/test/ReflectiveSchemaTest.java"><code>class ReflectiveSchemaTest</code></a>。</p><h3 id="定义自定义表"><a class="markdownIt-Anchor" href="#定义自定义表"></a> 定义自定义表</h3><p>要定义自定义表，你需要实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/schema/TableFactory.html"><code>interface TableFactory</code></a>。模式工厂是一组命名表，而表工厂在绑定到具有特定名称（以及可选的一组额外操作数）的模式时会生成单个表。</p><h3 id="修改数据"><a class="markdownIt-Anchor" href="#修改数据"></a> 修改数据</h3><p>如果你的表要支持 DML 操作（INSERT、UPDATE、DELETE、MERGE），则你的 <code>interface Table</code> 实现类必须同时实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/schema/ModifiableTable.html"><code>interface ModifiableTable</code></a>。</p><h3 id="流式操作"><a class="markdownIt-Anchor" href="#流式操作"></a> 流式操作</h3><p>如果你的表支持流式查询，则你的 <code>interface Table</code> 实现类必须实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/schema/StreamableTable.html"><code>interface StreamableTable</code></a>。</p><p>请参考 <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/master/core/src/test/java/org/apache/calcite/test/StreamTest.java"><code>class StreamTest</code></a> 示例。</p><h3 id="将操作下推到你的表中"><a class="markdownIt-Anchor" href="#将操作下推到你的表中"></a> 将操作下推到你的表中</h3><p>如果你希望将处理逻辑下推到自定义表的源系统，请考虑实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/schema/FilterableTable.html"><code>interface FilterableTable</code></a> 或 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/schema/ProjectableFilterableTable.html"><code>interface ProjectableFilterableTable</code></a>。</p><p>如果你想要更多的控制，你应该写一个<a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/adapter.html#planner-rule">优化规则</a>。这将允许你下推表达式，并基于代价做出关于是否下推处理的决定，以及下推更复杂的操作，例如：连接、聚合和排序。</p><h3 id="类型系统"><a class="markdownIt-Anchor" href="#类型系统"></a> 类型系统</h3><p>你可以通过实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/type/RelDataTypeSystem.html"><code>interface RelDataTypeSystem</code></a> 来自定义类型系统的某些方面。</p><h3 id="关系运算符"><a class="markdownIt-Anchor" href="#关系运算符"></a> 关系运算符</h3><p>所有关系运算符都实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/RelNode.html"><code>interface RelNode</code></a>，并且大多数扩展了 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/AbstractRelNode.html"><code>class AbstractRelNode</code></a>。最核心的运算符（被 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/sql2rel/SqlToRelConverter.html"><code>SqlToRelConverter</code></a> 使用并覆盖了常规的关系代数）是 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/TableScan.html"><code>TableScan</code></a>， <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/TableModify.html"><code>TableModify</code></a>， <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Values.html"><code>Values</code></a>， <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Project.html"><code>Project</code></a>， <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Filter.html"><code>Filter</code></a>， <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Aggregate.html"><code>Aggregate</code></a>， <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Join.html"><code>Join</code></a>， <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Sort.html"><code>Sort</code></a>， <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Union.html"><code>Union</code></a>， <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Intersect.html"><code>Intersect</code></a>， <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Minus.html"><code>Minus</code></a>， <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Window.html"><code>Window</code></a> 和 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Match.html"><code>Match</code></a>。</p><p>其中每一个都有一个<strong>纯</strong>逻辑子类， <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/logical/LogicalProject.html"><code>LogicalProject</code></a> 等。任何给定的适配器都会有对应的操作，其引擎可以有效地实现。例如，Cassandra 适配器有 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/cassandra/CassandraProject.html"><code>CassandraProject</code></a> 但没有 <code>CassandraJoin</code>。</p><p>你可以定义自己的 <code>RelNode</code> 子类来添加新运算符，或在特定引擎中添加现有运算符实现。</p><p>为了使运算符有用且强大，你需要将<a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/adapter.html#planner-rule">优化器规则</a>与现有运算符相结合（并且还提供元数据，见<a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/adapter.html#statistics-and-cost">下文</a>）。这些是关系代数，它们的效果是组合的：你虽然编写了少量的规则，但它们组合起来能够处理指数数量的查询模式。</p><p>如果可能，让你的运算符成为现有运算符的子类；那么你也许就可以重新使用或调整他们对应的规则。更好的是，如果你的运算符是一个可以根据现有运算符重写（再次通过优化器规则）的逻辑运算符，那么你应该这样做。你将无需额外工作即可重复使用这些运算符的规则、元数据和实现。</p><h3 id="优化规则"><a class="markdownIt-Anchor" href="#优化规则"></a> 优化规则</h3><p>优化器规则 ( <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/plan/RelOptRule.html"><code>class RelOptRule</code></a>) 将关系表达式转换为等效的关系表达式。</p><p>优化器引擎注册了许多优化器规则，并触发它们从而将输入的查询转换为更有效的查询。因此，优化器规则是优化过程的核心，但令人惊讶的是，每个优化器规则本身并不关心代价。优化器引擎负责按顺序触发规则以产生最佳计划，但每个单独的规则只关心自己的正确性。</p><p>Calcite 有两个内置的优化器引擎：<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/plan/volcano/VolcanoPlanner.html"><code>class VolcanoPlanner</code></a> 使用动态规划，它适用于穷举搜索，而 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/plan/hep/HepPlanner.html"><code>class HepPlanner</code></a> 以更固定的顺序触发一系列规则。</p><h3 id="调用约定"><a class="markdownIt-Anchor" href="#调用约定"></a> 调用约定</h3><p>调用约定是特定数据引擎使用的协议。例如，Cassandra 引擎有一组关系运算符，<code>CassandraProject</code>，<code>CassandraFilter</code> 等，并且这些运算符可以相互连接，而无需将数据从一种格式转换成另一种格式。</p><p>如果数据需要从一种调用约定转换为另一种调用约定，Calcite 使用称为转换器的特殊关系表达式子类（请参阅 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/convert/Converter.html"><code>interface Converter</code></a>）。但当然，转换数据有运行时的成本。</p><p>在优化器使用多个引擎进行查询时，Calcite 根据调用约定对关系表达式树的区域进行<strong>着色</strong>。优化器通过触发规则将操作推送到数据源中。如果引擎不支持特定操作，则不会触发规则。有时一项操作可能会发生在多个地方，最终会根据代价选择最佳方案。</p><p>调用约定是一个实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/plan/Convention.html"><code>interface Convention</code></a> 的类 、一个辅助接口（例如 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/cassandra/CassandraRel.html"><code>interface CassandraRel</code></a>），以及一组为核心关系运算符而实现 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/RelNode.html"><code>class RelNode</code></a> 接口的子类（<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Project.html"><code>Project</code></a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Filter.html"><code>Filter</code></a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/core/Aggregate.html"><code>Aggregate</code></a> 等）。</p><h3 id="内置-sql-实现"><a class="markdownIt-Anchor" href="#内置-sql-实现"></a> 内置 SQL 实现</h3><p>如果适配器没有实现所有核心关系运算符，Calcite 如何实现 SQL？</p><p>答案是特定的内置调用约定 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/adapter/enumerable/EnumerableConvention.html"><code>EnumerableConvention</code></a>。Enumerable 约定的关系表达式作为内置实现：Calcite 生成 Java 代码，对其进行编译，并在其自己的 JVM 中执行。Enumerable 约定的效率低于运行在面向列的数据文件上的分布式引擎，但它可以实现所有核心关系运算符以及所有内置 SQL 函数和运算符。如果数据源无法实现关系运算符，则可以使用枚举约定。</p><h3 id="统计和代价"><a class="markdownIt-Anchor" href="#统计和代价"></a> 统计和代价</h3><p>Calcite 有一个元数据系统，允许你定义有关关系运算符的代价函数和统计信息，统称为<strong>元数据</strong>。每种元数据都有一个单方法的接口（通常）。例如，选择性由<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdSelectivity.html"><code>class RelMdSelectivity</code></a> 和 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMetadataQuery.html#getSelectivity-org.apache.calcite.rel.RelNode-org.apache.calcite.rex.RexNode-"><code>getSelectivity(RelNode rel, RexNode predicate)</code></a> 方法定义。</p><p>有许多种内置的元数据，包括：<a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdCollation.html">排序规则</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdColumnOrigins.html">列来源</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdColumnUniqueness.html">列唯一性</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdDistinctRowCount.html">唯一行数</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdDistribution.html">分布</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdExplainVisibility.html">执行计划可见性</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdExpressionLineage.html">表达式血缘</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdMaxRowCount.html">最大行数</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdNodeTypes.html">节点类型</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdParallelism.html">并行度</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdPercentageOriginalRows.html">原始行百分比</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdPopulationSize.html">总体大小</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdPredicates.html">谓词</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdRowCount.html">行数</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdSelectivity.html">选择性</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdSize.html">大小</a>、 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdTableReferences.html">表引用</a> 和 <a target="_blank" rel="noopener" href="https://calcite.apache.org/javadocAggregate/org/apache/calcite/rel/metadata/RelMdUniqueKeys.html">唯一键</a>。你也可以定义自己的元数据。</p><p>然后，你可以提供一个<strong>元数据提供</strong>程序，为 <code>RelNode</code> 的特定子类计算此类元数据。元数据提供程序可以处理内置和扩展元数据类型，以及内置和扩展 <code>RelNode</code> 类型。在准备查询时，Calcite 结合了所有适用的元数据提供者并维护一个缓存，以便给定的元数据（例如特定 <code>Filter</code> 运算符中条件 <code>x &gt; 10</code> 的选择性）仅计算一次。</p><div class="tag-plugin quot"><p class="content" type="text"><span class="empty"></span><span class="text">写在最后</span><span class="empty"></span></p></div><p>笔者因为工作原因接触到 Calcite，前期学习过程中，深感 Calcite 学习资料之匮乏，因此创建了 <a target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/group/51128414222814">Calcite 从入门到精通知识星球</a>，希望能够将学习过程中的资料和经验沉淀下来，为更多想要学习 Calcite 的朋友提供一些帮助。</p><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/blog/blog/202309210909027.png" alt="Calcite 从入门到精通"></p><div class="article-footer fs14"></div></article><div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">回顾上一篇</div><a href="/wiki/calcite/algebra.html">代数</a></div><div class="item" id="next"><div class="note">接下来阅读</div><a href="/wiki/calcite/spatial.html">空间</a></div></section></div><div class="related-wrap md-text" id="comments"><section class="header cmt-title cap theme"><p>快来参与讨论吧~</p></section><section class="body cmt-body giscus"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg><div id="giscus" src="https://giscus.app/client.js" data-repo="strongduanmu/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkzNzQwMDk3Njg=" data-category="Announcements" data-category-id="DIC_kwDOFkrvqM4CZIsa" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div></section></div><footer class="page-footer footnote"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs15">博客</span><a href="/categories/">分类</a><a href="/tags/">标签</a><a href="/archives/">归档</a></div><div class="sitemap-group"><span class="fs15">文档</span><a href="/wiki/calcite/background.html">Calcite</a><a href="/wiki/cmu_15_445/index.html">CMU 15-445</a><a href="/wiki/cmu_15_721/index.html">CMU 15-721</a></div><div class="sitemap-group"><span class="fs15">便笺</span><a href="/notes/">Common</a><a href="/notes/docker.html">Docker</a><a href="/notes/git.html">Git</a></div><div class="sitemap-group"><span class="fs15">更多</span><a href="/more/">关于</a><a href="/more/news/">动态</a></div></div><div class="text"><p>本站由 <a target="_blank" rel="noopener" href="https://github.com/strongduanmu">@strongduanmu</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> 主题创建，使用 <a target="_blank" rel="noopener" href="https://vercel.com/">Vercel</a> 网站部署。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。<br>本站总访问量 <span id="vercount_value_site_pv"></span> 次，本站访客数 <span id="vercount_value_site_uv"></span> 人次。</p></div></footer><div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right"><div class="widgets"><widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E9%80%82%E9%85%8D%E5%99%A8"><span class="toc-text">模式适配器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E8%AF%AD%E8%A8%80%E6%8E%A5%E5%8F%A3"><span class="toc-text">其他语言接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E6%93%8E"><span class="toc-text">引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8"><span class="toc-text">驱动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jdbc-%E8%BF%9E%E6%8E%A5%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%82%E6%95%B0"><span class="toc-text">JDBC 连接字符串参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7"><span class="toc-text">可扩展性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%92%8C%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-text">函数和运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="toc-text">聚合函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="toc-text">窗口函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%BB%84%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="toc-text">分组窗口函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E5%87%BD%E6%95%B0%E5%92%8C%E8%A1%A8%E5%AE%8F"><span class="toc-text">表函数和表宏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-text">扩展解析器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%97%E5%92%8C%E7%94%9F%E6%88%90%E7%9A%84-sql-%E6%96%B9%E8%A8%80"><span class="toc-text">自定义接受和生成的 SQL 方言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%BC%8F"><span class="toc-text">定义自定义模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E6%A8%A1%E5%BC%8F"><span class="toc-text">反射模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A8"><span class="toc-text">定义自定义表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE"><span class="toc-text">修改数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E6%93%8D%E4%BD%9C"><span class="toc-text">流式操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E6%93%8D%E4%BD%9C%E4%B8%8B%E6%8E%A8%E5%88%B0%E4%BD%A0%E7%9A%84%E8%A1%A8%E4%B8%AD"><span class="toc-text">将操作下推到你的表中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F"><span class="toc-text">类型系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E7%B3%BB%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-text">关系运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E8%A7%84%E5%88%99"><span class="toc-text">优化规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E7%BA%A6%E5%AE%9A"><span class="toc-text">调用约定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE-sql-%E5%AE%9E%E7%8E%B0"><span class="toc-text">内置 SQL 实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E5%92%8C%E4%BB%A3%E4%BB%B7"><span class="toc-text">统计和代价</span></a></li></ol></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget></div></aside><div class="float-panel blur"><button type="button" style="display:none" class="laptop-only rightbar-toggle mobile" onclick="sidebar.rightbar()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></button> <button type="button" style="display:none" class="mobile-only leftbar-toggle mobile" onclick="sidebar.leftbar()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg></button></div></div><div class="scripts"><script>let ctx={date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前"},root:"/",tag_plugins:{chat:Object.assign({api:"https://siteinfo.listentothewind.cn/api/v1"})},search:{}};if((ctx.search.service="local_search")==ctx.search.service){let e=Object.assign({},'{"field":"all","path":"/search.json","content":true,"skip_search":null,"codeblock":true,"sort":"-date"}');ctx.search[ctx.search.service]=e}let def={avatar:"/assets/placeholder/avatar.svg",cover:"/assets/placeholder/cover.svg"},deps={jquery:"https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js",marked:"https://cdn.jsdelivr.net/npm/marked@13.0.1/lib/marked.umd.min.js"}</script><script>function RunItem(){function n(e,t){this.name=t||e.name,this.run=()=>{try{e()}catch(e){console.log(e)}}}this.list=[],this.start=()=>{for(var e=0;e<this.list.length;e++)this.list[e].run()},this.push=(e,t,r=!0)=>{let s=e,i=new n(s=r?()=>{utils.requestAnimationFrame(e)}:s,t);this.list.push(i)},this.remove=t=>{for(let e=0;e<this.list.length;e++)this.list[e].name==t&&this.list.splice(e,1)}}let utils={css:(e,t,r,s)=>{var i,n,a=window.document,o=a.createElement("link"),d=(n=t||(i=(a.body||a.getElementsByTagName("head")[0]).childNodes)[i.length-1],a.styleSheets);if(s)for(var l in s)s.hasOwnProperty(l)&&o.setAttribute(l,s[l]);o.rel="stylesheet",o.href=e,o.media="only x",function e(t){if(a.body)return t();setTimeout(function(){e(t)})}(function(){n.parentNode.insertBefore(o,t?n:n.nextSibling)});function u(e){for(var t=o.href,r=d.length;r--;)if(d[r].href===t)return e();setTimeout(function(){u(e)})}function h(){o.addEventListener&&o.removeEventListener("load",h),o.media=r||"all"}return o.addEventListener&&o.addEventListener("load",h),o.onloadcssdefined=u,u(h),o},js:(i,n)=>new Promise((t,e)=>{var r=document.createElement("script");if(i.startsWith("/")&&(i=ctx.root+i.substring(1)),r.src=i,n)for(var s of Object.keys(n))r[s]=n[s];else r.async=!0;r.onerror=e,r.onload=r.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(r.onload=r.onreadystatechange=null,t())},document.head.appendChild(r)}),jq:e=>{"undefined"==typeof jQuery?utils.js(deps.jquery).then(e):e()},onLoading:e=>{e&&$(e).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>')},onLoadSuccess:e=>{e&&$(e).find(".loading-wrap").remove()},onLoadFailure:e=>{e&&($(e).find(".loading-wrap svg").remove(),$(e).find(".loading-wrap").append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>'),$(e).find(".loading-wrap").addClass("error"))},request:(n,a,o,d)=>{let l=3;utils.onLoading(n),function i(){new Promise((t,e)=>{let r=0,s=setTimeout(()=>{0===r&&(r=2,s=null,e("请求超时"),0==l)&&d()},5e3);fetch(a).then(function(e){if(2!==r&&(clearTimeout(s),t(e),s=null,r=1),e.ok)return e.json();throw new Error("Network response was not ok.")}).then(function(e){l=0,utils.onLoadSuccess(n),o(e)}).catch(function(e){0<l?(--l,setTimeout(()=>{i()},5e3)):(utils.onLoadFailure(n),d())})})}()},requestAnimationFrame:e=>{window.requestAnimationFrame||(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame),window.requestAnimationFrame(e)},dark:{}};utils.dark.method={toggle:new RunItem},utils.dark=Object.assign(utils.dark,{push:utils.dark.method.toggle.push})</script><script>let sidebar={leftbar:()=>{l_body&&(l_body.toggleAttribute("leftbar"),l_body.removeAttribute("rightbar"))},rightbar:()=>{l_body&&(l_body.toggleAttribute("rightbar"),l_body.removeAttribute("leftbar"))},dismiss:()=>{l_body&&(l_body.removeAttribute("leftbar"),l_body.removeAttribute("rightbar"))},toggleTOC:()=>{document.querySelector("#data-toc").classList.toggle("collapse")}}</script><script>(()=>{var e;for(e of document.querySelectorAll(".tag-subtree.parent-tag > a > .tag-switcher-wrapper"))e.addEventListener("click",e=>{e.target.closest(".tag-subtree.parent-tag").classList.toggle("expanded"),e.preventDefault()});var t=new URLSearchParams(window.location.search).get("tag");if(t){let e=document.querySelector(`.tag-subtree[data-tag="${t}"]`);if(e)for(e.querySelector("a").classList.add("active");e;)e.classList.add("expanded"),e=e.parentElement.closest(".tag-subtree.parent-tag")}})()</script><script src="/js/main.js?v=1.30.1" defer></script><script>let applyTheme=e=>{"auto"===e?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme",e),applyThemeToGiscus(e)},applyThemeToGiscus=e=>{e="auto"===e?"preferred_color_scheme":e;var t=document.getElementById("giscus"),t=(t&&t.setAttribute("data-theme",e),document.querySelector("#comments > section.giscus > iframe"));t&&(e=t.src.replace(/theme=[\w]+/,"theme="+e),t.src=e)},switchTheme=()=>{let e;switch(document.documentElement.getAttribute("data-theme")){case"light":e="dark";break;case"dark":e="auto";break;default:e="light"}applyTheme(e),window.localStorage.setItem("Stellar.theme",e),utils.dark.mode="auto"===e?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e,utils.dark.method.toggle.start(),hud?.toast?.({light:"切换到浅色模式",dark:"切换到深色模式",auto:"切换到跟随系统配色"}[e])};(()=>{var e=window.localStorage.getItem("Stellar.theme");null!==e?applyTheme(e):utils.dark.mode=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",utils.dark.method.toggle.start()})()</script><script type="module">const el = document.querySelector('#comments #giscus');
  util.viewportLazyload(el, load_discus, false);

  function load_discus() {
    if (!el) return;
    try {
        el.innerHTML = '';
      } catch (error) {
        console.error(error);
      }
      const script = document.createElement('script');
      script.async = true;
      for (const key of Object.keys(el.attributes)) {
        const attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
  }</script><script defer>window.addEventListener("DOMContentLoaded",e=>{ctx.services=Object.assign({},JSON.parse('{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"}}'));for(let s of Object.keys(ctx.services)){let e=ctx.services[s].js;"siteinfo"==s?(ctx.cardlinks=document.querySelectorAll("a.link-card[cardlink]"),0<ctx.cardlinks?.length&&utils.js(e,{defer:!0}).then(function(){setCardLink(ctx.cardlinks)})):"voice"==s?(ctx.voiceAudios=document.querySelectorAll(".voice>audio"),0<ctx.voiceAudios?.length&&utils.js(e,{defer:!0}).then(function(){createVoiceDom(ctx.voiceAudios)})):"video"==s?(ctx.videos=document.querySelectorAll(".video>video"),0<ctx.videos?.length&&utils.js(e,{defer:!0}).then(function(){videoEvents(ctx.videos)})):"download-file"==s?(ctx.files=document.querySelectorAll(".file"),0<ctx.files?.length&&utils.js(e,{defer:!0}).then(function(){downloadFileEvent(ctx.files)})):0<document.getElementsByClassName("ds-"+s)?.length&&utils.jq(()=>{s,utils.js(deps.marked).then(function(){utils.js(e,{defer:!0})})})}let n=document.querySelectorAll(".chat .status-bar .time");var s,t;function i(){for(let e=0;e<n.length;++e){var s=n[e],t=new Date,i=t.getHours(),t=t.getMinutes();s.innerHTML=o(i)+":"+o(t)}}function o(e){return e<10?"0"+e:e}0<n.length&&(i(),s=(new Date).getSeconds(),t=setInterval(function(){i(),clearInterval(t),setInterval(i,6e4)},1e3*(60-s)));let c=new IntersectionObserver((e,t)=>{e.filter(e=>e.isIntersecting).sort((e,s)=>e.intersectionRect.y!==s.intersectionRect.y?e.intersectionRect.y-s.intersectionRect.y:e.intersectionRect.x-s.intersectionRect.x).forEach((e,s)=>{t.unobserve(e.target),setTimeout(()=>{e.target.classList.add("quote-blink"),setTimeout(()=>{e.target.classList.remove("quote-blink")},1e3)},Math.max(100,16)*(s+1))})}),r=document.querySelectorAll(".chat .talk .quote");r.forEach(i=>{i.addEventListener("click",function(){var e,s,t=document.getElementById("quote-"+i.getAttribute("quotedCellTag"));t&&(s=(e=t.parentElement).clientHeight/2,t.offsetTop>s-t.clientHeight/2?e.scrollTo({top:t.offsetTop-s+t.clientHeight/2,behavior:"smooth"}):e.scrollTo({top:0,behavior:"smooth"}),c.observe(t))})})})</script><script>window.addEventListener("DOMContentLoaded",e=>{ctx.search={path:"/search.json"},utils.js("/js/search/local-search.js",{defer:!0})})</script><script>window.FPConfig={delay:0,ignoreKeywords:[],maxRPS:5,hoverDelay:25}</script><script defer src="/js/flying-pages.min.js"></script><script defer src="/js/lazyload.min.js"></script><script>window.lazyLoadOptions={elements_selector:".lazy"},window.addEventListener("LazyLoad::Initialized",function(n){window.lazyLoadInstance=n.detail.instance},!1),document.addEventListener("DOMContentLoaded",function(){window.lazyLoadInstance?.update()})</script><script>ctx.fancybox={selector:"article.md-text img:not(.post-cover img):not(.cover img):not(.card-link img):not(.image-bg img):not(.social img):not(.preview img)",css:"/css/fancybox.min.css",js:"/js/fancybox.umd.min.js"};var selector="[data-fancybox]:not(.error)",needFancybox=(ctx.fancybox.selector&&(selector+=", "+ctx.fancybox.selector),0!==document.querySelectorAll(selector).length);if(!needFancybox){let e=document.getElementsByClassName("ds-memos");null!=e&&0<e.length&&(needFancybox=!0)}needFancybox&&(utils.css(ctx.fancybox.css),utils.js(ctx.fancybox.js,{defer:!0}).then(function(){Fancybox.bind(selector,{hideScrollbar:!1,Thumbs:{autoStart:!1},caption:(e,t)=>t.triggerEl.alt||t.triggerEl.dataset.caption||null})}))</script><script>window.addEventListener("DOMContentLoaded",e=>{let i=document.getElementById("swiper-api");null!=i&&(utils.css("/css/swiper-bundle.min.css"),utils.js("/js/swiper-bundle.min.js",{defer:!0}).then(function(){var e=i.getAttribute("effect")||"";new Swiper(".swiper#swiper-api",{slidesPerView:"auto",spaceBetween:8,centeredSlides:!0,effect:e,rewind:!0,pagination:{el:".swiper-pagination",clickable:!0},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"}})}))})</script><script>document.addEventListener("DOMContentLoaded",function(){window.codeElements=document.querySelectorAll(".code"),0<window.codeElements.length&&(ctx.copycode={default_text:"复制代码",success_text:"复制成功",toast:"复制成功"},utils.js("/js/plugins/copycode.js"))})</script><script async>((a,t,c)=>{t.ChatraID="PHWnu7Bamcwtbnx2d";var h=a.createElement("script");t[c]=t[c]||function(){(t[c].q=t[c].q||[]).push(arguments)},h.async=!0,h.src="https://call.chatra.io/chatra.js",a.head&&a.head.appendChild(h)})(document,window,"Chatra")</script><script defer src="https://cn.vercount.one/js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous" onload="renderMathInElement(document.body)"></script><script>window.va=window.va||function(){(window.vaq=window.vaq||[]).push(arguments)}</script><script defer src="/_vercel/insights/script.js"></script><script>window.si=window.si||function(){(window.siq=window.siq||[]).push(arguments)}</script><script defer src="/_vercel/speed-insights/script.js"></script><script>function change_banner(){$(".banner img.bg").attr("src","/assets/banner/banner_"+Math.floor(20*Math.random()+1)+".jpg")}setTimeout("change_banner()",250)</script><script>function add_page_pv(){$("#post-meta").after('<div class="flex-row" id="post-meta"><span class="text created">本文总阅读量 <span id="vercount_value_page_pv"></span> 次</span></div>')}setTimeout("add_page_pv()",500)</script><script>function change_img_alt(){$("article.md-text img:not(.post-cover img):not(.cover img):not(.card-link img):not(.image-bg img):not(.social img):not(.preview img)").each(function(t){$(this).after("<div class='image-meta' style='text-align:center;'><span class='image-caption center' style='display:inline-block;font-size:.8125rem;color:var(--text-p2);line-height:1.5;text-align:justify;'>"+($(this).attr("title")||$(this).attr("alt"))+"</span></div>")})}setTimeout("change_img_alt()",1e3)</script></div></body></html>