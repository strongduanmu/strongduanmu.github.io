<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.30.1" theme-name="Stellar" theme-version="1.30.1"><meta name="generator" content="Hexo 7.3.0"><meta http-equiv="x-dns-prefetch-control" content="on"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="theme-color" content="#f9fafb"><title>Calcite：如何参与 - 端小强的博客</title><meta name="description" content="原文链接：https:&#x2F;&#x2F;calcite.apache.org&#x2F;docs&#x2F;howto.html  以下是有关使用 Calcite 及其各种适配器的一些杂项文档。  从分发的源代码构建 先决条件是你的路径上有 Java（JDK 8、9、10、11、12、13、14、15、16、17、18 或 19）和 Gradle（版本 7.6.1）。 解压分发的源代码 .tar.gz 文件， cd 到解压源文件"><meta property="og:type" content="website"><meta property="og:title" content="如何参与"><meta property="og:url" content="https://strongduanmu.com/wiki/calcite/howto.html"><meta property="og:site_name" content="端小强的博客"><meta property="og:description" content="原文链接：https:&#x2F;&#x2F;calcite.apache.org&#x2F;docs&#x2F;howto.html  以下是有关使用 Calcite 及其各种适配器的一些杂项文档。  从分发的源代码构建 先决条件是你的路径上有 Java（JDK 8、9、10、11、12、13、14、15、16、17、18 或 19）和 Gradle（版本 7.6.1）。 解压分发的源代码 .tar.gz 文件， cd 到解压源文件"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://strongduanmu.com/assets/xingqiu/calcite_xingqiu.png"><meta property="article:published_time" content="2023-10-26T01:00:00.000Z"><meta property="article:modified_time" content="2023-10-26T01:00:00.000Z"><meta property="article:author" content="端小强"><meta property="article:tag" content="ShardingSphere"><meta property="article:tag" content="Calcite"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://strongduanmu.com/assets/xingqiu/calcite_xingqiu.png"><meta name="twitter:creator" content="@strongduanmu"><meta name="keywords" content="ShardingSphere,Calcite"><link rel="alternate" href="/atom.xml" title="端小强的博客" type="application/atom+xml"><link rel="stylesheet" href="/css/main.css?v=1.30.1"><link rel="shortcut icon" href="/assets/placeholder/favicon.ico"><meta name="baidu-site-verification" content="codeva-sIRwgTpHve"><link rel="apple-touch-icon" sizes="180x180" href="/assets/placeholder/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/placeholder/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/placeholder/favicon-16x16.png"><link rel="manifest" href="/assets/placeholder/site.webmanifest"><link rel="stylesheet" href="/css/custom.css" media="all" onload='this.media="all"'><link rel="stylesheet" href="/css/lxgwwenkaimono-bold.css" media="all" onload='this.media="all"'><link rel="stylesheet" href="/css/lxgwwenkaiscreen.css" media="all" onload='this.media="all"'></head><body><div class="l_body content tech" id="start" layout="wiki"><aside class="l_left"><div class="leftbar-container"><header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="/assets/blog/2021/07/01/1625102427.jpg" onerror="javascript:this.classList.add('error');this.src='/assets/placeholder/image.svg';"></div><a class="title" href="/wiki/calcite/background.html"><div class="main" ff="title">Calcite</div><div class="sub normal cap">最流行的 Java 优化器框架</div><div class="sub hover cap" style="opacity:0">学习数据库内核的绝佳案例</div></a></div></header><div class="nav-area"><div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" data-filter="/wiki/calcite/" placeholder="在 Calcite 中搜索..."></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div><nav class="menu dis-select"><a class="nav-item" title="博客" href="/"><span>博客</span></a><a class="nav-item active" title="文档" href="/wiki/"><span>文档</span></a><a class="nav-item" title="便笺" href="/notes/"><span>便笺</span></a><a class="nav-item" title="更多" href="/more/"><span>更多</span></a></nav></div><div class="widgets"><widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">概述</span></div><div class="widget-body fs14"><a class="link" href="/wiki/calcite/background.html#start"><span class="toc-text">背景</span></a><a class="link" href="/wiki/calcite/tutorial.html"><span class="toc-text">教程</span></a><a class="link" href="/wiki/calcite/algebra.html"><span class="toc-text">代数</span></a></div><div class="widget-header dis-select"><span class="name">高级主题</span></div><div class="widget-body fs14"><a class="link" href="/wiki/calcite/adapters.html"><span class="toc-text">适配器</span></a><a class="link" href="/wiki/calcite/spatial.html"><span class="toc-text">空间</span></a><a class="link" href="/wiki/calcite/stream.html"><span class="toc-text">流式查询</span></a><a class="link" href="/wiki/calcite/materialized-views.html"><span class="toc-text">物化视图</span></a><a class="link" href="/wiki/calcite/lattice.html"><span class="toc-text">Lattice 格</span></a></div><div class="widget-header dis-select"><span class="name">参考指南</span></div><div class="widget-body fs14"><a class="link" href="/wiki/calcite/reference.html"><span class="toc-text">参考指南</span></a><a class="link" href="/wiki/calcite/model.html"><span class="toc-text">JSON/YAML 模型</span></a><a class="link active" href="/wiki/calcite/howto.html"><span class="toc-text">如何参与</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a><a class="link" href="/wiki/calcite/develop.html"><span class="toc-text">开发 Calcite</span></a></div></widget></div><footer class="footer dis-select"><div class="social-wrap"><a class="social" href="mailto:duanzhengqiang@apache.org" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/email.svg"></a><a class="social" href="https://github.com/strongduanmu" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/github.svg"></a><a class="social" href="/sitemap.xml" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/sitemap.svg"></a><a class="social" href="/atom.xml" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/rss.svg"></a></div></footer></div></aside><div class="l_main" id="main"><div class="article banner top"><img class="bg lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/banner/banner_15.jpg"><div class="content"><div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a> <span class="sep"></span><a class="cap breadcrumb" id="menu" href="/wiki">文档</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/wiki/calcite/background.html">Calcite</a></div><div class="flex-row" id="post-meta"><span class="text created">更新于：<time datetime="2023-10-26T01:00:00.000Z">2023-10-26</time></span></div></div></div><div class="bottom only-title"><div class="text-area"><h1 class="text title"><span>如何参与</span></h1></div></div></div></div><article class="md-text content"><blockquote><p>原文链接：<a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/howto.html">https://calcite.apache.org/docs/howto.html</a></p></blockquote><p>以下是有关使用 Calcite 及其各种适配器的一些杂项文档。</p><h2 id="从分发的源代码构建"><a class="markdownIt-Anchor" href="#从分发的源代码构建"></a> 从分发的源代码构建</h2><p>先决条件是你的路径上有 Java（JDK 8、9、10、11、12、13、14、15、16、17、18 或 19）和 Gradle（版本 7.6.1）。</p><p>解压分发的源代码 <code>.tar.gz</code> 文件， <code>cd</code> 到解压源文件的根目录，然后使用 Gradle 进行构建：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tar xvfz apache-calcite-1.36.0-src.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> apache-calcite-1.36.0-src</span><br><span class="line">$ gradle build</span><br></pre></td></tr></table></figure><p><a href="https://strongduanmu.com/wiki/calcite/howto.html#%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95">运行测试</a>描述了如何运行更多或更少的测试（但你应该使用 <code>gradle</code> 命令而不是 <code>./gradlew</code> ）。</p><h2 id="从-git-构建"><a class="markdownIt-Anchor" href="#从-git-构建"></a> 从 Git 构建</h2><p>先决条件是你的路径上有 git 和 Java（JDK 8、9、10、11、12、13、14、15、16、17、18 或 19）。</p><p>创建 GitHub 存储库的本地副本，然后 <code>cd</code> 到其根目录，再使用包含的 Gradle 包装器进行构建：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/apache/calcite.git</span><br><span class="line">$ <span class="built_in">cd</span> calcite</span><br><span class="line">$ ./gradlew build</span><br></pre></td></tr></table></figure><p>Calcite 包含许多机器生成的代码。默认情况下，它们会在每次构建时重新生成，但这会产生负面影响，即在非机器生成的代码未更改时导致整个项目重新编译。</p><p>通常，当相关模板发生更改时，会自动调用重新生成，并且它应该透明地工作。但是，如果你的 IDE 不生成源（例如 <code>core/build/javacc/javaCCMain/org/apache/calcite/sql/parser/impl/SqlParserImpl.java</code> ），那么你可以手动调用 <code>./gradlew generateSources</code> 任务。</p><p><a href="https://strongduanmu.com/wiki/calcite/howto.html#%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95">运行测试</a>描述了如何运行更多或更少的测试。</p><h2 id="gradle-与-gradle-包装器"><a class="markdownIt-Anchor" href="#gradle-与-gradle-包装器"></a> Gradle 与 Gradle 包装器</h2><p>Calcite 使用 Gradle Wrapper 来创建一致的构建环境。在典型情况下，你不需要手动安装 Gradle， <code>./gradlew</code> 会为你下载正确的版本并验证预期的校验和。</p><p>如果你愿意，可以手动安装 Gradle，但请注意这可能会导致版本不匹配。</p><p>有关 Gradle 的更多信息，请查看以下链接：<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/what_is_gradle.html#five_things">Gradle 五件事</a> 和 <a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/intro_multi_project_builds.html">Gradle 多项目构建</a>。</p><h2 id="升级-gradle-和-gradle-包装器"><a class="markdownIt-Anchor" href="#升级-gradle-和-gradle-包装器"></a> 升级 Gradle 和 Gradle 包装器</h2><p><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/upgrading_version_7.html">Gradle 的文档</a>提供了有关如何升级 Gradle 的详细信息。以下是步骤列表：</p><ol><li>运行 <code>./gradlew help --warning-mode=all</code> 以查明你是否正在使用任何已弃用的功能；</li><li>修复弃用的问题并重复上一步以确认它们已修复。 Gradle 文档在这一步可能非常有帮助，因为它包含有关弃用以及如何处理它们的信息；</li><li>运行 <code>./gradlew wrapper --gradle-version &lt;new_gradle_version&gt;</code> 来升级 Gradle。如有必要，它还会升级 Gradle Wrapper。此步骤还会更新 <code>gradle/wrapper/gradle-wrapper.properties</code> ，包括校验和；</li><li>如果需要，检查并更新 <code>gradle.properties</code> 中的 Kotlin 版本。应根据 <a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/compatibility.html#kotlin">Kotlin 兼容性矩阵</a>进行检查；</li><li>步骤 3 将从 <code>gradle/wrapper/gradle-wrapper.properties</code> 中删除标头，因此现在运行 <code>./gradlew autostyleApply</code> 将其添加回来；</li><li>根据官方 <a target="_blank" rel="noopener" href="https://gradle.org/release-checksums/">Gradle 版本校验和</a>检查 <code>gradle/wrapper/gradle-wrapper.properties</code> 中更新的 Gradle 版本和校验和；</li><li>尝试构建项目并运行测试；使用<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/troubleshooting.html#troubleshooting">故障排除指南</a>调试任何错误；</li><li>更新本指南中的 Gradle 版本。</li></ol><h2 id="运行测试"><a class="markdownIt-Anchor" href="#运行测试"></a> 运行测试</h2><p>构建时测试套件将默认运行，除非你指定 <code>-x test</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./gradlew assemble <span class="comment"># build the artifacts</span></span><br><span class="line">$ ./gradlew build -x <span class="built_in">test</span> <span class="comment"># build the artifacts, verify code style, skip tests</span></span><br><span class="line">$ ./gradlew check <span class="comment"># verify code style, execute tests</span></span><br><span class="line">$ ./gradlew <span class="built_in">test</span> <span class="comment"># execute tests</span></span><br><span class="line">$ ./gradlew style <span class="comment"># update code formatting (for auto-correctable cases) and verify style</span></span><br><span class="line">$ ./gradlew autostyleCheck checkstyleAll <span class="comment"># report code style violations</span></span><br><span class="line">$ ./gradlew -PenableErrorprone classes <span class="comment"># verify Java code with Error Prone compiler, requires Java 11</span></span><br></pre></td></tr></table></figure><p>你可以使用 <code>./gradlew assemble</code> 构建工件并跳过所有测试和验证。</p><p>还有其他选项可以控制运行哪些测试以及在什么环境中运行，如下所示。</p><ul><li><code>-Dcalcite.test.db=DB</code> （其中 DB 为 <code>h2</code> 、 <code>hsqldb</code> 、 <code>mysql</code> 或 <code>postgresql</code> ）允许你更改 JDBC 测试套件的数据源。 Calcite 的测试套件需要一个填充有 foodmart 数据集的 JDBC 数据源。<ul><li><code>hsqldb</code> 默认使用 hsqldb 内存数据库；</li><li>所有其他都访问测试虚拟机（请参阅下面的<a href="https://strongduanmu.com/wiki/calcite/howto.html#%E8%BF%90%E8%A1%8C%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95">集成测试</a>）。 <code>mysql</code> 和 <code>postgresql</code> 可能比 hsqldb 快一些，但你需要填充它（即配置虚拟机）。</li></ul></li><li><code>-Dcalcite.debug</code> 将额外的调试信息打印到标准输出；</li><li><code>-Dcalcite.test.splunk</code> 启用针对 Splunk 运行的测试。Splunk 必须已安装并正在运行；</li><li><code>./gradlew testSlow</code> 运行需要更长时间执行的测试。例如，有些测试可以在内存中创建虚拟 TPC-H 和 TPC-DS 模式，并根据这些基准运行测试。</li></ul><p>注意：测试是在分叉的 JVM 中执行的，因此使用 Gradle 运行测试时不会自动传递系统属性。默认情况下，构建脚本传递以下 <code>-D...</code> 属性（请参阅 <code>build.gradle.kts</code> 中的 <code>passProperty</code> ）：</p><ul><li><code>java.awt.headless</code>；</li><li><code>junit.jupiter.execution.parallel.enabled</code>， 默认：<code>true</code>；</li><li><code>junit.jupiter.execution.timeout.default</code>， 默认：<code>5 m</code>；</li><li><code>user.language</code>， 默认：<code>TR</code>；</li><li><code>user.country</code>， 默认：<code>tr</code>；</li><li><code>calcite.**</code> （启用 <code>calcite.test.db</code> 及上述其他内容）。</li></ul><h2 id="运行集成测试"><a class="markdownIt-Anchor" href="#运行集成测试"></a> 运行集成测试</h2><p>为了测试 Calcite 的外部适配器，应使用测试虚拟机。 VM 包括 Cassandra、Druid、H2、HSQLDB、MySQL、MongoDB 和 PostgreSQL。</p><p>测试虚拟机需要 5GiB 磁盘空间，构建需要 30 分钟。</p><p>注意：你可以使用 <a target="_blank" rel="noopener" href="https://github.com/vlsi/calcite-test-dataset">calcite-test-dataset</a> 填充你自己的数据库，但建议使用测试虚拟机，以便可以重现测试环境。</p><h3 id="虚拟机准备"><a class="markdownIt-Anchor" href="#虚拟机准备"></a> 虚拟机准备</h3><ol start="0"><li>安装依赖项：<a target="_blank" rel="noopener" href="https://www.vagrantup.com/">Vagrant</a> 和 <a target="_blank" rel="noopener" href="https://www.virtualbox.org/">VirtualBox</a>；</li></ol><ol><li>在与 Calcite 存储库相同的级别克隆：<a target="_blank" rel="noopener" href="https://github.com/vlsi/calcite-test-dataset.git">https://github.com/vlsi/calcite-test-dataset.git</a> 仓库。例如：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">code</span><br><span class="line">  +-- calcite</span><br><span class="line">  +-- calcite-test-dataset</span><br></pre></td></tr></table></figure><p>注意：集成测试搜索 <code>../calcite-test-dataset</code> 或 <code>../../calcite-test-dataset</code>。你可以通过 <code>calcite.test.dataset</code> 系统属性指定完整路径。</p><ol start="2"><li>构建并启动 VM：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> calcite-test-dataset &amp;&amp; mvn install</span><br></pre></td></tr></table></figure><h3 id="虚拟机管理"><a class="markdownIt-Anchor" href="#虚拟机管理"></a> 虚拟机管理</h3><p>测试虚拟机由 Vagrant 配置，因此应使用常规 Vagrant <code>vagrant up</code> 和 <code>vagrant halt</code> 来启动和停止虚拟机。 <a target="_blank" rel="noopener" href="https://github.com/vlsi/calcite-test-dataset">calcite-test-dataset</a> 自述文件中列出了不同数据库的连接字符串。</p><h3 id="建议的测试流程"><a class="markdownIt-Anchor" href="#建议的测试流程"></a> 建议的测试流程</h3><p>注意：测试虚拟机应在启动集成测试之前启动。Calcite 本身不会启动/停止虚拟机。</p><p>命令行：</p><ul><li>执行常规单元测试（不需要外部数据）：没有变化。 <code>./gradlew test</code> 或 <code>./gradlew build</code>；</li><li>对所有数据库执行所有测试： <code>./gradlew test integTestAll</code>；</li><li>仅执行外部数据库的测试，不包括单元测试： <code>./gradlew integTestAll</code>；</li><li>执行 PostgreSQL JDBC 测试： <code>./gradlew integTestPostgresql</code>；</li><li>仅执行 MongoDB 测试： <code>./gradlew :mongo:build</code>。</li></ul><p>在 IDE 中执行：</p><ul><li>执行常规单元测试：没有变化；</li><li>执行 MongoDB 测试：使用 <code>calcite.integrationTest=true</code> 系统属性运行 <code>MongoAdapterTest.java</code>；</li><li>执行 MySQL 测试：使用设置 <code>-Dcalcite.test.db=mysql</code> 运行 <code>JdbcTest</code> 和 <code>JdbcAdapterTest</code>；</li><li>执行 PostgreSQL 测试：使用设置 <code>-Dcalcite.test.db=postgresql</code> 运行 <code>JdbcTest</code> 和 <code>JdbcAdapterTest</code>。</li></ul><h3 id="集成测试技术细节"><a class="markdownIt-Anchor" href="#集成测试技术细节"></a> 集成测试技术细节</h3><p>使用外部数据的测试是在 Gradle 的集成测试阶段执行的。我们目前不使用集成前测试/集成后测试，但是，我们将来可以使用它。构建通过/失败的验证是在验证阶段执行的。集成测试应命名为 <code>...IT.java</code> ，因此在单元测试执行时不会拾取它们。</p><h2 id="贡献"><a class="markdownIt-Anchor" href="#贡献"></a> 贡献</h2><p>请参阅<a href="https://strongduanmu.com/wiki/calcite/develop.html#%E8%B4%A1%E7%8C%AE">开发者指南-贡献</a>。</p><h2 id="入门"><a class="markdownIt-Anchor" href="#入门"></a> 入门</h2><p>请参阅<a href="https://strongduanmu.com/wiki/calcite/develop.html#%E5%85%A5%E9%97%A8">开发者指南-入门</a>。</p><h2 id="设置-ide-进行贡献"><a class="markdownIt-Anchor" href="#设置-ide-进行贡献"></a> 设置 IDE 进行贡献</h2><h3 id="设置-intellij-idea"><a class="markdownIt-Anchor" href="#设置-intellij-idea"></a> 设置 IntelliJ IDEA</h3><p>下载高于 (2018.X) 的 <a target="_blank" rel="noopener" href="https://www.jetbrains.com/idea/">IntelliJ IDEA</a> 版本。版本 2019.2 和 2019.3 已经过社区成员的测试，看起来很稳定。对于不使用 Gradle 构建（版本 1.21.0 及之前版本）的方解石源，旧版本的 IDEA 仍然可以正常工作。</p><p>按照安装 IDEA 的标准步骤并设置 Calcite 目前支持的 JDK 版本之一。</p><p>首先<a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/howto.html#building-from-a-source-distribution">从命令行构建 Calcite</a>。</p><p>转到 <code>文件 &gt; 打开...</code> 并打开 Calcite 的根 <code>build.gradle.kts</code> 文件。当 IntelliJ 询问你是否要将其作为项目或文件打开时，请选择项目。另外，当它询问你是否想要一个新窗口时，请选择是。 IntelliJ 的 Gradle 项目导入器应该处理其余的事情。</p><p>你可以在 <a target="_blank" rel="noopener" href="https://gist.github.com/gianm/27a4e3cad99d7b9b6513b6885d3cfcc9">GitHub</a> 上导入部分实现的 IntelliJ 代码样式配置。它并没有做让 Calcite 的样式检查器满意所需的一切，但它做了相当多的事情。要导入，请转至首选项 &gt; 编辑器 &gt; 代码样式，单击方案旁边的齿轮，然后单击导入方案 &gt; IntelliJ IDEA 代码样式 XML。</p><p>导入程序完成后，测试项目设置。例如，使用 Navigate &gt; Symbol 导航到方法 <code>JdbcTest.testWinAgg</code> 并输入 <code>testWinAgg</code> 。右键单击并选择运行（或等效的键盘快捷键）来运行 <code>testWinAgg</code> 。</p><h3 id="设置-netbeans"><a class="markdownIt-Anchor" href="#设置-netbeans"></a> 设置 NetBeans</h3><p>从主菜单中，选择 <code>文件 &gt; 打开项目</code>，然后导航到带有小 Gradle 图标的项目名称 (Calcite)，然后选择打开。等待 NetBeans 完成所有依赖项的导入。</p><p>为了确保项目配置成功，请导航到 <code>org.apache.calcite.test.JdbcTest</code> 中的方法 <code>testWinAgg</code> 。右键单击该方法并选择运行重点测试方法。 NetBeans 将运行 Gradle 进程，你应该在命令输出窗口中看到一行 <code>Running org.apache.calcite.test.JdbcTest</code> ，后跟 <code>&quot;BUILD SUCCESS&quot;</code> 。</p><p>注意：尚不清楚 NetBeans 是否在项目导入时自动生成相关源，因此你可能需要在导入项目之前（以及更新模板解析器源和项目版本时）运行 <code>./gradlew generateSources</code>。</p><h2 id="追踪tracing"><a class="markdownIt-Anchor" href="#追踪tracing"></a> 追踪（Tracing）</h2><p>要启用追踪，请将以下标志添加到 java 命令行：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-Dcalcite.debug</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure><p>第一个标志使 Calcite 将其生成的 Java 代码（以执行查询）打印到 stdout。如果你正在调试像这样的神秘问题，它特别有用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.ClassCastException: Integer cannot be cast to Long  at Baz$1$1.current(Unknown Source)</span><br></pre></td></tr></table></figure><p>默认情况下，Calcite 使用 SLF4J 的 Log4j 绑定。提供了一个配置文件，它将 INFO 级别的日志记录输出到 <code>core/src/test/resources/log4j.properties</code> 中的控制台。你可以修改 rootLogger 的级别以增加详细程度，或者更改特定类的级别（如果你愿意）。</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Change rootLogger level to WARN</span></span><br><span class="line"><span class="attr">log4j.rootLogger</span>=<span class="string">WARN, A1</span></span><br><span class="line"><span class="comment"># Increase level to DEBUG for RelOptPlanner</span></span><br><span class="line"><span class="attr">log4j.logger.org.apache.calcite.plan.RelOptPlanner</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="comment"># Increase level to TRACE for HepPlanner</span></span><br><span class="line"><span class="attr">log4j.logger.org.apache.calcite.plan.hep.HepPlanner</span>=<span class="string">TRACE</span></span><br></pre></td></tr></table></figure><h2 id="在-intellij-中调试生成的类"><a class="markdownIt-Anchor" href="#在-intellij-中调试生成的类"></a> 在 Intellij 中调试生成的类</h2><p>Calcite 使用 <a target="_blank" rel="noopener" href="https://janino-compiler.github.io/janino/">Janino</a> 生成 Java 代码。生成的类可以交互式调试（请参阅 <a target="_blank" rel="noopener" href="https://janino-compiler.github.io/janino/">Janino 教程</a>）。</p><p>要调试生成的类，请在启动 JVM 时设置两个系统属性：</p><ul><li><code>-Dorg.codehaus.janino.source_debugging.enable=true</code>；</li><li><code>-Dorg.codehaus.janino.source_debugging.dir=C:\tmp</code> （此属性是可选的；如果未设置，Janino 将在系统的默认临时文件位置创建临时文件，例如基于 Unix 的系统上的 <code>/tmp</code>）。</li></ul><p>代码生成后，可以进入 Intellij 将包含生成的临时文件的文件夹标记为生成的源根或源根，也可以在启动 JVM 时直接将 <code>org.codehaus.janino.source_debugging.dir</code> 的值设置为现有的源根。</p><h2 id="csv-适配器"><a class="markdownIt-Anchor" href="#csv-适配器"></a> CSV 适配器</h2><p>请参阅<a target="_blank" rel="noopener" href="https://calcite.apache.org/docs/tutorial.html">教程</a>。</p><h2 id="mongodb-适配器"><a class="markdownIt-Anchor" href="#mongodb-适配器"></a> MongoDB 适配器</h2><p>首先，下载并安装 Calcite，然后安装 <a target="_blank" rel="noopener" href="https://www.mongodb.org/downloads">MongoDB</a>。</p><p>注意：你可以从上面的集成测试虚拟机使用 MongoDB。</p><p>将 MongoDB 的邮政编码数据集导入 MongoDB：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl -o /tmp/zips.json https://media.mongodb.org/zips.json</span><br><span class="line">$ mongoimport --db <span class="built_in">test</span> --collection zips --file /tmp/zips.json</span><br><span class="line">Tue Jun  4 16:24:14.190 check 9 29470</span><br><span class="line">Tue Jun  4 16:24:14.469 imported 29470 objects</span><br></pre></td></tr></table></figure><p>登录 MongoDB 以检查它是否存在：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ mongo</span><br><span class="line">MongoDB shell version: 2.4.3</span><br><span class="line">connecting to: <span class="built_in">test</span></span><br><span class="line">&gt; db.zips.find().<span class="built_in">limit</span>(3)</span><br><span class="line">&#123; <span class="string">&quot;city&quot;</span> : <span class="string">&quot;ACMAR&quot;</span>, <span class="string">&quot;loc&quot;</span> : [ -86.51557, 33.584132 ], <span class="string">&quot;pop&quot;</span> : 6055, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;AL&quot;</span>, <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;35004&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;city&quot;</span> : <span class="string">&quot;ADAMSVILLE&quot;</span>, <span class="string">&quot;loc&quot;</span> : [ -86.959727, 33.588437 ], <span class="string">&quot;pop&quot;</span> : 10616, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;AL&quot;</span>, <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;35005&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;city&quot;</span> : <span class="string">&quot;ADGER&quot;</span>, <span class="string">&quot;loc&quot;</span> : [ -87.167455, 33.434277 ], <span class="string">&quot;pop&quot;</span> : 3205, <span class="string">&quot;state&quot;</span> : <span class="string">&quot;AL&quot;</span>, <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;35006&quot;</span> &#125;</span><br><span class="line">&gt; <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">bye</span></span><br></pre></td></tr></table></figure><p>使用 <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/main/mongodb/src/test/resources/mongo-model.json">mongo-model.json</a> Calcite 模型进行连接：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ ./sqlline</span><br><span class="line">sqlline&gt; !connect jdbc:calcite:model=mongodb/src/test/resources/mongo-model.json admin admin</span><br><span class="line">Connecting to jdbc:calcite:model=mongodb/src/test/resources/mongo-model.json</span><br><span class="line">Connected to: Calcite (version 1.x.x)</span><br><span class="line">Driver: Calcite JDBC Driver (version 1.x.x)</span><br><span class="line">Autocommit status: <span class="literal">true</span></span><br><span class="line">Transaction isolation: TRANSACTION_REPEATABLE_READ</span><br><span class="line">sqlline&gt; !tables</span><br><span class="line">+------------+--------------+-----------------+---------------+</span><br><span class="line">| TABLE_CAT  | TABLE_SCHEM  |   TABLE_NAME    |  TABLE_TYPE   |</span><br><span class="line">+------------+--------------+-----------------+---------------+</span><br><span class="line">| null       | mongo_raw    | zips            | TABLE         |</span><br><span class="line">| null       | mongo_raw    | system.indexes  | TABLE         |</span><br><span class="line">| null       | mongo        | ZIPS            | VIEW          |</span><br><span class="line">| null       | metadata     | COLUMNS         | SYSTEM_TABLE  |</span><br><span class="line">| null       | metadata     | TABLES          | SYSTEM_TABLE  |</span><br><span class="line">+------------+--------------+-----------------+---------------+</span><br><span class="line">sqlline&gt; <span class="keyword">select</span> count(*) from zips;</span><br><span class="line">+---------+</span><br><span class="line">| EXPR<span class="variable">$0</span>  |</span><br><span class="line">+---------+</span><br><span class="line">| 29467   |</span><br><span class="line">+---------+</span><br><span class="line">1 row selected (0.746 seconds)</span><br><span class="line">sqlline&gt; !quit</span><br><span class="line">Closing: org.apache.calcite.jdbc.FactoryJdbc41<span class="variable">$CalciteConnectionJdbc41</span></span><br><span class="line">$</span><br></pre></td></tr></table></figure><h2 id="splunk-适配器"><a class="markdownIt-Anchor" href="#splunk-适配器"></a> Splunk 适配器</h2><p>要针对 Splunk 运行测试套件和示例查询，请按照 <a target="_blank" rel="noopener" href="https://docs.splunk.com/Documentation/Splunk/6.0.2/PivotTutorial/GetthetutorialdataintoSplunk">Splunk 教程</a>中的说明加载 Splunk 的 <code>tutorialdata.zip</code> 数据集。</p><p>（此步骤是可选的，但它为示例查询提供了一些有趣的数据。如果你打算使用 <code>-Dcalcite.test.splunk=true</code> 运行测试套件，则这也是必要的。）</p><h2 id="实现一个适配器"><a class="markdownIt-Anchor" href="#实现一个适配器"></a> 实现一个适配器</h2><p>可以通过实现 <code>CalcitePrepare.Context</code> 创建新的适配器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.calcite.adapter.java.JavaTypeFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.jdbc.CalcitePrepare;</span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.jdbc.CalciteSchema;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdapterContext</span> <span class="keyword">implements</span> <span class="title class_">CalcitePrepare</span>.Context &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> JavaTypeFactory <span class="title function_">getTypeFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// adapter implementation</span></span><br><span class="line">    <span class="keyword">return</span> typeFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> CalciteSchema <span class="title function_">getRootSchema</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// adapter implementation</span></span><br><span class="line">    <span class="keyword">return</span> rootSchema;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="用-java-测试适配器"><a class="markdownIt-Anchor" href="#用-java-测试适配器"></a> 用 Java 测试适配器</h3><p>下面的示例显示了如何使用自定义上下文（在本例中为 <code>AdapterContext</code> ）将 SQL 查询提交到 <code>CalcitePrepare</code> 。 Calcite 使用 <code>Context</code> 提供的资源准备并实现查询执行。 <code>CalcitePrepare.PrepareResult</code> 提供对底层枚举和枚举方法的访问。可枚举本身自然可以是某些适配器特定的实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.calcite.jdbc.CalcitePrepare;</span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.prepare.CalcitePrepareImpl;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdapterContextTest</span> &#123;</span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectAllFromTable</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">AdapterContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdapterContext</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM TABLENAME&quot;</span>;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">elementType</span> <span class="operator">=</span> Object[].class;</span><br><span class="line">    CalcitePrepare.PrepareResult&lt;Object&gt; prepared =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">CalcitePrepareImpl</span>().prepareSql(ctx, sql, <span class="literal">null</span>, elementType, -<span class="number">1</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">enumerable</span> <span class="operator">=</span> prepared.getExecutable();</span><br><span class="line">    <span class="comment">// etc.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="面向开发者的高级主题"><a class="markdownIt-Anchor" href="#面向开发者的高级主题"></a> 面向开发者的高级主题</h1><p>如果你要向代码库的特定部分添加功能，则可能会对以下部分感兴趣。如果你只是从源代码构建并运行测试，则不需要了解这些主题。</p><h2 id="java-类型工厂"><a class="markdownIt-Anchor" href="#java-类型工厂"></a> Java 类型工厂</h2><p>当 Calcite 比较类型（ <code>RelDataType</code> 的实例）时，它要求它们是同一对象。如果有两个不同的类型实例引用相同的 Java 类型，Calcite 可能无法识别它们是否匹配。建议：</p><ul><li>在 Calcite 上下文中使用 <code>JavaTypeFactory</code> 的单个实例；</li></ul><ul><li>存储类型，以便始终为相同类型返回相同的对象。</li></ul><h2 id="重建生成的-protocol-buffer-代码"><a class="markdownIt-Anchor" href="#重建生成的-protocol-buffer-代码"></a> 重建生成的 Protocol Buffer 代码</h2><p>Calcite 的 Avatica Server 组件支持使用 <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a> 的 RPC 序列化。在 Avatica 的上下文中，Protocol Buffers 可以生成由模式定义的消息集合。该库本身可以使用新模式解析旧的序列化消息。在不保证客户端和服务器具有相同版本的对象的环境中，这是非常需要的。</p><p>通常，Protocol Buffers 库生成的代码不需要仅在每次构建时重新生成，仅当架构更改时才需要重新生成。</p><p>首先，安装Protobuf 3.0：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/google/protobuf/releases/download/v3.0.0-beta-1/protobuf-java-3.0.0-beta-1.tar.gz</span><br><span class="line">$ tar xf protobuf-java-3.0.0-beta-1.tar.gz &amp;&amp; <span class="built_in">cd</span> protobuf-3.0.0-beta-1</span><br><span class="line">$ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ <span class="built_in">sudo</span> make install</span><br></pre></td></tr></table></figure><p>然后，重新生成编译后的代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> avatica/core</span><br><span class="line">$ ./src/main/scripts/generate-protobuf.sh</span><br></pre></td></tr></table></figure><h2 id="创建优化器规则"><a class="markdownIt-Anchor" href="#创建优化器规则"></a> 创建优化器规则</h2><p>创建一个扩展 <code>RelRule</code> 的类（或者偶尔是一个子类）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Planner rule that matches a &#123;<span class="doctag">@link</span> Filter&#125; and futzes with it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> CoreRules#FILTER_FUTZ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FilterFutzRule</span> <span class="keyword">extends</span> <span class="title class_">RelRule</span>&lt;FilterFutzRule.Config&gt; &#123;</span><br><span class="line">  <span class="comment">/** Creates a FilterFutzRule. */</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">FilterFutzRule</span><span class="params">(Config config)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(config);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> onMatch(RelOptRuleCall call) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> call.rels(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">RelNode</span> <span class="variable">newRel</span> <span class="operator">=</span> ...;</span><br><span class="line">    call.transformTo(newRel);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Rule configuration. */</span></span><br><span class="line">  <span class="keyword">interface</span> <span class="title class_">Config</span> <span class="keyword">extends</span> <span class="title class_">RelRule</span>.Config &#123;</span><br><span class="line">    <span class="type">Config</span> <span class="variable">DEFAULT</span> <span class="operator">=</span> EMPTY.as(Config.class)</span><br><span class="line">        .withOperandSupplier(b0 -&gt;</span><br><span class="line">            b0.operand(LogicalFilter.class).anyInputs())</span><br><span class="line">        .as(Config.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">default</span> FilterFutzRule <span class="title function_">toRule</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FilterFutzRule</span>(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>类名应指示匹配的基本 RelNode 类型，有时后跟规则的作用，然后是单词 <code>Rule</code> 。示例： <code>ProjectFilterTransposeRule</code> 、 <code>FilterMergeRule</code> 。</p><p>该规则必须有一个以 <code>Config</code> 作为参数的构造函数。它应该是 <code>protected</code> ，并且只会从 <code>Config.toRule()</code> 调用。</p><p>该类必须包含一个名为 <code>Config</code> 的接口，该接口扩展 <code>RelRule.Config</code> （或规则的超类的配置）。</p><p><code>Config</code> 必须实现 <code>toRule</code> 方法并创建规则。</p><p><code>Config</code> 必须有一个名为 <code>DEFAULT</code> 的成员来创建典型配置。至少，它必须调用 <code>withOperandSupplier</code> 来创建典型的算子树。</p><p>该规则不应具有静态 <code>INSTANCE</code> 字段。持有者类中应该有一个规则实例，例如 <code>CoreRules</code> 或 <code>EnumerableRules</code> ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoreRules</span> &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Rule that matches a &#123;<span class="doctag">@link</span> Filter&#125; and futzes with it. */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">final</span> <span class="variable">FILTER_FUTZ</span> <span class="operator">=</span> FilterFutzRule.Config.DEFAULT.toRule();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>持有者类可以包含具有不同参数的规则的其他实例（如果常用）。</p><p>如果规则是使用多种操作数模式实例化的（例如，使用相同 RelNode 基类的不同子类，或者使用不同的谓词），则配置可能包含一个方法 <code>withOperandFor</code> 以使其更容易构建常见的操作数模式（参见 <code>FilterAggregateTransposeRule</code> 示例）。</p><h1 id="提交者的高级主题"><a class="markdownIt-Anchor" href="#提交者的高级主题"></a> 提交者的高级主题</h1><p>以下部分是 Calcite 提交者，特别是发布经理感兴趣的。</p><h2 id="通过-github-管理-calcite-仓库"><a class="markdownIt-Anchor" href="#通过-github-管理-calcite-仓库"></a> 通过 GitHub 管理 Calcite 仓库</h2><p>提交者拥有对 Calcite 的 <a target="_blank" rel="noopener" href="https://gitbox.apache.org/repos/asf#calcite">ASF git 存储库</a>的写入权限，该存储库托管项目的源代码以及网站。</p><p>GitBox 上的所有存储库都可以在 GitHub 上使用，并启用写入访问权限，包括打开/关闭/合并拉取请求和解决问题的权限。</p><p>为了利用 GitHub 服务，提交者应通过<a target="_blank" rel="noopener" href="https://gitbox.apache.org/setup/">帐户链接页面</a>链接其 ASF 和 GitHub 帐户。</p><p>步骤如下：</p><ul><li>将你的 GitHub 用户名设置到你的 <a target="_blank" rel="noopener" href="https://id.apache.org/">Apache 配置文件</a>中；</li><li>在你的 GitHub 帐户上启用 <a target="_blank" rel="noopener" href="https://help.github.com/articles/securing-your-account-with-two-factor-authentication-2fa/">GitHub 2FA</a>；</li><li>激活 GitHub 2FA 会更改身份验证过程，并可能影响你<a target="_blank" rel="noopener" href="https://help.github.com/en/github/authenticating-to-github/accessing-github-using-two-factor-authentication#using-two-factor-authentication-with-the-command-line">访问 GitHub</a> 的方式。你可能需要建立个人访问令牌或将公共 SSH 密钥上传到 GitHub，具体取决于你使用的协议（HTTPS 与 SSH）；</li><li>使用<a target="_blank" rel="noopener" href="https://gitbox.apache.org/setup/">帐户链接页面</a>合并你的 Apache 和 GitHub 帐户（你应该在 GitBox 中看到 3 个绿色对勾）；</li><li>至少等待 30 分钟，你将收到邀请你加入 Apache GitHub 组织的电子邮件；</li><li>接受邀请并验证你是<a target="_blank" rel="noopener" href="https://github.com/orgs/apache/teams/calcite-committers/members">团队成员</a>。</li></ul><h2 id="合并拉取请求"><a class="markdownIt-Anchor" href="#合并拉取请求"></a> 合并拉取请求</h2><p>这些是针对 Calcite 提交者的说明，他已审查了贡献者的拉取请求，发现它令人满意，并将其合并到 main。通常贡献者不是提交者（否则，在你在审查中批准后，他们会自己提交）。</p><p>有些类型的持续集成测试不会针对 PR 自动运行。可以通过向 PR 添加适当的标签来显式触发这些测试。例如，你可以通过添加 <code>slow-tests-needed</code> 标签来运行慢速测试。由你决定是否需要在合并之前运行这些附加测试。</p><p>如果 PR 有多个提交，请将它们压缩为单个提交。提交消息应遵循<a target="_blank" rel="noopener" href="https://calcite.apache.org/develop/#contributing">贡献指南</a>中概述的约定。如果存在冲突，最好要求贡献者执行此步骤，否则最好手动执行此操作，因为这样可以节省时间，也可以避免向 GitHub 上的许多人发送不必要的通知消息。</p><p>如果通过命令行（而不是通过 GitHub Web 界面）执行合并，请确保消息包含一行 <code>Close apache/calcite#YYY</code>，其中 YYY 是 GitHub 拉取请求标识符。</p><p>当 PR 合并并推送后，请务必更新 JIRA 案例。你必须：</p><ul><li>解决问题（不要关闭它，因为这将由发布经理完成）；</li><li>选择<code>已修复</code>作为解决原因；</li><li>在<code>修复版本</code>字段中标记适当的版本（例如 1.20.0）；</li><li>添加评论（例如，<code>已修复……</code>），其中包含指向解决问题的提交的超链接（在 GitHub 或 GitBox 中），并感谢贡献者的贡献（如果贡献者是已经是提交者了）。提供的超链接应该是相对于主分支的。你应该能够通过浏览来识别提交——<a target="_blank" rel="noopener" href="https://github.com/apache/calcite/commits/main/%E3%80%82">https://github.com/apache/calcite/commits/main/。</a></li></ul><h2 id="设置-pgp-签名密钥"><a class="markdownIt-Anchor" href="#设置-pgp-签名密钥"></a> 设置 PGP 签名密钥</h2><p>按照<a target="_blank" rel="noopener" href="https://www.apache.org/dev/release-signing">此处</a>的说明创建密钥对（在 macOS 上，我执行了 <code>brew install gpg</code> 和 <code>gpg --full-generate-key</code>）。</p><p>按照 <a target="_blank" rel="noopener" href="https://dist.apache.org/repos/dist/release/calcite/KEYS">KEYS</a> 文件中的说明将你的公钥添加到 <code>KEYS</code> 文件中。如果你没有更新 <code>KEYS</code> 文件的权限，请向 PMC 寻求帮助（ <code>KEYS</code> 文件不存在于 git 存储库或发布 tar 球中，因为这是<a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/CALCITE-1746">多余的</a>）。</p><p>为了能够制作候选版本，请确保将密钥上传到 <a target="_blank" rel="noopener" href="https://keyserver.ubuntu.com">https://keyserver.ubuntu.com</a> 和/或 <a target="_blank" rel="noopener" href="http://pool.sks-keyservers.net:11371">http://pool.sks-keyservers.net:11371</a>（Nexus 使用的密钥服务器）。</p><h2 id="设置-nexus-存储库凭据"><a class="markdownIt-Anchor" href="#设置-nexus-存储库凭据"></a> 设置 Nexus 存储库凭据</h2><p>Gradle 提供了多种<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/build_environment.html#sec:gradle_configuration_properties">配置项目属性</a>的方法。例如，你可以更新 <code>$HOME/.gradle/gradle.properties</code>。</p><p>注意：构建脚本会打印缺少的属性，因此你可以尝试运行它并让它抱怨缺少的属性。</p><p>使用以下选项：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">asfCommitterId</span>=<span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="attr">asfNexusUsername</span>=<span class="string"></span></span><br><span class="line"><span class="attr">asfNexusPassword</span>=<span class="string"></span></span><br><span class="line"><span class="attr">asfSvnUsername</span>=<span class="string"></span></span><br><span class="line"><span class="attr">asfSvnPassword</span>=<span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="attr">asfGitSourceUsername</span>=<span class="string"></span></span><br><span class="line"><span class="attr">asfGitSourcePassword</span>=<span class="string"></span></span><br></pre></td></tr></table></figure><p>注意：</p><ul><li><code>asfNexusUsername</code> 和 <code>asfSvnUsername</code> 都是你的 apache id， <code>asfNexusPassword</code> 和 <code>asfSvnPassword</code> 是相应的密码；</li><li>Git 源帐户可以配置为 Gitbox（默认）或 Github。对于 Gitbox， <code>asfGitSourceUsername</code> 是你的 apache id， <code>asfGitSourcePassword</code> 是相应的密码。对于 Github， <code>asfGitSourceUsername</code> 是你的 GitHub id，而 <code>asfGitSourcePassword</code> 不是你的 GitHub 密码，你需要在 <a target="_blank" rel="noopener" href="https://github.com/settings/tokens">https://github.com/settings/tokens</a> 中选择 <code>Personal access tokens</code>。</li></ul><p>当使用 <a target="_blank" rel="noopener" href="https://github.com/vlsi/asflike-release-environment">asflike-release-environment</a> 时，凭据取自 <code>asfTest...</code> （例如 <code>asfTestNexusUsername=test</code> ）</p><p>注意：如果你想使用 <code>gpg-agent</code> ，你需要传递一些更多的属性：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">useGpgCmd</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">signing.gnupg.keyName</span>=<span class="string"></span></span><br><span class="line"><span class="attr">signing.gnupg.useLegacyGpg</span>=<span class="string"></span></span><br></pre></td></tr></table></figure><h2 id="制作快照"><a class="markdownIt-Anchor" href="#制作快照"></a> 制作快照</h2><p>在你开始之前：</p><ul><li>确保你使用的是 JDK 8。注意：如果你使用基于 OpenJDK 的 Java，则需要 Java 8u202 或更高版本。</li><li>使用 <code>-Dcalcite.test.db=hsqldb</code> （默认）确保构建和测试成功。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Make sure that there are no junk files in the sandbox</span></span><br><span class="line">git clean -xn</span><br><span class="line"><span class="comment"># Publish snapshot artifacts</span></span><br><span class="line">./gradlew clean publish -Pasf</span><br></pre></td></tr></table></figure><h2 id="制作候选版本"><a class="markdownIt-Anchor" href="#制作候选版本"></a> 制作候选版本</h2><p>注意：发布构建（<code>dist.apache.org</code> 和 <code>repository.apache.org</code>）通过 <a target="_blank" rel="noopener" href="https://github.com/vlsi/vlsi-release-plugins/tree/master/plugins/stage-vote-release-plugin">stage-vote-release-plugin</a> 进行管理。</p><p>在你开始之前：</p><ul><li>请查阅<a target="_blank" rel="noopener" href="https://issues.apache.org/jira/secure/Dashboard.jspa?selectPageId=12333950">发布仪表板</a>以快速了解发布状态，并采取适当的操作来解决待处理的票证或将其移至另一个版本/待办事项；</li><li>发送电子邮件至 <a href="mailto:dev@calcite.apache.org">dev@calcite.apache.org</a> 通知 RC 构建过程正在启动，因此 <code>main</code> 分支处于代码冻结状态，直至另行通知；</li><li>如上所述设置签名密钥；</li><li>确保你使用的是 JDK 8（而不是 9 或 10）；</li><li>检查 <code>README</code> 和 <code>site/_docs/howto.md</code> 的版本号是否正确；</li><li>检查 <code>site/_docs/howto.md</code> 是否具有正确的 Gradle 版本；</li><li>检查 <code>NOTICE</code> 是否具有当前版权年份；</li><li>检查 <code>calcite.version</code> 在 <code>/gradle.properties</code> 中是否具有正确的值；</li><li>确保构建和测试成功；</li><li>确保 <code>./gradlew javadoc</code> 成功（即没有给出错误；警告也可以）；</li><li>使用 <code>./gradlew dependencyCheckUpdate dependencyCheckAggregate</code> 生成依赖项之间发生的漏洞的报告。如果在依赖项中发现新的严重漏洞，请向 <a href="mailto:private@calcite.apache.org">private@calcite.apache.org</a> 报告；</li><li>确定JDK、操作系统和Guava支持的配置。这些可能与先前版本的发行说明中描述的相同。将它们记录在发行说明中。要测试 Guava 版本 x.y，请指定 <code>-Pguava.version=x.y</code>；</li><li>使用属性的可选测试：<ul><li><code>-Dcalcite.test.db=mysql</code>；</li><li><code>-Dcalcite.test.db=hsqldb</code>；</li><li><code>-Dcalcite.test.mongodb</code>；</li><li><code>-Dcalcite.test.splunk</code>。</li></ul></li><li>使用任务的可选测试：<ul><li><code>./gradlew testSlow</code>；</li></ul></li><li>将发行说明添加到 <code>site/_docs/history.md</code> 。如果要发布的版本已存在发行说明，但已被注释掉，请删除注释（ <code>&#123;% comment %&#125;` 和 `&#123;% endcomment %&#125;</code> ）。包括提交历史记录、对该版本做出贡献的人员姓名，并说明该版本针对哪些版本的 Java、Guava 和操作系统进行了测试；</li><li>确保每个<a target="_blank" rel="noopener" href="https://issues.apache.org/jira/issues/?jql=project%20%3D%20CALCITE%20AND%20status%20%3D%20Resolved%20and%20fixVersion%20is%20null">已解决的 JIRA 案例</a>（包括重复的案例）都分配了一个修复版本（很可能是我们即将发布的版本）。</li></ul><p>生成贡献者列表：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Commits since 1.35</span></span><br><span class="line">range=calcite-1.35.0..HEAD</span><br><span class="line"><span class="comment"># distinct authors</span></span><br><span class="line">git <span class="built_in">log</span> --abbrev-commit --pretty=format:<span class="string">&#x27;%aN,&#x27;</span> <span class="variable">$range</span> | <span class="built_in">sort</span> -u</span><br><span class="line"><span class="comment"># most prolific authors</span></span><br><span class="line">git <span class="built_in">log</span> --abbrev-commit --pretty=format:<span class="string">&#x27;%aN&#x27;</span> <span class="variable">$range</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"><span class="comment"># number of JIRA cases</span></span><br><span class="line">git <span class="built_in">log</span> --abbrev-commit --pretty=format:<span class="string">&#x27;%f&#x27;</span> <span class="variable">$range</span> | awk -F- <span class="string">&#x27;$1 == &quot;CALCITE&quot; &#123;print $2&#125;&#x27;</span> | <span class="built_in">sort</span> -u | <span class="built_in">wc</span></span><br></pre></td></tr></table></figure><p>使用 Spatial 和 Oracle 函数表进行冒烟测试 <code>sqlline</code> ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ./sqlline</span><br><span class="line">&gt; !connect jdbc:calcite:fun=spatial,oracle <span class="string">&quot;sa&quot;</span> <span class="string">&quot;&quot;</span></span><br><span class="line">SELECT NVL(ST_Is3D(ST_PointFromText(<span class="string">&#x27;POINT(-71.064544 42.28787)&#x27;</span>)), TRUE);</span><br><span class="line">+--------+</span><br><span class="line">| EXPR<span class="variable">$0</span> |</span><br><span class="line">+--------+</span><br><span class="line">| <span class="literal">false</span>  |</span><br><span class="line">+--------+</span><br><span class="line">1 row selected (0.039 seconds)</span><br><span class="line">&gt; !quit</span><br></pre></td></tr></table></figure><p>候选版本进程不会添加提交，因此即使失败也不会造成任何影响。它可能会留下 <code>-rc</code> 标记，如果需要可以将其删除。</p><p>如果你愿意，你可以在 <a target="_blank" rel="noopener" href="https://github.com/vlsi/asflike-release-environment">asflike-release-environment</a> 的帮助下执行试运行发布；它会执行相同的步骤，但会将更改推送到模拟 Nexus、Git 和 SVN 服务器。</p><p>如果任何步骤失败，请解决问题，然后从头开始。</p><h3 id="开始候选版本构建"><a class="markdownIt-Anchor" href="#开始候选版本构建"></a> 开始候选版本构建</h3><p>选择一个候选版本索引并确保它不会干扰该版本之前的候选版本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Tell GPG how to read a password from your terminal</span></span><br><span class="line"><span class="built_in">export</span> GPG_TTY=$(<span class="built_in">tty</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make sure that there are no junk files in the sandbox</span></span><br><span class="line">git clean -xn</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dry run the release candidate (push to asf-like-environment)</span></span><br><span class="line">./gradlew prepareVote -Prc=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Push release candidate to ASF servers</span></span><br><span class="line"><span class="comment"># If you prefer to use Github account, change pushRepositoryProvider to GITHUB</span></span><br><span class="line">./gradlew prepareVote -Prc=0 -Pasf -Pasf.git.pushRepositoryProvider=GITBOX</span><br></pre></td></tr></table></figure><h3 id="故障排除"><a class="markdownIt-Anchor" href="#故障排除"></a> 故障排除</h3><ul><li><code>net.rubygrapefruit.platform.NativeException: Could not start 'svnmucc'</code> ：确保你的计算机中安装了 <code>svnmucc</code> 命令；</li><li><code>Execution failed for task ':closeRepository' ... Possible staging rules violation. Check repository status using Nexus UI</code> ：登录 Nexus UI 查看实际错误。如果是 <code>Failed: Signature Validation. No public key: Key with id: ... was not able to be located</code> ，请确保你已将密钥上传到 Nexus 使用的密钥服务器，请参阅上文；</li><li><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/CALCITE-5573">[CALCITE-5573]</a> 签署构建时 GradleprepareVote 失败；</li><li><a target="_blank" rel="noopener" href="https://github.com/vlsi/vlsi-release-plugins/issues/64">[VLSI-RELEASE-PLUGINS-64]</a> 由于缺少 <code>nexus.txt</code>，任务 <code>:releaseRepository</code> 执行失败。</li></ul><h3 id="检查构建"><a class="markdownIt-Anchor" href="#检查构建"></a> 检查构建</h3><ul><li><code>release/build/distributions</code> 目录中应包含以下 3 个文件，其中包括：<ul><li><code>apache-calcite-X.Y.Z-src.tar.gz</code>；</li><li><code>apache-calcite-X.Y.Z-src.tar.gz.asc</code>；</li><li><code>apache-calcite-X.Y.Z-src.tar.gz.sha512</code>。</li></ul></li><li>请注意，文件名以 <code>apache-calcite-</code> 开头；</li><li>在源发行版 <code>.tar.gz</code> （当前没有二进制发行版）中，检查所有文件是否属于名为 <code>apache-calcite-X.Y.Z-src</code> 的目录；</li><li>该目录必须包含文件 <code>NOTICE</code> 、 <code>LICENSE</code> 、 <code>README</code> 、 <code>README.md</code>；<ul><li>检查 <code>README</code> 中的版本是否正确；</li><li>检查 <code>NOTICE</code> 中的版权年份是否正确；</li><li>检查 <code>LICENSE</code> 是否与签入 git 的文件相同。</li></ul></li><li>确保以下文件不会出现在源发行版中： <code>KEYS</code> 、 <code>gradlew</code> 、 <code>gradlew.bat</code> 、 <code>gradle-wrapper.jar</code> 、 <code>gradle-wrapper.properties</code>；</li><li>确保源发行版中没有 <code>KEYS</code> 文件；</li><li>在每个 .jar（例如 <code>core/build/libs/calcite-core-X.Y.Z.jar</code> 和 <code>mongodb/build/libs/calcite-mongodb-X.Y.Z-sources.jar</code> ）中，检查 <code>META-INF</code> 目录是否包含 <code>LICENSE</code> 、 <code>NOTICE</code>；</li><li>检查 PGP，按照<a target="_blank" rel="noopener" href="https://httpd.apache.org/dev/verification.html">此文档</a>。</li></ul><p>验证 Nexus 存储库中的暂存构建：</p><ul><li>访问 <a target="_blank" rel="noopener" href="https://repository.apache.org/">https://repository.apache.org/</a> 并登录；</li><li>在 <code>Build Promotion</code> 下，单击 <code>Staging Repositories</code>；</li><li>在 <code>Staging Repositories</code> 选项卡中应该有一行包含配置文件 <code>org.apache.calcite</code> 和状态 <code>closed</code>；</li><li>浏览工件树并确保 .jar、.pom、.asc 文件存在。</li></ul><h2 id="尝试发布失败后进行清理"><a class="markdownIt-Anchor" href="#尝试发布失败后进行清理"></a> 尝试发布失败后进行清理</h2><p>如果某些内容不正确，你可以修复它，提交它，并为下一个候选人做好准备。候选版本标签可能会保留一段时间。</p><h2 id="验证发布"><a class="markdownIt-Anchor" href="#验证发布"></a> 验证发布</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check that the signing key (e.g. DDB6E9812AD3FAE3) is pushed</span></span><br><span class="line">gpg --recv-keys key</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check keys</span></span><br><span class="line">curl -O https://dist.apache.org/repos/dist/release/calcite/KEYS</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sign/check sha512 hashes</span></span><br><span class="line"><span class="comment"># (Assumes your O/S has a &#x27;shasum&#x27; command.)</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">checkHash</span></span>() &#123;</span><br><span class="line">  <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> *.&#123;pom,gz&#125;; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -f <span class="variable">$i</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="variable">$i</span>.sha512 ]; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> [ <span class="string">&quot;<span class="subst">$(cat $i.sha512)</span>&quot;</span> = <span class="string">&quot;<span class="subst">$(shasum -a 512 $i)</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$i</span>.sha512 present and correct</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$i</span>.sha512 does not match</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      shasum -a 512 <span class="variable">$i</span> &gt; <span class="variable">$i</span>.sha512</span><br><span class="line">      <span class="built_in">echo</span> <span class="variable">$i</span>.sha512 created</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line">checkHash apache-calcite-X.Y.Z-rcN</span><br></pre></td></tr></table></figure><h2 id="通过-apache-投票流程获得发布批准"><a class="markdownIt-Anchor" href="#通过-apache-投票流程获得发布批准"></a> 通过 Apache 投票流程获得发布批准</h2><p>通过向开发者列表发送电子邮件来开始投票。如果成功完成，Gradle <code>prepareVote</code> 任务会在最后打印草稿邮件。你可以在 <code>/build/prepareVote/mail.txt</code> 中找到草稿。</p><p>投票结束后，发送结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Subject: [RESULT] [VOTE] Release apache-calcite-X.Y.Z (release candidate N)</span><br><span class="line">To: dev@calcite.apache.org</span><br><span class="line"></span><br><span class="line">Thanks to everyone who has tested the release candidate and given</span><br><span class="line">their comments and votes.</span><br><span class="line"></span><br><span class="line">The tally is as follows.</span><br><span class="line"></span><br><span class="line">N binding +1s:</span><br><span class="line">&lt;names&gt;</span><br><span class="line"></span><br><span class="line">N non-binding +1s:</span><br><span class="line">&lt;names&gt;</span><br><span class="line"></span><br><span class="line">No 0s or -1s.</span><br><span class="line"></span><br><span class="line">Therefore, I am delighted to announce that the proposal to release</span><br><span class="line">Apache Calcite X.Y.Z has passed.</span><br><span class="line"></span><br><span class="line">Thanks everyone. We’ll now roll the release out to the mirrors.</span><br><span class="line"></span><br><span class="line">There was some feedback during voting. I shall open a separate</span><br><span class="line">thread to discuss.</span><br><span class="line"></span><br><span class="line">Julian</span><br></pre></td></tr></table></figure><h2 id="发布版本"><a class="markdownIt-Anchor" href="#发布版本"></a> 发布版本</h2><p>成功发布投票后，我们需要将版本推送到镜像和其他任务。</p><p>选择发布日期。这是基于你预计宣布发布的时间。这通常是投票结束后的一天。请记住，UTC 日期在太平洋时间下午 4 点更改。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dry run publishing the release (push to asf-like-environment)</span></span><br><span class="line">./gradlew publishDist -Prc=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Publish the release to ASF servers</span></span><br><span class="line"><span class="comment"># If you prefer to use Github account, change pushRepositoryProvider to GITHUB</span></span><br><span class="line">./gradlew publishDist -Prc=0 -Pasf -Pasf.git.pushRepositoryProvider=GITBOX</span><br></pre></td></tr></table></figure><p>如果由于某种原因 <code>publishDist</code> 任务失败（例如<a target="_blank" rel="noopener" href="https://github.com/vlsi/vlsi-release-plugins/issues/64">未能发布 nexus 存储库</a>，仍然可以手动执行发布任务。如果你不确定需要做什么，请在开发列表中寻求帮助。</p><p>如果 <code>releaseRepository</code> 任务打印如下内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; Task :releaseRepository</span><br><span class="line">Initialized stagingRepositoryId orgapachecalcite-1219 for repository nexus</span><br><span class="line">GET request failed. 404: Not Found, body: [errors:[[id:*, msg:No such repository: orgapachecalcite-1219]]]</span><br><span class="line">Requested operation was executed successfully in attempt 83 (maximum allowed 601)</span><br></pre></td></tr></table></figure><p>很可能存储库已成功发布，你可以在 <a target="_blank" rel="noopener" href="https://repository.apache.org/">ASF Nexus</a> 中检查它。</p><p>Svnpubsub 将发布到<a target="_blank" rel="noopener" href="https://dist.apache.org/repos/dist/release/calcite">发布存储库</a>并几乎立即传播到<a target="_blank" rel="noopener" href="https://www.apache.org/dyn/closer.cgi/calcite">镜像</a>。因此无需等待超过十五分钟即可宣布发布。</p><p>如果现在有超过 2 个版本，请清除最旧的版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/dist/release/calcite</span><br><span class="line">svn <span class="built_in">rm</span> apache-calcite-X.Y.Z</span><br><span class="line">svn ci</span><br></pre></td></tr></table></figure><p>旧版本将保留在<a target="_blank" rel="noopener" href="https://archive.apache.org/dist/calcite/">版本存档</a>中。</p><p>你应该会收到一封来自 <a href="">Apache Reporter Service</a> 的电子邮件。请务必在电子邮件中链接的网站上添加最新版本的版本号和日期。</p><p>一旦发布提交/标签到达 ASF 远程并触发相应的 <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/main/.github/workflows/">Github 工作流程</a>，新版本的发行说明和 javadoc 将自动部署到网站。</p><p>通过复制 <a href="site/_posts/2016-10-12-release-1.10.0.md">site/_posts/2016-10-12-release-1.10.0.md</a> 添加发布公告，并根据需要调整 <code>history.md</code> 中的发布日期。按照 <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/main/site/README.md">site/README.md</a> 中的说明在本地预览更改，然后提交更改并将其推送到 <code>main</code> 分支。请注意，由于 <a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/CALCITE-5584">CALCITE-5584</a>，该提交应作为最后一次提交推送到 Github，不要将其与<code>准备下一次开发迭代</code>提交链接。</p><p>确保正确显示网站的所有更改（新闻、发行说明、javadoc）。</p><p>在 JIRA 中，搜索<a target="_blank" rel="noopener" href="https://issues.apache.org/jira/issues/?jql=project%20%3D%20CALCITE%20and%20fixVersion%20%3D%201.5.0%20and%20status%20%3D%20Resolved%20and%20resolution%20%3D%20Fixed">此版本中解决的所有问题</a>，然后进行批量更新（选择 <code>transition issues</code> 选项），将其状态更改为“已关闭”，并添加更改注释“已在版本 X.Y.Z (YYYY-MM) 中解决” -DD)”（适当填写版本号和日期）。取消选中“发送此更新的邮件”。在 Calcite 项目的<a target="_blank" rel="noopener" href="https://issues.apache.org/jira/projects/CALCITE?selectedItem=com.atlassian.jira.jira-projects-plugin%3Arelease-page&amp;status=released-unreleased">发布选项卡</a>下，将发布 X.Y.Z 标记为已发布。如果尚不存在，请为下一个版本创建一个新版本（例如，X.Y+1.Z）。为了使<a target="_blank" rel="noopener" href="https://issues.apache.org/jira/secure/Dashboard.jspa?selectPageId=12333950">发布仪表板</a>反映下一个版本的状态，请更改为<a target="_blank" rel="noopener" href="https://issues.apache.org/jira/issues/?filter=12346388">仪表板提供支持的 JIRA 过滤器</a>中的修复版本并保存更改。</p><p>增加 <code>/gradle.properties</code> 中的 <code>calcite.version</code> 值，提交并推送更改，并显示消息“准备下一次开发迭代”（请参阅 <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/commit/ed1470a3ea53a78c667354a5ec066425364eca73">ed1470a</a> 作为参考）。</p><p>重新打开 <code>main</code> 分支。发送电子邮件至 <a href="mailto:dev@calcite.apache.org">dev@calcite.apache.org</a> 通知 <code>main</code> 代码冻结已结束并且可以恢复提交。</p><p>通过使用 <code>@apache.org</code> 地址向 <a href="mailto:announce@apache.org">announce@apache.org</a> 发送电子邮件来宣布发布。你可以使用<a target="_blank" rel="noopener" href="https://mail-archives.apache.org/mod_mbox/www-announce/201906.mbox/%3CCA%2BEpF8tcJcZ41rVuwJODJmyRy-qAxZUQm9OxKsoDi07c2SKs_A%40mail.gmail.com%3E">1.20.0 公告</a>作为模板。请务必包含项目的简短描述。</p><h2 id="发布网站"><a class="markdownIt-Anchor" href="#发布网站"></a> 发布网站</h2><p>请参阅 <a target="_blank" rel="noopener" href="https://github.com/apache/calcite/blob/main/site/README.md">site/README.md</a> 中的说明 。</p><h1 id="pmc-成员的高级主题"><a class="markdownIt-Anchor" href="#pmc-成员的高级主题"></a> PMC 成员的高级主题</h1><h2 id="处理-jira-帐户请求"><a class="markdownIt-Anchor" href="#处理-jira-帐户请求"></a> 处理 JIRA 帐户请求</h2><p>以下是一些在处理添加 JIRA 帐户作为贡献者的请求时可以使用的电子邮件模板。</p><h3 id="帐户已添加到贡献者列表"><a class="markdownIt-Anchor" href="#帐户已添加到贡献者列表"></a> 帐户已添加到贡献者列表</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Hello [INSERT NAME HERE],</span><br><span class="line"></span><br><span class="line">Thanks for your interest in becoming a Calcite contributor! I have added your username ([INSERT USERNAME HERE])</span><br><span class="line">to the contributors group in JIRA. Happy contributing!</span><br><span class="line"></span><br><span class="line">If you have not subscribed to our development list (dev@calcite.apache.org) yet, I encourage you to do so by</span><br><span class="line">emailing dev-subscribe@calcite.apache.org. Further information about our mailing lists is available here:</span><br><span class="line">https://calcite.apache.org/community/#mailing-lists</span><br><span class="line"></span><br><span class="line">Best regards,</span><br><span class="line">[INSERT YOUR NAME HERE]</span><br></pre></td></tr></table></figure><h3 id="找不到帐户"><a class="markdownIt-Anchor" href="#找不到帐户"></a> 找不到帐户</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Hello [INSERT NAME HERE],</span><br><span class="line"></span><br><span class="line">Thanks for your interest in becoming a Calcite contributor! I am sorry to inform you that I was unable to</span><br><span class="line">find your account ([INSERT USERNAME HERE]) in JIRA and was not able to add you to the contributors group.</span><br><span class="line">Please let me know the correct username by return email and I will process your request again.</span><br><span class="line"></span><br><span class="line">If you do not have an ASF JIRA account, please follow the instructions here to request one:</span><br><span class="line">https://calcite.apache.org/develop/#i-do-not-have-an-asf-jira-account-want-to-request-an-account-and-be-added-as-a-contributor</span><br><span class="line"></span><br><span class="line">Best regards,</span><br><span class="line">[INSERT YOUR NAME HERE]</span><br></pre></td></tr></table></figure><div class="tag-plugin quot"><p class="content" type="text"><span class="empty"></span><span class="text">写在最后</span><span class="empty"></span></p></div><p>笔者因为工作原因接触到 Calcite，前期学习过程中，深感 Calcite 学习资料之匮乏，因此创建了 <a target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/group/51128414222814">Calcite 从入门到精通知识星球</a>，希望能够将学习过程中的资料和经验沉淀下来，为更多想要学习 Calcite 的朋友提供一些帮助。</p><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/xingqiu/calcite_xingqiu.png" alt="Calcite 从入门到精通"></p><div class="article-footer fs14"></div></article><div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">回顾上一篇</div><a href="/wiki/calcite/model.html">JSON/YAML 模型</a></div><div class="item" id="next"><div class="note">接下来阅读</div><a href="/wiki/calcite/develop.html">开发 Calcite</a></div></section></div><div class="related-wrap md-text" id="comments"><section class="header cmt-title cap theme"><p>快来参与讨论吧~</p></section><section class="body cmt-body giscus"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg><div id="giscus" src="https://giscus.app/client.js" data-repo="strongduanmu/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkzNzQwMDk3Njg=" data-category="Announcements" data-category-id="DIC_kwDOFkrvqM4CZIsa" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div></section></div><footer class="page-footer footnote"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs15">博客</span><a href="/categories/">分类</a><a href="/tags/">标签</a><a href="/archives/">归档</a></div><div class="sitemap-group"><span class="fs15">文档</span><a href="/wiki/calcite/background.html">Calcite</a><a href="/wiki/cmu_15_445/index.html">CMU 15-445</a><a href="/wiki/cmu_15_721/index.html">CMU 15-721</a></div><div class="sitemap-group"><span class="fs15">便笺</span><a href="/notes/">Common</a><a href="/notes/docker.html">Docker</a><a href="/notes/git.html">Git</a></div><div class="sitemap-group"><span class="fs15">更多</span><a href="/more/">关于</a><a href="/more/news/">动态</a></div></div><div class="text"><p>本站由 <a target="_blank" rel="noopener" href="https://github.com/strongduanmu">@strongduanmu</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> 主题创建，使用 <a target="_blank" rel="noopener" href="https://vercel.com/">Vercel</a> 网站部署。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。<br>本站总访问量 <span id="vercount_value_site_pv"></span> 次，本站访客数 <span id="vercount_value_site_uv"></span> 人次。</p></div></footer><div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right"><div class="widgets"><widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E5%88%86%E5%8F%91%E7%9A%84%E6%BA%90%E4%BB%A3%E7%A0%81%E6%9E%84%E5%BB%BA"><span class="toc-text">从分发的源代码构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E-git-%E6%9E%84%E5%BB%BA"><span class="toc-text">从 Git 构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gradle-%E4%B8%8E-gradle-%E5%8C%85%E8%A3%85%E5%99%A8"><span class="toc-text">Gradle 与 Gradle 包装器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7-gradle-%E5%92%8C-gradle-%E5%8C%85%E8%A3%85%E5%99%A8"><span class="toc-text">升级 Gradle 和 Gradle 包装器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="toc-text">运行测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95"><span class="toc-text">运行集成测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%87%86%E5%A4%87"><span class="toc-text">虚拟机准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AE%A1%E7%90%86"><span class="toc-text">虚拟机管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E8%AE%AE%E7%9A%84%E6%B5%8B%E8%AF%95%E6%B5%81%E7%A8%8B"><span class="toc-text">建议的测试流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82"><span class="toc-text">集成测试技术细节</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%A1%E7%8C%AE"><span class="toc-text">贡献</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-text">入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-ide-%E8%BF%9B%E8%A1%8C%E8%B4%A1%E7%8C%AE"><span class="toc-text">设置 IDE 进行贡献</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-intellij-idea"><span class="toc-text">设置 IntelliJ IDEA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-netbeans"><span class="toc-text">设置 NetBeans</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%BD%E8%B8%AAtracing"><span class="toc-text">追踪（Tracing）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8-intellij-%E4%B8%AD%E8%B0%83%E8%AF%95%E7%94%9F%E6%88%90%E7%9A%84%E7%B1%BB"><span class="toc-text">在 Intellij 中调试生成的类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#csv-%E9%80%82%E9%85%8D%E5%99%A8"><span class="toc-text">CSV 适配器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mongodb-%E9%80%82%E9%85%8D%E5%99%A8"><span class="toc-text">MongoDB 适配器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#splunk-%E9%80%82%E9%85%8D%E5%99%A8"><span class="toc-text">Splunk 适配器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%80%82%E9%85%8D%E5%99%A8"><span class="toc-text">实现一个适配器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8-java-%E6%B5%8B%E8%AF%95%E9%80%82%E9%85%8D%E5%99%A8"><span class="toc-text">用 Java 测试适配器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#java-%E7%B1%BB%E5%9E%8B%E5%B7%A5%E5%8E%82"><span class="toc-text">Java 类型工厂</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E5%BB%BA%E7%94%9F%E6%88%90%E7%9A%84-protocol-buffer-%E4%BB%A3%E7%A0%81"><span class="toc-text">重建生成的 Protocol Buffer 代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BC%98%E5%8C%96%E5%99%A8%E8%A7%84%E5%88%99"><span class="toc-text">创建优化器规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-github-%E7%AE%A1%E7%90%86-calcite-%E4%BB%93%E5%BA%93"><span class="toc-text">通过 GitHub 管理 Calcite 仓库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%88%E5%B9%B6%E6%8B%89%E5%8F%96%E8%AF%B7%E6%B1%82"><span class="toc-text">合并拉取请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-pgp-%E7%AD%BE%E5%90%8D%E5%AF%86%E9%92%A5"><span class="toc-text">设置 PGP 签名密钥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-nexus-%E5%AD%98%E5%82%A8%E5%BA%93%E5%87%AD%E6%8D%AE"><span class="toc-text">设置 Nexus 存储库凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E5%BF%AB%E7%85%A7"><span class="toc-text">制作快照</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E5%80%99%E9%80%89%E7%89%88%E6%9C%AC"><span class="toc-text">制作候选版本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E5%80%99%E9%80%89%E7%89%88%E6%9C%AC%E6%9E%84%E5%BB%BA"><span class="toc-text">开始候选版本构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4"><span class="toc-text">故障排除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%9E%84%E5%BB%BA"><span class="toc-text">检查构建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E5%8F%91%E5%B8%83%E5%A4%B1%E8%B4%A5%E5%90%8E%E8%BF%9B%E8%A1%8C%E6%B8%85%E7%90%86"><span class="toc-text">尝试发布失败后进行清理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%8F%91%E5%B8%83"><span class="toc-text">验证发布</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-apache-%E6%8A%95%E7%A5%A8%E6%B5%81%E7%A8%8B%E8%8E%B7%E5%BE%97%E5%8F%91%E5%B8%83%E6%89%B9%E5%87%86"><span class="toc-text">通过 Apache 投票流程获得发布批准</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E7%89%88%E6%9C%AC"><span class="toc-text">发布版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E7%BD%91%E7%AB%99"><span class="toc-text">发布网站</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86-jira-%E5%B8%90%E6%88%B7%E8%AF%B7%E6%B1%82"><span class="toc-text">处理 JIRA 帐户请求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%90%E6%88%B7%E5%B7%B2%E6%B7%BB%E5%8A%A0%E5%88%B0%E8%B4%A1%E7%8C%AE%E8%80%85%E5%88%97%E8%A1%A8"><span class="toc-text">帐户已添加到贡献者列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%BE%E4%B8%8D%E5%88%B0%E5%B8%90%E6%88%B7"><span class="toc-text">找不到帐户</span></a></li></ol></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget></div></aside><div class="float-panel blur"><button type="button" style="display:none" class="laptop-only rightbar-toggle mobile" onclick="sidebar.rightbar()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></button> <button type="button" style="display:none" class="mobile-only leftbar-toggle mobile" onclick="sidebar.leftbar()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg></button></div></div><div class="scripts"><script>let ctx={date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前"},root:"/",tag_plugins:{chat:Object.assign({api:"https://siteinfo.listentothewind.cn/api/v1"})},search:{}};if((ctx.search.service="local_search")==ctx.search.service){let e=Object.assign({},'{"field":"all","path":"/search.json","content":true,"skip_search":null,"codeblock":true,"sort":"-date"}');ctx.search[ctx.search.service]=e}let def={avatar:"/assets/placeholder/avatar.svg",cover:"/assets/placeholder/cover.svg"},deps={jquery:"https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js",marked:"https://cdn.jsdelivr.net/npm/marked@13.0.1/lib/marked.umd.min.js"}</script><script>function RunItem(){function n(e,t){this.name=t||e.name,this.run=()=>{try{e()}catch(e){console.log(e)}}}this.list=[],this.start=()=>{for(var e=0;e<this.list.length;e++)this.list[e].run()},this.push=(e,t,r=!0)=>{let s=e,i=new n(s=r?()=>{utils.requestAnimationFrame(e)}:s,t);this.list.push(i)},this.remove=t=>{for(let e=0;e<this.list.length;e++)this.list[e].name==t&&this.list.splice(e,1)}}let utils={css:(e,t,r,s)=>{var i,n,a=window.document,o=a.createElement("link"),d=(n=t||(i=(a.body||a.getElementsByTagName("head")[0]).childNodes)[i.length-1],a.styleSheets);if(s)for(var l in s)s.hasOwnProperty(l)&&o.setAttribute(l,s[l]);o.rel="stylesheet",o.href=e,o.media="only x",function e(t){if(a.body)return t();setTimeout(function(){e(t)})}(function(){n.parentNode.insertBefore(o,t?n:n.nextSibling)});function u(e){for(var t=o.href,r=d.length;r--;)if(d[r].href===t)return e();setTimeout(function(){u(e)})}function h(){o.addEventListener&&o.removeEventListener("load",h),o.media=r||"all"}return o.addEventListener&&o.addEventListener("load",h),o.onloadcssdefined=u,u(h),o},js:(i,n)=>new Promise((t,e)=>{var r=document.createElement("script");if(i.startsWith("/")&&(i=ctx.root+i.substring(1)),r.src=i,n)for(var s of Object.keys(n))r[s]=n[s];else r.async=!0;r.onerror=e,r.onload=r.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(r.onload=r.onreadystatechange=null,t())},document.head.appendChild(r)}),jq:e=>{"undefined"==typeof jQuery?utils.js(deps.jquery).then(e):e()},onLoading:e=>{e&&$(e).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>')},onLoadSuccess:e=>{e&&$(e).find(".loading-wrap").remove()},onLoadFailure:e=>{e&&($(e).find(".loading-wrap svg").remove(),$(e).find(".loading-wrap").append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>'),$(e).find(".loading-wrap").addClass("error"))},request:(n,a,o,d)=>{let l=3;utils.onLoading(n),function i(){new Promise((t,e)=>{let r=0,s=setTimeout(()=>{0===r&&(r=2,s=null,e("请求超时"),0==l)&&d()},5e3);fetch(a).then(function(e){if(2!==r&&(clearTimeout(s),t(e),s=null,r=1),e.ok)return e.json();throw new Error("Network response was not ok.")}).then(function(e){l=0,utils.onLoadSuccess(n),o(e)}).catch(function(e){0<l?(--l,setTimeout(()=>{i()},5e3)):(utils.onLoadFailure(n),d())})})}()},requestAnimationFrame:e=>{window.requestAnimationFrame||(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame),window.requestAnimationFrame(e)},dark:{}};utils.dark.method={toggle:new RunItem},utils.dark=Object.assign(utils.dark,{push:utils.dark.method.toggle.push})</script><script>let sidebar={leftbar:()=>{l_body&&(l_body.toggleAttribute("leftbar"),l_body.removeAttribute("rightbar"))},rightbar:()=>{l_body&&(l_body.toggleAttribute("rightbar"),l_body.removeAttribute("leftbar"))},dismiss:()=>{l_body&&(l_body.removeAttribute("leftbar"),l_body.removeAttribute("rightbar"))},toggleTOC:()=>{document.querySelector("#data-toc").classList.toggle("collapse")}}</script><script>(()=>{var e;for(e of document.querySelectorAll(".tag-subtree.parent-tag > a > .tag-switcher-wrapper"))e.addEventListener("click",e=>{e.target.closest(".tag-subtree.parent-tag").classList.toggle("expanded"),e.preventDefault()});var t=new URLSearchParams(window.location.search).get("tag");if(t){let e=document.querySelector(`.tag-subtree[data-tag="${t}"]`);if(e)for(e.querySelector("a").classList.add("active");e;)e.classList.add("expanded"),e=e.parentElement.closest(".tag-subtree.parent-tag")}})()</script><script src="/js/main.js?v=1.30.1" defer></script><script>let applyTheme=e=>{"auto"===e?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme",e),applyThemeToGiscus(e)},applyThemeToGiscus=e=>{e="auto"===e?"preferred_color_scheme":e;var t=document.getElementById("giscus"),t=(t&&t.setAttribute("data-theme",e),document.querySelector("#comments > section.giscus > iframe"));t&&(e=t.src.replace(/theme=[\w]+/,"theme="+e),t.src=e)},switchTheme=()=>{let e;switch(document.documentElement.getAttribute("data-theme")){case"light":e="dark";break;case"dark":e="auto";break;default:e="light"}applyTheme(e),window.localStorage.setItem("Stellar.theme",e),utils.dark.mode="auto"===e?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e,utils.dark.method.toggle.start(),hud?.toast?.({light:"切换到浅色模式",dark:"切换到深色模式",auto:"切换到跟随系统配色"}[e])};(()=>{var e=window.localStorage.getItem("Stellar.theme");null!==e?applyTheme(e):utils.dark.mode=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",utils.dark.method.toggle.start()})()</script><script type="module">const el = document.querySelector('#comments #giscus');
  util.viewportLazyload(el, load_discus, false);

  function load_discus() {
    if (!el) return;
    try {
        el.innerHTML = '';
      } catch (error) {
        console.error(error);
      }
      const script = document.createElement('script');
      script.async = true;
      for (const key of Object.keys(el.attributes)) {
        const attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
  }</script><script defer>window.addEventListener("DOMContentLoaded",e=>{ctx.services=Object.assign({},JSON.parse('{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"}}'));for(let s of Object.keys(ctx.services)){let e=ctx.services[s].js;"siteinfo"==s?(ctx.cardlinks=document.querySelectorAll("a.link-card[cardlink]"),0<ctx.cardlinks?.length&&utils.js(e,{defer:!0}).then(function(){setCardLink(ctx.cardlinks)})):"voice"==s?(ctx.voiceAudios=document.querySelectorAll(".voice>audio"),0<ctx.voiceAudios?.length&&utils.js(e,{defer:!0}).then(function(){createVoiceDom(ctx.voiceAudios)})):"video"==s?(ctx.videos=document.querySelectorAll(".video>video"),0<ctx.videos?.length&&utils.js(e,{defer:!0}).then(function(){videoEvents(ctx.videos)})):"download-file"==s?(ctx.files=document.querySelectorAll(".file"),0<ctx.files?.length&&utils.js(e,{defer:!0}).then(function(){downloadFileEvent(ctx.files)})):0<document.getElementsByClassName("ds-"+s)?.length&&utils.jq(()=>{s,utils.js(deps.marked).then(function(){utils.js(e,{defer:!0})})})}let n=document.querySelectorAll(".chat .status-bar .time");var s,t;function i(){for(let e=0;e<n.length;++e){var s=n[e],t=new Date,i=t.getHours(),t=t.getMinutes();s.innerHTML=o(i)+":"+o(t)}}function o(e){return e<10?"0"+e:e}0<n.length&&(i(),s=(new Date).getSeconds(),t=setInterval(function(){i(),clearInterval(t),setInterval(i,6e4)},1e3*(60-s)));let c=new IntersectionObserver((e,t)=>{e.filter(e=>e.isIntersecting).sort((e,s)=>e.intersectionRect.y!==s.intersectionRect.y?e.intersectionRect.y-s.intersectionRect.y:e.intersectionRect.x-s.intersectionRect.x).forEach((e,s)=>{t.unobserve(e.target),setTimeout(()=>{e.target.classList.add("quote-blink"),setTimeout(()=>{e.target.classList.remove("quote-blink")},1e3)},Math.max(100,16)*(s+1))})}),r=document.querySelectorAll(".chat .talk .quote");r.forEach(i=>{i.addEventListener("click",function(){var e,s,t=document.getElementById("quote-"+i.getAttribute("quotedCellTag"));t&&(s=(e=t.parentElement).clientHeight/2,t.offsetTop>s-t.clientHeight/2?e.scrollTo({top:t.offsetTop-s+t.clientHeight/2,behavior:"smooth"}):e.scrollTo({top:0,behavior:"smooth"}),c.observe(t))})})})</script><script>window.addEventListener("DOMContentLoaded",e=>{ctx.search={path:"/search.json"},utils.js("/js/search/local-search.js",{defer:!0})})</script><script>window.FPConfig={delay:0,ignoreKeywords:[],maxRPS:5,hoverDelay:25}</script><script defer src="/js/flying-pages.min.js"></script><script defer src="/js/lazyload.min.js"></script><script>window.lazyLoadOptions={elements_selector:".lazy"},window.addEventListener("LazyLoad::Initialized",function(n){window.lazyLoadInstance=n.detail.instance},!1),document.addEventListener("DOMContentLoaded",function(){window.lazyLoadInstance?.update()})</script><script>ctx.fancybox={selector:"article.md-text img:not(.post-cover img):not(.cover img):not(.card-link img):not(.image-bg img):not(.social img):not(.preview img)",css:"/css/fancybox.min.css",js:"/js/fancybox.umd.min.js"};var selector="[data-fancybox]:not(.error)",needFancybox=(ctx.fancybox.selector&&(selector+=", "+ctx.fancybox.selector),0!==document.querySelectorAll(selector).length);if(!needFancybox){let e=document.getElementsByClassName("ds-memos");null!=e&&0<e.length&&(needFancybox=!0)}needFancybox&&(utils.css(ctx.fancybox.css),utils.js(ctx.fancybox.js,{defer:!0}).then(function(){Fancybox.bind(selector,{hideScrollbar:!1,Thumbs:{autoStart:!1},caption:(e,t)=>t.triggerEl.alt||t.triggerEl.dataset.caption||null})}))</script><script>window.addEventListener("DOMContentLoaded",e=>{let i=document.getElementById("swiper-api");null!=i&&(utils.css("/css/swiper-bundle.min.css"),utils.js("/js/swiper-bundle.min.js",{defer:!0}).then(function(){var e=i.getAttribute("effect")||"";new Swiper(".swiper#swiper-api",{slidesPerView:"auto",spaceBetween:8,centeredSlides:!0,effect:e,rewind:!0,pagination:{el:".swiper-pagination",clickable:!0},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"}})}))})</script><script>document.addEventListener("DOMContentLoaded",function(){window.codeElements=document.querySelectorAll(".code"),0<window.codeElements.length&&(ctx.copycode={default_text:"复制代码",success_text:"复制成功",toast:"复制成功"},utils.js("/js/plugins/copycode.js"))})</script><script async>((a,t,c)=>{t.ChatraID="PHWnu7Bamcwtbnx2d";var h=a.createElement("script");t[c]=t[c]||function(){(t[c].q=t[c].q||[]).push(arguments)},h.async=!0,h.src="https://call.chatra.io/chatra.js",a.head&&a.head.appendChild(h)})(document,window,"Chatra")</script><script defer src="https://cn.vercount.one/js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous" onload="renderMathInElement(document.body)"></script><script>window.va=window.va||function(){(window.vaq=window.vaq||[]).push(arguments)}</script><script defer src="/_vercel/insights/script.js"></script><script>window.si=window.si||function(){(window.siq=window.siq||[]).push(arguments)}</script><script defer src="/_vercel/speed-insights/script.js"></script><script>function change_banner(){$(".banner img.bg").attr("src","/assets/banner/banner_"+Math.floor(20*Math.random()+1)+".jpg")}setTimeout("change_banner()",250)</script><script>function add_page_pv(){$("#post-meta").after('<div class="flex-row" id="post-meta"><span class="text created">本文总阅读量 <span id="vercount_value_page_pv"></span> 次</span></div>')}setTimeout("add_page_pv()",500)</script><script>function change_img_alt(){$("article.md-text img:not(.post-cover img):not(.cover img):not(.card-link img):not(.image-bg img):not(.social img):not(.preview img)").each(function(t){$(this).after("<div class='image-meta' style='text-align:center;'><span class='image-caption center' style='display:inline-block;font-size:.8125rem;color:var(--text-p2);line-height:1.5;text-align:justify;'>"+($(this).attr("title")||$(this).attr("alt"))+"</span></div>")})}setTimeout("change_img_alt()",1e3)</script></div></body></html>